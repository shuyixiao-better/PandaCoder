buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath 'com.guardsquare:proguard-gradle:7.5.0'
    }
}

plugins {
    id 'java'
    id 'org.jetbrains.intellij' version '1.17.4'
}

group = 'com.shuyixiao'
version = '1.1.7' // å†…æµ‹ç‰ˆæœ¬ï¼šæ–°å¢Bugè®°å½•åŠŸèƒ½

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.apache.groovy:groovy:4.0.14'
    testImplementation platform('org.junit:junit-bom:5.10.0')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    implementation "com.google.code.gson:gson:2.11.0"
    implementation "org.jetbrains:annotations:24.1.0"
    // Jenkins Pipelineæ”¯æŒæ‰€éœ€ä¾èµ–
    implementation 'org.apache.commons:commons-lang3:3.12.0'
    implementation 'org.jetbrains:annotations:24.1.0'
}

intellij {
    version = '2024.1.6'
    type = 'IU'
    plugins = ['java', 'org.intellij.groovy']
    updateSinceUntilBuild = false
}

// ç¡®ä¿å›¾æ ‡èµ„æºè¢«æ­£ç¡®åŒ…å«
sourceSets {
    main {
        resources {
            srcDirs = ['src/main/resources']
            includes = ['**/*.svg', '**/*.png', '**/*.xml', '**/*.properties', '**/*.gdsl']
        }
    }
}

tasks.withType(org.jetbrains.intellij.tasks.BuildSearchableOptionsTask) {
    enabled = false
}

ext {
    niagara_home = project.rootDir.absolutePath
}

tasks.register('minJar', Jar) {
    archiveClassifier.set('min')
    from sourceSets.main.output
}

tasks.register('proguard', proguard.gradle.ProGuardTask) {
    dependsOn minJar
    doFirst {
        ext {
            injar = tasks.named('minJar').get().archiveFile.get().asFile
            outJar = file("$buildDir/libs/${rootProject.name}-${version}-proguarded.jar")

            fileTree(dir: 'lib', include: '*.jar').files.each { jarFile ->
                libraryjars(jarFile)
            }

            libraryjars(System.getProperty("java.home") + "/jmods/java.base.jmod")
        }

        injars injar
        outjars outJar
        configuration 'sensetech.pro'
    }
    outputs.upToDateWhen { false }
}

// è¿è¡Œæ’ä»¶é…ç½®
tasks.named("runIde") {
    // ä»ç¯å¢ƒå˜é‡æˆ–ç³»ç»Ÿå±æ€§ä¸­è¯»å–APIé…ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
    jvmArgs = [
        "-Xmx2g",
        // ç™¾åº¦ç¿»è¯‘APIé…ç½® - æ”¯æŒç¯å¢ƒå˜é‡
        "-Dbaidu.api.key=${System.getenv('BAIDU_API_KEY') ?: System.getProperty('baidu.api.key', '')}",
        "-Dbaidu.app.id=${System.getenv('BAIDU_APP_ID') ?: System.getProperty('baidu.app.id', '')}"
    ]

    // æ‰“å°é…ç½®ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ç§»é™¤ï¼‰
    doFirst {
        println "BAIDU_API_KEY ç¯å¢ƒå˜é‡: ${System.getenv('BAIDU_API_KEY') ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}"
        println "BAIDU_APP_ID ç¯å¢ƒå˜é‡: ${System.getenv('BAIDU_APP_ID') ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}"
    }
}

patchPluginXml {
    sinceBuild.set("241") // è®¾ç½®æœ€ä½æ”¯æŒç‰ˆæœ¬ä¸º 2024.1ï¼ŒåŒ¹é… Java 17 è¦æ±‚
    // ä¸è®¾ç½® untilBuildï¼Œå…è®¸åœ¨ä»»ä½•æ›´é«˜ç‰ˆæœ¬ä¸Šä½¿ç”¨

    // æ’ä»¶è¯¦ç»†æè¿°å’Œå˜æ›´è¯´æ˜
    pluginDescription.set("""
        PandaCoder is an intelligent development tool designed for Chinese developers, integrating Chinese programming assistant, comprehensive Jenkins Pipeline support, and SpringBoot configuration visualization.

        ğŸ¯ Core Features:

        ğŸ“ Chinese Programming Assistant:
        â€¢ Intelligent Chinese to English conversion: Achieved through large models and prompt engineering, avoiding mechanical word-for-word translation
        â€¢ Smart class creation: Supports Chinese input for quick Java class creation with automatic English conversion
        â€¢ Class name prefix recognition: Supports "Service:User Management" format for standardized naming
        â€¢ Multiple naming formats: CamelCase, PascalCase, UPPER_CASE with underscores
        â€¢ Multi-engine translation: Domestic AI models (Qianwen/Wenxin/Zhipu) > Google Cloud Translation > Baidu Translation

        ğŸ³ Jenkins Pipeline Support:
        â€¢ Custom file type and icon: Jenkins robot icon with 5-layer theme override protection
        â€¢ Enhanced syntax highlighting: 11 vibrant colors in VS Code style
        â€¢ Intelligent completion: pipeline, stage, step keywords and methods
        â€¢ Environment variable completion: Auto-recognizes env.BUILD_NUMBER, env.WORKSPACE, etc.
        â€¢ Parameter completion: Auto-completes params.APP_NAME, params.DEPLOY_ENV, etc.
        â€¢ Documentation support: Hover documentation and method signatures
        â€¢ Customizable colors: Adjust syntax highlighting colors in IDE settings

        ğŸƒ SpringBoot Configuration Icons:
        â€¢ Technology stack recognition: MySQL, PostgreSQL, Oracle, SQL Server, Redis, Kafka, RabbitMQ, Elasticsearch
        â€¢ Smart icon display: Colorful technology stack icons in editor gutter
        â€¢ Multi-format support: YAML and Properties configuration files
        â€¢ Priority matching: Specific technology icons override generic configuration icons
        â€¢ Hover tooltips: Display technology stack names and detailed information

        âš™ï¸ Advanced Features:
        â€¢ Custom translation prompts: Adapt to different technical domains
        â€¢ File template configuration: Custom Java file comment templates
        â€¢ API configuration validation: Real-time verification of translation engine APIs
        â€¢ Smart error handling: Graceful degradation ensuring functionality availability
        â€¢ Three-tier translation engine: Ensures translation quality and availability

        ğŸ¨ Technical Highlights:
        â€¢ Intelligent priority matching: Avoids icon conflicts, displays most relevant technology stack icons
        â€¢ Multi-language support: Chinese and English programming environments
        â€¢ Theme compatibility: Custom icons support light and dark themes
        â€¢ Performance optimization: Thread-safe caching and intelligent loading

        Significantly improves development efficiency for Chinese-speaking developers and enhances Jenkins Pipeline development experience while providing intuitive SpringBoot configuration visualization.
    """)

    changeNotes.set("""
        <ul>
            <li><b>1.1.7</b> - ğŸ§ª <b>å†…æµ‹ç‰ˆæœ¬</b>ï¼šæ–°å¢Bugè®°å½•åŠŸèƒ½
                <ul>
                    <li>ğŸ› <b>Bugè®°å½•å·¥å…·çª—å£</b>ï¼šæ–°å¢ä¸“é—¨çš„Bugè®°å½•å·¥å…·çª—å£ï¼Œæ–¹ä¾¿å¼€å‘è¿‡ç¨‹ä¸­è®°å½•å’Œç®¡ç†é—®é¢˜</li>
                    <li>ğŸ“ <b>æ™ºèƒ½é”™è¯¯è§£æ</b>ï¼šè‡ªåŠ¨è§£ææ§åˆ¶å°è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯ï¼Œæå–å…³é”®é”™è¯¯ä¿¡æ¯</li>
                    <li>ğŸ” <b>é”™è¯¯ç±»å‹è¯†åˆ«</b>ï¼šè‡ªåŠ¨è¯†åˆ«ä¸åŒç±»å‹çš„é”™è¯¯ï¼ˆç¼–è¯‘é”™è¯¯ã€è¿è¡Œæ—¶é”™è¯¯ã€è­¦å‘Šç­‰ï¼‰</li>
                    <li>ğŸ“Š <b>BugçŠ¶æ€ç®¡ç†</b>ï¼šæ”¯æŒæ ‡è®°BugçŠ¶æ€ï¼ˆæ–°å»ºã€å¤„ç†ä¸­ã€å·²è§£å†³ã€å·²å…³é—­ï¼‰</li>
                    <li>â° <b>æ—¶é—´æˆ³è®°å½•</b>ï¼šè‡ªåŠ¨è®°å½•Bugå‘ç°æ—¶é—´å’Œå¤„ç†æ—¶é—´</li>
                    <li>ğŸ’¾ <b>æœ¬åœ°å­˜å‚¨</b>ï¼šBugè®°å½•ä¿å­˜åœ¨æœ¬åœ°ï¼Œç¡®ä¿æ•°æ®å®‰å…¨</li>
                    <li>ğŸ”§ <b>æ§åˆ¶å°ç›‘æ§</b>ï¼šå®æ—¶ç›‘æ§æ§åˆ¶å°è¾“å‡ºï¼Œè‡ªåŠ¨æ•è·é”™è¯¯ä¿¡æ¯</li>
                    <li>âš ï¸ <b>å†…æµ‹åŠŸèƒ½</b>ï¼šæ­¤åŠŸèƒ½ç›®å‰å¤„äºå†…æµ‹é˜¶æ®µï¼Œå¯èƒ½å­˜åœ¨ä¸ç¨³å®šæ€§ï¼Œè¯·è°¨æ…ä½¿ç”¨</li>
                </ul>
            </li>
            <li><b>1.1.6</b> - ç”¨æˆ·ä½“éªŒå…¨é¢å‡çº§
                <ul>
                    <li>ğŸ¨ <b>ç°ä»£åŒ–æ¬¢è¿ç•Œé¢</b>ï¼šå…¨æ–°è®¾è®¡çš„æ¬¢è¿å¯¹è¯æ¡†ï¼Œæä¾›æ›´ç¾è§‚çš„ç”¨æˆ·ä½“éªŒ</li>
                    <li>ğŸ“± <b>å¾®ä¿¡å…¬ä¼—å·é›†æˆ</b>ï¼šä¸€é”®å…³æ³¨å…¬ä¼—å·ï¼Œè·å–æœ€æ–°åŠŸèƒ½æ›´æ–°å’ŒæŠ€æœ¯åˆ†äº«</li>
                    <li>ğŸ’¬ <b>é—®é¢˜åé¦ˆä¼˜åŒ–</b>ï¼šæä¾›æ›´ä¾¿æ·çš„é—®é¢˜åé¦ˆæ¸ é“ï¼Œæ”¯æŒå¾®ä¿¡ç›´æ¥è”ç³»</li>
                    <li>ğŸ¢ <b>ä½œè€…ä¿¡æ¯å±•ç¤º</b>ï¼šæ˜¾ç¤ºä½œè€…æ‰€åœ¨å…¬å¸ä¿¡æ¯ï¼Œå¢å¼ºç”¨æˆ·ä¿¡ä»»åº¦</li>
                    <li>ğŸ”§ <b>ç•Œé¢å¸ƒå±€ä¼˜åŒ–</b>ï¼šé‡æ–°è®¾è®¡ç•Œé¢å¸ƒå±€ï¼Œä¿¡æ¯å±•ç¤ºæ›´åŠ æ¸…æ™°</li>
                    <li>ğŸ“Š <b>åŠŸèƒ½ç‰¹æ€§å±•ç¤º</b>ï¼šè¯¦ç»†å±•ç¤ºæ’ä»¶æ ¸å¿ƒåŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿäº†è§£</li>
                    <li>ğŸ¯ <b>ä¸€é”®å¼€å§‹ä½¿ç”¨</b>ï¼šç®€åŒ–ç”¨æˆ·æ“ä½œæµç¨‹ï¼Œå¿«é€Ÿè¿›å…¥å·¥ä½œçŠ¶æ€</li>
                </ul>
            </li>
            <li><b>1.1.5</b> - é‡å¤§åŠŸèƒ½å‡çº§ï¼šæ–°å¢SpringBooté…ç½®æ–‡ä»¶å›¾æ ‡æ˜¾ç¤ºåŠŸèƒ½
                <ul>
                    <li>ğŸƒ <b>SpringBooté…ç½®æ–‡ä»¶å›¾æ ‡</b>ï¼šè‡ªåŠ¨è¯†åˆ«é…ç½®æ–‡ä»¶ä¸­çš„æŠ€æœ¯æ ˆå¹¶æ˜¾ç¤ºå¯¹åº”å›¾æ ‡</li>
                    <li>ğŸ¯ <b>æŠ€æœ¯æ ˆè¯†åˆ«</b>ï¼šæ”¯æŒMySQLã€PostgreSQLã€Oracleã€SQL Serverã€Redisã€Kafkaã€RabbitMQã€Elasticsearchç­‰</li>
                    <li>ğŸ“ <b>å¤šæ ¼å¼æ”¯æŒ</b>ï¼šæ”¯æŒYAMLå’ŒPropertiesæ ¼å¼çš„é…ç½®æ–‡ä»¶</li>
                    <li>ğŸ¨ <b>æ™ºèƒ½å›¾æ ‡æ˜¾ç¤º</b>ï¼šåœ¨ç¼–è¾‘å™¨å·¦ä¾§gutteråŒºåŸŸæ˜¾ç¤ºå½©è‰²æŠ€æœ¯æ ˆå›¾æ ‡</li>
                    <li>ğŸ§  <b>ä¼˜å…ˆçº§åŒ¹é…</b>ï¼šç‰¹å®šæŠ€æœ¯æ ˆå›¾æ ‡ä¼˜å…ˆäºé€šç”¨é…ç½®å›¾æ ‡</li>
                    <li>ğŸ–±ï¸ <b>é¼ æ ‡æ‚¬åœæç¤º</b>ï¼šæ˜¾ç¤ºæŠ€æœ¯æ ˆåç§°å’Œè¯¦ç»†ä¿¡æ¯</li>
                </ul>
            </li>
            <li><b>1.1.4</b> - å¤šå¼•æ“ç¿»è¯‘ç³»ç»Ÿé‡å¤§å‡çº§
                <ul>
                    <li>ğŸ¤– <b>å›½å†…å¤§æ¨¡å‹æ”¯æŒ</b>ï¼šæ–°å¢é€šä¹‰åƒé—®ã€æ–‡å¿ƒä¸€è¨€ã€æ™ºè°±AIä¸‰å¤§å›½å†…å¤§æ¨¡å‹</li>
                    <li>ğŸŒ <b>Google Cloud Translation</b>ï¼šæ–°å¢Googleç¿»è¯‘APIæ”¯æŒ</li>
                    <li>ğŸ”„ <b>ä¸‰çº§ç¿»è¯‘å¼•æ“</b>ï¼šå›½å†…å¤§æ¨¡å‹ > Googleç¿»è¯‘ > ç™¾åº¦ç¿»è¯‘æ™ºèƒ½åˆ‡æ¢</li>
                    <li>âš™ï¸ <b>è‡ªå®šä¹‰ç¿»è¯‘æç¤ºè¯</b>ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ç¿»è¯‘promptï¼Œé€‚é…ä¸åŒæŠ€æœ¯é¢†åŸŸ</li>
                    <li>ğŸ”§ <b>APIé…ç½®éªŒè¯</b>ï¼šå®æ—¶éªŒè¯å„ç¿»è¯‘å¼•æ“çš„APIé…ç½®</li>
                    <li>ğŸ›¡ï¸ <b>æ™ºèƒ½é”™è¯¯å¤„ç†</b>ï¼šä¼˜é›…é™çº§ï¼Œç¡®ä¿åŠŸèƒ½å¯ç”¨æ€§</li>
                    <li>ğŸ“Š <b>é…ç½®é¡µé¢ä¼˜åŒ–</b>ï¼šåˆ†ä¸º4ä¸ªæ ‡ç­¾é¡µï¼Œç•Œé¢æ›´åŠ æ¸…æ™°æ˜“ç”¨</li>
                </ul>
            </li>
            <li><b>1.1.3</b> - ä¸­æ–‡ç¼–ç¨‹åŠ©æ‰‹åŠŸèƒ½å®Œå–„
                <ul>
                    <li>ğŸ¯ <b>ç±»åå‰ç¼€è¯†åˆ«</b>ï¼šæ”¯æŒ"Service:ç”¨æˆ·ç®¡ç†"æ ¼å¼ï¼Œè‡ªåŠ¨ç”ŸæˆServiceUserManagementç­‰è§„èŒƒç±»å</li>
                    <li>ğŸ“ <b>è‡ªå®šä¹‰æ–‡ä»¶æ¨¡æ¿</b>ï¼šæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰Javaæ–‡ä»¶æ³¨é‡Šæ¨¡æ¿</li>
                    <li>ğŸ”§ <b>æ™ºèƒ½ç²¾ç®€è½¬æ¢</b>ï¼šè‡ªåŠ¨æå–æ ¸å¿ƒæŠ€æœ¯è¯æ±‡ï¼Œå»é™¤æ— ç”¨è¯</li>
                    <li>âš™ï¸ <b>ç±»åå‰ç¼€é…ç½®</b>ï¼šæ”¯æŒè‡ªå®šä¹‰ç±»åå‰ç¼€åˆ—è¡¨</li>
                </ul>
            </li>
            <li><b>1.1.2</b> - æ–°å¢å®Œæ•´Jenkins Pipelineæ”¯æŒ
                <ul>
                    <li>âœ¨ <b>è‡ªå®šä¹‰Jenkinsæ–‡ä»¶ç±»å‹å’Œå›¾æ ‡æ˜¾ç¤º</b></li>
                    <li>ğŸ¨ <b>11ç§é²œè‰³é¢œè‰²çš„è¯­æ³•é«˜äº®(VS Codeé£æ ¼)</b></li>
                    <li>ğŸ”§ <b>æ™ºèƒ½è¡¥å…¨</b>ï¼špipelineã€stageã€stepç­‰å…³é”®å­—</li>
                    <li>ğŸŒ <b>ç¯å¢ƒå˜é‡è¡¥å…¨</b>ï¼šenv.BUILD_NUMBERã€env.WORKSPACEç­‰</li>
                    <li>ğŸ“‹ <b>å‚æ•°è¡¥å…¨</b>ï¼šparams.APP_NAMEã€params.DEPLOY_ENVç­‰</li>
                    <li>ğŸ“– <b>æ‚¬åœæ–‡æ¡£</b>ï¼šæ˜¾ç¤ºæ–¹æ³•ç­¾åå’Œå‚æ•°è¯´æ˜</li>
                    <li>ğŸ›¡ï¸ <b>é˜²ä¸»é¢˜è¦†ç›–</b>ï¼š5å±‚é˜²æŠ¤ç¡®ä¿å›¾æ ‡åœ¨ä»»ä½•ä¸»é¢˜ä¸‹æ­£ç¡®æ˜¾ç¤º</li>
                    <li>âš™ï¸ <b>å¯è‡ªå®šä¹‰é¢œè‰²</b>ï¼šæ”¯æŒåœ¨è®¾ç½®ä¸­è°ƒæ•´è¯­æ³•é«˜äº®é¢œè‰²</li>
                </ul>
            </li>
            <li><b>1.1.0</b> - æ”¯æŒIntelliJ IDEA 2024.1ï¼Œå‡çº§åˆ°Java 17</li>
            <li><b>1.0.9</b> - æ–°å¢æ™ºèƒ½ç±»åˆ›å»ºå’Œå‰ç¼€æ”¯æŒ</li>
            <li><b>1.0.8</b> - æ”¹è¿›ç¿»è¯‘å‡†ç¡®æ€§ï¼Œæ–°å¢è‡ªå®šä¹‰æ¨¡æ¿</li>
            <li><b>1.0.7</b> - é¦–æ¬¡å‘å¸ƒï¼ŒåŸºç¡€ä¸­è‹±æ–‡è½¬æ¢åŠŸèƒ½</li>
        </ul>
    """)
}

// æ’ä»¶å‘å¸ƒé…ç½®
publishPlugin {
    // ä»ç¯å¢ƒå˜é‡è·å–å‘å¸ƒä»¤ç‰Œï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•ä»ç³»ç»Ÿå±æ€§è·å–
    token.set(System.getenv("JETBRAINS_TOKEN") ?: System.getProperty("jetbrains.token", ""))

    // å‘å¸ƒæ¸ é“ï¼Œé»˜è®¤ä¸ºé»˜è®¤æ¸ é“ï¼ˆç¨³å®šç‰ˆï¼‰
    // å¯ä»¥è®¾ç½®ä¸º 'eap'ã€'alpha' æˆ– 'beta' ç”¨äºä¸åŒçš„å‘å¸ƒé˜¶æ®µ
    channels.set([System.getenv("JETBRAINS_CHANNEL") ?: System.getProperty("jetbrains.channel", "default")])
}

// ä½¿ç”¨Java 17ï¼Œå…¼å®¹IntelliJ 2024.1.6
java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

test {
    useJUnitPlatform()
}
