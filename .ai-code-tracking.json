{
  "version": "1.0",
  "records": [
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/service/impl/ChatPromptServiceImpl.java",
      "timestamp": 1761236721035,
      "startOffset": 1291,
      "endOffset": 1444,
      "codeContent": "rag.constant.AgentPromptSteps;\nimport com.torchv.rag.constant.LLMDispatchers;\nimport com.torchv.rag.constant.Prompts;\nimport com.torchv.system.extensions",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 4
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/repository/database/mapper/BusinessDataSourceMapper.java",
      "timestamp": 1761236768593,
      "startOffset": 1357,
      "endOffset": 1402,
      "codeContent": ",@Param(\"containerCode\") String containerCode",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 1
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/store/domain/builder/AppChatContextBuilder.java",
      "timestamp": 1761236768603,
      "startOffset": 776,
      "endOffset": 6718,
      "codeContent": "n.hutool.core.util.StrUtil;\nimport com.torchv.application.knowledge.model.dto.PromptInfoResp;\nimport com.torchv.application.knowledge.model.request.PromptConfigReq;\nimport com.torchv.application.knowledge.service.ChatIntegrationService;\nimport com.torchv.application.store.domain.completion.AppChatDebugCompletion;\nimport com.torchv.application.store.domain.completion.LiteAgentContextCompletion;\nimport com.torchv.application.store.model.dto.AppSettingsResp;\nimport com.torchv.application.store.service.AppContainerService;\nimport com.torchv.application.store.service.AppInfoService;\nimport com.torchv.application.store.service.AppSettingsService;\nimport com.torchv.common.constant.ApiCodes;\nimport com.torchv.common.constant.AppTypes;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.exception.ApiException;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.kb.space.service.KnowledgeEmbeddingChangeService;\nimport com.torchv.infra.rag.chain.context.ContextBuilder;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.chain.model.ChainRequest;\nimport com.torchv.infra.rag.constant.AgentPromptSteps;\nimport com.torchv.infra.rag.constant.LLMDispatchers;\nimport com.torchv.infra.rag.llm.prompt.builder.LiteAgentContextPromptBuilder;\n\nimport com.torchv.repository.store.entity.AppInfo;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\nimport java.util.Optional;\n\n/**\n * 构建APP应用的大模型Chain上下文信息\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/4/21 11:48\n * @since torchv_server v1.7.2\n */\n@Slf4j\n@AllArgsConstructor\n@Component(\"appChatContextBuilder\")\npublic class AppChatContextBuilder implements ContextBuilder\u003cAppChatDebugCompletion\u003e {\n\n    final AppInfoService appInfoService;\n    final AppContainerService appContainerService;\n    final AppSettingsService appSettingsService;\n    final ChatIntegrationService chatIntegrationService;\n    final KnowledgeEmbeddingChangeService knowledgeEmbeddingChangeService;\n\n    @Override\n    public ChainContext build(AppChatDebugCompletion completion) {\n        log.info(\"构建APP应用的大模型Chain上下文信息\");\n        ChainContext chainContext \u003d new ChainContext();\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        chainContext.setTenantId(sysUserInfo.getTenantId());\n        chainContext.setUserId(sysUserInfo.getCode());\n        ChainRequest chainRequest \u003d new ChainRequest();\n        chainRequest.setPlatform(completion.getPlatforms());\n        Optional\u003cAppInfo\u003e appInfoOptional \u003d appInfoService.queryInfoByAppId(completion.getAppid(), sysUserInfo.getTenantId());\n        if (appInfoOptional.isEmpty()) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        AppInfo appInfo \u003d appInfoOptional.get();\n        AppTypes appTypes \u003d AppTypes.ofDefault(appInfo.getCategory());\n        // 是openapi接口\n        // chainRequest.setOpenapi(true);\n        chainRequest.setAppTypes(appTypes);\n        chainRequest.setQuestion(completion.getQuestion());\n        chainRequest.setReviseQuestion(completion.getQuestion());\n        Assert.notBlank(completion.getQuestion(), ApiException.one(ApiCodes.InvalidParameter));\n        // 如果是chatBot类型，需要赋予prompt\n        AppSettingsResp appSettingsResp \u003d appSettingsService.querySettingsByAppId(appInfo.getAppid(),sysUserInfo.getTenantId(),AppTypes.of(appInfo.getCategory()));\n        // 如果透传的config不为空，那么使用透传的config覆盖应用配置的config\n        if (completion.getConfig()\u003d\u003dnull){\n            // 使用绑定的配置config\n            PromptConfigReq configReq\u003dappSettingsResp.configReq();\n            completion.setConfig(configReq);\n        }\n        if (StrUtil.isBlank(completion.getPrompt())){\n            // 使用绑定的prompt\n            completion.setPrompt(appSettingsResp.getPrompt());\n        }\n\n        if (appTypes \u003d\u003d AppTypes.LITE_AGENT) {\n            // 如果是轻量级Agent，那么query和prompt需要处理\n            String prompt \u003d new LiteAgentContextPromptBuilder().build(LiteAgentContextCompletion.builder().question(completion.getQuestion()).prompt(appSettingsResp.getPrompt()).build());\n            chainRequest.setPrompt(prompt);\n            // LiteAgent应用不需要检索知识库\n            completion.setRagSearch(false);\n            chainContext.getSearchContext().setEnableEmbedding(false);\n            chainContext.getSearchContext().setEnableReRanker(false);\n        } else {\n            // 设置知识库id\n            // 查询应用绑定的容器\n            List\u003cString\u003e containerAppIds \u003dappContainerService.listContainers(appInfo);\n            if (CollUtil.isNotEmpty(containerAppIds)) {\n                // 设置embedding的模型\n                chainContext.getSearchContext().applyEmbeddingModel(knowledgeEmbeddingChangeService.checkKnowledgeConsistency(containerAppIds));\n            }else{\n                // 不进行embedding处理，直接大模型回复\n                chainContext.getSearchContext().setEnableEmbedding(false);\n                chainContext.getSearchContext().setEnableReRanker(false);\n                // 如果知识库没有绑定，那么不查询知识库，直接让大模型回答\n                //chainContext.getSearchContext().setRagSearch(false);\n                completion.setRagSearch(false);\n            }\n            // 使用应用设置的prompt\n            chainRequest.setPrompt(appSettingsResp.getPrompt());\n            // 设置添加prompt\n            chainContext.getPrompts().addPrompt(AgentPromptSteps.SYSTEM,appSettingsResp.getSystemPrompt());\n            chainContext.getPrompts().addPrompt(AgentPromptSteps.REWRITE,appSettingsResp.getRewritePrompt());\n            chainContext.getPrompts().addPrompt(AgentPromptSteps.SUB_QUERY,appSettingsResp.getSubQueryPrompt());\n            chainRequest.setContainerId(containerAppIds);\n        }\n        /**\n         * 输入的文件，可以根据输入文件进行对话\n         */\n        chainRequest.setFileId(completion.getFileId());\n        //chainRequest.setStream(true);\n        chainRequest.setStream(completion.isStream()",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 119
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/system/service/impl/ModelProviderServiceImpl.java",
      "timestamp": 1761236768606,
      "startOffset": 1764,
      "endOffset": 5208,
      "codeContent": "infra.rag.constant.LLMModels;\nimport com.torchv.infra.rag.llm.model.ModelSetting;\nimport com.torchv.repository.system.entity.RagConfigLlmModel;\nimport com.torchv.repository.system.mapper.RagConfigLlmModelMapper;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.stereotype.Service;\n\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\nimport java.util.concurrent.locks.Lock;\nimport java.util.concurrent.locks.ReentrantLock;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/9/21 15:54\n * @since torchv_server v1.8.3\n */\n@AllArgsConstructor\n@Service\n@Slf4j\npublic class ModelProviderServiceImpl implements ModelProviderService {\n    \n    final RagConfigLlmModelMapper ragConfigLlmModelMapper;\n    final RagConfigLlmModelService ragConfigLlmModelService;\n    final StringRedisTemplate stringRedisTemplate;\n    final Lock lock \u003d new ReentrantLock(false);\n    \n    @Override\n    public List\u003cString\u003e availableModels() {\n        lock.lock();\n        try {\n            /**String value \u003d stringRedisTemplate.opsForValue().get(CacheCns.CACHE_MODEL_AVAILABLE_SETTING);\n            if (StrUtil.isNotBlank(value)) {\n                return StrUtil.split(value, StrUtil.COMMA);\n            }**/\n            // 从DB数据库里面查询\n            LambdaQueryWrapper\u003cRagConfigLlmModel\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(RagConfigLlmModel.class);\n            lambdaQueryWrapper.eq(RagConfigLlmModel::getOnlineStatus, ToggleStatusEnum.YES.getValue());\n            List\u003cRagConfigLlmModel\u003e ragConfigLlmModels \u003d ragConfigLlmModelMapper.selectList(lambdaQueryWrapper);\n            if (CollectionUtil.isNotEmpty(ragConfigLlmModels)) {\n                List\u003cString\u003e models \u003d ragConfigLlmModels.stream().map(RagConfigLlmModel::getModel).toList();\n                stringRedisTemplate.opsForValue().set(CacheCns.CACHE_MODEL_AVAILABLE_SETTING, StrUtil.join(StrUtil.COMMA, models), 2L, TimeUnit.HOURS);\n                return models;\n            }\n            return List.of();\n        } finally {\n            lock.unlock();\n        }\n    }\n\n    @Override\n    public List\u003cString\u003e availableLargeModels(String tenantId) {\n        List\u003cSelectGroupResp\u003e selectGroups\u003dragConfigLlmModelService.listModelGroup(tenantId, LargeModelType.LARGE_LANGUAGE_MODELS);\n        if (CollUtil.isNotEmpty(selectGroups)){\n            List\u003cString\u003e models\u003dnew ArrayList\u003c\u003e();\n            for (SelectGroupResp s:selectGroups){\n                if (CollUtil.isNotEmpty(s.getOptions())){\n                    models.addAll(s.getOptions().stream().map(SelectDetailResp::getValue).toList());\n                }\n            }\n            return models;\n        }\n        return List.of();\n    }\n\n    @Override\n    public List\u003cString\u003e availableReRankerModels(String tenantId) {\n        List\u003cSelectGroupResp\u003e selectGroups\u003dragConfigLlmModelService.listModelGroup(tenantId, LargeModelType.RERANK_MODELS);\n        if (CollUtil.isNotEmpty(selectGroups)){\n            List\u003cString\u003e models\u003dnew ArrayList\u003c\u003e();\n            for (SelectGroupResp s:selectGroups){\n                if (CollUtil.isNotEmpty(s.getOptions())){\n                    models.addAll(s.getOptions().stream().map(SelectDetailResp::getValue).toList());\n                }\n            }\n            return models;\n        }\n        return List.of();\n    }\n",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 84
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/openapi/service/impl/OpenAPIServiceImpl.java",
      "timestamp": 1761236768625,
      "startOffset": 1530,
      "endOffset": 1780,
      "codeContent": "infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.chain.model.ChainRequest;\nimport com.torchv.infra.rag.constant.LLMDispatchers;\nimport com.torchv.infra.rag.llm.model.completions.BotMessage;\nimport com.torchv.infra.web.spring.properties",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 5
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/openapi/service/impl/OpenAppServiceImpl.java",
      "timestamp": 1761236768628,
      "startOffset": 1046,
      "endOffset": 4522,
      "codeContent": "knowledge.model.response.chat.ChatIntegration;\nimport com.torchv.application.openapi.domain.completion.ChatStoreAppApiV1Completion;\nimport com.torchv.application.openapi.domain.pojo.OpenAppChatValidationResult;\nimport com.torchv.application.openapi.domain.pojo.WebChatRecord;\nimport com.torchv.application.openapi.domain.completion.ChatAppApiV1Completion;\nimport com.torchv.application.openapi.model.req.ChatValidationReq;\nimport com.torchv.application.openapi.domain.pojo.WebPage;\nimport com.torchv.application.openapi.model.resp.ChatValidationResp;\nimport com.torchv.application.openapi.service.OpenAppService;\nimport com.torchv.application.knowledge.model.dto.PromptInfoResp;\nimport com.torchv.application.store.domain.completion.AppChatDebugCompletion;\nimport com.torchv.application.store.service.AppInfoService;\nimport com.torchv.application.store.service.AppSettingsService;\nimport com.torchv.common.constant.AppTypes;\nimport com.torchv.common.constant.CacheCns;\nimport com.torchv.common.constant.Cns;\nimport com.torchv.common.constant.Platforms;\nimport com.torchv.common.constant.llm.AgentIntegrations;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.extra.filter.ThreadLocalHolder;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.infra.common.external.queue.RabbitMessageService;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.utils.GsonUtils;\nimport com.torchv.common.utils.RsaUtil;\nimport com.torchv.repository.store.entity.AppInfo;\nimport jakarta.servlet.http.Cookie;\nimport jakarta.servlet.http.HttpServletRequest;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.stereotype.Service;\n\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/3/20 20:16\n * @since torchv_server v0.1-beta.1.6\n */\n@AllArgsConstructor\n@Slf4j\n@Service\npublic class OpenAppServiceImpl implements OpenAppService {\n    \n    final StringRedisTemplate stringRedisTemplate;\n    final AppInfoService appInfoService;\n    final AppSettingsService appSettingsService;\n    final RabbitMessageService rabbitMessageService;\n\n    @Override\n    public AppChatDebugCompletion buildDebugCompletion(ChatAppApiV1Completion req, OpenAppChatValidationResult result) {\n        // 构建用户信息\n        String tenantId \u003d result.getAppInfo().getTenantId();\n        String userId \u003d req.getUserId();\n        if (StrUtil.isBlank(userId)) {\n            userId \u003d StrUtil.hide(MD5.create().digestHex(result.getAppInfo().getTenantId()),5,26);\n        }\n        // 复制给LocalContext上下文,在UserContextHolder中使用\n        ThreadLocalHolder.setUser(SysUserInfo.webClient(userId, tenantId));\n        // 构建问答信息\n        AppChatDebugCompletion appChatDebugCompletion\u003dnew AppChatDebugCompletion();\n        appChatDebugCompletion.setAppid(result.getAppInfo().getAppid());\n        appChatDebugCompletion.setQuestion(req.getPrompt());\n        appChatDebugCompletion.setConversationId(req.getConversationId());\n        appChatDebugCompletion.setPlatforms(Platforms.PC);\n        // integrations\n        appChatDebugCompletion.setIntegrations(List.of(ChatIntegration.from(AgentIntegrations.INNER_INTENT),ChatIntegration.from(AgentIntegrations.INNER_SUBQUERY)));\n        return appChatDebugCompletion;\n    }\n",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 75
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/kb/page/service/impl/KbPageEventServiceImpl.java",
      "timestamp": 1761236768655,
      "startOffset": 1308,
      "endOffset": 6207,
      "codeContent": "infra.common.external.queue.RabbitMessageService;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.kb.common.constant.KbEventMessageTypes;\nimport com.torchv.kb.common.model.KbEventMessageCallbackDTO;\nimport com.torchv.kb.common.model.KbEventToggleReq;\nimport com.torchv.kb.page.model.dto.PageEventNameInfo;\nimport com.torchv.kb.page.model.event.KbPageEventMessage;\nimport com.torchv.kb.page.model.request.*;\nimport com.torchv.kb.page.model.response.KbPageFollowResp;\nimport com.torchv.kb.page.model.response.SpaceFollowInfoResp;\nimport com.torchv.kb.page.service.KbPageEventService;\nimport com.torchv.repository.kb.entity.KbUserCollectPageInfo;\nimport com.torchv.repository.kb.page.dto.PageEventUserInfo;\nimport com.torchv.repository.kb.page.entity.KbPageEvent;\nimport com.torchv.repository.kb.page.entity.KbUserPageFollowInfo;\nimport com.torchv.repository.kb.page.entity.KbUserPageFollowInfoSearch;\nimport com.torchv.repository.kb.page.mapper.KbPageEventMapper;\nimport com.torchv.repository.kb.space.dto.KbSpaceFollowingInfo;\nimport com.torchv.repository.kb.space.dto.SpaceFollowingSearch;\nimport com.torchv.repository.kb.space.mapper.KbSpaceFollowingMapper;\nimport com.torchv.repository.kb.user.mapper.KbUserCollectPageMapper;\nimport com.torchv.infra.web.i18n.I18nMessage;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.redisson.api.RLock;\nimport org.redisson.api.RedissonClient;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.stereotype.Service;\nimport java.time.Instant;\nimport java.time.LocalDate;\nimport java.time.LocalDateTime;\nimport java.time.ZoneId;\nimport java.util.*;\nimport java.util.concurrent.TimeUnit;\n\n/**\n * 页面事件模块-业务Service实现\n * @since torchv_server kb-v0.0.1\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/10/30 20:30\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class KbPageEventServiceImpl extends ServiceImpl\u003cKbPageEventMapper, KbPageEvent\u003e implements KbPageEventService {\n\n    final KbPageEventMapper kbPageEventMapper;\n    final RabbitMessageService rabbitMessageService;\n    final RedissonClient redissonClient;\n    final I18nMessage i18nMessage;\n    final KbSpaceFollowingMapper kbSpaceFollowingMapper;\n    final KbUserCollectPageMapper kbUserCollectPageMapper;\n    @Override\n    public Pagination\u003cPageEventUserInfo\u003e eventUserList(String eventType, String pageCode, Integer pageNo, Integer pageSize) {\n        long count;\n        List\u003cPageEventUserInfo\u003e list \u003d null;\n        // 启用分页查询，并在try资源管理中自动关闭分页上下文\n        try (Page\u003cPageEventUserInfo\u003e kbPagePageNo \u003d PageHelper.startPage(pageNo, pageSize)) {\n            // 执行查询，获取当前页的页面信息列表\n            list \u003d kbPageEventMapper.listEventUserInfo(UserContextHolder.getTenantId(), pageCode, eventType);\n            // 获取总记录数，用于分页信息\n            count \u003d kbPagePageNo.getTotal();\n        }\n        // 构造并返回分页响应对象，包含树形结构页面信息列表、总记录数、当前页码和每页记录数\n        return Pagination.pagination(list, count, pageNo, pageSize);\n\n    }\n    /**\n     * 追踪页面浏览信息\n     * 此方法用于记录用户的页面浏览数据，包括租户ID、页面代码和用户代码这些信息会被封装到一个事件对象中，\n     * 并发送到消息队列，以供后续处理或分析\n     *\n     * @param traceReq 包含页面追踪信息的请求对象\n     * @return 返回一个表示操作结果的Result对象，包含一个简单的成功消息\n     */\n    @Override\n    public Result\u003cString\u003e trace(PageTraceReq traceReq) {\n        // 获取当前用户信息\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        KbEventToggleReq eventToggleReq \u003d new KbEventToggleReq();\n        eventToggleReq.setBody(KbEventBody.PAGE);\n        eventToggleReq.setToggle(false);\n        eventToggleReq.setPageCode(traceReq.getPageCode());\n        eventToggleReq.setPrimaryCode(traceReq.getPageCode());\n        eventToggleReq.setType(KbEventMessageTypes.EVENT_PAGE_BROWSER);\n        // 创建页面浏览事件对象，包含租户ID、页面代码和用户代码\n        KbPageEventMessage event \u003d KbPageEventMessage.of(sysUserInfo, eventToggleReq);\n        // 将页面浏览事件信息发送到消息队列\n        rabbitMessageService.sendKbEventMessage(KbEventMessageCallbackDTO.of(KbEventMessageTypes.EVENT_PAGE_BROWSER, event));\n        // 返回成功结果\n        return Result.data(\"SUCCESS\");\n    }\n    \n    @Override\n    public Pagination\u003cPageEventNameInfo\u003e userEvent(Integer pageNo, Integer pageSize, List\u003cString\u003e eventTypes,Integer creator) {\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        List\u003cPageEventNameInfo\u003e eventNameInfos;\n        long count;\n        try (Page\u003cPageEventNameInfo\u003e page \u003d PageHelper.startPage(pageNo, pageSize)) {\n            Date date \u003d Date.from(LocalDate.now().minusDays(7).atStartOfDay(ZoneId.systemDefault()).toInstant());\n            eventNameInfos \u003d kbPageEventMapper.listUserEvent(sysUserInfo.getTenantId(), sysUserInfo.getCode(), eventTypes, date,creator);\n            count \u003d page.getTotal();\n        }\n        return Pagination.pagination(eventNameInfos, count, pageNo, pageSize);\n    }\n    ",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 108
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/kb/page/service/impl/PagePermissionDataServiceImpl.java",
      "timestamp": 1761236768662,
      "startOffset": 107,
      "endOffset": 8867,
      "codeContent": "util.StrUtil;\nimport com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;\nimport com.baomidou.mybatisplus.core.toolkit.Wrappers;\nimport com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;\nimport com.torchv.common.constant.enums.system.ToggleStatusEnum;\nimport com.torchv.common.constant.kb.KbKnowledgeBaseContainerMemberTypes;\nimport com.torchv.common.constant.kb.KbKnowledgeBaseContainerPermissionTypes;\nimport com.torchv.common.constant.kb.PagePermissionEventTypes;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.kb.common.metadata.data.PageMetaDataIndexField;\nimport com.torchv.kb.page.model.dto.PagePermissionCheckInfo;\nimport com.torchv.kb.page.model.request.PagePermissionBodyReq;\nimport com.torchv.kb.page.model.request.PagePermissionResetReq;\nimport com.torchv.kb.page.model.request.PagePermissionUpdateReq;\nimport com.torchv.kb.page.model.response.SaasKnowledgeElementPermissionResp;\nimport com.torchv.kb.page.service.PagePermissionDataService;\nimport com.torchv.kb.page.service.PagePermissionService;\nimport com.torchv.kb.space.service.KnowledgeContainerConfigQueryService;\nimport com.torchv.kb.space.service.SaasKnowledgeContainerPermissionService;\nimport com.torchv.infra.vector.VectorIndexDelegate;\nimport com.torchv.infra.vector.model.UpdateChunk;\nimport com.torchv.infra.vector.model.VectorChunkUpdateQueryReq;\nimport com.torchv.repository.chat.entity.SaasKnowledgeElement;\nimport com.torchv.repository.chat.entity.SaasKnowledgeElementPermission;\nimport com.torchv.repository.chat.mapper.SaasKnowledgeElementMapper;\nimport com.torchv.repository.chat.mapper.SaasKnowledgeElementPermissionMapper;\nimport com.torchv.infra.web.i18n.I18nMessage;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.util.*;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2025/9/14 17:54\n * @since ais-server\n */\n@Slf4j\n@Service\n@AllArgsConstructor\npublic class PagePermissionDataServiceImpl  extends ServiceImpl\u003cSaasKnowledgeElementPermissionMapper, SaasKnowledgeElementPermission\u003e  implements PagePermissionDataService {\n\n    final SaasKnowledgeElementMapper saasKnowledgeElementMapper;\n    final I18nMessage i18nMessage;\n    final PagePermissionService pagePermissionService;\n    final VectorIndexDelegate vectorIndexDelegate;\n    final KnowledgeContainerConfigQueryService knowledgeContainerConfigQueryService;\n    final SaasKnowledgeContainerPermissionService saasKnowledgeContainerPermissionService;\n\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e handlePermissionEvent(PagePermissionUpdateReq updateReq) {\n        PagePermissionEventTypes eventTypes\u003dPagePermissionEventTypes.fromString(updateReq.getEventType());\n        if (eventTypes\u003d\u003dnull) {\n            log.warn(\"不支持的权限事件类型:{}\", updateReq.getEventType());\n            return Result.customFail(\"不支持的权限事件类型:\" + updateReq.getEventType());\n        }\n        if (eventTypes\u003d\u003dPagePermissionEventTypes.PERMISSION_EVENT_TYPE_ADD) {\n            return this.handleEventAdd(updateReq);\n        } else if (eventTypes\u003d\u003dPagePermissionEventTypes.PERMISSION_EVENT_TYPE_UPDATE) {\n            return this.handleEventUpdate(updateReq);\n        } else if (eventTypes\u003d\u003dPagePermissionEventTypes.PERMISSION_EVENT_TYPE_DELETE) {\n            return this.handleEventDelete(updateReq);\n        }\n        return Result.customFail(\"不支持的权限事件类型:\" + updateReq.getEventType());\n    }\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e handleEventDelete(PagePermissionUpdateReq updateReq) {\n        // 删除事件，需要判断当前删除的用户是否更改了默认继承的权限\n        SysUserInfo sysUserInfo\u003d UserContextHolder.getCurrentUser();\n        // 有编辑+管理权限以上的人，才能删除用户\n        PagePermissionCheckInfo checkInfo\u003dpagePermissionService.checkOperationPermission(updateReq.getElementCode(),sysUserInfo,List.of(KbKnowledgeBaseContainerPermissionTypes.MANAGE,KbKnowledgeBaseContainerPermissionTypes.EDIT),true);\n        checkInfo.checkAdminPermission(sysUserInfo, updateReq);\n        SaasKnowledgeElement element\u003dcheckInfo.getElement();\n        int permissionStatus\u003delement.getPermissionStatus();\n        List\u003cString\u003e deletePermissionKeys\u003dnew ArrayList\u003c\u003e();\n        // 获取文档的权限列表\n        List\u003cSaasKnowledgeElementPermissionResp\u003e  permissions \u003d checkInfo.getPermissions();\n        // 校验权限，是否可以处理\n        // 判断当前文档是否是继承权限\n        boolean isInheritDeleted\u003dfalse;\n        boolean permissionInheritStatus\u003dObjects.equals(element.getPermissionStatus(), ToggleStatusEnum.YES.getCode());\n        // 是继承权限，此时要判断是否删除的非知识库继承的文档权限\n        // 判断是否对继承的权限做了删除\n        for (SaasKnowledgeElementPermissionResp permission : permissions) {\n            String permissionKey\u003dpermission.permissionKey();\n            long count\u003dupdateReq.getPermissions().stream().filter(p-\u003eObjects.equals(p.permissionKey(), permissionKey)).count();\n            if (count\u003e0){\n                // 标记删除的key权限\n                deletePermissionKeys.add(permissionKey);\n                if (permissionInheritStatus \u0026\u0026 permission.isInherited()){\n                    isInheritDeleted\u003dtrue;\n                }\n            }\n        }\n        // 根据条件记录直接做删除\n        LambdaQueryWrapper\u003cSaasKnowledgeElementPermission\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElementPermission.class)\n                .eq(SaasKnowledgeElementPermission::getTenantId, element.getTenantId())\n                .eq(SaasKnowledgeElementPermission::getElementCode, updateReq.getElementCode());\n        lambdaQueryWrapper.and(s-\u003e{\n            for (PagePermissionBodyReq permissionBodyReq:updateReq.getPermissions()) {\n                KbKnowledgeBaseContainerMemberTypes memberTypes\u003dKbKnowledgeBaseContainerMemberTypes.parse(permissionBodyReq.getMembershipType());\n                if (memberTypes\u003d\u003dnull){\n                    log.warn(\"不支持的权限类型:{}\", permissionBodyReq.getMembershipType());\n                    throw new IllegalArgumentException(\"不支持的权限类型:\"+permissionBodyReq.getMembershipType());\n                }\n                s.or().eq(SaasKnowledgeElementPermission::getMembershipType, memberTypes.getCode())\n                        .eq(SaasKnowledgeElementPermission::getMembershipCode, permissionBodyReq.getMembershipCode());\n            }\n        });\n        if (isInheritDeleted){\n            permissionStatus\u003dToggleStatusEnum.NO.getCode();\n            // 删除了继承的权限，当前文档需要变更为非继承权限\n            saasKnowledgeElementMapper.resetInheritPermission(updateReq.getElementCode(), permissionStatus);\n        }\n        // 做清理删除动作\n        boolean deleted\u003dthis.remove(lambdaQueryWrapper);;\n        log.info(\"文档权限删除,状态:{}，文档编码：{}，租户ID：{}\",deleted, updateReq.getElementCode(), element.getTenantId());\n        // 用户最新的权限编码\n        Set\u003cString\u003e permissionCodes\u003dnew HashSet\u003c\u003e();\n        List\u003cSaasKnowledgeElementPermission\u003e permissionList \u003dnew ArrayList\u003c\u003e();\n        // 这个时候，如果是继承权限被删除了，那么需要把继承的权限在批量新增加回来，因为当前文档已经变更为非继承权限了\n        // 针对删除的逻辑，es索引权限编码变更的逻辑：\n        // 1、判断当前删除的权限，是否已经把继承的权限删除了，\n        for (SaasKnowledgeElementPermissionResp permission : permissions) {\n            String permissionKey\u003dpermission.permissionKey();\n            if (deletePermissionKeys.contains(permissionKey)){\n                // 已经删除的权限。跳过\n                continue;\n            }\n            // 非删除的权限\n            if (isInheritDeleted){\n                // 如果是删除了继承权限，那么全部add进去，相当于复制\n                permissionCodes.add(permission.getMembershipCode());\n                // 在文档的权限表也需要add进去一份，相当于权限拷贝\n                permissionList.add(permission.addElementPermission(element,sysUserInfo));\n            }else{\n                // 如果没有删除继承权限，那么只把非继承的权限add进去\n                if (!permission.isInherited()){\n                    permissionCodes.add(permission.getMembershipCode());\n                }\n                // 如果没有删除继承权限，收集所有权限编码（包括知识库继承的和文档自定义的）\n//                permissionCodes.add(permission.getMembershipCode());\n            }\n        }\n        // 新增继承过来的权限\n        if (CollUtil.isNotEmpty(permissionList)){\n            log.info(\"文档权限删除后，新增非继承权限,文档编码：{}，租户ID：{}，新增权限数：{}\", updateReq.getElementCode(), element.getTenantId(), permissionList.size());\n            LambdaQueryWrapper\u003cSaasKnowledgeElementPermission\u003e saasKnowledgeElementPermissionLambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElementPermission.class)\n                    .eq(SaasKnowledgeElementPermission::getTenantId, element.getTenantId())\n                    .eq(SaasKnowledgeElementPermission::getElementCode, updateReq.getElementCode());\n            this.remove(saasKnowledgeElementPermissionLambdaQueryWrapper",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 159
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/repository/chat/mapper/SaasKnowledgeElementMapper.java",
      "timestamp": 1761236768682,
      "startOffset": 725,
      "endOffset": 1886,
      "codeContent": "FilterSearchCondition;\nimport com.torchv.repository.chat.dto.ElementSearchCondition;\nimport com.torchv.repository.chat.dto.ElementSearchValueCondition;\nimport com.torchv.repository.chat.entity.SaasKnowledgeElement;\nimport com.baomidou.mybatisplus.core.mapper.BaseMapper;\nimport com.torchv.repository.kb.page.dto.KbPageCreateInfo;\nimport com.torchv.repository.kb.page.dto.PageSnapshotSearchReq;\nimport org.apache.ibatis.annotations.Param;\n\nimport java.util.List;\n\n/**\n * \u003cp\u003e\n * 知识文件信息表 Mapper 接口\n * \u003c/p\u003e\n *\n * @author xiaoymin@foxmail.com\n * @since 2024-01-03\n */\npublic interface SaasKnowledgeElementMapper extends BaseMapper\u003cSaasKnowledgeElement\u003e {\n    /**\n     * 查询不可见的节点编码列表\n     * @param searchCondition 查询条件\n     * @return 节点编码列表\n     */\n    List\u003cString\u003e listVisibleSearchCodes(ElementSearchValueCondition searchCondition);\n    /**\n     * 查询不可见的节点编码列表\n     * @param searchCondition 查询条件\n     * @return 节点编码列表\n     */\n    List\u003cString\u003e listVisibleCodes(ElementSearchCondition searchCondition);\n\n    /**\n     * 查询非继承的元素编码\n     * 查询可见的节点编码列表\n     * @param searchCondition 查询条件\n     * @return 节点编码列表\n     */\n    List\u003cString\u003e listVisibleFilterCodes(ElementFilter",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 40
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/repository/system/entity/RagConfigLlmModel.java",
      "timestamp": 1761236768684,
      "startOffset": 3183,
      "endOffset": 3341,
      "codeContent": "    /**\n     * 插件厂商编码，关联plugin_vendor表\n     */\n    private Integer vendorCode;\n\n    /**\n     * 厂商模型编码(厂商内部的模型标识)\n     */\n    private String vendorModelCode;\n\n",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 11
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/user/web/AuthController.java",
      "timestamp": 1761236768688,
      "startOffset": 848,
      "endOffset": 14547,
      "codeContent": "config.SaTokenConfig;\nimport cn.dev33.satoken.stp.StpUtil;\nimport cn.hutool.core.lang.Assert;\nimport cn.hutool.core.util.IdUtil;\nimport cn.hutool.core.util.ObjectUtil;\nimport cn.hutool.extra.servlet.JakartaServletUtil;\nimport com.taobao.api.ApiException;\nimport com.torchv.application.user.model.response.ModuleEmbedAuthResp;\nimport com.torchv.application.user.model.dto.SysRoleDTO;\nimport com.torchv.application.user.model.dto.SysUserDTO;\nimport com.torchv.application.user.model.dto.UserPermissionDTO;\nimport com.torchv.application.user.model.pojo.LoginDecrypt;\nimport com.torchv.application.user.model.request.*;\nimport com.torchv.application.user.model.response.LoginH5Resp;\nimport com.torchv.application.user.model.request.LoginUserAutoReq;\nimport com.torchv.application.user.model.request.LoginUserReq;\nimport com.torchv.application.user.model.request.ResetPwdReq;\nimport com.torchv.application.user.model.request.ResetTenantPwdReq;\nimport com.torchv.application.user.model.response.LoginKbResp;\nimport com.torchv.application.user.model.response.LoginResp;\nimport com.torchv.application.user.model.response.UserInfoResp;\nimport com.torchv.application.user.model.response.VerifyCodeResp;\nimport com.torchv.application.user.service.*;\nimport com.torchv.common.constant.Cns;\nimport com.torchv.common.constant.enums.ErrorCodeEnum;\nimport com.torchv.common.constant.enums.system.SystemModule;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.exception.BizException;\nimport com.torchv.infra.common.extra.log.annotation.SysLog;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.model.base.CaptchaResult;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.infra.common.utils.CommonUtils;\nimport com.torchv.infra.common.utils.RedisUtil;\nimport com.torchv.infra.license.LicenseBootstrap;\nimport com.torchv.kb.system.service.SystemService;\nimport com.torchv.repository.tenant.entity.SaasTenantInfo;\nimport com.torchv.repository.user.entity.SysUser;\nimport com.torchv.infra.web.spring.properties.SecureConfig;\nimport io.swagger.v3.oas.annotations.Operation;\nimport io.swagger.v3.oas.annotations.Parameter;\nimport io.swagger.v3.oas.annotations.enums.ParameterIn;\nimport io.swagger.v3.oas.annotations.tags.Tag;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport jakarta.servlet.http.HttpSession;\nimport jakarta.validation.Valid;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.commons.lang3.StringUtils;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.web.bind.annotation.*;\n\nimport java.io.IOException;\nimport java.util.Collection;\nimport java.util.List;\nimport java.util.Objects;\nimport java.util.Optional;\n\n/**\n * 鉴权服务api\n *\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2022/7/15 11:25\n */\n@Tag(name \u003d \"授权登录(PC端)\")\n@Slf4j\n@AllArgsConstructor\n@RestController\n@RequestMapping(\"/user/api/auth\")\npublic class AuthController {\n\n    final UserAuthService userAuthService;\n    final UserRoleService userRoleService;\n    final PermService permService;\n    final SecureConfig secureConfig;\n    final TenantInfoService tenantInfoService;\n    final SystemService systemService;\n    final UserService userService;\n    final LicenseBootstrap licenseBootstrap;\n    final ModuleEmbedAuthService moduleEmbedAuthService;\n    final SaTokenConfig saTokenConfig;\n\n\n    @GetMapping(\"/token\")\n    @Operation(summary \u003d \"获取嵌入Token\", description \u003d \"支持两种模式：1.平台密钥(tk-开头)获取token 2.临时token换取新token\")\n    public Result\u003cModuleEmbedAuthResp\u003e getToken(\n            @RequestParam(\"secureKey\") @Parameter(description \u003d \"密钥或临时token\", required \u003d true, in \u003d ParameterIn.QUERY) String secureKey,\n            HttpServletRequest request,\n            HttpServletResponse response) {\n\n        log.info(\"获取嵌入Token, secureKey: {}\", secureKey);\n        \n        ModuleEmbedAuthResp resp;\n        String newToken;\n        \n        // 判断secureKey是否以tk-开头（平台密钥）\n        if (secureKey.startsWith(Cns.API_TOKEN_PREFIX_V2)) {\n            // 模式1：平台密钥模式（tk-开头）\n            log.info(\"模式1：使用平台密钥获取token, secureKey: {}\", secureKey);\n            \n            // getEmbedToken内部会添加Bearer前缀\n            resp \u003d moduleEmbedAuthService.getEmbedToken(secureKey, request);\n            newToken \u003d resp.getToken();\n            \n            log.info(\"模式1：平台密钥生成token成功\");\n            \n        } else {\n            // 模式2：临时token模式（从/apiToken接口获取的token）\n            log.info(\"模式2：使用临时token换取新token, tempToken: {}\", secureKey);\n            \n            // 从Redis中查询userCode\n            String redisKey \u003d \"embed:api_token:\" + secureKey;\n            String userCode \u003d RedisUtil.getString(redisKey);\n            \n            // 验证临时token是否有效\n            Assert.isTrue(StringUtils.isNotEmpty(userCode), () -\u003e new BizException(ErrorCodeEnum.PARAM_ERROR.getCode(), \"临时token无效或已使用\"));\n            \n            log.info(\"模式2：从Redis查询到userCode: {}\", userCode);\n            \n            // 删除Redis中的临时token记录（保证一次性使用）\n            RedisUtil.del(redisKey);\n            log.info(\"模式2：已删除Redis中的临时token记录，保证一次性使用\");\n            \n            // 使用userCode生成新的token\n            SysUserInfo userInfo \u003d userAuthService.getUserInfo(userCode, 0, Cns.SYS_TYPE.CLI);\n            Assert.notNull(userInfo, () -\u003e new BizException(\"用户不存在\"));\n            \n            // 生成新Token\n            StpUtil.login(userCode);\n            UserContextHolder.setCurrentUser(userInfo);\n            newToken \u003d StpUtil.getTokenInfo().getTokenValue();\n            \n            Integer tokenExpireSeconds \u003d 7200; // 默认过期时间2小时\n            resp \u003d new ModuleEmbedAuthResp();\n            resp.setToken(newToken);\n            resp.setTokenExpireSeconds(tokenExpireSeconds);\n            \n            log.info(\"模式2：临时token换取新token成功\");\n        }\n\n        // 设置Cookie，将新token写入到自己域名的Cookie中\n        if (StringUtils.isNotEmpty(newToken)) {\n            // 使用token的过期时间作为Cookie的存活时间\n            // 优先使用resp中的过期时间，如果没有则使用Sa-Token配置文件中的timeout值\n            int cookieAliveTime \u003d resp.getTokenExpireSeconds() !\u003d null \n                ? resp.getTokenExpireSeconds() \n                : (int) saTokenConfig.getTimeout();\n\n            // 写入Sa-Token识别的Cookie名称（与配置文件中的token-name保持一致）\n            JakartaServletUtil.addCookie(response, saTokenConfig.getTokenName(), newToken, cookieAliveTime);\n            log.info(\"设置Sa-Token Cookie成功, cookieName: {}, cookieAliveTime: {}秒\", saTokenConfig.getTokenName(), cookieAliveTime);\n        }\n\n        return Result.success(resp);\n    }\n\n    @GetMapping(\"/apiToken\")\n    @Operation(summary \u003d \"获取API Token（纯接口版本）\", description \u003d \"用于第三方系统纯后端API调用，根据平台密钥生成一次性临时Token\")\n    public Result\u003cModuleEmbedAuthResp\u003e getApiToken(\n            @RequestParam(\"secureKey\") @Parameter(description \u003d \"平台密钥（完整格式：tk-xxx）\", required \u003d true, in \u003d ParameterIn.QUERY) String secureKey,\n            HttpServletRequest request) {\n\n        log.info(\"获取API Token（纯接口版本）, secureKey: {}\", secureKey);\n\n        // 如果传入的secureKey不包含tk-前缀，自动添加（兼容旧接口）\n        String fullSecureKey \u003d secureKey.startsWith(Cns.API_TOKEN_PREFIX_V2) ? secureKey : Cns.API_TOKEN_PREFIX_V2 + secureKey;\n        \n        // 调用服务层生成Token（支持缓存机制）\n        ModuleEmbedAuthResp resp \u003d moduleEmbedAuthService.getEmbedToken(fullSecureKey, request);\n        String userCode \u003d StpUtil.getLoginIdAsString();\n        \n        // 生成一个临时token（一次性使用）\n        String tempToken \u003d IdUtil.fastSimpleUUID();\n        \n        // 将临时token和userCode的映射存储到Redis，有效期与tokenExpireSeconds保持一致\n        Integer expireSeconds \u003d resp.getTokenExpireSeconds() !\u003d null ? resp.getTokenExpireSeconds() : 7200;\n        String redisKey \u003d \"embed:api_token:\" + tempToken;\n        RedisUtil.setString(redisKey, userCode, expireSeconds);\n        \n        log.info(\"生成临时API Token成功, tempToken: {}, userCode: {}, expireSeconds: {}秒\", tempToken, userCode, expireSeconds);\n\n        // 返回临时token\n        ModuleEmbedAuthResp result \u003d new ModuleEmbedAuthResp();\n        result.setToken(tempToken);\n        result.setTokenExpireSeconds(expireSeconds);\n        \n        return Result.success(result);\n    }\n\n    /**\n     * 登录接口，登录成功返回accessToken\n     *\n     * @param loginUserReq 请求参数\n     * @return accessToken\n     */\n    @PostMapping(\"/login\")\n    @Operation(summary \u003d \"登录接口\")\n    @SysLog(value \u003d \"用户登录\", module \u003d SystemModule.LOGIN)\n    public Result\u003cLoginResp\u003e login(@Valid @RequestBody LoginUserReq loginUserReq) {\n        // 校验license，登录的时候校验\n        LicenseBootstrap.checkLicense();\n        LoginResp loginResult \u003d new LoginResp();\n        // 校验验证码\n        String cacheCode \u003d RedisUtil.getString(Cns.getCacheKeyImgCode(loginUserReq.getVerifyCodeToken()));\n        try {\n            Assert.isTrue(StringUtils.isNotEmpty(cacheCode), () -\u003e new BizException(ErrorCodeEnum.VERIFY_CODE_ERROR));\n            Assert.isTrue(cacheCode.equalsIgnoreCase(loginUserReq.getVerifyCode()), () -\u003e new BizException(ErrorCodeEnum.VERIFY_CODE_ERROR));\n        } finally {\n            // 验证码只能使用一次\n            RedisUtil.del(Cns.getCacheKeyImgCode(loginUserReq.getVerifyCodeToken()));\n        }\n        LoginDecrypt decrypt \u003d new LoginDecrypt(secureConfig, loginUserReq.getUsername(), loginUserReq.getPwd());\n        // 鉴权\n        String accessToken \u003d userAuthService.auth(decrypt.decryptUser(), decrypt.decryptPwd(), loginUserReq.getSysType());\n        loginResult.setXzAccessToken(accessToken);\n        return Result.success(loginResult);\n    }\n    /**\n     * 登录接口，登录成功返回accessToken（该接口去掉了验证码，单独给测试团队做自动化接口登录使用，不在程序界面功能中使用）\n     * @param loginUserReq 请求对象参数\n     * @return accessToken\n     */\n    @Operation(summary \u003d \"登录接口-非验证码\", description \u003d \"登录接口，登录成功返回accessToken（该接口去掉了验证码，单独给测试团队做自动化接口登录使用，不在程序界面功能中使用）\")\n    @PostMapping(\"/loginAuto\")\n    public Result\u003cLoginResp\u003e loginAuto(@Valid @RequestBody LoginUserAutoReq loginUserReq) {\n        LoginResp loginResult \u003d new LoginResp();\n        // 鉴权\n        LoginDecrypt decrypt \u003d new LoginDecrypt(secureConfig, loginUserReq.getUsername(), loginUserReq.getPwd());\n        String accessToken \u003d userAuthService.auth(decrypt.decryptUser(), decrypt.decryptPwd(), loginUserReq.getSysType());\n        loginResult.setXzAccessToken(accessToken);\n        return Result.success(loginResult);\n    }\n\n    /**\n     * H5端登录接口，登录成功返回accessToken\n     * @param loginH5UserReq 请求参数\n     * @return accessToken\n     */\n    @PostMapping(\"/h5Login\")\n    @Operation(summary \u003d \"H5端登录接口\")\n    @SysLog(value \u003d \"H5端登录接口\", module \u003d SystemModule.LOGIN)\n    public Result\u003cLoginH5Resp\u003e h5Login(@Valid @RequestBody LoginH5UserReq loginH5UserReq) throws ApiException {\n        log.info(\"H5端账号密码登录接口,api:{}\", \"/kb/auth/h5Login\");\n        return userAuthService.h5Login(loginH5UserReq);\n    }\n\n    /**\n     * 重定向 SSO 登录的 URL\n     * @param response\n     * @throws IOException\n     */\n    @GetMapping(\"/userLogin\")\n    @Operation(summary \u003d \"SSO登录跳转\")\n    public void ssoLoginRedirection(HttpServletResponse response) throws IOException {\n        try {\n            String loginUrl \u003d userAuthService.buildLoginUrl();\n            log.info(\"SSO登录跳转,loginUrl:{}\", loginUrl);\n            if (ObjectUtil.isNotEmpty(loginUrl)) {\n                // 重定向到三方鉴权URL\n                response.sendRedirect(loginUrl);\n            } else {\n                // URL无效，发送 400 错误响应\n                response.sendError(HttpServletResponse.SC_BAD_REQUEST, \"无效的登录 URL\");\n            }\n        } catch (IOException e) {\n            log.error(\"SSO登录重定向跳转异常\", e);\n            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, \"重定向到登录页面时发生错误\");\n        }\n    }\n\n    /**\n     * 处理SSO回调请求\n     * @param code 一次性鉴权码\n     * @param state 自定义加密查询参数\n     * @param session\n     * @param response\n     * @return\n     * @throws IOException\n     */\n    @GetMapping(\"/callback\")\n    @Operation(summary \u003d \"用户登录回调接口\")\n    public Result\u003cLoginKbResp\u003e callback(@RequestParam(\"code\") String code,\n            @RequestParam(value \u003d \"state\", required \u003d false) String state, HttpSession session, HttpServletResponse response) throws IOException {\n        Result\u003cLoginKbResp\u003e loginKbRespResult \u003d null;\n        try {\n            // 调用服务层处理回调请求\n            loginKbRespResult \u003d userAuthService.handleSSOCallback(code, state, session, response);\n        } catch (Exception e) {\n            log.error(\"处理回调请求时出错\", e);\n            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, \"处理回调请求时出错\");\n        }\n        return loginKbRespResult;\n    }\n\n\n    /**\n     * 用户登出接口\n     * @return 退出成功\n     */\n    @Operation(summary \u003d \"用户登出接口\")\n    @PostMapping(\"/logout\")\n    @SaCheckLogin\n    public Result\u003cString\u003e logout(HttpServletResponse response) {\n        // 获取当前token\n        String currentToken \u003d StpUtil.getTokenValue();\n        \n        // 删除Redis中的token缓存（embed:token:*格式的key）\n        // 由于不知道具体的secureKey，需要通过token查找并删除对应的缓存\n        String userCode \u003d StpUtil.getLoginIdAsString();\n        if (StringUtils.isNotEmpty(currentToken) \u0026\u0026 StringUtils.isNotEmpty(userCode)) {\n            // 尝试删除可能存在的embed token缓存\n            // 格式：embed:token:{secureKey}:{userCode}\n            String pattern \u003d \"embed:token:*:\" + userCode;\n            Collection\u003cString\u003e keys \u003d RedisUtil.keys(pattern);\n            if (keys !\u003d null \u0026\u0026 !keys.isEmpty()) {\n                RedisUtil.del(keys.toArray(new String[0]));\n                log.info(\"已删除用户 {} 的embed token缓存，共 {} 个key\", userCode, keys.size());\n            }\n        }\n        \n        // 执行Sa-Token登出\n        StpUtil.logout();\n        \n        // 手动清除Cookie（删除通过/token接口设置的cookie）\n        JakartaServletUtil.addCookie(response, saTokenConfig.getTokenName(), null, 0);\n        log.info(\"已清除Cookie: {}\", saTokenConfig.getTokenName());\n        \n        log.info(\"用户登出成功，已清除token、redis缓存和cookie\");\n        ",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 330
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/store/service/impl/AppInfoServiceImpl.java",
      "timestamp": 1761236768723,
      "startOffset": 2613,
      "endOffset": 6357,
      "codeContent": "infra.common.extra.log.LogContext;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.kb.admin.model.dto.DepartmentUserOrgPermissions;\nimport com.torchv.kb.admin.service.KbDepartmentUserService;\nimport com.torchv.kb.common.constant.PlatFormTypes;\nimport com.torchv.kb.space.service.KnowledgeEmbeddingChangeService;\nimport com.torchv.repository.application.entity.AppInfoPermission;\nimport com.torchv.repository.application.mapper.AppInfoPermissionMapper;\nimport com.torchv.repository.chat.entity.SaasKnowledgeContainer;\nimport com.torchv.repository.kb.department.entity.KbDepartment;\nimport com.torchv.repository.kb.department.entity.KbDepartmentUser;\nimport com.torchv.repository.kb.department.mapper.KbDepartmentMapper;\nimport com.torchv.repository.kb.department.mapper.KbDepartmentUserMapper;\nimport com.torchv.repository.store.entity.AppInfo;\nimport com.torchv.repository.store.entity.AppPrompt;\nimport com.torchv.repository.store.entity.AppSettings;\nimport com.torchv.repository.store.entity.AppTheme;\nimport com.torchv.repository.store.mapper.AppInfoMapper;\nimport com.torchv.repository.store.mapper.AppPromptMapper;\nimport com.torchv.repository.store.mapper.AppSettingsMapper;\nimport com.torchv.repository.store.mapper.AppThemeMapper;\nimport com.torchv.infra.web.spring.properties.ChatBotConfig;\nimport com.torchv.infra.web.i18n.I18nMessage;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.redisson.api.RLock;\nimport org.redisson.api.RedissonClient;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.time.LocalDateTime;\nimport java.util.*;\nimport java.util.concurrent.TimeUnit;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\nimport static com.torchv.kb.common.constant.KbAppStatusTypes.*;\n\n/**\n * 应用信息模块-业务Service实现\n * @since torchv_server v0.1-beta.1.6\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/03/19 15:05\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class AppInfoServiceImpl extends ServiceImpl\u003cAppInfoMapper, AppInfo\u003e implements AppInfoService {\n    \n    final AppInfoMapper appInfoMapper;\n    final AppContainerService appContainerService;\n    final I18nMessage i18nMessage;\n    final RedissonClient redissonClient;\n    final AppPromptService appPromptService;\n    final AppInfoPermissionMapper appInfoPermissionMapper;\n    final AppSettingsService appSettingsService;\n    final AppThemeService appThemeService;\n    final KnowledgeContainerService knowledgeContainerService;\n    final ChatBotConfig chatBotConfig;\n    final AppTagService appTagService;\n    final AppDestroyService appDestroyService;\n    final KbDepartmentUserMapper kbDepartmentUserMapper;\n    final KbDepartmentUserService kbDepartmentUserService;\n    final KbDepartmentMapper kbDepartmentMapper;\n    final AppPromptMapper appPromptMapper;\n    final AppSettingsMapper appSettingsMapper;\n    final AppThemeMapper appThemeMapper;\n    final UserService userService;\n    final KnowledgeEmbeddingChangeService knowledgeEmbeddingChangeService;\n\n\n    @Override\n    public Result\u003cString\u003e publishApp(String appid,String status) {\n        //String[] split \u003d appid.split(\",\");\n        //QueryWrapper\u003cAppInfo\u003e queryWrapper \u003d new QueryWrapper\u003cAppInfo\u003e().in(\"appid\", split);\n        LambdaQueryWrapper\u003cAppInfo\u003e lambdaQueryWrapper \u003d  Wrappers.lambdaQuery(AppInfo.class).in(AppInfo::getAppid, StrUtil.split(appid,StrUtil.COMMA));\n        AppInfo appInfo \u003d new AppInfo();\n        appInfo.setStatus(status);\n        int update \u003d baseMapper.update(appInfo, lambdaQ",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 82
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/store/service/impl/AppSettingsServiceImpl.java",
      "timestamp": 1761236768740,
      "startOffset": 1604,
      "endOffset": 14737,
      "codeContent": "infra.rag.constant.Prompts;\nimport com.torchv.repository.chat.entity.SaasPromptTemplate;\nimport com.torchv.repository.chat.mapper.SaasPromptTemplateMapper;\nimport com.torchv.repository.store.entity.AppPrompt;\nimport com.torchv.repository.store.entity.AppSettings;\nimport com.torchv.repository.store.mapper.AppSettingsMapper;\nimport com.torchv.infra.web.i18n.I18nMessage;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport cn.hutool.core.lang.Assert;\n\nimport com.baomidou.mybatisplus.core.toolkit.Wrappers;\n\nimport org.redisson.api.RLock;\nimport org.redisson.api.RedissonClient;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.stereotype.Service;\nimport com.torchv.application.store.service.AppSettingsService;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.math.BigDecimal;\nimport java.time.LocalDateTime;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\nimport java.util.function.Function;\n\n/**\n * 应用配置模块-业务Service实现\n * @since torchv_server v0.1-beta.1.6\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/03/20 10:10\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class AppSettingsServiceImpl implements AppSettingsService {\n    \n    final AppSettingsMapper appSettingsMapper;\n    final RedissonClient redissonClient;\n    final StringRedisTemplate stringRedisTemplate;\n    final I18nMessage i18nMessage;\n    final ModelProviderService modelProviderService;\n    final ChatPromptService chatPromptService;\n    final AppPromptService appPromptService;\n    final SaasPromptTemplateMapper saasPromptTemplateMapper;\n    \n    @Override\n    public void addDefaultSettings(String appid, String tenantId, AppTypes appTypes) {\n        AppSettings appSettings \u003d new AppSettings();\n        appSettings.setCreateTime(LocalDateTime.now());\n        appSettings.setModifierTime(LocalDateTime.now());\n        appSettings.setAppid(appid);\n        appSettings.setTenantId(tenantId);\n        PromptConfigReq configReq \u003d PromptConfigReq.DEFAULT;\n        appSettings.setQms(BigDecimal.valueOf(configReq.getQms()));\n        // 这里选择一个有效的模型\n        appSettings.setModelName(modelProviderService.availableModel(tenantId));\n        appSettings.setAutoReply(configReq.isRagNoContextFinallyAnswer() ? ToggleStatusEnum.YES.getCode() : ToggleStatusEnum.NO.getCode());\n        appSettings.setChatType(configReq.getChatType());\n        appSettings.setLlmDispatcherName(configReq.getLlmDispatcherName());\n        appSettings.setRagAlpha(BigDecimal.valueOf(configReq.getRagAlpha()));\n        appSettings.setRagNoContextFinallyAnswerText(configReq.getRagNoContextFinallyAnswerText());\n        appSettings.setReviseMinScore(BigDecimal.valueOf(configReq.getReviseMinScore()));\n        appSettings.setRms(BigDecimal.valueOf(configReq.getRms()));\n        appSettings.setTemperature(configReq.getTemperature());\n        appSettings.setTopP(configReq.getTopP());\n        // 轻量级Agent应用，无需检索知识库\n        if (appTypes \u003d\u003d AppTypes.LITE_AGENT) {\n            // 不开启知识库搜索\n            appSettings.setSearchKnowledge(ToggleStatusEnum.NO.getCode());\n            // 考虑到是LiteAgent应用类型，有些值需要设置屏蔽知识库检索\n            // 直接开启大模型回复\n            appSettings.setAutoReply(ToggleStatusEnum.YES.getCode());\n        } else {\n            appSettings.setSearchKnowledge(ToggleStatusEnum.YES.getCode());\n        }\n//        appSettings.setPrompt(Prompts.getPrompt(appTypes).getPrompt());\n        //新增默认要读取全局配置\n        PromptInfoResp promptInfoResp \u003d chatPromptService.queryPrompt(tenantId);\n        if (promptInfoResp !\u003d null \u0026\u0026 StrUtil.isNotBlank(promptInfoResp.getPrompt())) {\n            appSettings.setPrompt(promptInfoResp.getPrompt());\n        }else {\n            // 默认的Prompts配置\n            appSettings.setPrompt(Prompts.getPrompt(appTypes).getPrompt());\n        }\n        appSettingsMapper.insert(appSettings);\n    }\n    \n    /**\n     * 更新应用配置记录\n     * @param appSettingsUpdateReq 更新应用配置条件Vo\n     * @return 是否更新成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e update(AppSettingsUpdateReq appSettingsUpdateReq) {\n        log.info(\"根据主键id修改应用配置数据,Vo:{}\", appSettingsUpdateReq.toString());\n        String tenantId \u003d UserContextHolder.getTenantId();\n        LambdaQueryWrapper\u003cAppSettings\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(AppSettings.class).eq(AppSettings::getTenantId, tenantId).eq(AppSettings::getAppid, appSettingsUpdateReq.getAppid());\n        String redisKey \u003d Cns.LOCK_APP_THEME_KEY + tenantId + \":\" + appSettingsUpdateReq.getAppid();\n        RLock rLock \u003d redissonClient.getLock(redisKey);\n        try {\n            if (rLock.tryLock(10L, 10L, TimeUnit.SECONDS)) {\n                AppSettings dbAppSettings \u003d appSettingsMapper.selectOne(lambdaQueryWrapper, false);\n                AppSettings appSettings \u003d new AppSettings();\n                BeanUtils.copyProperties(appSettingsUpdateReq, appSettings);\n                BeanUtils.copyProperties(appSettingsUpdateReq.getConfig(), appSettings);\n                // 将config对象序列化为JSON字符串存储到config字段中\n                appSettings.setConfig(GsonUtils.GSON.toJson(appSettingsUpdateReq.getConfig()));\n                appSettings.setQms(BigDecimal.valueOf(appSettingsUpdateReq.getConfig().getQms()));\n                appSettings.setRms(BigDecimal.valueOf(appSettingsUpdateReq.getConfig().getRms()));\n                appSettings.setRagAlpha(BigDecimal.valueOf(appSettingsUpdateReq.getConfig().getRagAlpha()));\n                appSettings.setReviseMinScore(BigDecimal.valueOf(appSettingsUpdateReq.getConfig().getReviseMinScore()));\n                if (appSettingsUpdateReq.getConfig().isRagNoContextFinallyAnswer()) {\n                    appSettings.setAutoReply(ToggleStatusEnum.YES.getCode());\n                } else {\n                    appSettings.setAutoReply(ToggleStatusEnum.NO.getCode());\n                }\n                // 类型\n                appSettings.setModifierTime(LocalDateTime.now());\n                // 是否开启rag搜索\n                if (appSettingsUpdateReq.isRagSearch()) {\n                    appSettings.setSearchKnowledge(ToggleStatusEnum.YES.getCode());\n                } else {\n                    appSettings.setSearchKnowledge(ToggleStatusEnum.NO.getCode());\n                }\n                int ret;\n                if (dbAppSettings \u003d\u003d null) {\n                    ret \u003d appSettingsMapper.insert(appSettings);\n                } else {\n                    ret \u003d appSettingsMapper.update(appSettings, lambdaQueryWrapper);\n                }\n                // 配置发生变更，删除缓存，避免查询时获取到老数据\n                String cacheKey \u003d CacheCns.APP_CHAT_CONFIG_KEY + tenantId + \":\" + appSettingsUpdateReq.getAppid();\n                stringRedisTemplate.delete(cacheKey);\n                return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.insert.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.insert.fail\"));\n            }\n        } catch (InterruptedException e) {\n            log.error(\"获取锁异常\", e);\n        } finally {\n            if (rLock !\u003d null \u0026\u0026 rLock.isLocked()) {\n                rLock.unlock();\n            }\n        }\n        return Result.error(i18nMessage.resolveMessage(\"system.common.insert.fail\"));\n    }\n    \n    /**\n     * 根据id查询应用配置详情\n     * @param id 应用配置主键id\n     * @return 应用配置详情\n     */\n    @Override\n    public Result\u003cAppSettingsResp\u003e queryById(Integer id) {\n        log.info(\"根据主键id查询应用配置详情,Id:{}\", id);\n        AppSettings appSettings \u003d appSettingsMapper.selectById(id);\n        Assert.notNull(appSettings, \"请求数据非法\");\n        AppSettingsResp appSettingsResp \u003d new AppSettingsResp();\n        BeanUtils.copyProperties(appSettings, appSettingsResp);\n        return Result.data(appSettingsResp);\n    }\n    \n    @Override\n    public Result\u003cAppSettingsResp\u003e queryByAppId(String appId) {\n        log.info(\"根据appid查询应用配置详情,appId:{}\", appId);\n        String tenantId \u003d UserContextHolder.getTenantId();\n        LambdaQueryWrapper\u003cAppSettings\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(AppSettings.class).eq(AppSettings::getTenantId, tenantId).eq(AppSettings::getAppid, appId);\n        AppSettings appSettings \u003d appSettingsMapper.selectOne(lambdaQueryWrapper, false);\n        AppSettingsResp appSettingsResp \u003d new AppSettingsResp();\n        if (appSettings !\u003d null) {\n            appSettingsResp.applySettings(appSettings, modelProviderService.availableModel());\n        } else {\n            appSettingsResp.applyConfig(PromptConfigReq.DEFAULT, modelProviderService.availableModel());\n            // 设置prompt\n            appSettingsResp.setPrompt(Prompts.CHAT.getPrompt());\n            appSettingsResp.setAppid(appId);\n        }\n        return Result.data(appSettingsResp);\n    }\n    \n    @Override\n    public PromptInfoResp queryInfoByAppId(String appid, String tenantId, AppTypes appTypes) {\n        log.info(\"根据appid查询配置信息,appid:{},tenantId:{},appType:{}\", appid, tenantId,appTypes);\n        String redisKey \u003d CacheCns.APP_CHAT_CONFIG_KEY + tenantId + \":\" + appid;\n        String value \u003d stringRedisTemplate.opsForValue().get(redisKey);\n        if (StrUtil.isNotBlank(value)) {\n            log.info(\"从缓存中获取配置信息,redisKey:{},value:{}\", redisKey,value);\n            return GsonUtils.fromJson(value, PromptInfoResp.class).get();\n        } else {\n            LambdaQueryWrapper\u003cAppSettings\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(AppSettings.class).eq(AppSettings::getTenantId, tenantId).eq(AppSettings::getAppid, appid);\n            AppSettings appSettings \u003d appSettingsMapper.selectOne(lambdaQueryWrapper, false);\n            PromptInfoResp promptInfoResp \u003d new PromptInfoResp();\n            PromptConfigReq configReq \u003d new PromptConfigReq();\n            if (appSettings !\u003d null) {\n                // 配置信息赋值\n                BeanUtils.copyProperties(appSettings, configReq);\n                // 不同类型，单独set，避免copy方法失效\n                configReq.setQms(appSettings.getQms().floatValue());\n                configReq.setRms(appSettings.getRms().floatValue());\n                configReq.setRagAlpha(appSettings.getRagAlpha().floatValue());\n                configReq.setReviseMinScore(appSettings.getReviseMinScore().floatValue());\n                if (appSettings.getAutoReply() \u003d\u003d ToggleStatusEnum.YES.getCode()) {\n                    configReq.setRagNoContextFinallyAnswer(true);\n                } else {\n                    configReq.setRagNoContextFinallyAnswer(false);\n                }\n                promptInfoResp.setConfigReq(configReq);\n                promptInfoResp.setPrompt(appSettings.getPrompt());\n            } else {\n                promptInfoResp.setConfigReq(PromptConfigReq.DEFAULT);\n                promptInfoResp.setPrompt(Prompts.getPrompt(appTypes).getPrompt());\n            }\n            stringRedisTemplate.opsForValue().set(redisKey, GsonUtils.GSON.toJson(promptInfoResp), 1, TimeUnit.DAYS);\n            return promptInfoResp;\n        }\n    }\n    \n    /**\n     * 根据id查询应用配置实体详情\n     * @param id 主键id\n     * @return 应用配置的Optional\n     */\n    @Override\n    public Optional\u003cAppSettings\u003e queryInfoById(Integer id) {\n        log.info(\"根据请求id查询应用配置实体详情,id:{}\", id);\n        AppSettings appSettings \u003d appSettingsMapper.selectById(id);\n        if (appSettings !\u003d null) {\n            return Optional.of(appSettings);\n        }\n        return Optional.empty();\n    }\n    \n    @Override\n    public Optional\u003cAppSettings\u003e queryByAppId(String appId, String tenantId) {\n        LambdaQueryWrapper\u003cAppSettings\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(AppSettings.class).eq(AppSettings::getTenantId, tenantId).eq(AppSettings::getAppid, appId);\n        AppSettings appSettings \u003d appSettingsMapper.selectOne(lambdaQueryWrapper, false);\n        return Optional.ofNullable(appSettings);\n    }\n\n    @Override\n    public AppSettingsResp querySettingsByAppId(String appId,String tenantId, AppTypes appTypes) {\n        AppSettingsResp appSettingsResp \u003d new AppSettingsResp();\n        // 设置type\n        appSettingsResp.setCategory(appTypes.name());\n        Optional\u003cAppSettings\u003e appSettingsOptional \u003d this.queryByAppId(appId, tenantId);\n        if (appSettingsOptional.isPresent()) {\n            AppSettings appSettings \u003d appSettingsOptional.get();\n            // 判断配置信息JSON是否采用默认全局配置\n            if (StrUtil.isBlank(appSettings.getConfig()) || PromptConfigReq.DEFAULT.equals(appSettings.getConfig())) {\n                // 使用全局模板配置\n                LambdaQueryWrapper\u003cSaasPromptTemplate\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasPromptTemplate.class)\n                        .eq(SaasPromptTemplate::getTenantId, tenantId);\n                // 目前我看代码没做这个逻辑\n//                        .eq(SaasPromptTemplate::getUseFlag, 1);\n                SaasPromptTemplate saasPromptTemplate \u003d saasPromptTemplateMapper.selectOne(lambdaQueryWrapper, false);\n                if (saasPromptTemplate !\u003d null \u0026\u0026 StrUtil.isNotBlank(saasPromptTemplate.getConfig())) {\n                    // 将全局模板的config赋值给appSettings，然后再apply\n                    appSettings.setConfig(saasPromptTemplate.getConfig());\n                }\n            }",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 262
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/store/service/impl/ChannelLarkChatServiceImpl.java",
      "timestamp": 1761236768761,
      "startOffset": 974,
      "endOffset": 6904,
      "codeContent": "knowledge.model.response.chat.ChatIntegration;\nimport com.torchv.application.openapi.domain.completion.ChatChannelCallbackCompletion;\nimport com.torchv.application.store.domain.builder.AppChatContextBuilder;\nimport com.torchv.application.store.domain.completion.AppChatDebugCompletion;\nimport com.torchv.application.store.model.dto.AppLarkConfig;\nimport com.torchv.application.store.service.ChannelLarkChatService;\nimport com.torchv.application.store.service.ChannelLarkService;\nimport com.torchv.common.constant.Platforms;\nimport com.torchv.common.constant.llm.AgentIntegrations;\nimport com.torchv.common.extra.filter.ThreadLocalHolder;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.common.utils.GsonUtils;\nimport com.torchv.pipeline.channel.lark.dto.LarkEventMessageDTO;\nimport com.torchv.pipeline.channel.lark.parser.ChatMessageParser;\nimport com.torchv.pipeline.channel.lark.message.MarkdownBodyApply;\nimport com.torchv.infra.rag.agent.BotAgent;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.llm.model.completions.BotCompletionResponse;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.stereotype.Service;\n\nimport java.util.List;\nimport java.util.Optional;\n\n/**\n * \u003ca href\u003d\"https://open.feishu.cn/document/server-docs/im-v1/message-content-description/create_json#7111df05\"\u003e...\u003c/a\u003e\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/10/9 20:43\n * @since torchv_server v1.8.5\n */\n@AllArgsConstructor\n@Service\n@Slf4j\npublic class ChannelLarkChatServiceImpl implements ChannelLarkChatService {\n    \n    final BotAgent botAgent;\n    final ChannelLarkService channelLarkService;\n    final AppChatContextBuilder appChatContextBuilder;\n    \n    @Override\n    public void chat(LarkEventMessageDTO messageDTO) {\n        Optional\u003cAppLarkConfig\u003e configOptional \u003d channelLarkService.getByCode(messageDTO.getLarkId());\n        if (configOptional.isEmpty()) {\n            log.error(\"飞书应用配置不存在,appid:{}\", messageDTO.getLarkId());\n            return;\n        }\n        AppLarkConfig config \u003d configOptional.get();\n\n        // 构建用户信息\n        SysUserInfo sysUserInfo \u003d new SysUserInfo();\n        sysUserInfo.setCode(messageDTO.getUserId());\n        sysUserInfo.setTenantId(messageDTO.getTenantId());\n        // 复制给LocalContext上下文,在UserContextHolder中使用\n        ThreadLocalHolder.setUser(sysUserInfo);\n        // 构建问答信息\n        AppChatDebugCompletion appChatDebugCompletion\u003dnew AppChatDebugCompletion();\n        appChatDebugCompletion.setAppid(config.getAppid());\n        appChatDebugCompletion.setQuestion(messageDTO.getQuestion());\n        appChatDebugCompletion.setConversationId(messageDTO.getChatId());\n        appChatDebugCompletion.setPlatforms(Platforms.LARK);\n        appChatDebugCompletion.setStream(false);\n        // integrations\n        appChatDebugCompletion.setIntegrations(List.of(ChatIntegration.from(AgentIntegrations.INNER_INTENT),ChatIntegration.from(AgentIntegrations.INNER_SUBQUERY)));\n        ChainContext chainContext \u003d appChatContextBuilder.build(appChatDebugCompletion);\n        BotCompletionResponse botCompletionResponse \u003d botAgent.startSync(chainContext);\n        String answer \u003d botCompletionResponse.firstMessage();\n        Client client \u003d Client.newBuilder(config.getLarkId(), config.getSecret()).build();\n        try {\n            // 构建一个Markdown的回复格式\n            String markdown \u003d new MarkdownBodyApply().apply(answer);\n            if (StrUtil.equalsIgnoreCase(messageDTO.getChatType(), \"p2p\")) {\n                // 发送请求\n                CreateMessageResp resp \u003d client.im().message().create(CreateMessageReq.newBuilder()\n                        .receiveIdType(CreateMessageReceiveIdTypeEnum.OPEN_ID)\n                        .createMessageReqBody(CreateMessageReqBody.newBuilder()\n                                .msgType(\"post\")\n                                .receiveId(messageDTO.getUserId())\n                                .content(markdown)\n                                .uuid(IdUtil.fastSimpleUUID())\n                                .build())\n                        .build());\n                // 业务数据处理\n                log.info(Jsons.DEFAULT.toJson(resp.getData()));\n            } else if (StrUtil.equalsIgnoreCase(messageDTO.getChatType(), \"group\")) {\n                ReplyMessageResp resp \u003d client.im().message().reply(ReplyMessageReq.newBuilder().messageId(messageDTO.getMessageId()).replyMessageReqBody(\n                        ReplyMessageReqBody.newBuilder().msgType(\"post\").uuid(IdUtil.fastSimpleUUID())\n                                .content(markdown).build())\n                        .build());\n                log.info(Jsons.DEFAULT.toJson(resp.getData()));\n            }\n        } catch (Throwable e) {\n            log.error(e.getMessage(), e);\n        }\n    }\n    \n    @Override\n    public String chat(P2MessageReceiveV1 event, AppLarkConfig appLarkConfig) {\n        // 构建用户信息\n        SysUserInfo sysUserInfo \u003d new SysUserInfo();\n        sysUserInfo.setCode(event.getEvent().getSender().getSenderId().getOpenId());\n        sysUserInfo.setTenantId(appLarkConfig.getTenantId());\n        // 复制给LocalContext上下文,在UserContextHolder中使用\n        ThreadLocalHolder.setUser(sysUserInfo);\n        // 构建问答信息\n        AppChatDebugCompletion appChatDebugCompletion\u003dnew AppChatDebugCompletion();\n        appChatDebugCompletion.setAppid(appLarkConfig.getAppid());\n        appChatDebugCompletion.setQuestion(new ChatMessageParser().apply(event));\n        appChatDebugCompletion.setConversationId(event.getEvent().getMessage().getChatId());\n        appChatDebugCompletion.setPlatforms(Platforms.LARK);\n        // integrations\n        appChatDebugCompletion.setIntegrations(List.of(ChatIntegration.from(AgentIntegrations.INNER_INTENT),ChatIntegration.from(AgentIntegrations.INNER_SUBQUERY)));\n        ChainContext chainContext \u003d appChatContextBuilder.build(appChatDebugCompletion",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 113
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/store/service/impl/ChannelQyWechatChatServiceImpl.java",
      "timestamp": 1761236768763,
      "startOffset": 793,
      "endOffset": 4342,
      "codeContent": "knowledge.model.response.chat.ChatIntegration;\nimport com.torchv.application.store.domain.builder.AppChatContextBuilder;\nimport com.torchv.application.store.domain.completion.AppChatDebugCompletion;\nimport com.torchv.application.store.model.dto.AppQyWechatConfig;\nimport com.torchv.application.store.service.ChannelQyWechatChatService;\nimport com.torchv.application.store.service.ChannelQyWechatMessageService;\nimport com.torchv.application.store.service.ChannelQyWechatService;\nimport com.torchv.common.constant.Platforms;\nimport com.torchv.common.constant.llm.AgentIntegrations;\nimport com.torchv.common.extra.filter.ThreadLocalHolder;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.infra.rag.agent.BotAgent;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.llm.model.completions.BotCompletionResponse;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport me.chanjar.weixin.common.error.WxErrorException;\nimport me.chanjar.weixin.cp.api.WxCpMessageService;\nimport me.chanjar.weixin.cp.api.WxCpService;\nimport me.chanjar.weixin.cp.api.impl.WxCpMessageServiceImpl;\nimport me.chanjar.weixin.cp.bean.message.*;\nimport org.springframework.stereotype.Service;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\n\n/**\n * 实现微信的对话功能\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/9/20 18:03\n * @since torchv_server v1.8.3\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class ChannelQyWechatChatServiceImpl implements ChannelQyWechatChatService {\n    \n    final ChannelQyWechatService channelQyWechatService;\n    final BotAgent botAgent;\n    final ChannelQyWechatMessageService channelQyWechatMessageService;\n    final AppChatContextBuilder appChatContextBuilder;\n    \n    @Override\n    public WxCpXmlOutMessage chat(WxCpXmlMessage wxCpXmlMessage, Map\u003cString, Object\u003e map, WxCpService wxCpService) {\n        log.info(\"企业微信回调Chat事件\");\n        String agentId \u003d wxCpXmlMessage.getAgentId();\n        // conversationId使用fromUserName\n        String conversationId \u003d wxCpXmlMessage.getFromUserName();\n        String question \u003d wxCpXmlMessage.getContent();\n        if (StrUtil.isBlank(conversationId) || StrUtil.isBlank(question)) {\n            log.info(\"conversationId或者question为空\");\n            return null;\n        }\n        Optional\u003cAppQyWechatConfig\u003e wechatConfigOptional \u003d channelQyWechatService.getByCode(agentId);\n        if (wechatConfigOptional.isEmpty()) {\n            return null;\n        }\n        AppQyWechatConfig wechatConfig \u003d wechatConfigOptional.get();\n\n        // 构建用户信息\n        SysUserInfo sysUserInfo \u003d new SysUserInfo();\n        sysUserInfo.setCode(wxCpXmlMessage.getFromUserName());\n        sysUserInfo.setTenantId(wechatConfig.getTenantId());\n        // 复制给LocalContext上下文,在UserContextHolder中使用\n        ThreadLocalHolder.setUser(sysUserInfo);\n        // 构建问答信息\n        AppChatDebugCompletion appChatDebugCompletion\u003dnew AppChatDebugCompletion();\n        appChatDebugCompletion.setAppid(wechatConfig.getAppid());\n        appChatDebugCompletion.setQuestion(question);\n        appChatDebugCompletion.setConversationId(conversationId);\n        appChatDebugCompletion.setPlatforms(Platforms.QY_WECHAT);\n        appChatDebugCompletion.setStream(false);\n        // integrations\n        appChatDebugCompletion.setIntegrations(List.of(ChatIntegration.from(AgentIntegrations.INNER_INTENT),ChatIntegration.from(AgentIntegrations.INNER_SUBQUERY)));\n        ChainContext chainContext \u003d appChatContextBuilder.build(appChatDebugC",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 76
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/store/service/impl/ChannelQyWechatMessageServiceImpl.java",
      "timestamp": 1761236768765,
      "startOffset": 1014,
      "endOffset": 1223,
      "codeContent": "infra.common.utils.MarkdownUtils;\nimport com.torchv.repository.chat.entity.SaasConversationInfo;\nimport com.torchv.infra.web.spring.properties.ChatBotConfig;\nimport com.torchv.unstructured.utils.CharacterUtils",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 4
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/kb/page/service/KbPageEventService.java",
      "timestamp": 1761236768776,
      "startOffset": 957,
      "endOffset": 2159,
      "codeContent": "dto.PageEventNameInfo;\nimport com.torchv.kb.page.model.event.KbPageEventMessage;\nimport com.torchv.kb.page.model.request.*;\nimport com.torchv.kb.page.model.response.KbPageFollowResp;\nimport com.torchv.kb.page.model.response.SpaceFollowInfoResp;\nimport com.torchv.repository.kb.page.dto.PageEventUserInfo;\nimport com.torchv.repository.kb.page.entity.KbPageEvent;\n\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * 页面事件模块-业务Service\n * @since torchv_server kb-v0.0.1\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/10/30 20:30\n */\npublic interface KbPageEventService extends IService\u003cKbPageEvent\u003e {\n\n    /**\n     * 关注/编辑/评论用户列表\n     * @param pageCode 页面编码\n     * @return 关注用户列表\n     */\n    Pagination\u003cPageEventUserInfo\u003e eventUserList(String eventType, String pageCode, Integer pageNo, Integer pageSize);\n\n    /**\n     * 浏览知识页面\n     * @param traceReq 浏览知识页面条件Vo\n     * @return 是否浏览成功\n     */\n    Result\u003cString\u003e trace(PageTraceReq traceReq);\n    \n    /**\n     * 浏览事件列表\n     * @param pageNo 页码\n     * @param pageSize 页码大小\n     * @return 浏览事件列表\n     */\n    Pagination\u003cPageEventNameInfo\u003e userEvent(Integer pageNo, Integer pageSize, List\u003cString\u003e eventTypes,Integer creator);",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 40
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/kb/space/service/SaasKnowledgeContainerPermissionService.java",
      "timestamp": 1761236768779,
      "startOffset": 1655,
      "endOffset": 2431,
      "codeContent": "    /**\n     * 获取数据ID列表\n     * @param stringStringMap 知识库容器ID-权限编码Map\n     * @param sysUserInfo 用户信息\n     * @return 数据ID列表\n     */\n    List\u003cString\u003e getDataIds(Map\u003cString,String\u003e stringStringMap, SysUserInfo sysUserInfo,List\u003cString\u003e permissionCodes);\n\n\n    Map\u003cString,String\u003e getHighestPermissions(List\u003cString\u003e getContainerId,SysUserInfo sysUserInfo);\n    /**\n     * 获取最高权限\n     * @param getContainerId 知识库容器ID\n     * @param sysUserInfo 用户信息\n     * @return 最高权限\n     */\n    String getHighestPermission(String getContainerId,SysUserInfo sysUserInfo);\n    /**\n     * 获取最高权限\n     * @param permissionList 权限列表\n     * @param sysUserInfo 用户信息\n     * @return 最高权限\n     */\n    String getHighestPermission(List\u003cSaasKnowledgeContainerPermission\u003e permissionList,SysUserInfo sysUserInfo);\n",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 25
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/openapi/domain/channel/impl/DingTalkCallbackServiceImpl.java",
      "timestamp": 1761236768781,
      "startOffset": 976,
      "endOffset": 6546,
      "codeContent": "knowledge.model.response.chat.ChatIntegration;\nimport com.torchv.application.openapi.domain.channel.DingTalkCallbackService;\nimport com.torchv.application.openapi.model.req.channel.DingTalkCallbackReq;\nimport com.torchv.application.store.domain.builder.AppChatContextBuilder;\nimport com.torchv.application.store.domain.completion.AppChatDebugCompletion;\nimport com.torchv.application.store.service.ChannelDingTalkService;\nimport com.torchv.common.constant.Platforms;\nimport com.torchv.common.constant.llm.AgentIntegrations;\nimport com.torchv.common.extra.filter.ThreadLocalHolder;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.pipeline.channel.DingTalkClient;\nimport com.torchv.infra.rag.agent.BotAgent;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.llm.model.completions.BotCompletionResponse;\nimport com.torchv.repository.store.entity.AppChannelDingtalk;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.stereotype.Service;\n\nimport java.util.List;\nimport java.util.Optional;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/9/3 16:50\n * @since torchv_server v1.7.11\n */\n@AllArgsConstructor\n@Service\n@Slf4j\npublic class DingTalkCallbackServiceImpl implements DingTalkCallbackService {\n    \n    final ChannelDingTalkService channelDingTalkService;\n    final BotAgent botAgent;\n    final DingTalkClient dingTalkClient;\n    final AppChatContextBuilder appChatContextBuilder;\n\n\n    @Override\n    public String chat(DingTalkCallbackReq callbackReq) {\n        String robotCode \u003d callbackReq.getRobotCode();\n        log.info(\"钉钉回调Chat事件,robotCode:{}\", robotCode);\n        Optional\u003cAppChannelDingtalk\u003e dingtalk \u003d channelDingTalkService.getByCode(robotCode);\n        if (dingtalk.isEmpty()) {\n            log.info(\"code:{} 配置不存在，\", robotCode);\n            return \"failed\";\n        }\n        log.info(\"code:{} 配置存在，\", robotCode);\n        // 获取得到当前钉钉的配置信息，appid、secret\n        AppChannelDingtalk dingtalkConfig \u003d dingtalk.get();\n        String conversationId \u003d callbackReq.getConversationId();\n        String question \u003d callbackReq.chatContent();\n        if (StrUtil.isBlank(conversationId) || StrUtil.isBlank(question)) {\n            log.info(\"conversationId或者question为空\");\n            return \"failed\";\n        }\n        log.info(\"conversationId:{},question:{}\", conversationId, question);\n\n        // 构建用户信息\n        SysUserInfo sysUserInfo \u003d new SysUserInfo();\n        sysUserInfo.setCode(callbackReq.getChatbotUserId());\n        sysUserInfo.setTenantId(dingtalkConfig.getTenantId());\n        // 复制给LocalContext上下文,在UserContextHolder中使用\n        ThreadLocalHolder.setUser(sysUserInfo);\n        // 构建问答信息\n        AppChatDebugCompletion appChatDebugCompletion\u003dnew AppChatDebugCompletion();\n        appChatDebugCompletion.setAppid(dingtalkConfig.getAppid());\n        appChatDebugCompletion.setQuestion(question);\n        appChatDebugCompletion.setConversationId(conversationId);\n        appChatDebugCompletion.setPlatforms(Platforms.DING_TALK);\n        appChatDebugCompletion.setStream(false);\n        // integrations\n        appChatDebugCompletion.setIntegrations(List.of(ChatIntegration.from(AgentIntegrations.INNER_INTENT),ChatIntegration.from(AgentIntegrations.INNER_SUBQUERY)));\n        ChainContext chainContext \u003d appChatContextBuilder.build(appChatDebugCompletion);;\n        // 构建大模型的对话信息\n        BotCompletionResponse botCompletionResponse \u003d botAgent.startSync(chainContext);\n        String answer \u003d botCompletionResponse.firstMessage();\n        // 发送钉钉请求\n        JSONObject msgParam \u003d new JSONObject();\n        msgParam.put(\"text\", \"\u003e @\" + callbackReq.getSenderNick() + \" \" + question + \"\\n\\n\" + answer);\n        msgParam.put(\"title\", \"回复@\" + callbackReq.getSenderNick());\n        String marked \u003d msgParam.toJSONString();\n        dingTalkClient.initClient(robotCode, dingtalkConfig.getClientId(), dingtalkConfig.getClientSecret());\n        // 发送消息\n        dingTalkClient.simpleMarked(marked, robotCode, conversationId);\n        return \"SUCCESS\";\n    }\n\n    @Override\n    public OapiChatSendRequest.Markdown markdownStream(ChatbotMessage message, String tenantId, String appid) {\n        MessageContent messageContent\u003dmessage.getText();\n        // 构建用户信息\n        SysUserInfo sysUserInfo \u003d new SysUserInfo();\n        sysUserInfo.setCode(message.getSenderId());\n        sysUserInfo.setTenantId(tenantId);\n        // 复制给LocalContext上下文,在UserContextHolder中使用\n        ThreadLocalHolder.setUser(sysUserInfo);\n        // 构建问答信息\n        AppChatDebugCompletion appChatDebugCompletion\u003dnew AppChatDebugCompletion();\n        appChatDebugCompletion.setAppid(appid);\n        appChatDebugCompletion.setQuestion(messageContent.getContent());\n        appChatDebugCompletion.setConversationId(message.getConversationId());\n        appChatDebugCompletion.setPlatforms(Platforms.DING_TALK);\n        // integrations\n        appChatDebugCompletion.setIntegrations(List.of(ChatIntegration.from(AgentIntegrations.INNER_INTENT),ChatIntegration.from(AgentIntegrations.INNER_SUBQUERY)));\n        appChatDebugCompletion.setStream(false);\n        ChainContext chainContext \u003d appChatContextBuilder.build(appChatDebugCompletion);;\n        //ChainContext chainContext \u003d channelCallBackChatContextBuilder.build(channelCallbackCompletion);\n        BotCompletionResponse botCompletionResponse \u003d botAgent.startSync(chainContext);\n        String answer \u003d botCompletionResponse.firstMessage();\n        OapiChatSendRequest.Markdown markdown\u003dnew OapiChatSendRequest.Markdown();",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 111
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/uploader/impl/PPTUploader.java",
      "timestamp": 1761236768791,
      "startOffset": 962,
      "endOffset": 6178,
      "codeContent": "unstructured.oss.UnstructuredOSSClient;\nimport com.torchv.unstructured.pojo.DataSetChunkResponse;\nimport com.torchv.unstructured.ppt.PPTConvertOSSMarkdown;\nimport com.torchv.unstructured.ppt.PPTPreviewTextExtract;\nimport com.torchv.unstructured.ppt.PPTXConvertOSSMarkdown;\nimport com.torchv.unstructured.ppt.PPTXPreviewTextExtract;\nimport com.torchv.application.knowledge.domain.uploader.pojo.DataSetUploadContext;\nimport com.torchv.application.knowledge.domain.uploader.pojo.DataSetUploadResponse;\nimport com.torchv.infra.embedding.constant.DocConvertFormats;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.poi.poifs.filesystem.FileMagic;\nimport org.springframework.stereotype.Component;\n\nimport java.io.File;\nimport java.nio.charset.StandardCharsets;\nimport java.util.ArrayList;\nimport java.util.List;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/4/16 17:30\n * @since torchv_server v1.7.1\n */\n@Component\n@Slf4j\n@AllArgsConstructor\npublic class PPTUploader extends AbstractDataSetUploader {\n    \n    final MaterialService materialService;\n    final UnstructuredOSSClient unstructuredOSSClient;\n    \n    @Override\n    public DataSetUploadResponse upload(DataSetUploadContext uploadContext) {\n        log.info(\"开始处理PPT文件上传，文件名：{}\", uploadContext.getMultipartFile().getOriginalFilename());\n        DataSetUploadResponse response \u003d null;\n        FileMagic fm \u003d getFileMagic(uploadContext);\n        String docx_format \u003d \"pptx\";\n        switch (fm) {\n            case OLE2 -\u003e {\n                // ppt格式\n                response \u003d this.getPPT(uploadContext, DocConvertFormats.PPT);\n                response.setEleSuffix(DocConvertFormats.PPT.getSource());\n            }\n            case OOXML -\u003e {\n                // .pptx\n                response \u003d this.getPPT(uploadContext, DocConvertFormats.PPTX);\n                response.setEleSuffix(docx_format);\n            }\n            default -\u003e {\n                // 根据后缀名直接预览处理\n                String extName \u003d FileUtil.extName(uploadContext.getMultipartFile().getOriginalFilename());\n                if (StrUtil.equalsIgnoreCase(DocConvertFormats.PPT.getSource(), extName)) {\n                    response \u003d this.getPPT(uploadContext, DocConvertFormats.PPT);\n                    response.setEleSuffix(DocConvertFormats.PPT.getSource());\n                } else if (StrUtil.equalsIgnoreCase(docx_format, extName)) {\n                    uploadContext.processFileName(docx_format);\n                    response \u003d this.getPPT(uploadContext, DocConvertFormats.PPTX);\n                    response.setEleSuffix(docx_format);\n                }\n            }\n        }\n        return response;\n    }\n    \n    /**\n     * 处理PPT文件\n     * @param uploadContext 上传上下文\n     * @return DataSetUploadResponse\n     */\n    private DataSetUploadResponse getPPT(DataSetUploadContext uploadContext, DocConvertFormats formats) {\n        DataSetUploadResponse response \u003d this.initResponse(uploadContext.getMultipartFile());\n        // 使用真实的doc格式\n        response.setCategory(uploadContext.getCategory());\n        File tmpFile \u003d null;\n        try {\n            tmpFile \u003d FileUtil.createTempFile(\"\", \".\" + formats.getSource(), true);\n            FileUtil.writeFromStream(uploadContext.getMultipartFile().getInputStream(), tmpFile);\n            List\u003cDataSetChunkResponse\u003e chunksList \u003d new ArrayList\u003c\u003e();\n            if (formats \u003d\u003d DocConvertFormats.PPT) {\n                chunksList \u003d new PPTPreviewTextExtract(tmpFile).get();\n            } else if (formats \u003d\u003d DocConvertFormats.PPTX) {\n                chunksList \u003d new PPTXPreviewTextExtract(tmpFile).get();\n            }\n            response.setChunks(chunksList);\n            response.setPageCount(chunksList.size());\n            // 初始化chunks\n            MaterialInfoResp materialInfoResp \u003d materialService.save(tmpFile, response.getEleMd5(), uploadContext.getTenantId());\n            response.setEleUrl(materialInfoResp.getFileUrl());\n            response.setStatus(true);\n        } catch (Exception e) {\n            log.error(e.getMessage(), e);\n        } finally {\n            FileUtil.del(tmpFile);\n        }\n        return response;\n    }\n\n\n    @Override\n    public DataSetUploadResponse parse(DataSetUploadContext uploadContext) {\n        DataSetUploadResponse response \u003d this.initResponse(uploadContext.getMultipartFile());\n        File tmpFile \u003d null;\n        File docMdFile \u003d null;\n        DocConvertFormats formats \u003d DocConvertFormats.bySource(FileUtil.extName(uploadContext.getFileName()));\n        try {\n            tmpFile \u003d FileUtil.createTempFile(\"\", \".\" + FileUtil.extName(uploadContext.getFileName()), true);\n            FileUtil.writeFromStream(uploadContext.getMultipartFile().getInputStream(), tmpFile);\n            if (formats \u003d\u003d DocConvertFormats.PPT) {\n                // docMdFile \u003d new PPTConvertMarkdown().apply(tmpFile);\n                docMdFile \u003d new PPTConvertOSSMarkdown(unstructuredOSSClient, uploadContext.getTenantId()).apply(tmpFile);\n            } else if (formats \u003d\u003d DocConvertFormats.PPTX) {\n                // docMdFile \u003d new PPTXConvertMarkdown().apply(tmpFile);\n                docMdFile \u003d new PPTXConvertOSSMarkdown(unstructuredOSSClient",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 114
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/store/web/AppInfoController.java",
      "timestamp": 1761236768849,
      "startOffset": 1837,
      "endOffset": 12425,
      "codeContent": "infra.license.LicenseBootstrap;\nimport com.torchv.kb.space.service.KnowledgeEmbeddingChangeService;\nimport com.torchv.repository.store.entity.AppInfo;\nimport com.torchv.infra.common.extra.log.LogContext;\nimport com.torchv.infra.common.extra.log.annotation.SysLog;\nimport jakarta.servlet.http.HttpServletResponse;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\n\nimport cn.hutool.core.lang.Assert;\nimport org.springframework.web.bind.annotation.*;\n\nimport io.swagger.v3.oas.annotations.Operation;\nimport io.swagger.v3.oas.annotations.Parameter;\nimport io.swagger.v3.oas.annotations.Parameters;\nimport io.swagger.v3.oas.annotations.enums.ParameterIn;\nimport io.swagger.v3.oas.annotations.tags.Tag;\n\nimport com.torchv.application.store.service.AppInfoService;\nimport jakarta.validation.Valid;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.*;\n\n/**\n * 应用信息-接口API\n * @since torchv_server v0.1-beta.1.6\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/03/19 15:05\n */\n@Slf4j\n@AllArgsConstructor\n@Tag(name \u003d \"应用信息\")\n@RestController\n@RequestMapping(\"/store/api/saas/app\")\n@SaCheckPermission(value \u003d {\"RES_APP\", \"RES_STORE_APP\", \"RES_STORE_APP_DETAIL\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_ADMIN\", \"SYS_ROLE_CLI_ADMIN\"})\npublic class AppInfoController {\n    \n    final AppInfoService appInfoService;\n    final KnowledgeContainerService knowledgeContainerService;\n    final AppChatService appChatService;\n    final OpenAPIService openAPIService;\n    final TempFilesService tempFilesService;\n    final KnowledgeEmbeddingChangeService knowledgeEmbeddingChangeService;\n\n\n    @Operation(summary \u003d \"检查知识库容器ID是否存在embedding模型一致\")\n    @PostMapping(\"/checkContainerId\")\n    public Result\u003cBoolean\u003e checkContainerId(@Valid @RequestBody AppKnowledgeContainerEmbedValidReq embedValidReq){\n        log.info(\"检查知识库容器ID是否存在embedding模型一致,api:{}\", \"/store/api/saas/app/checkContainerId\");\n        knowledgeEmbeddingChangeService.checkKnowledgeConsistency(embedValidReq.getContainerId());\n        return Result.data(Boolean.TRUE);\n    }\n    \n    @Operation(summary \u003d \"应用配置\")\n    @PostMapping(\"/applySettings\")\n    public Result\u003cString\u003e applySettings(@Valid @RequestBody AppChatDebugCompletion debugReq) {\n        log.info(\"应用配置,api:{}\", \"/store/api/saas/app/applySettings\");\n        return appInfoService.applySettings(debugReq);\n    }\n    \n    @Operation(summary \u003d \"问答调试\")\n    @PostMapping(\"/chat\")\n    public Object chat(@Valid @RequestBody AppChatDebugCompletion debugReq, HttpServletResponse response) {\n        // 3. 组装请求参数并设置响应ContentType\n        log.info(\"问答调试,API:{}，JSON:{}\", \"/store/api/saas/app/chat\", GsonUtils.toJSONString(debugReq));\n        openAPIService.contentType(true, response);\n        return appChatService.chat(debugReq, response);\n    }\n    \n    \n    @Operation(summary \u003d \"文件上传-对话(临时)\")\n    @PostMapping(\"/upload\")\n    public Result\u003cMap\u003cString, String\u003e\u003e upload(@RequestParam(\"file\") MultipartFile[] multipartFiles) {\n        log.info(\"文件上传-对话,api:{}\", \"/kb/chat/upload\");\n        long size \u003d 0;\n        for (MultipartFile multipartFile : multipartFiles) {\n            size +\u003d multipartFile.getSize();\n        }\n        if (size \u003e 500 * 1024 * 1024) {\n            return Result.error(\"文件总大小不能超过500MB\");\n        }\n        List\u003cMultipartFile\u003e list \u003d Arrays.stream(multipartFiles).toList();\n        return tempFilesService.upload(list);\n    }\n    \n    \n    /**\n     * 分页查询应用信息\n     * @param appInfoQueryReq 查询条件vo\n     * @param pageNo 当前页码\n     * @param pageSize 页码大小\n     * @return 分页列表\n     */\n    @Operation(summary \u003d \"分页查询应用信息\")\n    @Parameters({\n            @Parameter(name \u003d \"pageNo\", description \u003d \"当前页码,默认1\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"1\"),\n            @Parameter(name \u003d \"pageSize\", description \u003d \"页码大小,默认10\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"10\")\n    })\n    @GetMapping(\"/list\")\n    public Pagination\u003cAppInfoResp\u003e list(AppInfoQueryReq appInfoQueryReq,\n                                        @RequestParam(value \u003d \"pageNo\", defaultValue \u003d \"1\") Integer pageNo,\n                                        @RequestParam(value \u003d \"pageSize\", defaultValue \u003d \"10\") Integer pageSize) {\n        log.info(\"分页查询应用信息,API:{},page:{},size:{}\", \"/store/api/saas/app/list\", pageNo, pageSize);\n        log.info(\"查询条件Vo:{}\", appInfoQueryReq.toString());\n        return appInfoService.listV2(appInfoQueryReq, pageNo, pageSize);\n    }\n    /**\n     * 新增应用信息\n     * @param appInfoAddReq 新增vo\n     * @return 新增是否成功\n     */\n    @Operation(summary \u003d \"新增应用信息\")\n    @SysLog(module \u003d SystemModule.PLATFORM_APP, value \u003d \"新增应用，名称:#{ #name }\")\n    @PostMapping(\"/add\")\n    public Result\u003cString\u003e add(@Valid @RequestBody AppInfoAddReq appInfoAddReq) {\n        log.info(\"新增应用信息,API:{}\", \"/store/api/saas/app/add\");\n        log.info(\"新增应用信息模块Vo:{}\", appInfoAddReq.toString());\n        LogContext.putVariable(\"name\", appInfoAddReq.getName());\n        // 校验license，登录的时候校验\n        LicenseBootstrap.checkLicense();\n        return appInfoService.add(appInfoAddReq);\n    }\n\n    /**\n     * 从应用市场添加到我的应用\n     * @return 配置信息\n     */\n    @Operation(summary \u003d \"从模板市场添加到我的应用（6.19版本）\")\n    @GetMapping(\"/storeToMyApp\")\n    public Result templateToApp(@RequestParam(value \u003d \"appid\") String appid) {\n        log.info(\"从应用市场添加到我的应用,API:{}\", \"/kb/app/storeToMyApp\");\n        return appInfoService.storeToMyApp(appid);\n    }\n\n\n    /**\n     * 刷新应用的AccessToken\n     * @param keyBindReq 参数\n     * @return 是否绑定成功\n     */\n    @Operation(summary \u003d \"刷新应用的AccessToken\")\n    @SysLog(module \u003d SystemModule.PLATFORM_APP, value \u003d \"刷新应用的AccessToken，名称:#{ #name } \")\n    @PostMapping(\"/refreshToken\")\n    public Result\u003cString\u003e refreshToken(@Valid @RequestBody AppInfoRefreshTokenReq keyBindReq) {\n        log.info(\"刷新应用的AccessToken,API:{}\", \"/store/api/saas/app/refreshToken\");\n        return appInfoService.refreshToken(keyBindReq);\n    }\n    \n    /**\n     * 绑定知识库\n     * @param keyBindReq 参数\n     * @return 是否绑定成功\n     */\n    @Operation(summary \u003d \"知识库绑定+基础内容更新\")\n    @SysLog(module \u003d SystemModule.PLATFORM_APP, value \u003d \"更新应用信息，名称:#{ #name } ,知识库绑定数量 : #{ #size }\")\n    @PostMapping(\"/bindUpdate\")\n    public Result\u003cString\u003e bindUpdate(@Valid @RequestBody AppInfoBindUpdateReq keyBindReq) {\n        log.info(\"绑定知识库+基础内容更新,API:{}\", \"/store/api/saas/app/bindUpdate\");\n        return appInfoService.bindUpdate(keyBindReq);\n    }\n    /**\n     * 绑定知识库\n     * @param keyBindReq 参数\n     * @return 是否绑定成功\n     */\n    @Operation(summary \u003d \"绑定知识库\")\n    @SysLog(module \u003d SystemModule.PLATFORM_APP, value \u003d \"绑定应用的知识库，名称:#{ #name } ,数量 : #{ #size }\")\n    @PostMapping(\"/bind\")\n    public Result\u003cString\u003e bind(@Valid @RequestBody AppInfoBindReq keyBindReq) {\n        log.info(\"绑定知识库,API:{}\", \"/store/api/saas/app/bind\");\n        return appInfoService.bind(keyBindReq);\n    }\n    \n    /**\n     * 更新应用信息\n     * @param appInfoUpdateReq 更新vo\n     * @return 更新是否成功\n     */\n    @Operation(summary \u003d \"修改应用信息\")\n    @PutMapping(\"/update\")\n    @SysLog(module \u003d SystemModule.PLATFORM_APP, value \u003d \"编辑应用，名称:#{ #name }\")\n    public Result\u003cString\u003e update(@Valid @RequestBody AppInfoUpdateReq appInfoUpdateReq) {\n        log.info(\"修改应用信息,API:{}\", \"/store/api/saas/app/update\");\n        log.info(\"修改Vo:{}\", appInfoUpdateReq.toString());\n        LogContext.putVariable(\"name\", appInfoUpdateReq.getName());\n        return appInfoService.update(appInfoUpdateReq);\n    }\n    \n    /**\n     * 根据id查询应用信息详情\n     * @param id 主键id\n     * @return 应用信息详情\n     */\n    @Operation(summary \u003d \"根据主键id查询应用信息详情\")\n    @Parameter(name \u003d \"id\", description \u003d \"主键id\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/queryById\")\n    public Result\u003cAppInfoResp\u003e queryById(@RequestParam(value \u003d \"id\") Integer id) {\n        log.info(\"根据主键id查询应用信息详情,API:{},主键id:{}\", \"/store/api/saas/app/queryById\", id);\n        return appInfoService.queryById(id);\n    }\n    \n    /**\n     * 根据id查询应用信息详情\n     * @param appId 应用id\n     * @return 应用信息详情\n     */\n    @Operation(summary \u003d \"根据应用appId查询应用信息详情\")\n    @Parameter(name \u003d \"appId\", description \u003d \"应用id\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/queryByAppId\")\n    public Result\u003cAppInfoResp\u003e queryByAppId(@RequestParam(value \u003d \"appid\") String appId) {\n        log.info(\"根据主键appId查询应用信息详情,API:{},主键id:{}\", \"/store/api/saas/app/queryByAppId\", appId);\n        return appInfoService.queryByAppId(appId);\n    }\n    /**\n     * 删除应用信息\n     * @param id 主键id\n     * @return 删除是否成功\n     */\n    @Operation(summary \u003d \"删除应用信息\")\n    @Parameter(name \u003d \"id\", description \u003d \"主键id\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @SysLog(module \u003d SystemModule.PLATFORM_APP, value \u003d \"删除应用,名称\\\"#{ #name }\\\"\")\n    @DeleteMapping(\"/delete\")\n    public Result\u003cString\u003e delete(@RequestParam(value \u003d \"id\") Integer id) {\n        log.info(\"删除应用信息,API:{},ID:{}\", \"/store/api/saas/app/delete\", id);\n        Assert.notNull(id, \"app.add.null.id\");\n        return appInfoService.delete(id);\n    }\n    \n    /**\n     * 根据条件查询所有知识库容器\n     * @param knowledgeContainerQueryReq 查询条件vo\n     * @return 所有知识库容器\n     */\n    @Operation(summary \u003d \"根据条件查询所有知识库容器\")\n    @GetMapping(\"/listContainers\")\n    public Result\u003cList\u003cKnowledgeContainerResp\u003e\u003e listAll(KnowledgeContainerQueryReq knowledgeContainerQueryReq) {\n        log.info(\"根据条件查询所有知识库容器,API:{}\", \"/store/api/saas/app/listContainers\");\n        log.info(\"查询条件Vo-:{}\", knowledgeContainerQueryReq.toString());\n        Pagination\u003cKnowledgeContainerResp\u003e pagination \u003d knowledgeContainerService.list(knowledgeContainerQueryReq, 1, 1000);\n        if (pagination !\u003d null) {\n            return Result.data(pagination.getData());\n        }\n        return Result.data(new ArrayList\u003c\u003e());\n    }\n    \n    /**\n     * 查询key密钥已经绑定的知识库列表Id集合\n     * @param appid 应用id\n     * @return 知识库列表Id集合\n     */\n    @Operation(summary \u003d \"查询应用已经绑定的知识库列表Id集合\")\n    @Parameter(name \u003d \"appid\", description \u003d \"应用id\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/listBindContainers\")\n    public Result\u003cList\u003cAppContainerResp\u003e\u003e listContainers(@RequestParam(value \u003d \"appid\") String appid) {\n        log.info(\"查询key密钥绑定的知识库列表Id集合,API:{},appid:{}\", \"/store/api/saas/app/listContainers\", appid);\n        Optional\u003cAppInfo\u003e appInfoOptional \u003d appInfoService.queryInfoByAppId(appid);\n        if (appInfoOptional.isEmpty()) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        return Result.success(appInfoService.listContainersByName(appInfoOptional.get().getId()));\n    }\n\n    /**\n     * 发布或下架应用\n     */\n    @Operation(summary \u003d \"发布或下架应用\")\n    @PostMapping(\"/publishApp\")\n    public Result\u003cString",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 269
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/store/model/dto/AppSettingsResp.java",
      "timestamp": 1761236768865,
      "startOffset": 1000,
      "endOffset": 13955,
      "codeContent": "infra.rag.constant.AgentPromptSteps;\nimport com.torchv.repository.store.entity.AppPrompt;\nimport com.torchv.repository.store.entity.AppSettings;\nimport io.swagger.v3.oas.annotations.media.Schema;\n\nimport lombok.Data;\nimport lombok.ToString;\nimport org.springframework.beans.BeanUtils;\n\n/**\n * 应用高级配置信息表\n * @since torchv_server v0.1-beta.1.6\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/03/20 10:10\n */\n@Data\n@ToString\npublic class AppSettingsResp {\n    \n    /**\n     * 主键id，自增长列\n     */\n    @Schema(description \u003d \"主键id，自增长列\")\n    private Integer id;\n    /**\n     * 创建人\n     */\n    @Schema(description \u003d \"创建人\")\n    private String creator;\n    /**\n     * 创建时间\n     */\n    @Schema(description \u003d \"创建时间\")\n    private LocalDateTime createTime;\n    /**\n     * 修改人\n     */\n    @Schema(description \u003d \"修改人\")\n    private String modifier;\n    /**\n     * 修改时间\n     */\n    @Schema(description \u003d \"修改时间\")\n    private LocalDateTime modifierTime;\n    /**\n     * 排序\n     */\n    @Schema(description \u003d \"排序\")\n    private Integer sort;\n    /**\n     * 租户id\n     */\n    @Schema(description \u003d \"租户id\")\n    private String tenantId;\n    /**\n     * 应用app ID\n     */\n    @Schema(description \u003d \"应用app ID\")\n    private String appid;\n    \n    @Schema(description \u003d \"应用分类\")\n    private String category;\n    /**\n     * 应用的prompt信息\n     */\n    @Schema(description \u003d \"应用的prompt信息\")\n    private String prompt;\n\n    @Schema(description \u003d \"系统级的prompt信息\")\n    private String systemPrompt;\n\n    @Schema(description \u003d \"用户级的prompt信息\")\n    private String rewritePrompt;\n\n    @Schema(description \u003d \"子查询prompt信息\")\n    private String subQueryPrompt;\n    /**\n     * 大模型调度策略,RANDOM-随机，HASH-哈希模式，CUSTOM-客户指定\n     */\n    @Schema(description \u003d \"大模型调度策略,RANDOM-随机，HASH-哈希模式，CUSTOM-客户指定\")\n    private String llmDispatcherName;\n    /**\n     * 大模型编码\n     */\n    @Schema(description \u003d \"大模型编码\")\n    private String modelName;\n    /**\n     * 查询QA问答知识库最小的阈值范围，取值在[0,1]之间，分值越高，则和QA问答对的问题越相关，分值越低，则和QA问答对的问题越不相关。\n     */\n    @Schema(description \u003d \"查询QA问答知识库最小的阈值范围，取值在[0,1]之间，分值越高，则和QA问答对的问题越相关，分值越低，则和QA问答对的问题越不相关。\")\n    private float qms;\n    /**\n     * 表示RAG检索文档的boost参数权重alpha值，通常情况下，`alpha` 的取值在 0 和 1 之间，`alpha` 越大，表示越倾向于使用向量搜索，`alpha` 越小，表示越倾向于使用文本搜索(BM25)。\n     */\n    @Schema(description \u003d \"表示RAG检索文档的boost参数权重alpha值，通常情况下，`alpha` 的取值在 0 和 1 之间，`alpha` 越大，表示越倾向于使用向量搜索，`alpha` 越小，表示越倾向于使用文本搜索(BM25)。\")\n    private float ragAlpha;\n    /**\n     * RAG检索文档最小的阈值范围，取值在[0,1]之间，分值越高，则和RAG检索文档的问题越相关，分值越低，则和RAG检索文档的问题越不相关。(最小值为0.5)\n     */\n    @Schema(description \u003d \"RAG检索文档最小的阈值范围，取值在[0,1]之间，分值越高，则和RAG检索文档的问题越相关，分值越低，则和RAG检索文档的问题越不相关。(最小值为0.5)\")\n    private float rms;\n    /**\n     * 基于多轮对话纠正的score分值阈值，取值在[0,1]之间，控制在多轮对话的过程中，防止LLM纠正错误\n     */\n    @Schema(description \u003d \"基于多轮对话纠正的score分值阈值，取值在[0,1]之间，控制在多轮对话的过程中，防止LLM纠正错误\")\n    private float reviseMinScore;\n    /**\n     * 对话模式，single-单轮对话，multiple-多轮对话\n     */\n    @Schema(description \u003d \"对话模式，single-单轮对话，multiple-多轮对话\")\n    private Integer chatType;\n    /**\n     * 是否开启大模型自动回复，0-否，1-是\n     */\n    @Schema(description \u003d \"是否开启大模型自动回复，0-否，1-是\")\n    private Integer autoReply;\n    /**\n     * 在通过rms控制了rag检索的上下文档context后，如果没有检索到，是否需要大模型进行兜底回答\n     * true-需要，将用户的原句发送给LLM大模型进行回答\n     * false-不需要，直接响应：您的问题暂时没有答案\n     */\n    @Schema(description \u003d \"在通过rms控制了rag检索的上下文档context后，如果没有检索到，是否需要大模型进行兜底回答，true/false\")\n    private boolean ragNoContextFinallyAnswer \u003d false;\n    /**\n     * 当机器人认为掌握的知识不足以回答用户的提问时，会将该内容作为答案回复给用户\n     */\n    @Schema(description \u003d \"当机器人认为掌握的知识不足以回答用户的提问时，会将该内容作为答案回复给用户\")\n    private String ragNoContextFinallyAnswerText;\n    /**\n     * 较高的值会使机器人的回答更具有创造性、多样性，而较低的值则会使回答更加确定和不那么出人意料\n     */\n    @Schema(description \u003d \"较高的值会使机器人的回答更具有创造性、多样性，而较低的值则会使回答更加确定和不那么出人意料\")\n    private Integer temperature;\n    /**\n     * 控制模型返回结果的真实性。如果你需要准确和事实的答案，就把参数值调低。如果你想要更多样化的答案，就把参数值调高一些\n     */\n    @Schema(description \u003d \"控制模型返回结果的真实性。如果你需要准确和事实的答案，就把参数值调低。如果你想要更多样化的答案，就把参数值调高一些\")\n    private Integer topP;\n    /**\n     * 其它配置信息JSON\n     */\n    @Schema(description \u003d \"其它配置信息JSON\")\n    private String config;\n    \n    @Schema(description \u003d \"contextWindow,最终送给大模型的上下文数量,范围[1,10]之间\")\n    private int contextWindow \u003d 5;\n    \n    @Schema(description \u003d \"多轮对话轮次,范围[1,10]之间\")\n    private int roundSessionCount \u003d 5;\n    \n    /**\n     * RAG检索返回的Top K数量\n     */\n    @Schema(description \u003d \"RAG检索返回的Top K数量，默认为10\")\n    private Integer topK \u003d 10;\n    \n    /**\n     * 是否使用RRF（Reciprocal Rank Fusion）融合算法\n     */\n    @Schema(description \u003d \"是否使用RRF（Reciprocal Rank Fusion）融合算法，默认为false\")\n    private Boolean rrf \u003d false;\n    \n    /**\n     * 是否使用Reranker重排序\n     */\n    @Schema(description \u003d \"是否使用Reranker重排序，默认为false\")\n    private Boolean useReranker \u003d false;\n    \n    /**\n     * Reranker模型名称\n     */\n    @Schema(description \u003d \"Reranker模型名称，当useReranker为true时生效\")\n    private String rankerModelName \u003d \"\";\n    \n    /**\n     * 相邻页数，用于检索相邻文档片段\n     */\n    @Schema(description \u003d \"相邻页数，用于检索相邻文档片段，默认为0\")\n    private Integer nearPageNumber \u003d 0;\n\n\n    /**\n     * 配置参数\n     * @since v1.4.5\n     */\n    public PromptConfigReq configReq(){\n        PromptConfigReq configReq \u003d new PromptConfigReq();\n        BeanUtils.copyProperties(this,configReq);\n        configReq.setRrf(true);\n        configReq.setUseReranker(true);\n        configReq.setModelName(this.modelName);\n        configReq.setLlmDispatcherName(this.llmDispatcherName);\n        configReq.setTemperature(this.temperature);\n        configReq.setTopP(this.topP);\n        configReq.setTopK(this.topK);\n        return configReq;\n    }\n    \n    public void applyConfig(PromptConfigReq configReq, String modelName) {\n        BeanUtils.copyProperties(configReq, this);\n        if (PromptConfigReq.DEFAULT.isRagNoContextFinallyAnswer()) {\n            this.setAutoReply(ToggleStatusEnum.YES.getCode());\n        } else {\n            this.setAutoReply(ToggleStatusEnum.NO.getCode());\n        }\n        // 不同类型，单独set，避免copy方法失效\n        this.setQms(configReq.getQms());\n        this.setRms(configReq.getRms());\n        this.setRagAlpha(configReq.getRagAlpha());\n        this.setReviseMinScore(configReq.getReviseMinScore());\n        if (StrUtil.isNotBlank(configReq.getModelName())) {\n            this.setModelName(configReq.getModelName());\n        } else {\n            this.setModelName(modelName);\n        }\n        \n        // 从PromptConfigReq中设置新增字段（BeanUtils.copyProperties应该已经复制了，这里为了确保）\n        if (configReq.getTopK() !\u003d null) {\n            this.setTopK(configReq.getTopK());\n        }\n        if (configReq.getRrf() !\u003d null) {\n            this.setRrf(configReq.getRrf());\n        }\n        if (configReq.getUseReranker() !\u003d null) {\n            this.setUseReranker(configReq.getUseReranker());\n        }\n        if (StrUtil.isNotBlank(configReq.getRankerModelName())) {\n            this.setRankerModelName(configReq.getRankerModelName());\n        }\n        if (configReq.getNearPageNumber() !\u003d null) {\n            this.setNearPageNumber(configReq.getNearPageNumber());\n        }\n    }\n    \n    public void applySettings(AppSettings settings, String modelName) {\n        BeanUtils.copyProperties(settings, this);\n        if (NumberUtil.equals(settings.getAutoReply().intValue(), ToggleStatusEnum.YES.getCode())) {\n            this.setRagNoContextFinallyAnswer(true);\n        } else {\n            this.setRagNoContextFinallyAnswer(false);\n        }\n        // 不同类型，单独set，避免copy方法失效\n        this.setQms(settings.getQms().floatValue());\n        this.setRms(settings.getRms().floatValue());\n        this.setRagAlpha(settings.getRagAlpha().floatValue());\n        this.setReviseMinScore(settings.getReviseMinScore().floatValue());\n        if (StrUtil.isNotBlank(settings.getModelName())) {\n            this.setModelName(settings.getModelName());\n        } else {\n            this.setModelName(modelName);\n        }\n        \n        // 从config JSON字段中解析额外的配置信息\n        if (StrUtil.isNotBlank(settings.getConfig())) {\n            try {\n                com.google.gson.JsonObject configJson \u003d com.google.gson.JsonParser.parseString(settings.getConfig()).getAsJsonObject();\n                \n                // 解析llmDispatcherName\n                if (configJson.has(\"llmDispatcherName\") \u0026\u0026 !configJson.get(\"llmDispatcherName\").isJsonNull()) {\n                    this.setLlmDispatcherName(configJson.get(\"llmDispatcherName\").getAsString());\n                }\n                \n                // 解析modelName\n                if (configJson.has(\"modelName\") \u0026\u0026 !configJson.get(\"modelName\").isJsonNull()) {\n                    this.setModelName(configJson.get(\"modelName\").getAsString());\n                }\n                \n                // 解析chatType\n                if (configJson.has(\"chatType\") \u0026\u0026 !configJson.get(\"chatType\").isJsonNull()) {\n                    this.setChatType(configJson.get(\"chatType\").getAsInt());\n                }\n                \n                // 解析qms\n                if (configJson.has(\"qms\") \u0026\u0026 !configJson.get(\"qms\").isJsonNull()) {\n                    this.setQms((float)configJson.get(\"qms\").getAsDouble());\n                }\n                \n                // 解析ragAlpha (也可能叫queryAlpha)\n                if (configJson.has(\"ragAlpha\") \u0026\u0026 !configJson.get(\"ragAlpha\").isJsonNull()) {\n                    this.setRagAlpha((float)configJson.get(\"ragAlpha\").getAsDouble());\n                } else if (configJson.has(\"queryAlpha\") \u0026\u0026 !configJson.get(\"queryAlpha\").isJsonNull()) {\n                    this.setRagAlpha((float)configJson.get(\"queryAlpha\").getAsDouble());\n                }\n                \n                // 解析rms\n                if (configJson.has(\"rms\") \u0026\u0026 !configJson.get(\"rms\").isJsonNull()) {\n                    this.setRms((float)configJson.get(\"rms\").getAsDouble());\n                }\n                \n                // 解析reviseMinScore\n                if (configJson.has(\"reviseMinScore\") \u0026\u0026 !configJson.get(\"reviseMinScore\").isJsonNull()) {\n                    this.setReviseMinScore((float)configJson.get(\"reviseMinScore\").getAsDouble());\n                }\n                \n                // 解析ragNoContextFinallyAnswer\n                if (configJson.has(\"ragNoContextFinallyAnswer\") \u0026\u0026 !configJson.get(\"ragNoContextFinallyAnswer\").isJsonNull()) {\n                    this.setRagNoContextFinallyAnswer(configJson.get(\"ragNoContextFinallyAnswer\").getAsBoolean());\n                }\n                \n                // 解析ragNoContextFinallyAnswerText\n                if (configJson.has(\"ragNoContextFinallyAnswerText\") \u0026\u0026 !configJson.get(\"ragNoContextFinallyAnswerText\").isJsonNull()) {\n                    this.setRagNoContextFinallyAnswerText(configJson.get(\"ragNoContextFinallyAnswerText\").getAsString());\n                }\n                \n                // 解析temperature\n                if (configJson.has(\"temperature\") \u0026\u0026 !configJson.get(\"temperature\").isJsonNull()) {\n                    this.setTemperature(configJson.get(\"temperature\").getAsInt());\n                }\n                \n                // 解析topP\n                if (configJson.has(\"topP\") \u0026\u0026 !configJson.get(\"topP\").isJsonNull()) {\n                    this.setTopP(configJson.get(\"topP\").getAsInt());\n                }\n                \n                // 解析contextWindow\n                if (configJson.has(\"contextWindow\") \u0026\u0026 !configJson.get(\"contextWindow\").isJsonNull()) {\n                    this.setContextWindow(configJson.get(\"contextWindow\").getAsInt());\n                }\n                \n                // 解析roundSessionCount\n                if (configJson.has(\"roundSessionCount\") \u0026\u0026 !configJson.get(\"roundSessionCount\").isJsonNull()) {\n                    this.setRoundSessionCount(configJson.get(\"roundSessionCount\").getAsInt());\n                }\n                \n                // 解析topK\n                if (configJson.has(\"topK\") \u0026\u0026 !configJson.get(\"topK\").isJsonNull()) {\n                    this.setTopK(configJson.get(\"topK\").getAsInt());\n                }\n                \n                // 解析rrf\n                if (configJson.has(\"rrf\") \u0026\u0026 !configJson.get(\"rrf\").isJsonNull()) {\n                    this.setRrf(configJson.get(\"rrf\").getAsBoolean());\n                }\n                \n                // 解析useReranker\n                if (configJson.has(\"useReranker\") \u0026\u0026 !configJson.get(\"useReranker\").isJsonNull()) {\n                    this.setUseReranker(configJson.get(\"useReranker\").getAsBoolean());\n                }\n                \n                // 解析rankerModelName\n                if (configJson.has(\"rankerModelName\") \u0026\u0026 !configJson.get(\"rankerModelName\").isJsonNull()) {\n                    this.setRankerModelName(configJson.get(\"rankerModelName\").getAsString());\n                }\n                \n                // 解析nearPageNumber\n                if (configJson.has(\"nearPageNumber\") \u0026\u0026 !configJson.get(\"nearPageNumber\").isJsonNull()) {\n                    this.setNearPageNumber(configJson.get(\"nearPageNumber\").getAsInt());\n                }\n            } catch (Exception e) {\n                // 如果解析失败，使用默认值，不影响其他字段\n            }",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 351
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/database/impl/BusinessDatasourceDynamicServiceImpl.java",
      "timestamp": 1761236768915,
      "startOffset": 1260,
      "endOffset": 12751,
      "codeContent": "QueryResult;\nimport com.torchv.application.knowledge.model.response.database.DataSQLCacheResp;\nimport com.torchv.application.knowledge.model.response.database.DataSQLResp;\nimport com.torchv.application.knowledge.model.response.database.DataTableColumnResp;\nimport com.torchv.application.knowledge.model.response.database.DataTableResp;\nimport com.torchv.common.constant.CacheCns;\nimport com.torchv.common.constant.enums.system.ToggleStatusEnum;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport com.torchv.database.constant.DataSourceTypes;\nimport com.torchv.database.jdbc.cache.MultiDsProviderFactory;\nimport com.torchv.database.jdbc.cache.MultiJdbcDataSourceFactory;\nimport com.torchv.database.jdbc.metadata.DataSourceParams;\nimport com.torchv.database.schema.SuperColumnType;\nimport com.torchv.infra.common.utils.SQLUtils;\nimport com.torchv.database.util.SecureDbUtils;\nimport com.torchv.repository.database.entity.BusinessDataSource;\nimport com.torchv.repository.database.entity.DataBaseTable;\nimport com.torchv.repository.database.entity.DatabaseColumn;\nimport com.torchv.repository.database.mapper.MySQLMetadataMapper;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.mybatis.spring.SqlSessionFactoryBean;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.stereotype.Service;\n\nimport java.util.*;\nimport java.util.concurrent.TimeUnit;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/7/16 20:02\n * @since torchv_server v1.7.8\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class BusinessDatasourceDynamicServiceImpl implements BusinessDatasourceDynamicService {\n    \n    final BusinessDataSourceService businessDataSourceService;\n    final MultiJdbcDataSourceFactory multiJdbcDataSourceFactory;\n    final DatabaseAccessProviders databaseAccessProviders;\n    final StringRedisTemplate stringRedisTemplate;\n    \n    @Override\n    public BusinessDataSource checkDataSource(Integer dsId) {\n        Optional\u003cBusinessDataSource\u003e dataSourceOptional \u003d businessDataSourceService.queryInfoById(dsId);\n        if (dataSourceOptional.isEmpty()) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        BusinessDataSource dataSource \u003d dataSourceOptional.get();\n        Assert.isTrue(StrUtil.equalsIgnoreCase(dataSource.getTenantId(), UserContextHolder.getTenantId()), \"system.common.request.invalid\");\n        // create\n        DataSourceTypes dataSourceTypes \u003d DataSourceTypes.of(dataSource.getType());\n        if (dataSourceTypes \u003d\u003d null) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        // 避免数据源未加载的情况\n        this.loadDataSource(dataSource);\n        return dataSource;\n    }\n    \n    @Override\n    public Pagination\u003cDataTableResp\u003e list(Integer pageNo, Integer pageSize, Integer dsId) {\n        BusinessDataSource dataSource \u003d this.checkDataSource(dsId);\n        DataSourceTypes dataSourceTypes \u003d DataSourceTypes.of(dataSource.getType());\n        if (dataSourceTypes \u003d\u003d null) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        // 获取数据源\n        List\u003cDataTableResp\u003e tableResps \u003d new LinkedList\u003c\u003e();\n        DatabaseAccessProvider databaseAccessProvider \u003d databaseAccessProviders.createAccessProvider(dataSourceTypes);\n        Pagination\u003cDataBaseTable\u003e tablePagination \u003d databaseAccessProvider.listTables(pageNo, pageSize, dataSource);\n        if (CollUtil.isNotEmpty(tablePagination.getData())) {\n            tableResps \u003d tablePagination.getData().stream().map(DataTableResp::of).toList();\n        }\n        return Pagination.pagination(tableResps, tablePagination.getTotal(), pageNo, pageSize);\n    }\n    \n    @Override\n    public Optional\u003cDataBaseTable\u003e getTable(Integer dsId, String tableName) {\n        BusinessDataSource businessDataSource \u003d this.checkDataSource(dsId);\n        return this.getTable(businessDataSource, tableName);\n    }\n    \n    @Override\n    public Optional\u003cDataBaseTable\u003e getTable(BusinessDataSource businessDataSource, String tableName) {\n        log.info(\"获取表信息，db:{},table:{}\", businessDataSource.getDbName(), tableName);\n        DataSourceTypes dataSourceTypes \u003d DataSourceTypes.of(businessDataSource.getType());\n        if (dataSourceTypes \u003d\u003d null) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        DatabaseAccessProvider databaseAccessProvider \u003d databaseAccessProviders.createAccessProvider(dataSourceTypes);\n        DataBaseTable table \u003d databaseAccessProvider.getTable(businessDataSource, tableName);\n        return Optional.ofNullable(table);\n    }\n    \n    @Override\n    public Result\u003cList\u003cDataTableColumnResp\u003e\u003e listColumns(Integer dsId, String tableName) {\n        BusinessDataSource dataSource \u003d this.checkDataSource(dsId);\n        List\u003cDatabaseColumn\u003e columns \u003d this.listColumns(dataSource, tableName);\n        if (CollUtil.isNotEmpty(columns)) {\n            return Result.data(columns.stream().map(DataTableColumnResp::of).toList());\n        }\n        return Result.data(new ArrayList\u003c\u003e());\n    }\n    \n    @Override\n    public List\u003cDatabaseColumn\u003e listColumns(BusinessDataSource businessDataSource, String tableName) {\n        log.info(\"查询表列信息，dbName:{},tableName:{}\", businessDataSource.getDbName(), tableName);\n        DataSourceTypes dataSourceTypes \u003d DataSourceTypes.of(businessDataSource.getType());\n        if (dataSourceTypes \u003d\u003d null) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        DatabaseAccessProvider databaseAccessProvider \u003d databaseAccessProviders.createAccessProvider(dataSourceTypes);\n        return databaseAccessProvider.listColumns(businessDataSource, tableName);\n    }\n    \n    @Override\n    public List\u003cMap\u003cString, Object\u003e\u003e executeSql(Integer dsId, String sql, int page, int size) {\n        log.info(\"executeQuery,dsId:{},sql:{}\", dsId, sql);\n        sql \u003d SQLUtils.checkSelect(sql);\n        BusinessDataSource dataSource \u003d this.checkDataSource(dsId);\n        DataSourceTypes dataSourceTypes \u003d DataSourceTypes.of(dataSource.getType());\n        if (dataSourceTypes \u003d\u003d null) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        DatabaseAccessProvider databaseAccessProvider \u003d databaseAccessProviders.createAccessProvider(dataSourceTypes);\n        // SQL语句剔除特殊字符，例如句号，分号等\n        sql \u003d StrUtil.replace(sql, \";\", \"\");\n        // sql \u003d StrUtil.replace(sql, \".\", \"\");\n        sql \u003d StrUtil.replace(sql, \"。\", \"\");\n        sql \u003d StrUtil.replace(sql, \"`\", \"\");\n        DataQueryResult queryResult \u003d databaseAccessProvider.executeQuery(dataSource, sql, page, size);\n        return queryResult.getData();\n    }\n    \n    @Override\n    public Result\u003cDataSQLResp\u003e executeQuery(Integer dsId, String sql, int page, int size) {\n        log.info(\"executeQuery,dsId:{},sql:{}\", dsId, sql);\n        sql \u003d SQLUtils.checkSelect(sql);\n        log.info(\"检查SQL语句通过，dsId:{},sql:{}\", dsId, sql);\n        BusinessDataSource dataSource \u003d this.checkDataSource(dsId);\n        DataSourceTypes dataSourceTypes \u003d DataSourceTypes.of(dataSource.getType());\n        if (dataSourceTypes \u003d\u003d null) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        DatabaseAccessProvider databaseAccessProvider \u003d databaseAccessProviders.createAccessProvider(dataSourceTypes);\n        // SQL语句剔除特殊字符，例如句号，分号等\n        sql \u003d StrUtil.replace(sql, \";\", \"\");\n        //sql \u003d StrUtil.replace(sql, \".\", \"\");\n        sql \u003d StrUtil.replace(sql, \"。\", \"\");\n        sql \u003d StrUtil.replace(sql, \"`\", \"\");\n        \n        // 执行查询并获取结果和总数\n        DataQueryResult queryResult \u003d databaseAccessProvider.executeQuery(dataSource, sql, page, size);\n        List\u003cMap\u003cString, Object\u003e\u003e records \u003d queryResult.getData();\n        Long total \u003d queryResult.getTotal();\n        \n        String sqlId \u003d IdUtil.getSnowflakeNextIdStr();\n        if (CollUtil.isNotEmpty(records)) {\n            // 获取当前的记录数据，并且转换为DataColumns\n            Map\u003cString, Object\u003e record \u003d records.get(0);\n            String key \u003d CacheCns.CACHE_KNOWLEDGE_SQL_RESULT + sqlId;\n            List\u003cDatabaseColumn\u003e columns \u003d new LinkedList\u003c\u003e();\n            for (Map.Entry\u003cString, Object\u003e entry : record.entrySet()) {\n                DatabaseColumn column \u003d new DatabaseColumn();\n                column.setName(entry.getKey());\n                column.setNullable(ToggleStatusEnum.NO.getCode());\n                SuperColumnType superColumnType \u003d SuperColumnType.getColumnType(entry.getValue().getClass());\n                column.setType(superColumnType.getDbType());\n                column.setPrimaryKey(ToggleStatusEnum.NO.getCode());\n                column.setDataType(superColumnType.getDbType());\n                column.setDataLength(0L);\n                columns.add(column);\n            }\n            DataSQLCacheResp cacheResp \u003d DataSQLCacheResp.of(sqlId, sql, columns);\n            // 保存\n            log.info(\"保存SQL结果，key:{}\", key);\n            stringRedisTemplate.opsForValue().set(key, cacheResp.toJson(), 10, TimeUnit.MINUTES);\n        }\n        DataSQLResp resp \u003d new DataSQLResp();\n        resp.setRetId(sqlId);\n        resp.setSql(sql);\n        resp.setData(records);\n        resp.setTotal(total);\n        return Result.data(resp);\n    }\n    \n    @Override\n    public synchronized void loadDataSource(BusinessDataSource dataSource) {\n        // create\n        DataSourceTypes dataSourceTypes \u003d DataSourceTypes.of(dataSource.getType());\n        if (dataSourceTypes \u003d\u003d null) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        // 加载数据源\n        if (!multiJdbcDataSourceFactory.containsDs(dataSource.getCode())) {\n            SqlSessionFactoryBean sqlSessionFactoryBean \u003d MultiDsProviderFactory.session(dataSourceTypes).getSessionFactory(this.buildParams(dataSource));\n            multiJdbcDataSourceFactory.addDs(dataSource.getCode(), sqlSessionFactoryBean);\n        }\n    }\n    \n    @Override\n    public DataSourceParams buildParams(BusinessDataSource dataSource) {\n        DataSourceParams dataSourceParams \u003d new DataSourceParams();\n        dataSourceParams.setIdleTimeout(dataSource.getIdleTimeout());\n        dataSourceParams.setMaxLifeTime(Objects.requireNonNullElse(dataSource.getMaxLifeTime(), 120000));\n        dataSourceParams.setMaximumPoolSize(Objects.requireNonNullElse(dataSource.getMaximumPoolSize(), 50));\n        dataSourceParams.setMinimumIdle(Objects.requireNonNullElse(dataSourceParams.getMinimumIdle(), 5));\n        dataSourceParams.setConnectionTimeout(Objects.requireNonNullElse(dataSourceParams.getConnectionTimeout(), 60000));\n        dataSourceParams.setHost(dataSource.getHost());\n        // 密码需要解密\n        dataSourceParams.setPassword(SecureDbUtils.decrypt(dataSource.getPassword()));\n        dataSourceParams.setPort(dataSource.getPort());\n        dataSourceParams.setDbName(dataSource.getDbName());\n        dataSourceParams.setUserName(dataSource.getUserName());\n        //  补充mappers的路径\n        String[] mapperLocations \u003d new String[]{\"classpath*:mapper/*Mapper.xml\", \"classpath*:mapper/*/*Mapper.xml\"};\n        dataSourceParams.setMapperLocations(List.of(mapperLocations));\n        dataSourceParams.setTypeAliasesPackage(\"com.torchv.repository.*.entity\");\n        dataSourceParams.setMapperClasses(List.of(MySQLMetadataMapper.class",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 223
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/database/impl/BusinessDataSourceServiceImpl.java",
      "timestamp": 1761236768905,
      "startOffset": 4387,
      "endOffset": 15213,
      "codeContent": "eq(StrUtil.isNotBlank(businessDataSourceQueryReq.getContainerCode()), BusinessDataSource::getContainerCode, businessDataSourceQueryReq.getContainerCode());\n        lambdaQueryWrapper.orderByDesc(BusinessDataSource::getCreateTime);\n        List\u003cBusinessDataSource\u003e businessDataSourceInfos \u003d businessDataSourceMapper.selectList(lambdaQueryWrapper);\n        List\u003cBusinessDataSourceResp\u003e businessDataSourceRespInfos \u003d new ArrayList\u003c\u003e();\n        long count \u003d businessDataSourcePageNo.getTotal();\n        if (CollectionUtil.isNotEmpty(businessDataSourceInfos)) {\n            businessDataSourceRespInfos.addAll(businessDataSourceInfos.stream().map(new BusinessDataSourceApplyFunction()).toList());\n        }\n        // 对数据源对可用状态进行排序\n        // 先对所有可用状态对排到最前，然后按创建时间倒叙\n        businessDataSourceRespInfos.sort((o1, o2) -\u003e {\n            if (StrUtil.equals(o1.getStatus(), DataSourceStatus.AVAILABLE.name()) \u0026\u0026 StrUtil.equals(o2.getStatus(), DataSourceStatus.UNAVAILABLE.name())) {\n                return -1;\n            } else if (StrUtil.equals(o1.getStatus(), DataSourceStatus.UNAVAILABLE.name()) \u0026\u0026 StrUtil.equals(o2.getStatus(), DataSourceStatus.AVAILABLE.name())) {\n                return 1;\n            } else {\n                return o2.getCreateTime().compareTo(o1.getCreateTime());\n            }\n        });\n        return Pagination.pagination(businessDataSourceRespInfos, count, pageNo, pageSize);\n    }\n    \n    @Override\n    public Result\u003cList\u003cBusinessDataSourceCountResp\u003e\u003e listCount(String containerCode) {\n        List\u003cBusinessDataSourceCount\u003e businessDataSourceCounts \u003d businessDataSourceMapper.groupByTenant(UserContextHolder.getTenantId(),containerCode);\n        List\u003cBusinessDataSourceCountResp\u003e businessDataSourceCountResps \u003d CollUtil.newArrayList();\n        if (CollUtil.isNotEmpty(businessDataSourceCounts)) {\n            businessDataSourceCounts.forEach(businessDataSourceCount -\u003e {\n                BusinessDataSourceCountResp businessDataSourceCountResp \u003d new BusinessDataSourceCountResp();\n                businessDataSourceCountResp.setType(businessDataSourceCount.getType());\n                businessDataSourceCountResp.setNumber(businessDataSourceCount.getNumber());\n                businessDataSourceCountResps.add(businessDataSourceCountResp);\n            });\n        }\n        return Result.data(businessDataSourceCountResps);\n    }\n    \n    /**\n     * 新增数据源记录\n     * @param businessDataSourceAddReq 新增数据源条件Vo\n     * @return 是否新增成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e add(BusinessDataSourceAddReq businessDataSourceAddReq) {\n        log.info(\"新增数据源数据,Vo:{}\", businessDataSourceAddReq.toString());\n        DataSourceTypes types \u003d DataSourceTypes.of(businessDataSourceAddReq.getType());\n        if (types \u003d\u003d null) {\n            throw new IllegalArgumentException(\"not support data source type,type:\" + businessDataSourceAddReq.getType());\n        }\n        BusinessDataSource businessDataSource \u003d new BusinessDataSource();\n        BeanUtils.copyProperties(businessDataSourceAddReq, businessDataSource);\n        businessDataSource.setCreateTime(LocalDateTime.now());\n        businessDataSource.setModifierTime(LocalDateTime.now());\n        businessDataSource.setTenantId(UserContextHolder.getTenantId());\n        businessDataSource.setCode(IdUtil.getSnowflakeNextIdStr());\n        businessDataSource.setStatus(ToggleStatusEnum.YES.getValue());\n        businessDataSource.setPassword(SecureDbUtils.encrypt(businessDataSource.getPassword()));\n        // 数据源状态\n        ConnectionProvider connectionProvider \u003d MultiDsProviderFactory.of(types);\n        boolean connectStatus \u003d connectionProvider.connection(businessDataSourceAddReq.toConnectionParams());\n        if (connectStatus) {\n            businessDataSource.setStatus(DataSourceStatus.AVAILABLE.name());\n        } else {\n            businessDataSource.setStatus(DataSourceStatus.UNAVAILABLE.name());\n        }\n        // 数据库的密码，不能用明文存储\n        int ret \u003d businessDataSourceMapper.insert(businessDataSource);\n        return ret \u003e 0 ? Result.defaultSuccess(\"新增成功\") : Result.error(\"新增失败\");\n    }\n    \n    @Override\n    public Result\u003cBoolean\u003e testDs(BusinessDataSourceTestConnectionReq connectionReq) {\n        log.info(\"测试数据源连接,host:{},port:{},db:{}\", connectionReq.getHost(), connectionReq.getPort(), connectionReq.getDbName());\n        DataSourceTypes types \u003d DataSourceTypes.of(connectionReq.getType());\n        if (types \u003d\u003d null) {\n            throw new IllegalArgumentException(\"not support data source type,type:\" + connectionReq.getType());\n        }\n        ConnectionProvider connectionProvider \u003d MultiDsProviderFactory.of(types);\n        boolean ret \u003d connectionProvider.connection(connectionReq.toConnectionParams());\n        log.info(\"连接状态:{}\", ret);\n        return Result.data(ret);\n    }\n    \n    /**\n     * 更新数据源记录\n     * @param businessDataSourceUpdateReq 更新数据源条件Vo\n     * @return 是否更新成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e update(BusinessDataSourceUpdateReq businessDataSourceUpdateReq) {\n        log.info(\"根据containerCode修改数据源数据,Vo:{}\", businessDataSourceUpdateReq.toString());\n        // 查询所有匹配的数据源\n        LambdaQueryWrapper\u003cBusinessDataSource\u003e queryWrapper \u003d Wrappers.lambdaQuery(BusinessDataSource.class)\n                .eq(BusinessDataSource::getTenantId, UserContextHolder.getTenantId())\n                .eq(BusinessDataSource::getContainerCode, businessDataSourceUpdateReq.getContainerCode());\n        List\u003cBusinessDataSource\u003e records \u003d businessDataSourceMapper.selectList(queryWrapper);\n        Assert.notEmpty(records, \"请求数据非法\");\n        \n        // 获取第一条记录用于类型验证和连接测试\n        BusinessDataSource firstRecord \u003d records.get(0);\n        DataSourceTypes types \u003d DataSourceTypes.of(businessDataSourceUpdateReq.getType());\n        if (types \u003d\u003d null) {\n            throw new IllegalArgumentException(\"not support data source type,type:\" + businessDataSourceUpdateReq.getType());\n        }\n        \n        // 准备更新的数据\n        BusinessDataSource businessDataSource \u003d new BusinessDataSource();\n        BeanUtils.copyProperties(businessDataSourceUpdateReq, businessDataSource);\n        businessDataSource.setModifierTime(LocalDateTime.now());\n        businessDataSource.setId(null); // 清除id，避免使用id更新\n        \n        if (StrUtil.isNotBlank(businessDataSourceUpdateReq.getPassword())) {\n            businessDataSource.setPassword(SecureDbUtils.encrypt(businessDataSource.getPassword()));\n        }\n        \n        // 测试数据源连接状态\n        ConnectionProvider connectionProvider \u003d MultiDsProviderFactory.of(types);\n        boolean connectStatus \u003d connectionProvider.connection(businessDataSourceUpdateReq.toConnectionParams(firstRecord));\n        \n        // 更新状态\n        if (connectStatus) {\n            businessDataSource.setStatus(DataSourceStatus.AVAILABLE.name());\n        } else {\n            businessDataSource.setStatus(DataSourceStatus.UNAVAILABLE.name());\n        }\n        \n        // 批量更新所有匹配的数据源\n        LambdaQueryWrapper\u003cBusinessDataSource\u003e updateWrapper \u003d Wrappers.lambdaQuery(BusinessDataSource.class)\n                .eq(BusinessDataSource::getTenantId, UserContextHolder.getTenantId())\n                .eq(BusinessDataSource::getContainerCode, businessDataSourceUpdateReq.getContainerCode());\n        int ret \u003d businessDataSourceMapper.update(businessDataSource, updateWrapper);\n        \n        if (ret \u003e 0) {\n            // 删除缓冲中的所有数据源\n            records.forEach(record -\u003e multiJdbcDataSourceFactory.removeDs(record.getCode()));\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(\"更新成功\") : Result.error(\"更新失败\");\n    }\n    \n    /**\n     * 根据containerCode查询数据源详情\n     * @param containerCode 容器编码\n     * @return 数据源详情列表\n     */\n    @Override\n    public Result\u003cList\u003cBusinessDataSourceResp\u003e\u003e queryById(String containerCode) {\n        log.info(\"根据containerCode查询数据源详情,containerCode:{}\", containerCode);\n        LambdaQueryWrapper\u003cBusinessDataSource\u003e queryWrapper \u003d Wrappers.lambdaQuery(BusinessDataSource.class)\n                .eq(BusinessDataSource::getTenantId, UserContextHolder.getTenantId())\n                .eq(BusinessDataSource::getContainerCode, containerCode);\n        List\u003cBusinessDataSource\u003e businessDataSourceList \u003d businessDataSourceMapper.selectList(queryWrapper);\n        List\u003cBusinessDataSourceResp\u003e respList \u003d new ArrayList\u003c\u003e();\n        if (CollUtil.isNotEmpty(businessDataSourceList)) {\n            businessDataSourceList.forEach(businessDataSource -\u003e {\n                BusinessDataSourceResp businessDataSourceResp \u003d new BusinessDataSourceResp();\n                BeanUtils.copyProperties(businessDataSource, businessDataSourceResp);\n                respList.add(businessDataSourceResp);\n            });\n        }\n        return Result.data(respList);\n    }\n    \n    /**\n     * 根据主键id批量删除数据源\n     * @param ids 批量删除主键id集合\n     * @return 是否删除成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e delete(List\u003cInteger\u003e ids) {\n        log.info(\"批量删除数据源,pageSize:{}\", CollectionUtil.size(ids));\n        LambdaQueryWrapper\u003cBusinessDataSource\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(BusinessDataSource.class)\n                .eq(BusinessDataSource::getTenantId, UserContextHolder.getTenantId());\n        lambdaQueryWrapper.in(BusinessDataSource::getContainerCode, ids);\n        List\u003cBusinessDataSource\u003e businessDataSources \u003d businessDataSourceMapper.selectList(lambdaQueryWrapper);\n        int ret \u003d businessDataSourceMapper.delete(lambdaQueryWrapper);\n        Assert.isTrue(NumberUtil.equals(ret, CollUtil.size(ids)), \"请求数据非法\");\n        if (ret \u003e 0) {\n            businessDataSources.forEach(businessDataSource -\u003e multiJdbcDataSourceFactory.removeDs(businessDataSource.getCode()));\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(\"删除成功\") : Result.error(\"删除失败\");\n    }\n    \n    /**\n     * 根据containerCode删除数据源\n     * @param containerCode 容器编码\n     * @return 是否删除成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e delete(String containerCode) {\n        log.info(\"根据containerCode删除数据源,containerCode:{}\", containerCode);\n        LambdaQueryWrapper\u003cBusinessDataSource\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(BusinessDataSource.class)\n                .eq(BusinessDataSource::getTenantId, UserContextHolder.getTenantId())\n                .eq(BusinessDataSource::getContainerCode, containerCode);\n        List\u003cBusinessDataSource\u003e businessDataSources \u003d businessDataSourceMapper.selectList(lambdaQueryWrapper);\n        Assert.notEmpty(businessDataSources, \"请求数据非法\");\n        int ret \u003d businessDataSourceMapper.delete(lambdaQueryWrapper);\n        if (ret \u003e 0) {\n            businessDataSources.forEach(businessDataSource -\u003e multiJdbcDataSourceFactory.removeDs(businessDataSource.getCode()",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 202
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/database/impl/BusinessColumnServiceImpl.java",
      "timestamp": 1761236768900,
      "startOffset": 1961,
      "endOffset": 6479,
      "codeContent": "Map;\nimport java.util.Optional;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\n/**\n * 数据列模块-业务Service实现\n * @since torchv_server v1.7.8.1\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/07/25 11:25\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class BusinessColumnServiceImpl extends ServiceImpl\u003cBusinessColumnMapper, BusinessColumn\u003e implements BusinessColumnService {\n    \n    final BusinessColumnMapper businessColumnMapper;\n    \n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public void addColumns(List\u003cDatabaseColumn\u003e columns, BusinessTable table) {\n        Assert.isTrue(CollUtil.isNotEmpty(columns), \"columns can\u0027t be empty!\");\n        final LocalDateTime nowTime \u003d LocalDateTime.now();\n        List\u003cBusinessColumn\u003e businessColumns \u003d new ArrayList\u003c\u003e();\n        for (int i \u003d 0; i \u003c columns.size(); i++) {\n            DatabaseColumn column \u003d columns.get(i);\n            BusinessColumn businessColumn \u003d new BusinessColumn();\n            businessColumn.setModifierTime(nowTime);\n            businessColumn.setCreateTime(nowTime);\n            businessColumn.setBelongDs(table.getBelongDs());\n            businessColumn.setBelongTable(table.getCode());\n            businessColumn.setCode(IdUtil.getSnowflakeNextIdStr());\n            businessColumn.setTenantId(table.getTenantId());\n            businessColumn.setDescription(column.getDescription());\n            businessColumn.setName(column.getName());\n            businessColumn.setDataType(column.getType());\n            businessColumn.setDataLength(column.getDataLength());\n            businessColumn.setDataPrecision(0);\n            businessColumn.setPkStatus(column.getPrimaryKey());\n            businessColumn.setNullable(column.getNullable());\n            businessColumn.setSort(i + 1);\n            businessColumns.add(businessColumn);\n        }\n        this.saveBatch(businessColumns);\n    }\n    \n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public void updateColumns(BusinessTable table, List\u003cBusinessColumnUpdateReq\u003e columns) {\n        // 先删除列\n        LambdaQueryWrapper\u003cBusinessColumn\u003e lambdaQueryWrapper \u003d\n                Wrappers.lambdaQuery(BusinessColumn.class).eq(BusinessColumn::getTenantId, table.getTenantId()).eq(BusinessColumn::getBelongTable, table.getCode());\n        businessColumnMapper.delete(lambdaQueryWrapper);\n        // 再新增列\n        if (CollUtil.isEmpty(columns)) {\n            return;\n        }\n        // 批量新增列\n        List\u003cBusinessColumn\u003e businessColumns \u003d new ArrayList\u003c\u003e();\n        for (int i \u003d 0; i \u003c columns.size(); i++) {\n            businessColumns.add(columns.get(i).of(table, i + 1));\n        }\n        this.saveBatch(businessColumns);\n    }\n    \n    @Override\n    public void deleteColumns(String tenantId, List\u003cString\u003e tableCodes) {\n        if (StrUtil.isEmpty(tenantId) || CollUtil.isEmpty(tableCodes)) {\n            return;\n        }\n        LambdaQueryWrapper\u003cBusinessColumn\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(BusinessColumn.class).eq(BusinessColumn::getTenantId, tenantId).in(BusinessColumn::getBelongTable, tableCodes);\n        businessColumnMapper.delete(lambdaQueryWrapper);\n    }\n    \n    @Override\n    public List\u003cBusinessColumn\u003e listColumns(BusinessTable businessTable) {\n        LambdaQueryWrapper\u003cBusinessColumn\u003e lambdaQueryWrapper \u003d\n                Wrappers.lambdaQuery(BusinessColumn.class).eq(BusinessColumn::getTenantId, businessTable.getTenantId()).eq(BusinessColumn::getBelongTable, businessTable.getCode());\n        lambdaQueryWrapper.orderByDesc(BusinessColumn::getSort);\n        return businessColumnMapper.selectList(lambdaQueryWrapper);\n    }\n\n    @Override\n    public Map\u003cString, List\u003cBusinessColumn\u003e\u003e mapByTables(List\u003cBusinessTable\u003e tables) {\n        if (CollUtil.isEmpty(tables)) {\n            return Map.of();\n        }\n        List\u003cString\u003e tableCodes \u003d tables.stream().map(BusinessTable::getCode).toList();\n        LambdaQueryWrapper\u003cBusinessColumn\u003e lambdaQueryWrapper \u003d\n                Wrappers.lambdaQuery(BusinessColumn.class).in(BusinessColumn::getBelongTable, tableCodes);\n        lambdaQueryWrapper.orderByDesc(BusinessColumn::getSort);\n        List\u003cBusinessColumn\u003e columns\u003d businessColumnMapper.selectList(lambdaQueryWrapper);\n        // 根据getBelongTable 进行分组，转换为map对象，key是表code，value是字段列表\n        if (CollUtil.isNotEmpty(columns)) {\n            return columns.stream().collect(Collectors.groupingBy(BusinessColumn::getBelongTable));\n        }\n        return Map.of();\n    }\n",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 99
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/database/impl/BusinessTableServiceImpl.java",
      "timestamp": 1761236768897,
      "startOffset": 9373,
      "endOffset": 20024,
      "codeContent": "if (StrUtil.isNotBlank(businessViewAddReq.getComment())) {\n            businessTable.setDescription(businessViewAddReq.getComment());\n        } else {\n            businessTable.setDescription(\"VIEW_\" + businessViewAddReq.getName());\n        }\n       // businessTable.setDescription(businessViewAddReq.getComment());\n        businessTable.setDbName(businessDataSource.getDbName());\n        businessTable.setBelongDs(businessDataSource.getCode());\n        businessTable.setTenantId(tenantId);\n        businessTable.setSqlSource(dataSQLCacheResp.getSql());\n        // table类型的\n        businessTable.setType(KnowledgeTableTypes.VIEW.name());\n        businessTable.setStatus(ProcessStatusEnum.UN_ISSUE.getCode());\n        businessTable.setModifierTime(LocalDateTime.now());\n        businessTable.setCreateTime(LocalDateTime.now());\n        businessTable.setCreator(Objects.toString(sysUser.getId()));\n        businessTable.setModifier(Objects.toString(sysUser.getId()));\n        int ret \u003d businessTableMapper.insert(businessTable);\n        if (ret \u003e 0) {\n            // 新增列明细信息\n            businessColumnService.addColumns(dataSQLCacheResp.getColumns(), businessTable);\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(\"新增成功\") : Result.error(\"新增失败\");\n    }\n    \n    @Override\n    public Result\u003cDataSQLResp\u003e preview(Integer tableId, Integer pageNo, Integer pageSize) {\n        BusinessTable businessTable \u003d businessTableMapper.selectById(tableId);\n        Assert.notNull(businessTable, \"system.common.request.invalid\");\n        SysUserInfo sysUser \u003d UserContextHolder.getCurrentUser();\n        Assert.isTrue(StrUtil.equalsIgnoreCase(sysUser.getTenantId(), businessTable.getTenantId()), \"system.common.request.invalid\");\n        KnowledgeTableTypes tableTypes \u003d KnowledgeTableTypes.of(businessTable.getType());\n        String sql \u003d businessTable.getSqlSource();\n        if (tableTypes \u003d\u003d KnowledgeTableTypes.TABLE) {\n            sql \u003d \"select * from \" + businessTable.getName();\n        }\n        Optional\u003cBusinessDataSource\u003e dataSourceOptional \u003d businessDataSourceService.queryInfoByCode(businessTable.getBelongDs(), sysUser.getTenantId());\n        if (dataSourceOptional.isEmpty()) {\n            throw new RuntimeException(\"system.common.request.invalid\");\n        }\n        return businessDatasourceDynamicService.executeQuery(dataSourceOptional.get().getId(), sql, pageNo, pageSize);\n    }\n    \n    /**\n     * 更新数据表记录\n     * @param businessTableUpdateReq 更新数据表条件Vo\n     * @return 是否更新成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e update(BusinessTableUpdateReq businessTableUpdateReq) {\n        log.info(\"根据主键id修改数据表数据,Vo:{}\", businessTableUpdateReq.toString());\n        BusinessTable record \u003d businessTableMapper.selectById(businessTableUpdateReq.getId());\n        Assert.notNull(record, \"请求数据非法\");\n        SysUserInfo sysUser \u003d UserContextHolder.getCurrentUser();\n        Assert.isTrue(StrUtil.equalsIgnoreCase(sysUser.getTenantId(), record.getTenantId()), \"请求数据非法\");\n        List\u003cBusinessColumn\u003e columns \u003d businessColumnService.listColumns(record);\n        // 校验表信息是否修改了\n        StringBuilder hexBuilder \u003d new StringBuilder();\n        hexBuilder.append(record.getName()).append(record.getDescription()).append(record.getRemark());\n        for (BusinessColumn column : columns) {\n            hexBuilder.append(column.getName()).append(\":\").append(column.getDescription());\n        }\n        String recordHex \u003d DigestUtil.sha256Hex(hexBuilder.toString());\n        BusinessTable businessTable \u003d new BusinessTable();\n        BeanUtils.copyProperties(businessTableUpdateReq, businessTable);\n        businessTable.setModifierTime(LocalDateTime.now());\n        String updateHex \u003d businessTableUpdateReq.updateHex();\n        boolean hexEquals \u003d StrUtil.equalsIgnoreCase(recordHex, updateHex);\n        if (!hexEquals) {\n            // 数据发生了变动，需要重新发布。\n            businessTable.setStatus(ProcessStatusEnum.UN_ISSUE.getCode());\n        }\n        int ret \u003d businessTableMapper.updateById(businessTable);\n        if (ret \u003e 0) {\n            // 校验文本是否修改了\n            businessColumnService.updateColumns(record, businessTableUpdateReq.getColumns());\n            if (!hexEquals) {\n                knowledgeElementService.deleteByCode(sysUser.getTenantId(), businessTable.getContainerId(), CollUtil.newArrayList(record.getCode()));\n            }\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(\"更新成功\") : Result.error(\"更新失败\");\n    }\n    \n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e issue(BusinessTableIssueReq issueReq) {\n        BusinessTable businessTable \u003d businessTableMapper.selectById(issueReq.getId());\n        Assert.notNull(businessTable, \"请求数据非法\");\n        SysUserInfo sysUser \u003d UserContextHolder.getCurrentUser();\n        Assert.isTrue(StrUtil.equalsIgnoreCase(sysUser.getTenantId(), businessTable.getTenantId()), \"请求数据非法\");\n        // 先删除老的\n        knowledgeElementService.deleteByCode(sysUser.getTenantId(), businessTable.getContainerId(), CollUtil.newArrayList(businessTable.getCode()));\n        // 重新发布\n        BusinessTable update \u003d new BusinessTable();\n        update.setModifierTime(LocalDateTime.now());\n        update.setStatus(ProcessStatusEnum.INIT.getCode());\n        update.setId(issueReq.getId());\n        int ret \u003d businessTableMapper.updateById(update);\n        if (ret \u003e 0) {\n            List\u003cBusinessColumn\u003e columns \u003d businessColumnService.listColumns(businessTable);\n            // 新增新数据\n            knowledgeElementService.addKnowledge(businessTable, columns, sysUser, businessTable.getContainerId());\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(\"发布成功\") : Result.error(\"发布失败\");\n    }\n    \n    /**\n     * 根据id查询数据表详情\n     * @param id 数据表主键id\n     * @return 数据表详情\n     */\n    @Override\n    public Result\u003cBusinessTableResp\u003e queryById(Integer id) {\n        log.info(\"根据主键id查询数据表详情,Id:{}\", id);\n        BusinessTable businessTable \u003d businessTableMapper.selectById(id);\n        Assert.notNull(businessTable, \"请求数据非法\");\n        SysUserInfo sysUser \u003d UserContextHolder.getCurrentUser();\n        Assert.isTrue(StrUtil.equalsIgnoreCase(sysUser.getTenantId(), businessTable.getTenantId()), \"请求数据非法\");\n        BusinessTableResp businessTableResp \u003d new BusinessTableResp();\n        BeanUtils.copyProperties(businessTable, businessTableResp);\n        // 列明细详情\n        businessTableResp.setColumns(businessColumnService.listByTable(businessTable));\n        // 关联已经发布的table状态\n        Set\u003cString\u003e codes \u003d CollUtil.newHashSet(businessTable.getCode());\n        Map\u003cString, SaasKnowledgeElement\u003e elementMap \u003d knowledgeBasicQueryService.queryByCodes(codes, sysUser.getTenantId());\n        SaasKnowledgeElement element \u003d elementMap.get(businessTable.getCode());\n        if (element !\u003d null) {\n            businessTableResp.setStatus(element.getProcessStatus());\n        }\n        return Result.data(businessTableResp);\n    }\n    \n    /**\n     * 根据主键id批量删除数据表\n     * @param ids 批量删除主键id集合\n     * @return 是否删除成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e delete(List\u003cInteger\u003e ids) {\n        log.info(\"批量删除数据表,pageSize:{}\", CollectionUtil.size(ids));\n        if (CollectionUtil.isEmpty(ids)) {\n            return Result.error(\"请求数据非法\");\n        }\n        String tenantId \u003d UserContextHolder.getTenantId();\n        LambdaQueryWrapper\u003cBusinessTable\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(BusinessTable.class).eq(BusinessTable::getTenantId, tenantId)\n                .in(BusinessTable::getId, ids).select(BusinessTable::getCode, BusinessTable::getId);\n        List\u003cBusinessTable\u003e tables \u003d businessTableMapper.selectList(lambdaQueryWrapper);\n        Assert.isTrue(NumberUtil.equals(CollUtil.size(tables), CollUtil.size(ids)), \"请求数据非法\");\n        int ret \u003d businessTableMapper.deleteBatchIds(ids);\n        if (ret \u003d\u003d CollUtil.size(ids)) {\n            // 删除列信息\n            List\u003cString\u003e tableCodes \u003d tables.stream().map(BusinessTable::getCode).toList();\n            businessColumnService.deleteColumns(tenantId, tableCodes);\n            // 删除知识库文件\n            knowledgeElementService.deleteByCode(tenantId, tables.get(0).getContainerId(), tableCodes);\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(\"删除成功\") : Result.error(\"删除失败\");\n    }\n    \n    /**\n     * 根据主键id删除数据表\n     * @param id 主键id\n     * @return 是否删除成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e delete(Integer id) {\n        log.info(\"根据主键id删除数据表,id:{}\", id);\n        BusinessTable businessTable \u003d businessTableMapper.selectById(id);\n        Assert.notNull(businessTable, \"请求数据非法\");\n        SysUserInfo sysUser \u003d UserContextHolder.getCurrentUser();\n        Assert.isTrue(StrUtil.equalsIgnoreCase(sysUser.getTenantId(), businessTable.getTenantId()), \"请求数据非法\");\n        int ret \u003d businessTableMapper.deleteById(id);\n        if (ret \u003e 0) {\n            businessColumnService.deleteColumns(businessTable.getTenantId(), CollUtil.newArrayList(businessTable.getCode()));\n            knowledgeElementService.deleteByCode(sysUser.getTenantId(), businessTable.getContainerId(), CollUtil.newArrayList(businessTable.getCode()));\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(\"删除成功\") : Result.error(\"删除失败\");\n    }\n    \n    /**\n     * 根据id查询数据表实体详情\n     * @param id 主键id\n     * @return 数据表的Optional\n     */\n    @Override\n    public Optional\u003cBusinessTable\u003e queryInfoById(Integer id) {\n        log.info(\"根据请求id查询数据表实体详情,id:{}\", id);\n        BusinessTable businessTable \u003d businessTableMapper.selectById(id);\n        if (businessTable !\u003d null) {\n            return Optional.of(businessTable);\n        }\n        return Optional.empty();\n    }\n    \n    @Override\n    public Optional\u003cBusinessTable\u003e queryInfoByCode(String tenantId, String code) {\n        log.info(\"根据code查询数据表实体详情,code:{},tenant:{}\", code, tenantId);\n        LambdaQueryWrapper\u003cBusinessTable\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(BusinessTable.class).eq(BusinessTable::getTenantId, tenantId).eq(BusinessTable::getCode, code);\n        BusinessTable table \u003d businessTableMapper.selectOne(lambdaQueryWrapper, false);\n        return Optional.ofNullable(table);\n    }\n\n    @Override\n    public List\u003cBusinessTable\u003e listByCodes(List\u003cString\u003e codes) {\n        log.info(\"根据多个code查询数据表实体列表,codes:{}\", codes);\n        if (CollUtil.isNotEmpty(codes)) {\n            LambdaQueryWrapper\u003cBusinessTable\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(BusinessTable.class).in(BusinessTable::getCode, codes);\n            return businessTableMapper.selectList(lambdaQueryWrapper);\n        }\n        return List.of();\n    }\n",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 215
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/kb/user/web/UserEventDataController.java",
      "timestamp": 1761236768888,
      "startOffset": 97,
      "endOffset": 2943,
      "codeContent": "common.constant.KbEventMessageTypes;\nimport com.torchv.kb.page.model.dto.PageEventNameInfo;\nimport com.torchv.kb.page.service.KbPageEventService;\nimport com.torchv.kb.space.model.request.KbSpaceQueryReq;\nimport com.torchv.kb.space.model.response.KbSpaceResp;\nimport com.torchv.kb.space.service.KbSpaceService;\nimport io.swagger.v3.oas.annotations.Operation;\nimport io.swagger.v3.oas.annotations.Parameter;\nimport io.swagger.v3.oas.annotations.Parameters;\nimport io.swagger.v3.oas.annotations.enums.ParameterIn;\nimport io.swagger.v3.oas.annotations.tags.Tag;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.List;\n\n/**\n * Copyright © 2025 integration-projects-maven. All rights reserved.\n * ClassName UserEventDataController.java\n * author 舒一笑\n * version 1.0.0\n * Description 知识库用户事件\n * createTime 2025年07月09日 17:40:48\n */\n@RestController\n@RequestMapping(\"/kb/user/event/data\")\n@AllArgsConstructor\n@Slf4j\n@Tag(name \u003d \"知识库用户事件\")\npublic class UserEventDataController {\n    \n    final KbSpaceService kbSpaceService;\n    final KbPageEventService kbPageEventService;\n    \n    \n    /**\n     * 分页查询知识库空间\n     * @param spaceQueryReq 查询条件vo\n     * @param pageNo 当前页码\n     * @param pageSize 页码大小\n     * @return 分页列表\n     */\n    @Operation(summary \u003d \"分页查询有权限的知识库空间\")\n    @Parameters({\n            @Parameter(name \u003d \"pageNo\", description \u003d \"当前页码,默认1\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"1\"),\n            @Parameter(name \u003d \"pageSize\", description \u003d \"页码大小,默认10\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"10\")\n    })\n    @GetMapping(\"/space/list\")\n    public Pagination\u003cKbSpaceResp\u003e spaceList(KbSpaceQueryReq spaceQueryReq,\n            @RequestParam(value \u003d \"pageNo\", defaultValue \u003d \"1\") Integer pageNo,\n            @RequestParam(value \u003d \"pageSize\", defaultValue \u003d \"10\") Integer pageSize) {\n        log.info(\"list user space,api:{}\", \"/kb/user/event/data/space/list\");\n        return kbSpaceService.list(spaceQueryReq, pageNo, pageSize);\n    }\n    \n    \n    /**\n     * 浏览知识页面页面\n     * @return 浏览知识页面页面\n     */\n    @Operation(summary \u003d \"浏览页面列表\")\n    @GetMapping(\"/tracing\")\n    public Pagination\u003cPageEventNameInfo\u003e tracing(@RequestParam(value \u003d \"pageNo\", defaultValue \u003d \"1\") Integer pageNo,\n            @RequestParam(value \u003d \"pageSize\", defaultValue \u003d \"10\") Integer pageSize,@RequestParam(value \u003d \"creator\" , required \u003d false) Integer creator) {\n        log.info(\"浏览知识页面页面,api:{}\", \"/kb/user/event/data/tracing\");\n        return kbPageEventService.userEvent(pageNo, pageSize, List.of(KbEventMessageTypes.EVENT_PAGE_BROWSER.name()), creator);\n    }\n    ",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 72
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/database/BusinessColumnService.java",
      "timestamp": 1761236768883,
      "startOffset": 1189,
      "endOffset": 2284,
      "codeContent": "Map;\nimport java.util.Optional;\n\n/**\n * 数据列模块-业务Service\n * @since torchv_server v1.7.8.1\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/07/25 11:25\n */\npublic interface BusinessColumnService extends IService\u003cBusinessColumn\u003e {\n    \n    /**\n     * 批量新增列\n     * @param columns 列集合\n     * @param table 表\n     */\n    void addColumns(List\u003cDatabaseColumn\u003e columns, BusinessTable table);\n    \n    /**\n     * 更新表字段\n     * @param table 表格\n     * @param columns 字段列\n     */\n    void updateColumns(BusinessTable table, List\u003cBusinessColumnUpdateReq\u003e columns);\n    \n    /**\n     * 批量删除字段列，根据表code集合\n     * @param tenantId 租户id\n     * @param tableCodes 表code\n     */\n    void deleteColumns(String tenantId, List\u003cString\u003e tableCodes);\n    \n    /**\n     * 查询字段列表\n     * @param businessTable 表信息\n     * @return 字段列表\n     */\n    List\u003cBusinessColumn\u003e listColumns(BusinessTable businessTable);\n\n\n    /**\n     * 根据表集合查询字段列表，并且进行分组\n     * @param tables 表集合\n     * @return 分组后的字段列表\n     * @since 1.4.4\n     */\n    Map\u003cString,List\u003cBusinessColumn\u003e\u003e mapByTables(List\u003cBusinessTable\u003e tables",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 47
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/knowledge/impl/KnowledgeCategoryServiceImpl.java",
      "timestamp": 1761236769002,
      "startOffset": 1979,
      "endOffset": 13361,
      "codeContent": "infra.web.i18n.I18nMessage;\nimport com.torchv.infra.common.extra.log.LogContext;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.time.LocalDateTime;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.function.Function;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/4/22 19:26\n * @since torchv_server v1.7.2\n */\n@Service\n@Slf4j\n@AllArgsConstructor\npublic class KnowledgeCategoryServiceImpl implements KnowledgeCategoryService {\n    \n    final I18nMessage i18nMessage;\n    final SaasKnowledgeCategoryMapper saasKnowledgeCategoryMapper;\n    final SaasKnowledgeContainerMapper saasKnowledgeContainerMapper;\n    \n    @Override\n    public Optional\u003cSaasKnowledgeCategory\u003e queryByCode(String code, String tenantId) {\n        log.info(\"根据code查询分类,code:{},tenantId:{}\", code, tenantId);\n        LambdaQueryWrapper\u003cSaasKnowledgeCategory\u003e lambdaQueryWrapper \u003d\n                Wrappers.lambdaQuery(SaasKnowledgeCategory.class).eq(SaasKnowledgeCategory::getCode, code).eq(SaasKnowledgeCategory::getTenantId, tenantId);\n        SaasKnowledgeCategory saasKnowledgeCategory \u003d saasKnowledgeCategoryMapper.selectOne(lambdaQueryWrapper, false);\n        return Optional.ofNullable(saasKnowledgeCategory);\n    }\n    \n    @Override\n    public Optional\u003cSaasKnowledgeCategory\u003e queryByCode(String code) {\n        log.info(\"根据code查询分类,code:{}\", code);\n        LambdaQueryWrapper\u003cSaasKnowledgeCategory\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeCategory.class).eq(SaasKnowledgeCategory::getCode, code);\n        SaasKnowledgeCategory saasKnowledgeCategory \u003d saasKnowledgeCategoryMapper.selectOne(lambdaQueryWrapper, false);\n        return Optional.ofNullable(saasKnowledgeCategory);\n    }\n    \n    /**\n     * 分页查询-知识分类列表数据\n     * @param knowledgeCategoryQueryReq 查询条件Vo\n     * @param pageNo 当前页码\n     * @param pageSize 每页页码大小\n     * @return 知识分类列表\n     */\n    @Override\n    public Pagination\u003cKnowledgeCategoryResp\u003e list(KnowledgeCategoryQueryReq knowledgeCategoryQueryReq, Integer pageNo, Integer pageSize) {\n        log.info(\"分页查询知识分类列表,pageNo:{},pageSize:{}\", pageNo, pageSize);\n        log.info(\"分页QueryReq:{}\", knowledgeCategoryQueryReq.toString());\n        Page\u003cSaasKnowledgeCategory\u003e saasKnowledgeCategoryPageNo \u003d PageHelper.startPage(pageNo, pageSize);\n        LambdaQueryWrapper\u003cSaasKnowledgeCategory\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeCategory.class).eq(SaasKnowledgeCategory::getTenantId, UserContextHolder.getTenantId());\n        if (StrUtil.isNotBlank(knowledgeCategoryQueryReq.getParentCode())) {\n            lambdaQueryWrapper.eq(SaasKnowledgeCategory::getParentCode, knowledgeCategoryQueryReq.getParentCode());\n        }\n        if (StrUtil.isNotBlank(knowledgeCategoryQueryReq.getName())) {\n            lambdaQueryWrapper.like(SaasKnowledgeCategory::getName, knowledgeCategoryQueryReq.getName());\n        }\n        List\u003cSaasKnowledgeCategory\u003e saasKnowledgeCategoryInfos \u003d saasKnowledgeCategoryMapper.selectList(lambdaQueryWrapper);\n        List\u003cKnowledgeCategoryResp\u003e knowledgeCategoryRespInfos \u003d new ArrayList\u003c\u003e();\n        long count \u003d saasKnowledgeCategoryPageNo.getTotal();\n        if (CollectionUtil.isNotEmpty(saasKnowledgeCategoryInfos)) {\n            knowledgeCategoryRespInfos.addAll(saasKnowledgeCategoryInfos.stream().map(new SaasKnowledgeCategoryApplyFunction()).toList());\n        }\n        return Pagination.pagination(knowledgeCategoryRespInfos, count, pageNo, pageSize);\n    }\n    /**\n     * 新增知识分类记录\n     * @param knowledgeCategoryAddReq 新增知识分类条件Vo\n     * @return 是否新增成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e add(KnowledgeCategoryAddReq knowledgeCategoryAddReq) {\n        log.info(\"新增知识分类数据,Vo:{}\", knowledgeCategoryAddReq.toString());\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        LogContext.putVariable(\"name\", knowledgeCategoryAddReq.getName());\n        \n        // 检查同名分类是否存在\n        boolean nameExists \u003d this.checkNameExists(knowledgeCategoryAddReq.getName(), sysUserInfo.getTenantId(), knowledgeCategoryAddReq.getParentCode(), null);\n        Assert.isTrue(!nameExists, \"knowledge.category.add.name.exists\");\n        \n        SaasKnowledgeCategory saasKnowledgeCategory \u003d new SaasKnowledgeCategory();\n        BeanUtils.copyProperties(knowledgeCategoryAddReq, saasKnowledgeCategory);\n        // parentCode默认为0,判断父编码\n        if (StrUtil.equalsIgnoreCase(knowledgeCategoryAddReq.getParentCode(), \"0\")) {\n            saasKnowledgeCategory.setGrade(1);\n        } else {\n            // 查询父编码\n            Optional\u003cSaasKnowledgeCategory\u003e categoryOptional \u003d this.queryByCode(knowledgeCategoryAddReq.getParentCode(), sysUserInfo.getTenantId());\n            if (categoryOptional.isEmpty()) {\n                throw new IllegalArgumentException(\"knowledge.category.add.parentCode.not.exists\");\n            }\n            int grade \u003d categoryOptional.get().getGrade() + 1;\n            Assert.isTrue(grade \u003c 4, \"knowledge.category.add.validation.grade\");\n            saasKnowledgeCategory.setGrade(grade);\n        }\n        // 设置编码\n        saasKnowledgeCategory.setCode(IdUtil.getSnowflakeNextIdStr());\n        saasKnowledgeCategory.setCreateTime(LocalDateTime.now());\n        saasKnowledgeCategory.setCreator(Objects.toString(sysUserInfo.getId()));\n        saasKnowledgeCategory.setModifier(Objects.toString(sysUserInfo.getId()));\n        saasKnowledgeCategory.setModifierTime(LocalDateTime.now());\n        saasKnowledgeCategory.setTenantId(sysUserInfo.getTenantId());\n        int ret \u003d saasKnowledgeCategoryMapper.insert(saasKnowledgeCategory);\n        return i18nMessage.add(ret);\n    }\n    \n    /**\n     * 更新知识分类记录\n     * @param knowledgeCategoryUpdateReq 更新知识分类条件Vo\n     * @return 是否更新成功\n     */\n    @Override\n    public Result\u003cString\u003e update(KnowledgeCategoryUpdateReq knowledgeCategoryUpdateReq) {\n        log.info(\"根据主键id修改知识分类数据,Vo:{}\", knowledgeCategoryUpdateReq.toString());\n        LogContext.putVariable(\"name\", knowledgeCategoryUpdateReq.getName());\n        SaasKnowledgeCategory record \u003d saasKnowledgeCategoryMapper.selectById(knowledgeCategoryUpdateReq.getId());\n        Assert.notNull(record, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(record.getTenantId(), UserContextHolder.getTenantId()), \"system.common.request.invalid\");\n        \n        // 检查同名分类是否存在（排除当前记录）\n        boolean nameExists \u003d this.checkNameExists(knowledgeCategoryUpdateReq.getName(), record.getTenantId(), record.getParentCode(), knowledgeCategoryUpdateReq.getId());\n        Assert.isTrue(!nameExists, \"knowledge.category.add.name.exists\");\n        \n        SaasKnowledgeCategory saasKnowledgeCategory \u003d new SaasKnowledgeCategory();\n        BeanUtils.copyProperties(knowledgeCategoryUpdateReq, saasKnowledgeCategory);\n        saasKnowledgeCategory.setModifierTime(LocalDateTime.now());\n        int ret \u003d saasKnowledgeCategoryMapper.updateById(saasKnowledgeCategory);\n        return i18nMessage.update(ret);\n    }\n    \n    /**\n     * 根据id查询知识分类详情\n     * @param id 知识分类主键id\n     * @return 知识分类详情\n     */\n    @Override\n    public Result\u003cKnowledgeCategoryResp\u003e queryById(Integer id) {\n        log.info(\"根据主键id查询知识分类详情,Id:{}\", id);\n        SaasKnowledgeCategory record \u003d saasKnowledgeCategoryMapper.selectById(id);\n        Assert.notNull(record, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(record.getTenantId(), UserContextHolder.getTenantId()), \"system.common.request.invalid\");\n        KnowledgeCategoryResp knowledgeCategoryResp \u003d new KnowledgeCategoryResp();\n        BeanUtils.copyProperties(record, knowledgeCategoryResp);\n        return Result.data(knowledgeCategoryResp);\n    }\n    \n    /**\n     * 根据主键id批量删除知识分类\n     * @param ids 批量删除主键id集合\n     * @return 是否删除成功\n     */\n    @Override\n    public Result\u003cString\u003e delete(List\u003cInteger\u003e ids) {\n        log.info(\"批量删除知识分类,pageSize:{}\", CollectionUtil.size(ids));\n        int ret \u003d saasKnowledgeCategoryMapper.deleteBatchIds(ids);\n        return i18nMessage.del(ret);\n    }\n    \n    /**\n     * 根据主键id删除知识分类\n     * @param id 主键id\n     * @return 是否删除成功\n     */\n    @Override\n    public Result\u003cString\u003e delete(Integer id) {\n        log.info(\"根据主键id删除知识分类,id:{}\", id);\n        SaasKnowledgeCategory record \u003d saasKnowledgeCategoryMapper.selectById(id);\n        Assert.notNull(record, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(record.getTenantId(), UserContextHolder.getTenantId()), \"system.common.request.invalid\");\n        LogContext.putVariable(\"name\", record.getName());\n        long childrenCount \u003d this.countChildren(record.getCode(), record.getTenantId());\n        Assert.isTrue(childrenCount \u003c\u003d 0, \"knowledge.category.delete.validation.children\");\n        int ret \u003d saasKnowledgeCategoryMapper.deleteById(id);\n        if (ret \u003e 0) {\n            ContainerClassifyCondition classifyCondition \u003d new ContainerClassifyCondition();\n            classifyCondition.setClassifyCode(record.getCode());\n            classifyCondition.setTenantId(record.getTenantId());\n            // 更新知识库容器的分类编码\n            saasKnowledgeContainerMapper.updateClassifyCode(classifyCondition);\n        }\n        return i18nMessage.del(ret);\n    }\n    \n    /**\n     * 根据id查询知识分类实体详情\n     * @param id 主键id\n     * @return 知识分类的Optional\n     */\n    @Override\n    public Optional\u003cSaasKnowledgeCategory\u003e queryInfoById(Integer id) {\n        log.info(\"根据请求id查询知识分类实体详情,id:{}\", id);\n        SaasKnowledgeCategory saasKnowledgeCategory \u003d saasKnowledgeCategoryMapper.selectById(id);\n        if (saasKnowledgeCategory !\u003d null) {\n            return Optional.of(saasKnowledgeCategory);\n        }\n        return Optional.empty();\n    }\n    \n    @Override\n    public long countChildren(String code, String tenantId) {\n        log.info(\"根据id查询知识分类子分类数量,code:{}\", code);\n        return saasKnowledgeCategoryMapper\n                .selectCount(Wrappers.lambdaQuery(SaasKnowledgeCategory.class).eq(SaasKnowledgeCategory::getTenantId, tenantId).eq(SaasKnowledgeCategory::getParentCode, code));\n    }\n    \n    /**\n     * 校验请求id是否非法\n     * @param id 主键id\n     * @return 是否存在\n     */\n    @Override\n    public boolean checkIdExists(Integer id) {\n        log.info(\"校验请求Id是否存在,id:{}\", id);\n        return saasKnowledgeCategoryMapper.selectById(id) !\u003d null;\n    }\n    \n    /**\n     * 检查同名分类是否存在\n     * @param name 分类名称\n     * @param tenantId 租户ID\n     * @param parentCode 父编码\n     * @param excludeId 排除的ID（更新时使用）\n     * @return 是否存在同名分类\n     */\n    private boolean checkNameExists(String name, String tenantId, String parentCode, Integer excludeId) {\n        LambdaQueryWrapper\u003cSaasKnowledgeCategory\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeCategory.class)\n                .eq(SaasKnowledgeCategory::getName, name)\n                .eq(SaasKnowledgeCategory::getTenantId, tenantId)\n                .eq(SaasKnowledgeCategory::getParentCode, parentCode);\n        \n        if (excludeId !\u003d null) {\n            lambdaQueryWrapper.ne(SaasKnowledgeCategory::getId, excludeId);\n        }\n        \n        return saasKnowledgeCategoryMapper.selectCount(lambdaQueryWrapper) \u003e 0",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 244
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/knowledge/impl/KnowledgeChunkSortServiceImpl.java",
      "timestamp": 1761236769010,
      "startOffset": 827,
      "endOffset": 8539,
      "codeContent": "embedding.pojo.UniversalReRankerConfig;\nimport com.torchv.application.knowledge.domain.embedding.pojo.UniversalReRankerRequest;\nimport com.torchv.application.knowledge.domain.embedding.pojo.UniversalReRankerResponse;\nimport com.torchv.application.knowledge.domain.knowledge.KnowledgeChunkSortService;\nimport com.torchv.application.knowledge.model.request.knowledge.KnowledgeChunkSortParagraphReq;\nimport com.torchv.application.knowledge.model.request.knowledge.KnowledgeChunkSortReq;\nimport com.torchv.application.knowledge.model.response.knowledge.ChunkSortParagraph;\nimport com.torchv.application.knowledge.model.response.knowledge.KnowledgeChunkSort;\nimport com.torchv.application.knowledge.model.response.knowledge.KnowledgeChunkSortParagraphResp;\nimport com.torchv.application.knowledge.model.response.knowledge.KnowledgeChunkSortResp;\nimport com.torchv.application.system.service.ModelProviderService;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.model.Result;\nimport com.torchv.infra.rag.rerank.UniversalReRankerService;\nimport com.torchv.infra.web.spring.properties.ChatBotConfig;\nimport com.torchv.infra.vector.model.dataset.DataSetScoreChunkInfo;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.context.ApplicationContext;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.stereotype.Service;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/6/21 13:32\n * @since torchv_server v1.7.6\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class KnowledgeChunkSortServiceImpl implements KnowledgeChunkSortService {\n    \n    final ChatBotConfig chatBotConfig;\n    final StringRedisTemplate stringRedisTemplate;\n    final ApplicationContext applicationContext;\n    final ModelProviderService modelProviderService;\n    final UniversalReRankerService universalReRankerService;\n\n    @Override\n    public Result\u003cKnowledgeChunkSortResp\u003e sort(KnowledgeChunkSortReq sortReq) {\n        log.info(\"进行知识库chunk排序\");\n        int chunkSize \u003d CollUtil.size(sortReq.getChunks());\n        // 判断chunk数量\n        if (chunkSize \u003c\u003d 1) {\n            return Result.data(sortReq.defaultResult(false));\n        }\n        // rerank成功\n        String cacheKey \u003d sortReq.cacheKey();\n        String value \u003d stringRedisTemplate.opsForValue().get(cacheKey);\n        // 从缓存中获取结果\n        if (StrUtil.isNotBlank(value)) {\n            Optional\u003cKnowledgeChunkSortResp\u003e respOptional \u003d KnowledgeChunkSortResp.of(value);\n            if (respOptional.isPresent()) {\n                return Result.data(respOptional.get());\n            }\n        }\n        // 进行重排序\n        List\u003cDataSetScoreChunkInfo\u003e chunkInfos \u003d sortReq.toChunk();\n\n        // 组装用户问句，对召回对内容进行ReRank\n        List\u003cString\u003e  models\u003dmodelProviderService.availableReRankerModels(UserContextHolder.getTenantId());\n        if (CollUtil.isNotEmpty(models)){\n            Optional\u003cUniversalReRankerConfig\u003e reRankerConfigOptional \u003d modelProviderService\n                    .loadReRanker(models.get(0));\n            if (reRankerConfigOptional.isPresent()) {\n                UniversalReRankerConfig reRankerConfig \u003d reRankerConfigOptional.get();\n\n                        // 构建参数\n                UniversalReRankerRequest request \u003d universalReRankerService.build(reRankerConfig,\n                        sortReq.getQuery(), chunkInfos);\n                // reranker请求\n                UniversalReRankerResponse reRankResponse \u003d universalReRankerService.rerank(reRankerConfig, request);\n                // 获取重排序的片段信息,这里设置一个最小的分值\n                List\u003cDataSetScoreChunkInfo\u003e results \u003d universalReRankerService.result(reRankResponse, chunkInfos, 0f);\n                KnowledgeChunkSortResp result \u003d new KnowledgeChunkSortResp();\n                result.setSorted(true);\n                result.setQuery(sortReq.getQuery());\n                for (DataSetScoreChunkInfo chunkInfo : results) {\n                    result.add(KnowledgeChunkSort.of(chunkInfo.getContent(), chunkInfo.getNormalizedScore()));\n                }\n                String cacheValue \u003d result.toJson();\n                // 缓存10分钟\n                stringRedisTemplate.opsForValue().set(cacheKey, cacheValue, 10, TimeUnit.MINUTES);\n                return Result.data(result);\n            }else {\n                // rerank失败，通过hanlp的工具离线计算距离\n                return Result.data(sortReq.defaultResult(false));\n            }\n        }else {\n            // rerank失败，通过hanlp的工具离线计算距离\n            return Result.data(sortReq.defaultResult(false));\n        }\n\n    }\n    \n    @Override\n    public Result\u003cKnowledgeChunkSortParagraphResp\u003e sortParagraph(KnowledgeChunkSortParagraphReq sortReq) {\n        log.info(\"进行知识库Paragraph排序\");\n        int chunkSize \u003d CollUtil.size(sortReq.getChunks());\n        // 判断chunk数量\n        if (chunkSize \u003c\u003d 1) {\n            return Result.data(sortReq.defaultResult(false));\n        }\n        // rerank成功\n        String cacheKey \u003d sortReq.cacheKey();\n        log.info(\"cacheKey:{}\", cacheKey);\n        String value \u003d stringRedisTemplate.opsForValue().get(cacheKey);\n        // 从缓存中获取结果\n        if (StrUtil.isNotBlank(value)) {\n            Optional\u003cKnowledgeChunkSortParagraphResp\u003e respOptional \u003d KnowledgeChunkSortParagraphResp.of(value);\n            if (respOptional.isPresent()) {\n                return Result.data(respOptional.get());\n            }\n        }\n        // 进行重排序\n        List\u003cDataSetScoreChunkInfo\u003e chunkInfos \u003d sortReq.toChunk();\n\n\n        // 组装用户问句，对召回对内容进行ReRank\n        List\u003cString\u003e  models\u003dmodelProviderService.availableReRankerModels(UserContextHolder.getTenantId());\n        if (CollUtil.isNotEmpty(models)){\n            Optional\u003cUniversalReRankerConfig\u003e reRankerConfigOptional \u003d modelProviderService\n                    .loadReRanker(models.get(0));\n            if (reRankerConfigOptional.isPresent()) {\n                UniversalReRankerConfig reRankerConfig \u003d reRankerConfigOptional.get();\n                // 构建参数\n                UniversalReRankerRequest request \u003d universalReRankerService.build(reRankerConfig,\n                        sortReq.getQuery(), chunkInfos);\n                // reranker请求\n                UniversalReRankerResponse reRankResponse \u003d universalReRankerService.rerank(reRankerConfig, request);\n                // 获取重排序的片段信息,这里设置一个最小的分值\n                List\u003cDataSetScoreChunkInfo\u003e results \u003d universalReRankerService.result(reRankResponse, chunkInfos, 0f);\n                Map\u003cString, ChunkSortParagraph\u003e sortParagraphMap \u003d sortReq.map();\n                for (DataSetScoreChunkInfo chunkInfo : results) {\n                    String mapKey \u003d chunkInfo.mapKey();\n                    if (sortParagraphMap.containsKey(mapKey)) {\n                        sortParagraphMap.get(mapKey).setScore(chunkInfo.getNormalizedScore());\n                    }\n                }\n\n                KnowledgeChunkSortParagraphResp result \u003d new KnowledgeChunkSortParagraphResp();\n                result.setSorted(true);\n                result.setQuery(sortReq.getQuery());\n                for (ChunkSortParagraph chunk : sortParagraphMap.values()) {\n                    result.add(chunk);\n                }\n                // 对result进行排序\n                result.sort();\n                String cacheValue \u003d result.toJson();\n                // 缓存10分钟\n                stringRedisTemplate.opsForValue().set(cacheKey, cacheValue, 10, TimeUnit.MINUTES);\n                return Result.data(result);\n            }else {\n                // rerank失败，通过hanlp的工具离线计算距离\n                return Result.data(sortReq.defaultResult(false));\n            }\n        }",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 162
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/knowledge/impl/KnowledgeElementServiceImpl.java",
      "timestamp": 1761236769027,
      "startOffset": 1210,
      "endOffset": 180089,
      "codeContent": "MessageCodeEnum;\nimport com.torchv.common.constant.enums.system.ToggleStatusEnum;\nimport com.torchv.common.constant.kb.*;\nimport com.torchv.common.exception.supplier.BizExceptionSupplier;\nimport com.torchv.common.extra.filter.ThreadLocalHolder;\nimport com.torchv.common.utils.unit.DataSizeUtil;\nimport cn.hutool.core.lang.Assert;\nimport cn.hutool.core.util.IdUtil;\nimport cn.hutool.core.util.StrUtil;\nimport cn.hutool.crypto.digest.MD5;\nimport com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;\nimport com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;\nimport com.baomidou.mybatisplus.core.toolkit.ObjectUtils;\nimport com.baomidou.mybatisplus.core.toolkit.Wrappers;\nimport com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;\nimport com.github.pagehelper.Page;\nimport com.github.pagehelper.PageHelper;\nimport com.torchv.application.billing.service.BillingSubscribeAccountService;\nimport com.torchv.application.knowledge.domain.embedding.pojo.DataSetChunkCallbackReq;\nimport com.torchv.application.knowledge.domain.embedding.pojo.DataSetChunkSubmitModel;\nimport com.torchv.application.knowledge.domain.embedding.pojo.UniversalEmbeddingConfig;\nimport com.torchv.application.knowledge.domain.knowledge.*;\nimport com.torchv.application.knowledge.domain.knowledge.pojo.*;\nimport com.torchv.application.knowledge.model.dto.queue.MessageFileConvertReq;\nimport com.torchv.application.knowledge.model.request.KnowledgeElementTreeResp;\nimport com.torchv.application.knowledge.model.request.PageVersionRestoreReq;\nimport com.torchv.application.knowledge.model.request.knowledge.*;\nimport com.torchv.application.knowledge.model.response.SaasKnowledgeElementCacheInfo;\nimport com.torchv.application.knowledge.model.response.knowledge.KnowledgeElementResp;\nimport com.torchv.application.knowledge.model.response.knowledge.BatchOperationResult;\nimport com.torchv.application.knowledge.service.KnowledgeElementTrendService;\nimport com.torchv.application.knowledge.vo.SaasKnowledgeElementTrendAddReq;\nimport com.torchv.application.operation.model.resp.MaterialInfoResp;\nimport com.torchv.application.operation.service.MaterialService;\nimport com.torchv.application.store.model.req.ChatKnowledgeUploadReq;\nimport com.torchv.application.user.service.UserService;\nimport com.torchv.common.constant.Cns;\nimport com.torchv.common.constant.dataset.DocTimeStatus;\nimport com.torchv.common.constant.enums.ErrorCodeEnum;\nimport com.torchv.common.constant.enums.file.ProcessStatusEnum;\nimport com.torchv.common.constant.knowledge.*;\nimport com.torchv.infra.common.constant.knowledge.DataSetFileCategory;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.exception.BizException;\nimport com.torchv.infra.common.extra.log.LogContext;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.common.utils.GsonUtils;\nimport com.torchv.infra.common.utils.MarkdownUtils;\nimport com.torchv.common.utils.WebUtil;\nimport com.torchv.infra.common.utils.SQLUtils;\nimport com.torchv.kb.admin.model.dto.DepartmentUserOrgPermissions;\nimport com.torchv.kb.admin.service.KbDepartmentUserService;\nimport com.torchv.kb.common.constant.KbEventMessageTypes;\nimport com.torchv.kb.page.model.request.KnowledgeElementContentUpdateReq;\nimport com.torchv.kb.page.model.request.KnowledgeElementAddReq;\nimport com.torchv.kb.page.model.request.SaasKnowledgeElementIssueContext;\nimport com.torchv.kb.page.model.response.KbPageCreateInfoResp;\nimport com.torchv.kb.page.service.KbPageEventService;\nimport com.torchv.kb.page.service.KbPageTemplateService;\nimport com.torchv.kb.space.model.vo.SaasKnowledgeConfigElementAddReq;\nimport com.torchv.kb.space.service.KbSpaceUserService;\nimport com.torchv.kb.space.service.SaasKnowledgeConfigContainerService;\nimport com.torchv.kb.space.service.SaasKnowledgeConfigElementService;\nimport com.torchv.infra.vector.VectorIndexDelegate;\nimport com.torchv.infra.vector.model.UpdateReference;\nimport com.torchv.infra.vector.model.dataset.DataSetChunkInfo;\nimport com.torchv.kb.space.service.SaasKnowledgeContainerPermissionService;\nimport com.torchv.repository.chat.dto.ElementFilterSearchCondition;\nimport com.torchv.repository.chat.dto.ElementSearchCondition;\nimport com.torchv.repository.chat.entity.SaasKnowledgeContainer;\nimport com.torchv.repository.chat.entity.SaasKnowledgeElement;\nimport com.torchv.repository.chat.entity.SaasKnowledgeElementVersion;\nimport com.torchv.repository.chat.mapper.SaasKnowledgeContainerMapper;\nimport com.torchv.repository.chat.mapper.SaasKnowledgeElementMapper;\nimport com.torchv.repository.database.entity.BusinessColumn;\nimport com.torchv.repository.database.entity.BusinessTable;\nimport com.torchv.repository.kb.entity.SaasKnowledgeConfigContainer;\nimport com.torchv.repository.kb.entity.SaasKnowledgeConfigElement;\nimport com.torchv.repository.kb.page.dto.KbPageCreateInfo;\nimport com.torchv.repository.kb.page.dto.PageSnapshotSearchReq;\nimport com.torchv.repository.kb.page.entity.KbPageEvent;\nimport com.torchv.repository.kb.page.mapper.SaasKnowledgeElementVersionMapper;\nimport com.torchv.infra.web.i18n.I18nMessage;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.redisson.api.RLock;\nimport org.redisson.api.RedissonClient;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.io.File;\nimport java.io.IOException;\nimport java.math.BigDecimal;\nimport java.math.RoundingMode;\nimport java.net.URL;\nimport java.nio.charset.StandardCharsets;\nimport java.time.LocalDateTime;\nimport java.time.ZoneId;\nimport java.time.format.DateTimeFormatter;\nimport java.time.format.DateTimeParseException;\nimport java.time.temporal.ChronoUnit;\nimport java.util.*;\nimport java.util.concurrent.TimeUnit;\nimport java.util.concurrent.atomic.AtomicInteger;\nimport java.util.concurrent.atomic.AtomicLong;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\n/**\n * 知识库元素模块-业务Service实现\n * @since torchv_server v0.1-beta.1\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/01/03 11:44\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class KnowledgeElementServiceImpl extends ServiceImpl\u003cSaasKnowledgeElementMapper, SaasKnowledgeElement\u003e implements KnowledgeElementService {\n\n    final SaasKnowledgeElementMapper saasKnowledgeElementMapper;\n    final SaasKnowledgeContainerMapper saasKnowledgeContainerMapper;\n    final SaasKnowledgeElementVersionMapper saasKnowledgeElementVersionMapper;\n    final StringRedisTemplate stringRedisTemplate;\n    final MaterialService materialService;\n    final KnowledgeSimilarService knowledgeSimilarService;\n    final KnowledgeReferenceService knowledgeReferenceService;\n    final KnowledgeStorageService knowledgeStorageService;\n    final BillingSubscribeAccountService billingSubscribeAccountService;\n    final RedissonClient redissonClient;\n    final VectorIndexDelegate vectorIndexDelegate;\n    final I18nMessage i18nMessage;\n    final KnowledgeValidationService knowledgeValidationService;\n    final KnowledgeElementProcessService knowledgeElementProcessService;\n    final SaasKnowledgeConfigElementService saasKnowledgeConfigElementService;\n    final SaasKnowledgeConfigContainerService saasKnowledgeConfigContainerService;\n    final UserService userService;\n    final SaasKnowledgeContainerPermissionService saasKnowledgeContainerPermissionService;\n    final KnowledgeElementVersionService knowledgeElementVersionService;\n    final KbPageTemplateService kbPageTemplateService;\n    final KnowledgeElementTrendService saasKnowledgeElementTrendService;\n    final KbSpaceUserService kbSpaceUserService;\n    final KnowledgeContainerCapacityDataService knowledgeContainerCapacityDataService;\n    final KnowledgeElementDataService knowledgeElementDataService;\n    final KnowledgeElementEmbeddingQueryService knowledgeElementEmbeddingQueryService;\n    final KbPageEventService kbPageEventService;\n    final KbDepartmentUserService kbDepartmentUserService;\n    final KnowledgeContainerQueryService knowledgeContainerQueryService;\n\n    final MD5 md5 \u003d MD5.create();\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e importWebs(KnowledgeElementBatchWebReq webReq) {\n        log.info(\"批量导入web集合\");\n        webReq.validateWebUrl();\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 校验知识库文件\n        knowledgeValidationService.validateFileBase(webReq, sysUserInfo.getTenantId());\n        // 每个网页按1KB计算\n        long totalSpace \u003d webReq.getUrls().size() * 1024L;\n        // 校验上传流量空间\n        Assert.isTrue(billingSubscribeAccountService.validateAvailableStorage(sysUserInfo.getTenantId(), totalSpace), \"knowledge.preview.upload.limit\");\n        List\u003cSaasKnowledgeElement\u003e saasKnowledgeElements \u003d webReq.of(sysUserInfo);\n        return this.lockBatchFile(saasKnowledgeElements, sysUserInfo.getTenantId(), totalSpace, new ArrayList\u003c\u003e(), webReq.getContainerId());\n    }\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e importFiles(KnowledgeElementBatchFileReq batchFileReq, MultipartFile[] multipartFiles) {\n        Assert.notEmpty(multipartFiles, \"system.common.request.invalid\");\n        log.info(\"批量导入paas层接口文件，数量:{}\", multipartFiles.length);\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 校验知识库文件\n        knowledgeValidationService.validateFileBase(batchFileReq, sysUserInfo.getTenantId());\n        FileValidationResult fileValidationResult \u003d knowledgeValidationService.files(multipartFiles);\n        // 总流量\n        long totalSpace \u003d fileValidationResult.getTotalSpace().get();\n        // 校验上传流量空间\n        Assert.isTrue(billingSubscribeAccountService.validateAvailableStorage(sysUserInfo.getTenantId(), totalSpace), \"knowledge.preview.upload.limit\");\n        List\u003cSaasKnowledgeElement\u003e saasKnowledgeElements \u003d new ArrayList\u003c\u003e();\n        for (MultipartFile file : multipartFiles) {\n            FileMetadata fileMetadata \u003d fileValidationResult.fileMeta(file);\n            // 上传\n            MaterialInfoResp material \u003d materialService.save(file, fileMetadata.getMd5(), sysUserInfo.getTenantId());\n            saasKnowledgeElements.add(batchFileReq.of(file, sysUserInfo, fileValidationResult, material.getFileUrl()));\n        }\n        return this.lockBatchFile(saasKnowledgeElements, sysUserInfo.getTenantId(), totalSpace, new ArrayList\u003c\u003e(), batchFileReq.getContainerId());\n    }\n\n    @Override\n    public Result\u003cString\u003e getElementContent(Integer id) {\n        Assert.notNull(id, \"system.common.request.invalid\");\n        SaasKnowledgeElement element \u003d saasKnowledgeElementMapper.selectById(id);\n        Assert.notNull(element, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equals(element.getTenantId(), UserContextHolder.getTenantId()), \"system.common.request.invalid\");\n        return Result.data(vectorIndexDelegate.getContent(element.getTenantId(), element.getCode(), element.getContainerId()));\n    }\n\n    @Override\n    public Long countContainerSize(String tenantId, String containerId) {\n        log.info(\"统计知识库容量大小，tenant:{},containerId:{}\", tenantId, containerId);\n        return saasKnowledgeElementMapper.sumContainerSize(tenantId, containerId);\n    }\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public void addKnowledge(BusinessTable table, List\u003cBusinessColumn\u003e columns, SysUserInfo sysUserInfo, String containerId) {\n        // 将当前的表格信息+字段列表信息，全部保存成txt文本，方便后续向量化处理\n        String tableContent \u003d SQLUtils.toTxt(table, columns);\n        // 插入一条知识文件信息，类型是Table\n        SaasKnowledgeElement element \u003d new SaasKnowledgeElement();\n        File tableFile \u003d null;\n        try {\n            tableFile \u003d File.createTempFile(\"table_source\", \".txt\");\n            FileUtil.writeString(tableContent, tableFile, StandardCharsets.UTF_8);\n            // 上传文件\n            String md5_str \u003d MD5.create().digestHex16(tableContent);\n            MaterialInfoResp materialInfoResp \u003d materialService.save(tableFile, md5_str, sysUserInfo.getTenantId());\n            // 上传成功\n            String ossUrl \u003d materialInfoResp.getFileUrl();\n            element.setNeverExpire(DocTimeStatus.NEVER_EXPIRE.getCode());\n            element.setContainerId(table.getContainerId());\n            element.setElePreviewUrl(ossUrl);\n            element.setEleUrl(ossUrl);\n            element.setTenantId(sysUserInfo.getTenantId());\n            element.setEleSuffix(\"txt\");\n            element.setEleName(table.getName());\n            element.setEleMd5(md5_str);\n            element.setEleSize(FileUtil.size(tableFile));\n            // 没有预览功能，该值为空\n            element.setEleTokenSize(0L);\n            element.setCreateTime(LocalDateTime.now());\n            element.setCreator(Objects.toString(sysUserInfo.getId()));\n            element.setModifierTime(LocalDateTime.now());\n            element.setModifier(Objects.toString(sysUserInfo.getId()));\n            element.setProcessStatus(ProcessStatusEnum.INIT.getCode());\n            element.setParentCode(\"0\");\n            // 关联表信息的code\n            element.setCode(table.getCode());\n            element.setPageCount(1);\n            element.setProcessCount(0);\n            element.setYear(0);\n            element.setCategory(KnowledgeElementCategory.TABLE.name());\n            element.setTopic(\"DEFAULT\");\n            element.setChunkCount(0);\n            // 批量导入文本信息\n            this.lockBatchFile(CollUtil.newArrayList(element), sysUserInfo.getTenantId(), element.getEleSize(), new ArrayList\u003c\u003e(), containerId);\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        } finally {\n            FileUtil.del(tableFile);\n        }\n    }\n\n    @Override\n    public Pagination\u003cSaasKnowledgeElement\u003e listChunkFiles(Integer page, Integer size) {\n        // 日期是1年内的文件\n        //LocalDateTime minTime \u003d LocalDateTime.now().minusDays(360L);\n        // 查询待初始化、转换成功的文件列表\n        LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class)\n                .in(SaasKnowledgeElement::getProcessStatus, CollUtil.newArrayList(ProcessStatusEnum.INIT.getCode(), ProcessStatusEnum.CONVERT_SUCCESS.getCode()))\n                .ne(SaasKnowledgeElement::getCategory, KnowledgeElementCategory.DIRECTORY.getName());\n                //.gt(SaasKnowledgeElement::getCreateTime, minTime);\n        try (Page\u003cSaasKnowledgeElement\u003e saasKnowledgeElementPageNo \u003d PageHelper.startPage(page, size)) {\n            List\u003cSaasKnowledgeElement\u003e knowledgeElements \u003d saasKnowledgeElementMapper.selectList(lambdaQueryWrapper);\n            return Pagination.pagination(knowledgeElements, saasKnowledgeElementPageNo.getTotal(), page, size);\n        }\n    }\n\n    @Override\n    public Pagination\u003cSaasKnowledgeElement\u003e listChunkFiles(Integer page, Integer size, ProcessStatusEnum statusEnum) {\n        // 查询待初始化的文件列表\n        LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getProcessStatus, statusEnum.getCode())\n                .ne(SaasKnowledgeElement::getCategory, KnowledgeElementCategory.DIRECTORY.getName());\n        try (Page\u003cSaasKnowledgeElement\u003e saasKnowledgeElementPageNo \u003d PageHelper.startPage(page, size)) {\n            List\u003cSaasKnowledgeElement\u003e knowledgeElements \u003d saasKnowledgeElementMapper.selectList(lambdaQueryWrapper);\n            return Pagination.pagination(knowledgeElements, saasKnowledgeElementPageNo.getTotal(), page, size);\n        }\n    }\n\n    @Override\n    public void callback(DataSetChunkCallbackReq callbackReq) {\n        // 判断process类型\n        if (callbackReq.getBasic() \u003d\u003d null) {\n            return;\n        }\n        try {\n            LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, callbackReq.getBasic().getTenantId())\n                    .eq(SaasKnowledgeElement::getContainerId, callbackReq.getBasic().getContainerId())\n                    .eq(SaasKnowledgeElement::getCode, callbackReq.getBasic().getDataId());\n            SaasKnowledgeElement knowledgeElement \u003d new SaasKnowledgeElement();\n            knowledgeElement.setModifierTime(LocalDateTime.now());\n            knowledgeElement.setProcessCount(callbackReq.getProcessPage());\n            knowledgeElement.setPageCount(callbackReq.getTotalPage());\n            knowledgeElement.setChunkCount(callbackReq.getChunkCounter());\n            if (StrUtil.isNotBlank(callbackReq.getMessage())) {\n                knowledgeElement.setErrorMessage(callbackReq.getMessage());\n            }\n            ProcessStatusEnum processStatusEnum \u003d ProcessStatusEnum.parseByName(callbackReq.getProcessStatus());\n            if (processStatusEnum !\u003d null) {\n                knowledgeElement.setProcessStatus(processStatusEnum.getCode());\n            }\n            saasKnowledgeElementMapper.update(knowledgeElement, lambdaQueryWrapper);\n        } catch (Exception e) {\n            log.error(e.getMessage());\n        }\n    }\n\n    @Override\n    public DataSetChunkSubmitModel buildChunkParams(SaasKnowledgeElement knowledgeElement, String callbackUrl) {\n        // 定时任务只处理文件类型和网页类型\n        Assert.isTrue(StrUtil.equalsIgnoreCase(knowledgeElement.getCategory(), KnowledgeElementCategory.FILE.getName())\n                || StrUtil.equalsIgnoreCase(knowledgeElement.getCategory(), KnowledgeElementCategory.WEB.getName())\n                || StrUtil.equalsIgnoreCase(knowledgeElement.getCategory(), KnowledgeElementCategory.VIRTUAL_FILE.getName()), \"system.common.request.invalid\");\n        DataSetChunkSubmitModel submitModel \u003d new DataSetChunkSubmitModel();\n        submitModel.setCallbackUrl(callbackUrl);\n        submitModel.setOssUrl(knowledgeElement.getEleUrl());\n        submitModel.setDataId(knowledgeElement.getCode());\n        submitModel.setTenantId(knowledgeElement.getTenantId());\n        submitModel.setTimeStatus(knowledgeElement.getNeverExpire());\n        if (knowledgeElement.getStartTime() !\u003d null \u0026\u0026 knowledgeElement.getEndTime() !\u003d null) {\n            submitModel.setStartTime(knowledgeElement.getStartTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());\n            submitModel.setEndTime(knowledgeElement.getEndTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());\n        }\n        submitModel.setYear(knowledgeElement.getYear());\n        submitModel.setFileName(knowledgeElement.getEleName());\n        submitModel.setFileType(knowledgeElement.getEleSuffix());\n        submitModel.setContainerId(knowledgeElement.getContainerId());\n        // 判断是否为网页\n        if (StrUtil.equalsIgnoreCase(knowledgeElement.getCategory(), KnowledgeElementCategory.WEB.getName())) {\n            Optional\u003cDataSetWebConfig\u003e webConfig \u003d GsonUtils.fromJson(knowledgeElement.getConfig(), DataSetWebConfig.class);\n            webConfig.ifPresent(submitModel::apply);\n            // webConfig.ifPresent(w -\u003e submitModel.setSelector(w.getSelector()));\n        }\n        // 租户配置,embedding模型\n        // SaasTenantInfoCacheResp cacheResp \u003d tenantInfoService.getByCode(knowledgeElement.getTenantId());\n\n        Optional\u003cSaasKnowledgeConfigContainer\u003e saasKnowledgeConfigContainer \u003d saasKnowledgeConfigContainerService.queryInfoByContainerId(knowledgeElement.getContainerId());\n        if (saasKnowledgeConfigContainer.isPresent()) {\n            submitModel.setEmbedding(saasKnowledgeConfigContainer.get().getEmbeddingModel());\n        } else {\n            log.error(\"containerId:{} not found\", knowledgeElement.getContainerId());\n            throw new BizException(ErrorCodeEnum.SYSTEM_ERROR);\n        }\n\n        return submitModel;\n    }\n\n    @Override\n    public void updateElementStatus(SaasKnowledgeElement knowledgeElement, ProcessStatusEnum processStatusEnum) {\n        SaasKnowledgeElement element \u003d new SaasKnowledgeElement();\n        element.setId(knowledgeElement.getId());\n        element.setModifierTime(LocalDateTime.now());\n        element.setProcessStatus(processStatusEnum.getCode());\n        saasKnowledgeElementMapper.updateById(element);\n    }\n\n    @Override\n    public void updateConvert(MessageFileConvertReq convertReq, KnowledgeFileConvertResult convertResult) {\n        SaasKnowledgeElement element \u003d new SaasKnowledgeElement();\n        element.setId(convertReq.getDataId());\n        element.setModifierTime(LocalDateTime.now());\n        if (convertResult.getStatusEnum() \u003d\u003d ProcessStatusEnum.CONVERT_SUCCESS) {\n            // 转换成功，才更新相关信息\n            element.setEleUrl(convertResult.getOssUrl());\n            element.setEleSuffix(convertResult.getTargetFormat());\n            // preview地址设置为老的地址\n            element.setElePreviewUrl(convertReq.getOssUrl());\n            element.setProcessStatus(convertResult.getStatusEnum().getCode());\n        } else if (convertResult.getStatusEnum() \u003d\u003d ProcessStatusEnum.PROCESSING) {\n            // Process的状态，代表提交处理成功，此时，不更新processStatus的状态\n            // 转换成功，才更新相关信息\n            element.setEleUrl(convertResult.getOssUrl());\n            element.setEleSuffix(convertResult.getTargetFormat());\n            // preview地址设置为老的地址\n            element.setElePreviewUrl(convertReq.getOssUrl());\n        } else {\n            // 其它状态，可能是失败等状态信息\n            element.setProcessStatus(convertResult.getStatusEnum().getCode());\n        }\n        LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d\n                Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getId, convertReq.getDataId()).eq(SaasKnowledgeElement::getTenantId, convertReq.getTenantId());\n        saasKnowledgeElementMapper.update(element, lambdaQueryWrapper);\n    }\n\n    /**\n     * 分页查询-知识库元素列表数据\n     * @param knowledgeElementQueryReq 查询条件Vo\n     * @param pageNo 当前页码\n     * @param pageSize 每页页码大小\n     * @return 知识库元素列表\n     */\n    @Override\n    public Pagination\u003cKnowledgeElementResp\u003e list(KnowledgeElementQueryReq knowledgeElementQueryReq, Integer pageNo, Integer pageSize) {\n        if (StrUtil.isNotBlank(knowledgeElementQueryReq.getPageCode())){\n            return listWithPath(knowledgeElementQueryReq, pageNo, pageSize);\n        }\n        log.info(\"分页查询知识库元素列表,pageNo:{},pageSize:{}\", pageNo, pageSize);\n        log.info(\"分页QueryReq:{}\", knowledgeElementQueryReq.toString());\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 查询全部列表的\n        DepartmentUserOrgPermissions orgPermissions\u003dkbDepartmentUserService.listAccessibleDepartmentCodes(sysUserInfo);\n\n        LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, sysUserInfo.getTenantId());\n        // 查询条件\n        lambdaQueryWrapper.eq(StrUtil.isNotBlank(knowledgeElementQueryReq.getContainerId()), SaasKnowledgeElement::getContainerId, knowledgeElementQueryReq.getContainerId());\n        lambdaQueryWrapper.eq(StrUtil.isNotBlank(knowledgeElementQueryReq.getParentCode()), SaasKnowledgeElement::getParentCode, knowledgeElementQueryReq.getParentCode());\n        if (StrUtil.isNotBlank(knowledgeElementQueryReq.getCategory())) {\n            List\u003cString\u003e category \u003d StrUtil.split(knowledgeElementQueryReq.getCategory(), StrUtil.COMMA);\n            lambdaQueryWrapper.in(SaasKnowledgeElement::getCategory, category);\n        }\n        lambdaQueryWrapper.like(StrUtil.isNotBlank(knowledgeElementQueryReq.getEleName()), SaasKnowledgeElement::getEleName, knowledgeElementQueryReq.getEleName());\n        // 草稿状态只能自己可见\n        lambdaQueryWrapper.and(l-\u003e{\n            l.ne(SaasKnowledgeElement::getProcessStatus,ProcessStatusEnum.DRAFT.getCode()).or(lf-\u003e{\n                lf.eq(SaasKnowledgeElement::getProcessStatus,ProcessStatusEnum.DRAFT.getCode());\n                lf.eq(SaasKnowledgeElement::getCreator, Objects.toString(sysUserInfo.getCode()));\n            });\n        });\n        // 过滤权限，因为parentCode不为空，那么查询出当前用户不可见的文档编码，然后在进行过滤\n        ElementSearchCondition searchCondition\u003dElementSearchCondition.from(sysUserInfo.getTenantId(),knowledgeElementQueryReq.getContainerId(),knowledgeElementQueryReq.getParentCode(),orgPermissions.permissionCodesToList());\n        List\u003cString\u003e visibleCodes \u003d saasKnowledgeElementMapper.listVisibleCodes(searchCondition);\n        if (CollUtil.isNotEmpty(visibleCodes)){\n            // 继承的权限文档全部可见，然后可见的文档也可见\n            log.info(\"过滤掉不可见的权限code列表，size:{}\",visibleCodes.size());\n            lambdaQueryWrapper.and(lf-\u003e lf.eq(SaasKnowledgeElement::getPermissionStatus,ToggleStatusEnum.YES.getCode()).or(l1-\u003e{\n                l1.eq(SaasKnowledgeElement::getPermissionStatus,ToggleStatusEnum.NO.getCode());\n                l1.in(SaasKnowledgeElement::getCode,visibleCodes);\n            }));\n\n            ///lambdaQueryWrapper.notIn(SaasKnowledgeElement::getCode,notVisibleCodes);\n        }else{\n            // 没有任何可见的文档\n            log.info(\"没有权限，查询继承下来的文档\");\n            lambdaQueryWrapper.eq(SaasKnowledgeElement::getPermissionStatus,ToggleStatusEnum.YES.getCode());\n        }\n        // 设定排序规则\n        SortRules sortRule\u003d SortRules.parse(knowledgeElementQueryReq.getSortRule());\n        if (sortRule\u003d\u003dSortRules.SORT_NUMBER){\n            lambdaQueryWrapper.orderByAsc(SaasKnowledgeElement::getSort);\n        }else if (sortRule\u003d\u003dSortRules.SORT_CREATE_TIME){\n            // 判断倒序还是顺序\n            if (knowledgeElementQueryReq.getSortType()\u003d\u003d0){\n                lambdaQueryWrapper.orderByAsc(SaasKnowledgeElement::getCreateTime);\n            }else{\n                lambdaQueryWrapper.orderByDesc(SaasKnowledgeElement::getCreateTime);\n            }\n        }else if (sortRule\u003d\u003dSortRules.SORT_MODIFY_TIME) {\n            // 判断倒序还是顺序\n            if (knowledgeElementQueryReq.getSortType() \u003d\u003d 0) {\n                lambdaQueryWrapper.orderByAsc(SaasKnowledgeElement::getModifierTime);\n            } else {\n                lambdaQueryWrapper.orderByDesc(SaasKnowledgeElement::getModifierTime);\n            }\n        }else if (sortRule\u003d\u003dSortRules.SORT_TITLE) {\n            // 对于文件名排序，不在数据库层排序，而在内存中进行自定义排序\n            // 这样可以支持按数字前缀排序的需求\n        }\n\n        List\u003cSaasKnowledgeElement\u003e saasKnowledgeElementInfos;\n        List\u003cKnowledgeElementResp\u003e knowledgeElementRespInfos;\n        long count;\n\n        if (sortRule \u003d\u003d SortRules.SORT_TITLE) {\n            // 文件名排序需要在内存中进行，所以先查询所有数据\n            saasKnowledgeElementInfos \u003d saasKnowledgeElementMapper.selectList(lambdaQueryWrapper);\n            count \u003d saasKnowledgeElementInfos.size();\n\n            // 按照文件名进行自定义排序（支持数字前缀排序）\n            saasKnowledgeElementInfos.sort((a, b) -\u003e compareFileName(a.getEleName(), b.getEleName(), knowledgeElementQueryReq.getSortType()));\n\n            // 手动分页\n            int startIndex \u003d (pageNo - 1) * pageSize;\n            int endIndex \u003d Math.min(startIndex + pageSize, saasKnowledgeElementInfos.size());\n            if (startIndex \u003c saasKnowledgeElementInfos.size()) {\n                saasKnowledgeElementInfos \u003d saasKnowledgeElementInfos.subList(startIndex, endIndex);\n            } else {\n                saasKnowledgeElementInfos \u003d new ArrayList\u003c\u003e();\n            }\n\n            knowledgeElementRespInfos \u003d new ArrayList\u003c\u003e();\n        } else {\n            // 其他排序规则使用数据库分页\n            try (Page\u003cSaasKnowledgeElement\u003e saasKnowledgeElementPageNo \u003d PageHelper.startPage(pageNo, pageSize)) {\n                saasKnowledgeElementInfos \u003d saasKnowledgeElementMapper.selectList(lambdaQueryWrapper);\n                knowledgeElementRespInfos \u003d new ArrayList\u003c\u003e();\n                count \u003d saasKnowledgeElementPageNo.getTotal();\n            }\n        }\n        if (CollectionUtil.isNotEmpty(saasKnowledgeElementInfos)) {\n            knowledgeElementRespInfos.addAll(saasKnowledgeElementInfos.stream().map(new SaasKnowledgeElementApplyFunction()).toList());\n            // 批量填充creatorName和modifierName\n            Set\u003cString\u003e userCodes \u003d new HashSet\u003c\u003e();\n            for (KnowledgeElementResp resp : knowledgeElementRespInfos) {\n                userCodes.addAll(resp.userCodes());\n            }\n            if (!userCodes.isEmpty()) {\n                Map\u003cString, String\u003e userMap \u003d userService.selectByCode(new ArrayList\u003c\u003e(userCodes));\n                for (KnowledgeElementResp resp : knowledgeElementRespInfos) {\n                    resp.applyUserName(userMap);\n                }\n            }\n        }\n        return Pagination.pagination(knowledgeElementRespInfos, count, pageNo, pageSize);\n    }\n\n    private Pagination\u003cKnowledgeElementResp\u003e listWithPath(KnowledgeElementQueryReq knowledgeElementQueryReq, Integer pageNo, Integer pageSize) {\n        log.info(\"分页查询知识库元素列表,pageNo:{},pageSize:{}\", pageNo, pageSize);\n        log.info(\"分页QueryReq:{}\", knowledgeElementQueryReq.toString());\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        SaasKnowledgeElement saasKnowledgeElementNode \u003d saasKnowledgeElementMapper.selectOne(Wrappers.lambdaQuery(SaasKnowledgeElement.class).select(SaasKnowledgeElement::getParentCode, SaasKnowledgeElement::getCode).eq(SaasKnowledgeElement::getTenantId, sysUserInfo.getTenantId()).eq(SaasKnowledgeElement::getCode, knowledgeElementQueryReq.getPageCode()));\n        if(saasKnowledgeElementNode \u003d\u003d null){\n            log.info(\"没有找到对应的知识库元素\");\n            return Pagination.empty(pageNo, pageSize);\n        }\n        String permissionType \u003d saasKnowledgeContainerPermissionService.getHighestPermission(knowledgeElementQueryReq.getContainerId(),sysUserInfo);\n        log.info(\"当前用户在容器中的最高权限:{}\",permissionType);\n        // 如果是没权限的角色，那么需要判断当前的知识库是否设置为公开，如果是公开的情况下，那么给予只读角色\n        Optional\u003cSaasKnowledgeContainer\u003e containerOptional \u003d knowledgeContainerQueryService.queryInfoByCode(knowledgeElementQueryReq.getContainerId());\n        if (containerOptional.isEmpty()) {\n            return Pagination.empty(pageNo, pageSize);\n        }\n        boolean canFilter\u003dtrue;\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d containerOptional.get();\n        if ( KbKnowledgeBaseContainerVisibilityRange.publicRead(saasKnowledgeContainer.getVisibilityRange())){\n            // 公开可读\n            canFilter\u003dfalse;\n        }else{\n            // 非公开可读，那么必须有权限才可以查看\n            if (!StrUtil.equalsIgnoreCase(KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode(),permissionType)){\n                // 公开可读\n                canFilter\u003dfalse;\n            }\n        }\n        String parentCode \u003d saasKnowledgeElementNode.getParentCode();\n        // 查询全部列表的\n        DepartmentUserOrgPermissions orgPermissions\u003dkbDepartmentUserService.listAccessibleDepartmentCodes(sysUserInfo);\n        List\u003cKnowledgeElementResp\u003e respInfos \u003d new ArrayList\u003c\u003e();\n        while(StrUtil.isNotBlank(parentCode)) {\n            LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, sysUserInfo.getTenantId());\n            // 查询条件\n            lambdaQueryWrapper.eq(StrUtil.isNotBlank(knowledgeElementQueryReq.getContainerId()), SaasKnowledgeElement::getContainerId, knowledgeElementQueryReq.getContainerId());\n            lambdaQueryWrapper.eq(StrUtil.isNotBlank(parentCode), SaasKnowledgeElement::getParentCode, parentCode);\n            if (StrUtil.isNotBlank(knowledgeElementQueryReq.getCategory())) {\n                List\u003cString\u003e category \u003d StrUtil.split(knowledgeElementQueryReq.getCategory(), StrUtil.COMMA);\n                lambdaQueryWrapper.in(SaasKnowledgeElement::getCategory, category);\n            }\n            lambdaQueryWrapper.like(StrUtil.isNotBlank(knowledgeElementQueryReq.getEleName()), SaasKnowledgeElement::getEleName, knowledgeElementQueryReq.getEleName());\n            // 草稿状态只能自己可见\n            lambdaQueryWrapper.and(l-\u003e{\n                l.ne(SaasKnowledgeElement::getProcessStatus,ProcessStatusEnum.DRAFT.getCode()).or(lf-\u003e{\n                    lf.eq(SaasKnowledgeElement::getProcessStatus,ProcessStatusEnum.DRAFT.getCode());\n                    lf.eq(SaasKnowledgeElement::getCreator, Objects.toString(sysUserInfo.getCode()));\n                });\n            });\n            // 过滤权限，因为parentCode不为空，那么查询出当前用户不可见的文档编码，然后在进行过滤\n            ElementSearchCondition searchCondition\u003dElementSearchCondition.from(sysUserInfo.getTenantId(),knowledgeElementQueryReq.getContainerId(),parentCode,orgPermissions.permissionCodesToList());\n            List\u003cString\u003e visibleCodes \u003d saasKnowledgeElementMapper.listVisibleCodes(searchCondition);\n            if (CollUtil.isNotEmpty(visibleCodes)){\n                // 继承的权限文档全部可见，然后可见的文档也可见\n                log.info(\"过滤掉不可见的权限code列表，size:{}\",visibleCodes.size());\n                lambdaQueryWrapper.and(lf-\u003e lf.eq(SaasKnowledgeElement::getPermissionStatus,ToggleStatusEnum.YES.getCode()).or(l1-\u003e{\n                    l1.eq(SaasKnowledgeElement::getPermissionStatus,ToggleStatusEnum.NO.getCode());\n                    l1.in(SaasKnowledgeElement::getCode,visibleCodes);\n                }));\n\n                ///lambdaQueryWrapper.notIn(SaasKnowledgeElement::getCode,notVisibleCodes);\n            }else{\n                // 没有任何可见的文档\n                log.info(\"没有权限，查询继承下来的文档\");\n                lambdaQueryWrapper.eq(SaasKnowledgeElement::getPermissionStatus,ToggleStatusEnum.YES.getCode());\n            }\n            // 设定排序规则\n            SortRules sortRule\u003d SortRules.parse(knowledgeElementQueryReq.getSortRule());\n            if (sortRule\u003d\u003dSortRules.SORT_NUMBER){\n                lambdaQueryWrapper.orderByAsc(SaasKnowledgeElement::getSort);\n            }else if (sortRule\u003d\u003dSortRules.SORT_CREATE_TIME){\n                // 判断倒序还是顺序\n                if (knowledgeElementQueryReq.getSortType()\u003d\u003d0){\n                    lambdaQueryWrapper.orderByAsc(SaasKnowledgeElement::getCreateTime);\n                }else{\n                    lambdaQueryWrapper.orderByDesc(SaasKnowledgeElement::getCreateTime);\n                }\n            }else if (sortRule\u003d\u003dSortRules.SORT_MODIFY_TIME) {\n                // 判断倒序还是顺序\n                if (knowledgeElementQueryReq.getSortType() \u003d\u003d 0) {\n                    lambdaQueryWrapper.orderByAsc(SaasKnowledgeElement::getModifierTime);\n                } else {\n                    lambdaQueryWrapper.orderByDesc(SaasKnowledgeElement::getModifierTime);\n                }\n            }else if (sortRule\u003d\u003dSortRules.SORT_TITLE) {\n                // 对于文件名排序，不在数据库层排序，而在内存中进行自定义排序\n                // 这样可以支持按数字前缀排序的需求\n            }\n\n            List\u003cSaasKnowledgeElement\u003e saasKnowledgeElementInfos;\n            List\u003cKnowledgeElementResp\u003e knowledgeElementRespInfos;\n\n            if (sortRule \u003d\u003d SortRules.SORT_TITLE) {\n                // 文件名排序需要在内存中进行，所以先查询所有数据\n                saasKnowledgeElementInfos \u003d saasKnowledgeElementMapper.selectList(lambdaQueryWrapper);\n\n                // 按照文件名进行自定义排序（支持数字前缀排序）\n                saasKnowledgeElementInfos.sort((a, b) -\u003e compareFileName(a.getEleName(), b.getEleName(), knowledgeElementQueryReq.getSortType()));\n\n                // 手动分页\n                int startIndex \u003d (pageNo - 1) * pageSize;\n                int endIndex \u003d Math.min(startIndex + pageSize, saasKnowledgeElementInfos.size());\n                if (startIndex \u003c saasKnowledgeElementInfos.size()) {\n                    saasKnowledgeElementInfos \u003d saasKnowledgeElementInfos.subList(startIndex, endIndex);\n                } else {\n                    saasKnowledgeElementInfos \u003d new ArrayList\u003c\u003e();\n                }\n\n                knowledgeElementRespInfos \u003d new ArrayList\u003c\u003e();\n            } else {\n                // 其他排序规则使用数据库分页\n                try (Page\u003cSaasKnowledgeElement\u003e saasKnowledgeElementPageNo \u003d PageHelper.startPage(pageNo, pageSize)) {\n                    saasKnowledgeElementInfos \u003d saasKnowledgeElementMapper.selectList(lambdaQueryWrapper);\n                    knowledgeElementRespInfos \u003d new ArrayList\u003c\u003e();\n                }\n            }\n            if (CollectionUtil.isNotEmpty(saasKnowledgeElementInfos)) {\n                if (canFilter){\n                    // 说明要做过滤，这判断你这个人是否可以看\n                    // 过滤权限，因为parentCode不为空，那么查询出当前用户不可见的文档编码，然后在进行过滤\n                    List\u003cString\u003e elementCodes\u003dsaasKnowledgeElementInfos.stream().map(SaasKnowledgeElement::getCode).toList();\n                    ElementFilterSearchCondition searchFilterCondition\u003d ElementFilterSearchCondition.from(sysUserInfo.getTenantId(),knowledgeElementQueryReq.getContainerId(),elementCodes,orgPermissions.permissionCodesToList());\n                    List\u003cString\u003e visibleFilterCodes \u003d saasKnowledgeElementMapper.listVisibleFilterCodes(searchFilterCondition);\n                    if (CollUtil.isNotEmpty(visibleFilterCodes)){\n                        knowledgeElementRespInfos.addAll(saasKnowledgeElementInfos.stream().filter(s-\u003evisibleFilterCodes.contains(s.getCode())).map(new SaasKnowledgeElementApplyFunction()).toList());\n                    }\n                }else{\n                    knowledgeElementRespInfos.addAll(saasKnowledgeElementInfos.stream().map(new SaasKnowledgeElementApplyFunction()).toList());\n                }\n                // 批量填充creatorName和modifierName\n                Set\u003cString\u003e userCodes \u003d new HashSet\u003c\u003e();\n                for (KnowledgeElementResp resp : knowledgeElementRespInfos) {\n                    userCodes.addAll(resp.userCodes());\n                }\n                if (!userCodes.isEmpty()) {\n                    Map\u003cString, String\u003e userMap \u003d userService.selectByCode(new ArrayList\u003c\u003e(userCodes));\n                    for (KnowledgeElementResp resp : knowledgeElementRespInfos) {\n                        resp.applyUserName(userMap);\n                    }\n                }\n            }\n            if (CollUtil.isNotEmpty(respInfos)){\n                String parentCode1 \u003d respInfos.get(0).getParentCode();\n                for (KnowledgeElementResp info : knowledgeElementRespInfos){\n                    if (StrUtil.equals(info.getCode(), parentCode1)){\n                        info.setChildrens(respInfos);\n                        break;\n                    }\n                }\n            }\n            if (CollUtil.isNotEmpty(knowledgeElementRespInfos)){\n                respInfos\u003dknowledgeElementRespInfos;\n            }\n            if (StrUtil.equalsIgnoreCase(parentCode, \"0\")){\n                break;\n            }\n            SaasKnowledgeElement saasKnowledgeElement \u003d saasKnowledgeElementMapper.selectOne(Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getCode, parentCode));\n            parentCode \u003d saasKnowledgeElement.getParentCode();\n        }\n        long totalCount \u003d respInfos.size();\n\n        return Pagination.pagination(respInfos, totalCount, pageNo, pageSize);\n    }\n\n    /**\n     * 递归获取父级名称链\n     * @param code 当前节点编码\n     * @param tenantId 租户ID\n     * @return 父级名称链\n     */\n    private String buildParentNamesRecursively(String code, String tenantId) {\n        if (StrUtil.isBlank(code) || \"0\".equals(code)) {\n            return \"\";\n        }\n\n        SaasKnowledgeElement element \u003d saasKnowledgeElementMapper.getByCodeAndTenantId(code, tenantId);\n        if (element \u003d\u003d null) {\n            return \"\";\n        }\n\n        String currentName \u003d element.getCode() + \"#\" + element.getEleName();\n        String parentCode \u003d element.getParentCode();\n\n        if (StrUtil.isBlank(parentCode) || \"0\".equals(parentCode)) {\n            return currentName;\n        }\n\n        String parentNames \u003d buildParentNamesRecursively(parentCode, tenantId);\n        if (StrUtil.isBlank(parentNames)) {\n            return currentName;\n        }\n\n        return parentNames + \",\" + currentName;\n    }\n\n    @Override\n    public Result\u003cList\u003cKnowledgeElementResp\u003e\u003e queryParentName(String code) {\n        List\u003cKnowledgeElementResp\u003e results \u003d new ArrayList\u003c\u003e();\n\n        if (StrUtil.isBlank(code) || StrUtil.equalsIgnoreCase(code, \"0\")) {\n            return Result.data(results);\n        }\n\n        // 使用新的递归方法\n        String parentNames \u003d buildParentNamesRecursively(code, UserContextHolder.getTenantId());\n\n        if (StrUtil.isNotBlank(parentNames)) {\n            List\u003cString\u003e arr \u003d StrUtil.split(parentNames, \",\");\n            for (String names : arr) {\n                if (StrUtil.isNotBlank(names)) {\n                    List\u003cString\u003e nameInfo \u003d StrUtil.split(names, \"#\");\n                    if (nameInfo.size() \u003e\u003d 2) {\n                        KnowledgeElementResp resp \u003d new KnowledgeElementResp();\n                        resp.setCode(nameInfo.get(0));\n                        resp.setEleName(nameInfo.get(1));\n                        results.add(resp);\n                    }\n                }\n            }\n        }\n\n        return Result.data(results);\n    }\n\n    /**\n    * 查询所有知识库元素数据\n    */\n    @Override\n    public List\u003cKnowledgeElementResp\u003e listAll() {\n        log.info(\"查询所有知识库元素数据\");\n        List\u003cSaasKnowledgeElement\u003e saasKnowledgeElementInfos \u003d saasKnowledgeElementMapper.selectList(Wrappers.query());\n        List\u003cKnowledgeElementResp\u003e knowledgeElementRespInfos \u003d new ArrayList\u003c\u003e();\n        if (CollectionUtil.isNotEmpty(saasKnowledgeElementInfos)) {\n            knowledgeElementRespInfos.addAll(saasKnowledgeElementInfos.stream().map(new SaasKnowledgeElementApplyFunction()).toList());\n        }\n        return knowledgeElementRespInfos;\n    }\n\n    /**\n     * 查询所有知识库元素列表\n     * @param knowledgeElementQueryReq 查询条件Vo\n     * @return 所有知识库元素列表\n     */\n    @Override\n    public Result\u003cList\u003cKnowledgeElementResp\u003e\u003e listAll(KnowledgeElementQueryReq knowledgeElementQueryReq) {\n        log.info(\"根据条件查询所有知识库元素列表\");\n        log.info(\"QueryReq:{}\", knowledgeElementQueryReq.toString());\n        SaasKnowledgeElement queryModel \u003d new SaasKnowledgeElement();\n        BeanUtils.copyProperties(knowledgeElementQueryReq, queryModel);\n        QueryWrapper\u003cSaasKnowledgeElement\u003e queryWrapper \u003d Wrappers.query(queryModel);\n        List\u003cSaasKnowledgeElement\u003e saasKnowledgeElementInfos \u003d saasKnowledgeElementMapper.selectList(queryWrapper);\n        List\u003cKnowledgeElementResp\u003e knowledgeElementRespInfos \u003d new ArrayList\u003c\u003e();\n        if (CollectionUtil.isNotEmpty(saasKnowledgeElementInfos)) {\n            knowledgeElementRespInfos.addAll(saasKnowledgeElementInfos.stream().map(new SaasKnowledgeElementApplyFunction()).toList());\n        }\n        return Result.data(knowledgeElementRespInfos);\n    }\n\n    /**\n     * 批量新增文件\n     * @param saasKnowledgeElements 知识库元素列表\n     * @param tenantId 租户\n     * @param fileSpace 文件占用空间\n     * @param cacheKeys 缓存keys\n     * @return 是否新增成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    protected Result\u003cString\u003e lockBatchFile(List\u003cSaasKnowledgeElement\u003e saasKnowledgeElements, String tenantId, Long fileSpace, List\u003cString\u003e cacheKeys, String containerId) {\n        String key \u003d Cns.LOCK_KNOWLEDGE_KEY + tenantId;\n        RLock rLock \u003d redissonClient.getLock(key);\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        try {\n            // 校验知识库空间大小\n            // /kl/api/saas/element/addFiles\n            knowledgeContainerCapacityDataService.validateContainerCapacity(saasKnowledgeElements.get(0).getContainerId(),fileSpace);\n            if (rLock.tryLock(10, 10, TimeUnit.SECONDS)) {\n                boolean ret \u003d this.saveBatch(saasKnowledgeElements);\n                if (ret) {\n                    boolean result \u003d knowledgeStorageService.addStorages(saasKnowledgeElements.stream().map(KnowledgeStorageRecord::uploadFile).collect(Collectors.toList()));\n                    Assert.isTrue(result, \"knowledge.dataset.file.validation.expireFile\");\n                    // 扣费\n                    // 上传流量账户扣费\n                    result \u003d billingSubscribeAccountService.costStorage(tenantId, fileSpace);\n                    Assert.isTrue(result, \"knowledge.dataset.file.validation.expireFile\");\n                    // 清除缓存\n                    if (CollUtil.isNotEmpty(cacheKeys)) {\n                        stringRedisTemplate.delete(cacheKeys);\n                    }\n                    // 新增文件解析配置\n                    Optional\u003cSaasKnowledgeConfigContainer\u003e saasKnowledgeConfigContainer \u003d saasKnowledgeConfigContainerService.queryInfoByContainerId(containerId);\n                    if (saasKnowledgeConfigContainer.isEmpty()) {\n                        log.error(\"未找到知识库配置信息\");\n                        return Result.error(i18nMessage.resolveMessage(\"system.common.add.fail\"));\n                    }\n                    List\u003cSaasKnowledgeConfigElement\u003e saasKnowledgeConfigElements \u003d new ArrayList\u003c\u003e();\n                    // 构建批量动态记录请求列表\n                    List\u003cSaasKnowledgeElementTrendAddReq\u003e trendAddReqs \u003d new ArrayList\u003c\u003e();\n                    for (SaasKnowledgeElement saasKnowledgeElement : saasKnowledgeElements) {\n                        SaasKnowledgeConfigElement request \u003d SaasKnowledgeConfigElement.builder()\n                                .elementId(saasKnowledgeElement.getCode())\n                                .analysisEngine(saasKnowledgeConfigContainer.get().getAnalysisEngine())\n                                .analysisMode(saasKnowledgeConfigContainer.get().getAnalysisMode())\n                                .ocrEngine(saasKnowledgeConfigContainer.get().getOcrEngine())\n                                .multiModalityEngine(saasKnowledgeConfigContainer.get().getMultiModalityEngine())\n                                .splitMode(saasKnowledgeConfigContainer.get().getSplitMode())\n                                .maxChunkSize(saasKnowledgeConfigContainer.get().getMaxChunkSize())\n                                .overlapSize(saasKnowledgeConfigContainer.get().getOverlapSize())\n                                .maxChunkLength(saasKnowledgeConfigContainer.get().getMaxChunkLength())\n                                .splitDelimiters(saasKnowledgeConfigContainer.get().getSplitDelimiters())\n                                .imageOcr(saasKnowledgeConfigContainer.get().getImageOcr())\n                                .tenantId(saasKnowledgeConfigContainer.get().getTenantId())\n                                .sort(saasKnowledgeConfigContainer.get().getSort())\n                                .modifier(UserContextHolder.getCurrentUser().getCode())\n                                .creator(UserContextHolder.getCurrentUser().getCode())\n                                .modifierTime(LocalDateTime.now())\n                                .containerId(saasKnowledgeConfigContainer.get().getContainerId())\n                                .engineType(saasKnowledgeConfigContainer.get().getEngineType())\n                                .useOriginalContent(Cns.YES)\n                                .createTime(LocalDateTime.now())\n                                .build();\n                        FileConfig fileConfig \u003d saasKnowledgeElement.getFileConfig();\n                        if (fileConfig!\u003dnull \u0026\u0026 request!\u003dnull){\n                            // 设置分析引擎\n                            if (StrUtil.isNotBlank(fileConfig.getAnalysisEngine())) {\n                                request.setAnalysisEngine(fileConfig.getAnalysisEngine());\n                            }\n                            // 设置分析模式\n                            if (StrUtil.isNotBlank(fileConfig.getAnalysisMode())) {\n                                request.setAnalysisMode(fileConfig.getAnalysisMode());\n                            }\n                            // 设置引擎类型\n                            if (StrUtil.isNotBlank(fileConfig.getEngineType())) {\n                                request.setEngineType(fileConfig.getEngineType());\n                            }\n                            if (StrUtil.equalsIgnoreCase(EngineTypesEnum.OCR.name(),fileConfig.getEngineType())){\n                                // 设置OCR引擎\n                                if (StrUtil.isNotBlank(fileConfig.getOcrEngine())) {\n                                    request.setOcrEngine(fileConfig.getOcrEngine());\n                                }\n                            }else if (StrUtil.equalsIgnoreCase(EngineTypesEnum.VLM.name(),fileConfig.getEngineType())){\n                                // 设置多模态引擎\n                                if (StrUtil.isNotBlank(fileConfig.getMultiModalityEngine())) {\n                                    request.setMultiModalityEngine(fileConfig.getMultiModalityEngine());\n                                }\n                            }\n                        }\n                        saasKnowledgeConfigElements.add(request);\n                        // 批量更新知识库动态配置\n                        // 草稿状态不列入动态信息\n                        if (!ProcessStatusEnum.DRAFT.equals(ProcessStatusEnum.parse(saasKnowledgeElement.getProcessStatus()))) {\n                            // 获取空间动态信息\n                            SaasKnowledgeElementCacheInfo saasKnowledgeElementCacheInfo \u003d this.get(\n                                    saasKnowledgeElement.getContainerId(),\n                                    saasKnowledgeElement.getTenantId()\n                            );\n                            // 使用 UPLOAD 事件创建动态记录请求\n                            SaasKnowledgeElementTrendAddReq trendAddReq \u003d SaasKnowledgeElementTrendAddReq.of(\n                                    sysUserInfo,\n                                    saasKnowledgeElement,\n                                    SaasKnowledgeElementEvent.UPLOAD,\n                                    saasKnowledgeElementCacheInfo\n                            );\n\n                            trendAddReqs.add(trendAddReq);\n                        }\n                    }\n\n                    // 批量插入动态记录\n                    if (CollectionUtil.isNotEmpty(trendAddReqs)) {\n                        saasKnowledgeElementTrendService.messageTrendBatch(trendAddReqs);\n                        log.info(\"批量更新知识库动态配置完成，实际处理数量:{}\", trendAddReqs.size());\n                    } else {\n                        log.info(\"批量更新知识库动态配置完成，无需处理的记录\");\n                    }\n\n                    saasKnowledgeConfigElementService.saveBatch(saasKnowledgeConfigElements);\n\n                }\n                return ret ? Result.success(i18nMessage.resolveMessage(\"system.common.insert.success\")) : Result.error(i18nMessage.resolveMessage(\"knowledge.dataset.file.save.fail\"));\n            }\n        } catch (InterruptedException e) {\n            log.error(e.getMessage());\n            throw new RuntimeException(\"system.error.inner.exception\");\n        } finally {\n            // 释放分布式锁\n            if (rLock !\u003d null \u0026\u0026 rLock.isLocked()) {\n                rLock.unlock();\n                log.info(\"free addFiles lock successful...\");\n            }\n        }\n        return Result.error(\"knowledge.dataset.file.validation.expireFile\");\n    }\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e addFiles(KnowledgeElementAddFileReq addFileReq) {\n        log.info(\"批量新增文件\");\n        SysUserInfo sysUserInfo\u003dUserContextHolder.getCurrentUser();\n        String tenantId \u003d sysUserInfo.getTenantId();\n        knowledgeValidationService.validateFileBase(addFileReq, tenantId);\n        List\u003cString\u003e cacheKeys \u003d new LinkedList\u003c\u003e();\n        List\u003cSaasKnowledgeElement\u003e saasKnowledgeElements \u003d new ArrayList\u003c\u003e();\n        // 保存成功，提交异步处理流程\n        AtomicLong storageAmount \u003d new AtomicLong(0);\n        // redis的值，避免并发问题\n        // 查询最大maxOrder\n        Integer maxOrder\u003dsaasKnowledgeElementMapper.maxOrder(tenantId, addFileReq.getContainerId(), addFileReq.getParentCode());\n\n        AtomicInteger maxOrderAtomic\u003dnew AtomicInteger(Objects.requireNonNullElse(maxOrder,0));\n        for (KnowledgeElementAddFileOneReq fileOneReq : addFileReq.getDataSets()) {\n            String cacheKey \u003d Cns.PIPELINE_CACHE_PREFIX + tenantId + \":\" + fileOneReq.getDataId();\n            cacheKeys.add(cacheKey);\n            String value \u003d stringRedisTemplate.opsForValue().get(cacheKey);\n            Assert.notBlank(value, \"knowledge.dataset.file.validation.expireFile\");\n\n            saasKnowledgeElements.addAll(fileOneReq.getElementList(addFileReq,maxOrderAtomic, tenantId, value, storageAmount,sysUserInfo));\n        }\n        // 校验上传流量空间\n        Assert.isTrue(billingSubscribeAccountService.validateAvailableStorage(tenantId, storageAmount.get()), \"knowledge.preview.upload.limit\");\n        return this.lockBatchFile(saasKnowledgeElements, tenantId, storageAmount.get(), cacheKeys, addFileReq.getContainerId());\n    }\n\n    @Override\n    public Result\u003cKnowledgeElementTreeResp\u003e addPersonalKnowledge(ChatKnowledgeUploadReq uploadReq, SysUserInfo sysUserInfo,String containerId, String knowledgeContent) {\n        // 这里页码取当前的conversationId作为唯一标识，如果已经存在的情况下，就作为新版本进行更新\n        String pageCode \u003d uploadReq.getConversationId();\n        // 创建saasKnowledgeElement对象并从请求Vo中复制属性\n        SaasKnowledgeElement saasKnowledgeElement \u003d uploadReq.build(sysUserInfo,containerId,knowledgeContent);\n        // 判断是否已经存在，如果存在，直接更新版本\n        Optional\u003cSaasKnowledgeElement\u003e existingElement \u003d this.queryByCode(pageCode,sysUserInfo.getTenantId());\n        int ret\u003d-1;\n        // 版本号\n        String pageVersionCode \u003d IdUtil.getSnowflakeNextIdStr();\n        if (existingElement.isEmpty()){\n            // 不存在，创建新的知识库元素\n            // 查询最大的Sort值\n            Integer maxOrder \u003d saasKnowledgeElementMapper.maxOrder(saasKnowledgeElement.getTenantId(), saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getParentCode());\n            Integer currentOrder \u003d Objects.requireNonNullElse(maxOrder, 0) + KbConst.MOVE_ORDER_LAST_NEXT;\n            // 设置排序\n            saasKnowledgeElement.setSort(currentOrder);\n            // 插入页面记录到数据库\n            ret \u003d saasKnowledgeElementMapper.insert(saasKnowledgeElement);\n        }else{\n            // 存在，新增版本\n            SaasKnowledgeElement existing \u003d existingElement.get();\n            SaasKnowledgeElement updateElement \u003d new SaasKnowledgeElement();\n            updateElement.setEleSize(saasKnowledgeElement.getEleSize());\n            updateElement.setId(existing.getId());\n            updateElement.setModifierTime(LocalDateTime.now());\n            updateElement.setModifier(sysUserInfo.getCode());\n            updateElement.setEleMd5(saasKnowledgeElement.getEleMd5());\n            // 更新状态，重新向量化\n            updateElement.setProcessStatus(ProcessStatusEnum.INIT.getCode());\n            ret\u003dsaasKnowledgeElementMapper.updateById(updateElement);\n        }\n        if (ret \u003e 0) {\n            // 插入版本信息\n            knowledgeElementVersionService.add(pageVersionCode, saasKnowledgeElement, new ArrayList\u003c\u003e(), sysUserInfo, KnowledgeElementVersionStatus.ISSUED);\n            // 插入文件解析配置\n            Optional\u003cSaasKnowledgeConfigContainer\u003e saasKnowledgeConfigContainer \u003d saasKnowledgeConfigContainerService.queryInfoByContainerId(saasKnowledgeElement.getContainerId());\n            if (saasKnowledgeConfigContainer.isEmpty()) {\n                log.error(\"未找到知识库配置信息\");\n                return Result.error(i18nMessage.resolveMessage(\"system.common.add.fail\"));\n            }\n            SaasKnowledgeConfigElement request \u003d SaasKnowledgeConfigElement.builder()\n                    .elementId(saasKnowledgeElement.getCode())\n                    .analysisEngine(saasKnowledgeConfigContainer.get().getAnalysisEngine())\n                    .analysisMode(saasKnowledgeConfigContainer.get().getAnalysisMode())\n                    .ocrEngine(saasKnowledgeConfigContainer.get().getOcrEngine())\n                    .multiModalityEngine(saasKnowledgeConfigContainer.get().getMultiModalityEngine())\n                    .splitMode(saasKnowledgeConfigContainer.get().getSplitMode())\n                    .maxChunkSize(saasKnowledgeConfigContainer.get().getMaxChunkSize())\n                    .overlapSize(saasKnowledgeConfigContainer.get().getOverlapSize())\n                    .maxChunkLength(saasKnowledgeConfigContainer.get().getMaxChunkLength())\n                    .splitDelimiters(saasKnowledgeConfigContainer.get().getSplitDelimiters())\n                    .imageOcr(saasKnowledgeConfigContainer.get().getImageOcr())\n                    .tenantId(saasKnowledgeConfigContainer.get().getTenantId())\n                    .sort(saasKnowledgeConfigContainer.get().getSort())\n                    .modifier(UserContextHolder.getCurrentUser().getCode())\n                    .creator(UserContextHolder.getCurrentUser().getCode())\n                    .modifierTime(LocalDateTime.now())\n                    .containerId(saasKnowledgeConfigContainer.get().getContainerId())\n                    .engineType(saasKnowledgeConfigContainer.get().getEngineType())\n                    .useOriginalContent(Cns.YES)\n                    .createTime(LocalDateTime.now())\n                    .build();\n            saasKnowledgeConfigElementService.save(request);\n            // 通用知识库文档列入 草稿状态不列入动态信息\n            String spaceCode \u003d saasKnowledgeElement.getContainerId();\n            LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e queryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n            queryWrapper.eq(SaasKnowledgeContainer::getCode, spaceCode);\n            queryWrapper.eq(SaasKnowledgeContainer::getTenantId, sysUserInfo.getCode());\n            // 更新动态\n            SaasKnowledgeElementCacheInfo saasKnowledgeElementCacheInfo \u003d this.get(saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getTenantId());\n            saasKnowledgeElementTrendService.messageTrend(SaasKnowledgeElementTrendAddReq.of(sysUserInfo, saasKnowledgeElement, SaasKnowledgeElementEvent.UPDATED, saasKnowledgeElementCacheInfo));\n        }\n        return Result.data(KnowledgeElementTreeResp.of(saasKnowledgeElement));\n    }\n\n    /**\n     * 新增知识库元素记录\n     * @param knowledgeElementAddReq 新增知识库元素条件Vo\n     * @return 是否新增成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e add(com.torchv.application.knowledge.model.request.knowledge.KnowledgeElementAddReq knowledgeElementAddReq) {\n        log.info(\"新增知识库元素数据,Vo:{}\", knowledgeElementAddReq.toString());\n        SaasKnowledgeElement saasKnowledgeElement \u003d new SaasKnowledgeElement();\n        BeanUtils.copyProperties(knowledgeElementAddReq, saasKnowledgeElement);\n        saasKnowledgeElement.setCreateTime(LocalDateTime.now());\n        saasKnowledgeElement.setTenantId(UserContextHolder.getTenantId());\n\n        // 唯一编码\n        saasKnowledgeElement.setCode(IdUtil.getSnowflakeNextIdStr());\n        int ret \u003d saasKnowledgeElementMapper.insert(saasKnowledgeElement);\n        if (ret \u003e 0) {\n            Optional\u003cSaasKnowledgeConfigContainer\u003e saasKnowledgeConfigContainer \u003d saasKnowledgeConfigContainerService.queryInfoByContainerId(knowledgeElementAddReq.getContainerId());\n            if (saasKnowledgeConfigContainer.isEmpty()) {\n                log.error(\"未找到知识库配置信息\");\n                return Result.error(i18nMessage.resolveMessage(\"system.common.add.fail\"));\n            }\n\n            SaasKnowledgeConfigElementAddReq request \u003d SaasKnowledgeConfigElementAddReq.builder()\n                    .elementId(saasKnowledgeElement.getCode())\n                    .analysisEngine(saasKnowledgeConfigContainer.get().getAnalysisEngine())\n                    .analysisMode(saasKnowledgeConfigContainer.get().getAnalysisMode())\n                    .ocrEngine(saasKnowledgeConfigContainer.get().getOcrEngine())\n                    .multiModalityEngine(saasKnowledgeConfigContainer.get().getMultiModalityEngine())\n                    .splitMode(saasKnowledgeConfigContainer.get().getSplitMode())\n                    .maxChunkSize(saasKnowledgeConfigContainer.get().getMaxChunkSize())\n                    .overlapSize(saasKnowledgeConfigContainer.get().getOverlapSize())\n                    .maxChunkLength(saasKnowledgeConfigContainer.get().getMaxChunkLength())\n                    .splitDelimiters(saasKnowledgeConfigContainer.get().getSplitDelimiters())\n                    .imageOcr(saasKnowledgeConfigContainer.get().getImageOcr())\n                    .tenantId(saasKnowledgeConfigContainer.get().getTenantId())\n                    .sort(saasKnowledgeConfigContainer.get().getSort())\n                    .modifier(UserContextHolder.getCurrentUser().getCode())\n                    .creator(UserContextHolder.getCurrentUser().getCode())\n                    .modifierTime(LocalDateTime.now())\n                    .containerId(saasKnowledgeConfigContainer.get().getContainerId())\n                    .engineType(saasKnowledgeConfigContainer.get().getEngineType())\n                    .createTime(LocalDateTime.now())\n                    .build();\n\n            return saasKnowledgeConfigElementService.add(request);\n\n        } else {\n            return Result.error(i18nMessage.resolveMessage(\"system.common.add.fail\"));\n        }\n    }\n\n\n    @Override\n    @Transactional(rollbackFor \u003d Exception.class)\n    public Result\u003cKnowledgeElementTreeResp\u003e add(KnowledgeElementAddReq knowledgeElementAddReq, KnowledgeElementTypes types) {\n        log.info(\"新增空间页面数据,Vo:{}\", knowledgeElementAddReq.toString());\n        String pageCode \u003d IdUtil.getSnowflakeNextIdStr();\n        // 获取当前用户信息\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 生成唯一的MD5值，避免空内容导致的MD5冲突\n        String uniqueContent \u003d generateUniqueContent(knowledgeElementAddReq, pageCode, sysUserInfo);\n        String eleMd5 \u003d MD5.create().digestHex16(uniqueContent);\n        // 创建saasKnowledgeElement对象并从请求Vo中复制属性\n        SaasKnowledgeElement saasKnowledgeElement \u003d new SaasKnowledgeElement();\n        BeanUtils.copyProperties(knowledgeElementAddReq, saasKnowledgeElement);\n        // 模板信息获取\n        if (ObjectUtils.isNotEmpty(knowledgeElementAddReq.getTemplateCode())) {\n            String templateCode \u003d knowledgeElementAddReq.getTemplateCode();\n            String tenantId \u003d UserContextHolder.getTenantId();\n            kbPageTemplateService.queryTemplateByCode(tenantId, templateCode).ifPresent(template -\u003e {\n                saasKnowledgeElement.setContentMarked(template.getContentMarked());\n            });\n        }\n        saasKnowledgeElement.setCode(pageCode);\n        saasKnowledgeElement.setEleMd5(eleMd5);\n        // 设置页面类型\n        saasKnowledgeElement.setCategory(types.name());\n        // 设置描述字段\n        String description \u003d MarkdownUtils.cleanAndSub(knowledgeElementAddReq.getContentMarked());\n        // 临时复用存储\n        saasKnowledgeElement.setConfig(description);\n        // 设置修改者和修改时间\n        saasKnowledgeElement.setModifier(sysUserInfo.getCode());\n        saasKnowledgeElement.setModifierTime(LocalDateTime.now());\n        // 设置创建者和创建时间\n        saasKnowledgeElement.setCreator(sysUserInfo.getCode());\n        saasKnowledgeElement.setCreateTime(LocalDateTime.now());\n        saasKnowledgeElement.setTenantId(sysUserInfo.getTenantId());\n        saasKnowledgeElement.setContainerId(knowledgeElementAddReq.getSpaceCode());\n        // 设置页面状态为待处理\n        saasKnowledgeElement.setProcessStatus(ProcessStatusEnum.DRAFT.getCode());\n        // 查询最大的Sort值\n        Integer maxOrder \u003d saasKnowledgeElementMapper.maxOrder(saasKnowledgeElement.getTenantId(), saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getParentCode());\n        Integer currentOrder \u003d Objects.requireNonNullElse(maxOrder, 0) + KbConst.MOVE_ORDER_LAST_NEXT;\n        // 设置排序\n        saasKnowledgeElement.setSort(currentOrder);\n        // 版本号\n        String pageVersionCode \u003d IdUtil.getSnowflakeNextIdStr();\n        // 设置标题名称\n        saasKnowledgeElement.setEleName(knowledgeElementAddReq.getTitle());\n        // 插入页面记录到数据库\n        int ret \u003d saasKnowledgeElementMapper.insert(saasKnowledgeElement);\n        if (ret \u003e 0) {\n            // 插入版本信息\n            knowledgeElementVersionService.add(pageVersionCode, saasKnowledgeElement, knowledgeElementAddReq.getAttachments(), sysUserInfo, KnowledgeElementVersionStatus.DEFAULT);\n            // 插入文件解析配置\n            Optional\u003cSaasKnowledgeConfigContainer\u003e saasKnowledgeConfigContainer \u003d saasKnowledgeConfigContainerService.queryInfoByContainerId(knowledgeElementAddReq.getSpaceCode());\n            if (saasKnowledgeConfigContainer.isEmpty()) {\n                log.error(\"未找到知识库配置信息\");\n                return Result.error(i18nMessage.resolveMessage(\"system.common.add.fail\"));\n            }\n            SaasKnowledgeConfigElement request \u003d SaasKnowledgeConfigElement.builder()\n                    .elementId(saasKnowledgeElement.getCode())\n                    .analysisEngine(saasKnowledgeConfigContainer.get().getAnalysisEngine())\n                    .analysisMode(saasKnowledgeConfigContainer.get().getAnalysisMode())\n                    .ocrEngine(saasKnowledgeConfigContainer.get().getOcrEngine())\n                    .multiModalityEngine(saasKnowledgeConfigContainer.get().getMultiModalityEngine())\n                    .splitMode(saasKnowledgeConfigContainer.get().getSplitMode())\n                    .maxChunkSize(saasKnowledgeConfigContainer.get().getMaxChunkSize())\n                    .overlapSize(saasKnowledgeConfigContainer.get().getOverlapSize())\n                    .maxChunkLength(saasKnowledgeConfigContainer.get().getMaxChunkLength())\n                    .splitDelimiters(saasKnowledgeConfigContainer.get().getSplitDelimiters())\n                    .imageOcr(saasKnowledgeConfigContainer.get().getImageOcr())\n                    .tenantId(saasKnowledgeConfigContainer.get().getTenantId())\n                    .sort(saasKnowledgeConfigContainer.get().getSort())\n                    .modifier(UserContextHolder.getCurrentUser().getCode())\n                    .creator(UserContextHolder.getCurrentUser().getCode())\n                    .modifierTime(LocalDateTime.now())\n                    .containerId(saasKnowledgeConfigContainer.get().getContainerId())\n                    .engineType(saasKnowledgeConfigContainer.get().getEngineType())\n                    .useOriginalContent(Cns.YES)\n                    .createTime(LocalDateTime.now())\n                    .build();\n            saasKnowledgeConfigElementService.save(request);\n            // 通用知识库文档列入 草稿状态不列入动态信息\n            String spaceCode \u003d knowledgeElementAddReq.getSpaceCode();\n            LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e queryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n            queryWrapper.eq(SaasKnowledgeContainer::getCode, spaceCode);\n            queryWrapper.eq(SaasKnowledgeContainer::getTenantId, sysUserInfo.getCode());\n            SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectOne(queryWrapper);\n            if (!ProcessStatusEnum.DRAFT.equals(ProcessStatusEnum.parse(saasKnowledgeElement.getProcessStatus()))\n            \u0026\u0026 saasKnowledgeContainer.getCategory().equals(KnowledgeCategory.COMMON.name())){\n                // 空间动态信息新增\n                SaasKnowledgeElementCacheInfo saasKnowledgeElementCacheInfo \u003d this.get(saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getTenantId());\n                saasKnowledgeElementTrendService.messageTrend(SaasKnowledgeElementTrendAddReq.of(sysUserInfo, saasKnowledgeElement, SaasKnowledgeElementEvent.UPDATED, saasKnowledgeElementCacheInfo));\n            }\n        }\n        // 模板信息获取\n        if (ObjectUtils.isNotEmpty(knowledgeElementAddReq.getTemplateCode())) {\n            String templateCode \u003d knowledgeElementAddReq.getTemplateCode();\n            String tenantId \u003d UserContextHolder.getTenantId();\n            kbPageTemplateService.queryTemplateByCode(tenantId, templateCode).ifPresent(template -\u003e {\n                saasKnowledgeElement.setContentMarked(template.getContentMarked());\n            });\n        }\n        return Result.data(KnowledgeElementTreeResp.of(saasKnowledgeElement));\n    }\n\n    /**\n     * 生成唯一的内容字符串，避免空内容导致的MD5冲突\n     */\n    private String generateUniqueContent(KnowledgeElementAddReq req, String pageCode, SysUserInfo sysUserInfo) {\n        StringBuilder contentBuilder \u003d new StringBuilder();\n\n        // 添加页面标题\n        if (StrUtil.isNotBlank(req.getTitle())) {\n            contentBuilder.append(req.getTitle());\n        }\n\n        // 添加页面内容\n        if (StrUtil.isNotBlank(req.getContent())) {\n            contentBuilder.append(req.getContent());\n        }\n\n        // 添加markdown内容\n        if (StrUtil.isNotBlank(req.getContentMarked())) {\n            contentBuilder.append(req.getContentMarked());\n        }\n\n        // 如果内容为空，使用唯一标识符确保MD5不同\n        if (contentBuilder.length() \u003d\u003d 0) {\n            contentBuilder.append(\"EMPTY_CONTENT_\")\n                    .append(pageCode)\n                    .append(\"_\")\n                    .append(sysUserInfo.getTenantId())\n                    .append(\"_\")\n                    .append(System.currentTimeMillis());\n        }\n\n        return contentBuilder.toString();\n    }\n\n    @Override\n    public Result\u003cString\u003e addSingle(KnowledgeSingleElementAddFileReq singleFileReq) {\n        log.info(\"新增知识库元素数据Single,Vo:{}\", singleFileReq.toString());\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 校验知识库 请求参数\n        knowledgeValidationService.validateFileBase(singleFileReq, sysUserInfo.getTenantId());\n        SaasKnowledgeElement saasKnowledgeElement \u003d new SaasKnowledgeElement();\n        BeanUtils.copyProperties(singleFileReq, saasKnowledgeElement);\n        saasKnowledgeElement.setStartTime(singleFileReq.startTimeInstance());\n        saasKnowledgeElement.setEndTime(singleFileReq.endTimeInstance());\n        KnowledgeElementCategory elementCategory \u003d KnowledgeElementCategory.getKnowledgeCategory(singleFileReq.getCategory());\n        saasKnowledgeElement.setCategory(Objects.requireNonNull(elementCategory, \"system.common.request.invalid\").getName());\n        saasKnowledgeElement.setCreateTime(LocalDateTime.now());\n        saasKnowledgeElement.setCreator(sysUserInfo.getCode());\n        saasKnowledgeElement.setModifier(sysUserInfo.getCode());\n        saasKnowledgeElement.setModifierTime(LocalDateTime.now());\n        saasKnowledgeElement.setTenantId(UserContextHolder.getTenantId());\n        // 唯一编码\n        saasKnowledgeElement.setCode(IdUtil.getSnowflakeNextIdStr());\n        // 文件md5\n        saasKnowledgeElement.setEleMd5(MD5.create().digestHex16(singleFileReq.getName()));\n        saasKnowledgeElement.setEleName(singleFileReq.getName());\n        // 设置状态,默认为成功状态\n        saasKnowledgeElement.setProcessStatus(ProcessStatusEnum.SUCCESS.getCode());\n        saasKnowledgeElement.setProcessCount(0);\n        saasKnowledgeElement.setPageCount(1);\n\n        int ret \u003d saasKnowledgeElementMapper.insert(saasKnowledgeElement);\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.add.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.add.fail\"));\n    }\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cKnowledgeElementResp\u003e addText(KnowledgeElementTxtAddFileReq addFileReq) {\n        log.info(\"新增文本，name:{}\", addFileReq.getName());\n        LogContext.putVariable(\"name\", addFileReq.getName());\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        knowledgeValidationService.validateFileBase(addFileReq, sysUserInfo.getTenantId());\n        File tmpFile \u003d null;\n        File tmpPreviewFile \u003d null;\n        String md5_str \u003d MD5.create().digestHex16(addFileReq.getContent());\n        String md5_preview_str \u003d MD5.create().digestHex16(addFileReq.getOriginContent());\n        LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class)\n                .eq(SaasKnowledgeElement::getTenantId, UserContextHolder.getTenantId())\n                .eq(SaasKnowledgeElement::getEleMd5, md5_str);\n        Assert.isFalse(saasKnowledgeElementMapper.selectCount(lambdaQueryWrapper) \u003e 0, \"knowledge.dataset.txt.validation.exists.content\");\n        String key \u003d Cns.LOCK_KNOWLEDGE_KEY + sysUserInfo.getTenantId();\n        RLock rLock \u003d redissonClient.getLock(key);\n        try {\n            if (rLock.tryLock(10, 10, TimeUnit.SECONDS)) {\n                // 上传\n                tmpFile \u003d File.createTempFile(\"custom_\" + addFileReq.getName(), \".txt\");\n                tmpPreviewFile \u003d File.createTempFile(\"custom_preview_\" + addFileReq.getName(), \".txt\");\n                // 文本类型的情况，把标题也添加进去？\n                FileUtil.writeUtf8String(addFileReq.markdownText(), tmpFile);\n                FileUtil.writeUtf8String(addFileReq.getOriginContent(), tmpPreviewFile);\n                // 记录上传流量日志\n                long fileSize \u003d FileUtil.size(tmpFile);\n                boolean storageValidate \u003d billingSubscribeAccountService.validateAvailableStorage(sysUserInfo.getTenantId(), fileSize);\n                Assert.isTrue(storageValidate, \"knowledge.preview.upload.limit\");\n                // 上传\n                MaterialInfoResp materialInfoResp \u003d materialService.save(tmpFile, md5_str, sysUserInfo.getTenantId());\n                MaterialInfoResp materialInfoPreviewResp \u003d materialService.save(tmpPreviewFile, md5_preview_str, sysUserInfo.getTenantId());\n                SaasKnowledgeElement saasKnowledgeElement \u003d new SaasKnowledgeElement();\n                BeanUtils.copyProperties(addFileReq, saasKnowledgeElement);\n                saasKnowledgeElement.setStartTime(addFileReq.startTimeInstance());\n                saasKnowledgeElement.setEndTime(addFileReq.endTimeInstance());\n                // 文件md5\n                saasKnowledgeElement.setEleMd5(MD5.create().digestHex16(addFileReq.getContent()));\n                saasKnowledgeElement.setEleName(addFileReq.getName());\n                saasKnowledgeElement.setEleUrl(materialInfoResp.getFileUrl());\n                // 预览地址存储富文本\n                saasKnowledgeElement.setElePreviewUrl(materialInfoPreviewResp.getFileUrl());\n                saasKnowledgeElement.setEleTokenSize(Long.parseLong(Objects.toString(StrUtil.length(addFileReq.getContent()), \"0\")));\n                saasKnowledgeElement.setEleSuffix(\"txt\");\n                saasKnowledgeElement.setEleSize(fileSize);\n                saasKnowledgeElement.setCategory(KnowledgeElementCategory.FILE.getName());\n                saasKnowledgeElement.setCreateTime(LocalDateTime.now());\n                saasKnowledgeElement.setCreator(sysUserInfo.getCode());\n                saasKnowledgeElement.setModifier(sysUserInfo.getCode());\n                saasKnowledgeElement.setModifierTime(LocalDateTime.now());\n                saasKnowledgeElement.setTenantId(sysUserInfo.getTenantId());\n                // 唯一编码\n                saasKnowledgeElement.setCode(IdUtil.getSnowflakeNextIdStr());\n                // 设置状态,默认为待处理状态\n                saasKnowledgeElement.setProcessStatus(ProcessStatusEnum.INIT.getCode());\n                saasKnowledgeElement.setProcessCount(0);\n                saasKnowledgeElement.setPageCount(1);\n                int ret \u003d saasKnowledgeElementMapper.insert(saasKnowledgeElement);\n                if (ret \u003e 0) {\n                    Optional\u003cSaasKnowledgeConfigContainer\u003e saasKnowledgeConfigContainer \u003d saasKnowledgeConfigContainerService.queryInfoByContainerId(addFileReq.getContainerId());\n                    if (saasKnowledgeConfigContainer.isEmpty()) {\n                        log.error(\"未找到知识库配置信息\");\n                        return Result.error(i18nMessage.resolveMessage(\"system.common.add.fail\"));\n                    }\n\n                    SaasKnowledgeConfigElementAddReq request \u003d SaasKnowledgeConfigElementAddReq.builder()\n                            .elementId(saasKnowledgeElement.getCode())\n                            .analysisEngine(saasKnowledgeConfigContainer.get().getAnalysisEngine())\n                            .analysisMode(saasKnowledgeConfigContainer.get().getAnalysisMode())\n                            .ocrEngine(saasKnowledgeConfigContainer.get().getOcrEngine())\n                            .multiModalityEngine(saasKnowledgeConfigContainer.get().getMultiModalityEngine())\n                            .splitMode(saasKnowledgeConfigContainer.get().getSplitMode())\n                            .maxChunkSize(saasKnowledgeConfigContainer.get().getMaxChunkSize())\n                            .overlapSize(saasKnowledgeConfigContainer.get().getOverlapSize())\n                            .maxChunkLength(saasKnowledgeConfigContainer.get().getMaxChunkLength())\n                            .splitDelimiters(saasKnowledgeConfigContainer.get().getSplitDelimiters())\n                            .imageOcr(saasKnowledgeConfigContainer.get().getImageOcr())\n                            .tenantId(saasKnowledgeConfigContainer.get().getTenantId())\n                            .sort(saasKnowledgeConfigContainer.get().getSort())\n                            .modifier(UserContextHolder.getCurrentUser().getCode())\n                            .creator(UserContextHolder.getCurrentUser().getCode())\n                            .modifierTime(LocalDateTime.now())\n                            .containerId(saasKnowledgeConfigContainer.get().getContainerId())\n                            .engineType(saasKnowledgeConfigContainer.get().getEngineType())\n                            .createTime(LocalDateTime.now())\n                            .build();\n\n                    boolean f \u003d saasKnowledgeConfigElementService.add(request).getCode().equals(ErrorCodeEnum.SUCCESS.getCode());\n                    Assert.isTrue(f, \"knowledge.dataset.txt.add.fail\");\n                    // 增加存储流量日志\n                    boolean storageResult \u003d knowledgeStorageService.addStorage(KnowledgeStorageRecord.uploadText(sysUserInfo.getTenantId(), saasKnowledgeElement, materialInfoResp));\n                    Assert.isTrue(storageResult, \"knowledge.dataset.txt.add.fail\");\n                    // 上传流量账户扣费\n                    boolean result \u003d billingSubscribeAccountService.costStorage(sysUserInfo.getTenantId(), fileSize);\n                    Assert.isTrue(result, \"knowledge.dataset.txt.add.fail\");\n                }\n                return ret \u003e 0 ? Result.data(new SaasKnowledgeElementApplyFunction().apply(saasKnowledgeElement)) : Result.error(i18nMessage.resolveMessage(\"system.common.add.fail\"));\n            }\n        } catch (InterruptedException | IOException i) {\n            log.error(i.getMessage(), i);\n            throw new RuntimeException(\"system.error.inner.exception\");\n        } finally {\n            FileUtil.del(tmpFile);\n            // 释放分布式锁\n            if (rLock !\u003d null \u0026\u0026 rLock.isLocked()) {\n                rLock.unlock();\n                log.info(\"free lock successful...\");\n            }\n        }\n        return Result.error(i18nMessage.resolveMessage(\"knowledge.dataset.txt.add.fail\"));\n    }\n\n    /**\n     * 更新知识库元素记录\n     * @param knowledgeElementUpdateReq 更新知识库元素条件Vo\n     * @return 是否更新成功\n     */\n    @Override\n    public Result\u003cString\u003e update(KnowledgeElementUpdateReq knowledgeElementUpdateReq) {\n        log.info(\"根据主键id修改知识库元素数据,Vo:{}\", knowledgeElementUpdateReq.toString());\n        LogContext.putVariable(\"name\", knowledgeElementUpdateReq.getEleName());\n        SaasKnowledgeElement record \u003d saasKnowledgeElementMapper.selectById(knowledgeElementUpdateReq.getId());\n        Assert.notNull(record, \"system.common.request.invalid\");\n        String tenantId \u003d UserContextHolder.getTenantId();\n        Assert.isTrue(StrUtil.equalsIgnoreCase(tenantId, record.getTenantId()), \"system.common.request.invalid\");\n        SaasKnowledgeElement saasKnowledgeElement \u003d new SaasKnowledgeElement();\n        BeanUtils.copyProperties(knowledgeElementUpdateReq, saasKnowledgeElement);\n        saasKnowledgeElement.setModifierTime(LocalDateTime.now());\n        int ret \u003d saasKnowledgeElementMapper.updateById(saasKnowledgeElement);\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.update.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.update.fail\"));\n    }\n\n\n    @Override\n    public Result\u003cString\u003e enable(KnowledgeElementEnableReq req) {\n        String tenantId \u003d UserContextHolder.getTenantId();\n        String lockKey \u003d Cns.LOCK_KNOWLEDGE_KEY + tenantId + \":enable:\" + req.getId();\n        RLock rLock \u003d redissonClient.getLock(lockKey);\n        try {\n            if (rLock.tryLock(10, 10, TimeUnit.SECONDS)) {\n                SaasKnowledgeElement record \u003d saasKnowledgeElementMapper.selectById(req.getId());\n                Assert.isTrue(ObjectUtil.isNotEmpty(record) \u0026\u0026 StrUtil.equalsIgnoreCase(tenantId, record.getTenantId()), \"system.common.request.invalid\");\n                record.setModifierTime(LocalDateTime.now());\n                if (StrUtil.isAllNotEmpty(req.getStartTime(),req.getEndTime())){\n                    DateTimeFormatter formatter \u003d DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\");\n                    String startTimeStr \u003d req.getStartTime();\n                    String endTimeStr \u003d req.getEndTime();\n                    LocalDateTime start \u003d null;\n                    LocalDateTime end \u003d null;\n                    try {\n                        if (startTimeStr !\u003d null \u0026\u0026 !startTimeStr.isEmpty()) {\n                            start \u003d LocalDateTime.parse(startTimeStr, formatter);\n                        }\n                        if (endTimeStr !\u003d null \u0026\u0026 !endTimeStr.isEmpty()) {\n                            end \u003d LocalDateTime.parse(endTimeStr, formatter);\n                        }\n                    } catch (DateTimeParseException e) {\n                        log.error(\"时间格式错误，startTime:{}, endTime:{}\", startTimeStr, endTimeStr, e);\n                    }\n                    record.setStartTime(start);\n                    record.setEndTime(end);\n                }else{\n                    if (Objects.equals(record.getEnable(), ToggleStatusEnum.NO.getCode())){\n                        record.setEnable(ToggleStatusEnum.YES.getCode());\n                    }else{\n                        record.setEnable(ToggleStatusEnum.NO.getCode());\n                    }\n                }\n                if (ObjectUtil.isNotEmpty(req.getNeverExpire())){\n                    record.setNeverExpire(req.getNeverExpire());\n                }\n\n                int ret \u003d saasKnowledgeElementMapper.updateById(record);\n                if (ret \u003e 0){\n                    try {\n                        log.info(\"开始同步-启用/禁用-状态到ES.enable:{},startTime:{},endTime:{},neverExpire:{}\",record.getEnable(),record.getStartTime(),record.getEndTime(),record.getNeverExpire());\n                        Map\u003cString, Object\u003e updateFields \u003d new HashMap\u003c\u003e();\n                        if (ObjectUtil.isNotEmpty(record.getEnable())) {\n                            updateFields.put(DataSetChunkInfo.FIELD_ENABLE, String.valueOf(record.getEnable()));\n                        }\n                        if (record.getStartTime() !\u003d null) {\n                            updateFields.put(DataSetChunkInfo.FIELD_START_TIME, record.getStartTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());\n                        }\n                        if (record.getEndTime() !\u003d null) {\n                            updateFields.put(DataSetChunkInfo.FIELD_END_TIME, record.getEndTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());\n                        }\n                        if (record.getNeverExpire() !\u003d null) {\n                            updateFields.put(DataSetChunkInfo.FIELD_TIME_STATUS, String.valueOf(record.getNeverExpire()));\n                        }\n\n                        if (!updateFields.isEmpty()) {\n                            try {\n                                List\u003cUpdateReference\u003e updateChunks \u003d Arrays.asList(\n                                        UpdateReference.builder()\n                                                .dataId(record.getCode())\n                                                .value(updateFields)\n                                                .build()\n                                );\n\n                                UniversalEmbeddingConfig embeddingConfig \u003d knowledgeElementEmbeddingQueryService.getEmbeddingConfigByContainerId(record.getContainerId());\n                                vectorIndexDelegate.updateChuck(tenantId, updateChunks,embeddingConfig.getVectorDimension());\n\n                                log.info(\"updateChunk成功更新同步启用/禁用状态到ES，elementCode:{}, 更新字段:{}\", record.getCode(), updateFields);\n\n                            } catch (Exception chunkUpdateEx) {\n                                log.error(\"updateChunk更新同步ES失败，elementCode:{}, error:{}\", record.getCode(), chunkUpdateEx.getMessage(), chunkUpdateEx);\n                            }\n                        }\n                    } catch (Exception e) {\n                        log.error(\"同步启用/禁用状态到ES失败，数据库已更新ES同步失败，elementId:{}, error:{}\", record.getId(), e.getMessage(), e);\n                    }\n                }\n                return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.update.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.update.fail\"));\n            } else {\n                return Result.error(i18nMessage.resolveMessage(\"system.common.update.fail\"));\n            }\n        } catch (InterruptedException e) {\n            log.error(\"获取锁失败\", e);\n            Thread.currentThread().interrupt();\n            return Result.error(i18nMessage.resolveMessage(\"system.common.update.fail\"));\n        } finally {\n            if (rLock !\u003d null \u0026\u0026 rLock.isLocked()) {\n                rLock.unlock();\n            }\n        }\n    }\n\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cBatchOperationResult\u003e batchEnable(KnowledgeElementEnableReq req) {\n        String tenantId \u003d UserContextHolder.getTenantId();\n        BatchOperationResult result \u003d new BatchOperationResult();\n        result.setSuccessCount(0);\n        result.setFailureCount(0);\n        result.setSuccessIds(new ArrayList\u003c\u003e());\n        result.setFailureDetails(new ArrayList\u003c\u003e());\n\n        if (CollUtil.isEmpty(req.getIds())) {\n            return Result.error(\"ID列表不能为空\");\n        }\n\n        for (Integer id : req.getIds()) {\n            String lockKey \u003d Cns.LOCK_KNOWLEDGE_KEY + tenantId + \":enable:\" + id;\n            RLock rLock \u003d redissonClient.getLock(lockKey);\n            try {\n                if (rLock.tryLock(10, 10, TimeUnit.SECONDS)) {\n                    SaasKnowledgeElement record \u003d saasKnowledgeElementMapper.selectById(id);\n                    if (ObjectUtil.isEmpty(record) || !StrUtil.equalsIgnoreCase(tenantId, record.getTenantId())) {\n                        result.getFailureDetails().add(new BatchOperationResult.FailureDetail(id, \"记录不存在或无权限\"));\n                        result.setFailureCount(result.getFailureCount() + 1);\n                        continue;\n                    }\n                    record.setModifierTime(LocalDateTime.now());\n                    if (Objects.equals(record.getEnable(), ToggleStatusEnum.NO.getCode())){\n                        record.setEnable(ToggleStatusEnum.YES.getCode());\n                    }else{\n                        record.setEnable(ToggleStatusEnum.NO.getCode());\n                    }\n                    int ret \u003d saasKnowledgeElementMapper.updateById(record);\n                    if (ret \u003e 0) {\n                        try {\n                            Map\u003cString, Object\u003e updateFields \u003d new HashMap\u003c\u003e();\n                            if (ObjectUtil.isNotEmpty(record.getEnable())) {\n                                updateFields.put(DataSetChunkInfo.FIELD_ENABLE, String.valueOf(record.getEnable()));\n                            }\n                            if (record.getStartTime() !\u003d null) {\n                                updateFields.put(DataSetChunkInfo.FIELD_START_TIME, record.getStartTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());\n                            }\n                            if (record.getEndTime() !\u003d null) {\n                                updateFields.put(DataSetChunkInfo.FIELD_END_TIME, record.getEndTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());\n                            }\n                            if (record.getNeverExpire() !\u003d null) {\n                                updateFields.put(DataSetChunkInfo.FIELD_TIME_STATUS, String.valueOf(record.getNeverExpire()));\n                            }\n\n                            if (!updateFields.isEmpty()) {\n                                List\u003cUpdateReference\u003e updateChunks \u003d Arrays.asList(\n                                        UpdateReference.builder()\n                                                .dataId(record.getCode())\n                                                .value(updateFields)\n                                                .build()\n                                );\n                                UniversalEmbeddingConfig embeddingConfig \u003d knowledgeElementEmbeddingQueryService.getEmbeddingConfigByContainerId(record.getContainerId());\n                                vectorIndexDelegate.updateChuck(tenantId, updateChunks, embeddingConfig.getVectorDimension());\n                            }\n                            result.getSuccessIds().add(id);\n                            result.setSuccessCount(result.getSuccessCount() + 1);\n                        } catch (Exception e) {\n                            log.error(\"同步ES失败，ID:{}\", id, e);\n                            result.getFailureDetails().add(new BatchOperationResult.FailureDetail(id, \"ES同步失败\"));\n                            result.setFailureCount(result.getFailureCount() + 1);\n                        }\n                    } else {\n                        result.getFailureDetails().add(new BatchOperationResult.FailureDetail(id, \"数据库更新失败\"));\n                        result.setFailureCount(result.getFailureCount() + 1);\n                    }\n                } else {\n                    result.getFailureDetails().add(new BatchOperationResult.FailureDetail(id, \"获取锁超时\"));\n                    result.setFailureCount(result.getFailureCount() + 1);\n                }\n            } catch (Exception e) {\n                log.error(\"批量启用/禁用处理失败，ID:{}\", id, e);\n                result.getFailureDetails().add(new BatchOperationResult.FailureDetail(id, \"处理异常: \" + e.getMessage()));\n                result.setFailureCount(result.getFailureCount() + 1);\n            } finally {\n                if (rLock !\u003d null \u0026\u0026 rLock.isLocked()) {\n                    rLock.unlock();\n                }\n            }\n        }\n\n        String message \u003d String.format(\"批量操作完成，成功:%d个，失败:%d个\", result.getSuccessCount(), result.getFailureCount());\n        return Result.data(result, message);\n    }\n\n    @Override\n    public Result\u003cBatchOperationResult\u003e batchReset(KnowledgeElementResetReq req) {\n        if (CollUtil.isEmpty(req.getIds())) {\n            return Result.error(\"ID列表不能为空\");\n        }\n        String tenantId \u003d UserContextHolder.getTenantId();\n        BatchOperationResult result \u003d new BatchOperationResult();\n        result.setSuccessCount(0);\n        result.setFailureCount(0);\n        result.setSuccessIds(new ArrayList\u003c\u003e());\n        result.setFailureDetails(new ArrayList\u003c\u003e());\n        for (Integer id : req.getIds()) {\n            try {\n                SaasKnowledgeElement saasKnowledgeElement \u003d saasKnowledgeElementMapper.selectById(id);\n                if (ObjectUtil.isEmpty(saasKnowledgeElement) || !StrUtil.equalsIgnoreCase(saasKnowledgeElement.getTenantId(), tenantId)) {\n                    result.getFailureDetails().add(new BatchOperationResult.FailureDetail(id, \"记录不存在或无权限\"));\n                    result.setFailureCount(result.getFailureCount() + 1);\n                    continue;\n                }\n\n                // 判断状态,正在处理中的文件不允许删除\n                ProcessStatusEnum processStatusEnum \u003d ProcessStatusEnum.parse(saasKnowledgeElement.getProcessStatus());\n                // 如果已经是待处理或者成功的状态，那么不用二次重置处理\n                if (processStatusEnum \u003d\u003d ProcessStatusEnum.SUCCESS || processStatusEnum \u003d\u003d ProcessStatusEnum.INIT) {\n                    result.getSuccessIds().add(id);\n                    result.setSuccessCount(result.getSuccessCount() + 1);\n                    continue;\n                }\n                // 非处理失败的情况下，给一个间隔\n                if (processStatusEnum !\u003d ProcessStatusEnum.FAILURE) {\n                    // 计算一下时间，避免误操作\n                    if (ChronoUnit.MINUTES.between(saasKnowledgeElement.getModifierTime(), LocalDateTime.now()) \u003c 0.5) {\n                        // 在5分钟内，不允许重置\n                        result.getFailureDetails().add(new BatchOperationResult.FailureDetail(id, \"操作间隔时间不足5分钟\"));\n                        result.setFailureCount(result.getFailureCount() + 1);\n                        continue;\n                    }\n                }\n                // 更新状态\n                SaasKnowledgeElement element \u003d new SaasKnowledgeElement();\n                element.setId(id);\n                element.setModifierTime(LocalDateTime.now());\n                element.setProcessStatus(ProcessStatusEnum.INIT.getCode());\n\n                // 判断文本的元素类型，如果是wiki类型，那么不需要重置地址\n                if (!StrUtil.equalsIgnoreCase(saasKnowledgeElement.getCategory(), KnowledgeElementCategory.VIRTUAL_FILE.getName())) {\n                    if (StrUtil.isNotBlank(saasKnowledgeElement.getElePreviewUrl())) {\n                        // 把原始的地址重置回去\n                        element.setEleUrl(saasKnowledgeElement.getElePreviewUrl());\n                    }\n                }\n                int ret \u003d saasKnowledgeElementMapper.updateById(element);\n                if (ret \u003e 0) {\n                    // 根据数据集code删除索引的数据\n                    knowledgeElementDataService.deleteByDataId(tenantId, saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getCode());\n                    result.getSuccessIds().add(id);\n                    result.setSuccessCount(result.getSuccessCount() + 1);\n                } else {\n                    result.getFailureDetails().add(new BatchOperationResult.FailureDetail(id, \"数据库更新失败\"));\n                    result.setFailureCount(result.getFailureCount() + 1);\n                }\n\n            } catch (Exception e) {\n                log.error(\"批量重置处理失败，ID:{}\", id, e);\n                result.getFailureDetails().add(new BatchOperationResult.FailureDetail(id, \"处理异常: \" + e.getMessage()));\n                result.setFailureCount(result.getFailureCount() + 1);\n            }\n        }\n        String message \u003d String.format(\"批量重置完成，成功:%d个，失败:%d个\", result.getSuccessCount(), result.getFailureCount());\n        return Result.data(result, message);\n    }\n\n    public Result\u003cKnowledgeElementResp\u003e buildElementInfo(SaasKnowledgeElement saasKnowledgeElement,Boolean edit){\n        Assert.notNull(saasKnowledgeElement, BizExceptionSupplier.notFoundInstance());\n        String tenantId \u003d UserContextHolder.getTenantId();\n        Assert.isTrue(StrUtil.equalsIgnoreCase(tenantId, saasKnowledgeElement.getTenantId()), BizExceptionSupplier.authenticationFailedInstance());\n        KnowledgeElementResp knowledgeElementResp \u003d new KnowledgeElementResp();\n        BeanUtils.copyProperties(saasKnowledgeElement, knowledgeElementResp);\n        // 查询用户名称\n        Map\u003cString, String\u003e userMap \u003d userService.selectByCode(knowledgeElementResp.userCodes());\n        knowledgeElementResp.applyUserName(userMap);\n        // 判断是否为QA对\n        if (StrUtil.equalsIgnoreCase(knowledgeElementResp.getCategory(), KnowledgeElementCategory.QA.getName())) {\n            // 查询答案,相似问列表\n            knowledgeElementResp.setAnswer(knowledgeReferenceService.getAnswer(knowledgeElementResp.getCode(), tenantId));\n            knowledgeElementResp.setSimilar(knowledgeSimilarService.listSimilar(tenantId, knowledgeElementResp.getCode()));\n            // 获取原始文本\n            if (StrUtil.isNotBlank(saasKnowledgeElement.getElePreviewUrl())) {\n                knowledgeElementResp.setOriginContent(WebUtil.getString(saasKnowledgeElement.getElePreviewUrl()));\n            } else {\n                knowledgeElementResp.setOriginContent(knowledgeElementResp.getAnswer());\n            }\n        } else {\n            if (KnowledgeElementTypes.PAGE.name().equals(saasKnowledgeElement.getCategory())){\n                // 如果是页面类型的知识库元素，那么查询最新版本\n                knowledgeElementVersionService.queryLatestVersionByPageCode(saasKnowledgeElement.getCode(), saasKnowledgeElement.getTenantId(), edit)\n                        .ifPresent(version -\u003e {\n                            knowledgeElementResp.setContentMarked(version.getContentMarked());\n                            knowledgeElementResp.setOriginContent(version.getContent());\n                            knowledgeElementResp.setContent(version.getContent());\n                        });\n            }else {\n                try {\n                    DataSetFileCategory dataSetFileCategory \u003d DataSetFileCategory.getDataSetFileCategoryBySuffix(knowledgeElementResp.getEleSuffix());\n                    if (dataSetFileCategory \u003d\u003d DataSetFileCategory.TXT || dataSetFileCategory \u003d\u003d DataSetFileCategory.MARKDOWN) {\n                        // 如果是md或者txt文件，那么下载oss的内容，给到前端\n                        URL presignedUrl\u003dmaterialService.refreshPresignedUrl(saasKnowledgeElement.getEleUrl());\n                        log.info(\"download-url-string:{},presignedUrl:{}\", saasKnowledgeElement.getEleUrl(),presignedUrl);\n                        // knowledgeElementResp.setAnswer(HttpUtil.downloadString(saasKnowledgeElement.getEleUrl(), StandardCharsets.UTF_8));\n                        //knowledgeElementResp.setAnswer(WebUtil.getString(saasKnowledgeElement.getEleUrl()));\n                        knowledgeElementResp.setAnswer(WebUtil.getString(presignedUrl.toString()));\n                        // 获取原始文本\n                        if (StrUtil.isNotBlank(saasKnowledgeElement.getElePreviewUrl())) {\n                            URL presignedPreviewUrl\u003dmaterialService.refreshPresignedUrl(saasKnowledgeElement.getElePreviewUrl());\n                            log.info(\"preview-download-url-string:{},presignedPreviewUrl:{}\", saasKnowledgeElement.getElePreviewUrl(),presignedPreviewUrl);\n                            //knowledgeElementResp.setOriginContent(WebUtil.getString(saasKnowledgeElement.getElePreviewUrl()));\n                            knowledgeElementResp.setOriginContent(WebUtil.getString(presignedPreviewUrl.toString()));\n                        } else {\n                            knowledgeElementResp.setOriginContent(knowledgeElementResp.getAnswer());\n                        }\n                    }\n                } catch (Exception e) {\n                    log.error(e.getMessage(), e);\n                }\n            }\n        }\n        // 设置显示\n        if (saasKnowledgeElement.getEleSize() !\u003d null \u0026\u0026 saasKnowledgeElement.getEleSize() \u003e 0) {\n            knowledgeElementResp.setEleSizeDisplay(DataSizeUtil.format(saasKnowledgeElement.getEleSize()));\n        } else {\n            knowledgeElementResp.setEleSizeDisplay(\"-\");\n        }\n        // 设置online,非edit请求才返回online地址\n        if (!edit){\n            // 文件类型，但是不包含PDF，PDF前端单独处理\n            log.info(\"code:{} ,category:{},suffix:{}\",saasKnowledgeElement.getCode(), saasKnowledgeElement.getCategory(),saasKnowledgeElement.getEleSuffix());\n            if (KnowledgeElementCategory.FILE.name().equalsIgnoreCase(saasKnowledgeElement.getCategory())||KnowledgeElementCategory.VIRTUAL_FILE.name().equalsIgnoreCase(saasKnowledgeElement.getCategory())){\n                String url\u003dsaasKnowledgeElement.onlineUrl();\n                if (StrUtil.isNotBlank(url)){\n                    log.info(\"online-url-string:{}\", url);\n                    knowledgeElementResp.setOnline(materialService.online(ThreadLocalHolder.getHttpServletRequest(),url));\n                }\n            }\n        }\n\n        return Result.data(knowledgeElementResp);\n    }\n\n    public Result\u003cKnowledgeElementResp\u003e buildElementInfoNoAuth(SaasKnowledgeElement saasKnowledgeElement,Boolean edit,String tenantId){\n        Assert.notNull(saasKnowledgeElement, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(tenantId, saasKnowledgeElement.getTenantId()), \"system.common.request.invalid\");\n        KnowledgeElementResp knowledgeElementResp \u003d new KnowledgeElementResp();\n        BeanUtils.copyProperties(saasKnowledgeElement, knowledgeElementResp);\n        // 查询用户名称\n        Map\u003cString, String\u003e userMap \u003d userService.selectByCode(knowledgeElementResp.userCodes());\n        knowledgeElementResp.applyUserName(userMap);\n        // 判断是否为QA对\n        if (StrUtil.equalsIgnoreCase(knowledgeElementResp.getCategory(), KnowledgeElementCategory.QA.getName())) {\n            // 查询答案,相似问列表\n            knowledgeElementResp.setAnswer(knowledgeReferenceService.getAnswer(knowledgeElementResp.getCode(), tenantId));\n            knowledgeElementResp.setSimilar(knowledgeSimilarService.listSimilar(tenantId, knowledgeElementResp.getCode()));\n            // 获取原始文本\n            if (StrUtil.isNotBlank(saasKnowledgeElement.getElePreviewUrl())) {\n                knowledgeElementResp.setOriginContent(WebUtil.getString(saasKnowledgeElement.getElePreviewUrl()));\n            } else {\n                knowledgeElementResp.setOriginContent(knowledgeElementResp.getAnswer());\n            }\n        } else {\n            if (KnowledgeElementTypes.PAGE.name().equals(saasKnowledgeElement.getCategory())){\n                // 如果是页面类型的知识库元素，那么查询最新版本\n                knowledgeElementVersionService.queryLatestVersionByPageCode(saasKnowledgeElement.getCode(), saasKnowledgeElement.getTenantId(), edit)\n                        .ifPresent(version -\u003e {\n                            knowledgeElementResp.setContentMarked(version.getContentMarked());\n                            knowledgeElementResp.setOriginContent(version.getContent());\n                            knowledgeElementResp.setContent(version.getContent());\n                        });\n            }else {\n                try {\n                    DataSetFileCategory dataSetFileCategory \u003d DataSetFileCategory.getDataSetFileCategoryBySuffix(knowledgeElementResp.getEleSuffix());\n                    if (dataSetFileCategory \u003d\u003d DataSetFileCategory.TXT || dataSetFileCategory \u003d\u003d DataSetFileCategory.MARKDOWN) {\n                        // 如果是md或者txt文件，那么下载oss的内容，给到前端\n                        log.info(\"download-url-string:{}\", saasKnowledgeElement.getEleUrl());\n                        // knowledgeElementResp.setAnswer(HttpUtil.downloadString(saasKnowledgeElement.getEleUrl(), StandardCharsets.UTF_8));\n                        knowledgeElementResp.setAnswer(WebUtil.getString(saasKnowledgeElement.getEleUrl()));\n                        // 获取原始文本\n                        if (StrUtil.isNotBlank(saasKnowledgeElement.getElePreviewUrl())) {\n                            knowledgeElementResp.setOriginContent(WebUtil.getString(saasKnowledgeElement.getElePreviewUrl()));\n                        } else {\n                            knowledgeElementResp.setOriginContent(knowledgeElementResp.getAnswer());\n                        }\n                    }\n                } catch (Exception e) {\n                    log.error(e.getMessage(), e);\n                }\n            }\n        }\n        // 设置显示\n        if (saasKnowledgeElement.getEleSize() !\u003d null \u0026\u0026 saasKnowledgeElement.getEleSize() \u003e 0) {\n            knowledgeElementResp.setEleSizeDisplay(DataSizeUtil.format(saasKnowledgeElement.getEleSize()));\n        } else {\n            knowledgeElementResp.setEleSizeDisplay(\"-\");\n        }\n        return Result.data(knowledgeElementResp);\n    }\n\n    /**\n     * 根据id查询知识库元素详情\n     * @param id 知识库元素主键id\n     * @return 知识库元素详情\n     */\n    @Override\n    public Result\u003cKnowledgeElementResp\u003e queryById(Integer id) {\n        log.info(\"根据主键id查询知识库元素详情,Id:{}\", id);\n        SaasKnowledgeElement saasKnowledgeElement \u003d saasKnowledgeElementMapper.selectById(id);\n        return buildElementInfo(saasKnowledgeElement,false);\n    }\n\n    @Override\n    public Result\u003cKnowledgeElementResp\u003e queryByCode(String code, Boolean edit) {\n        Optional\u003cSaasKnowledgeElement\u003e  elementOptional\u003dqueryInfoByCode(code);\n        if (elementOptional.isEmpty()){\n            return Result.customFail(MessageCodeEnum.NOT_FOUND_RESOURCE.getCode(), MessageCodeEnum.NOT_FOUND_RESOURCE.getMsg());\n        }\n        return buildElementInfo(elementOptional.get(),edit);\n    }\n    @Override\n    public Result\u003cString\u003e queryContentByCode(String pageCode, String tenantId,String code,String userId) {\n        String cachedObject\u003d stringRedisTemplate.opsForValue().get(String.format(\"exportCode:pageCode:%s:tenantId:%s:userId:%s:decryptCode:%s\", pageCode, tenantId, userId, code));\n        if (StrUtil.isBlank(cachedObject) || !StrUtil.equals(cachedObject, code)) {\n            return Result.error(\"访问码无效或已过期\");\n        }\n        Optional\u003cSaasKnowledgeElement\u003e elementOptional\u003dqueryContentByCodeAndTenantId(pageCode,tenantId);\n        Result\u003cKnowledgeElementResp\u003e knowledgeElementRespResult \u003d buildElementInfoNoAuth(elementOptional.get(), false, tenantId);\n        return Result.data(knowledgeElementRespResult.getData().getContent());\n    }\n    @Override\n    public Result\u003cString\u003e getEncryptCode(String pageCode, String tenantId,String userId) {\n        String decryptCode \u003d IdUtil.getSnowflakeNextIdStr();\n        stringRedisTemplate.opsForValue().set(String.format(\"exportCode:pageCode:%s:tenantId:%s:userId:%s:decryptCode:%s\", pageCode, tenantId,userId,decryptCode), decryptCode, 2, TimeUnit.MINUTES);\n        return Result.data(decryptCode);\n    }\n    @Override\n    public Result\u003cBoolean\u003e getDecryptCode(String pageCode, String tenantId,String userId,String decryptCode) {\n        Boolean delete \u003d stringRedisTemplate.delete(String.format(\"exportCode:pageCode:%s:tenantId:%s:userId:%s:decryptCode:%s\", pageCode, tenantId,userId,decryptCode));\n        return delete ? Result.data(delete) : Result.error(i18nMessage.resolveMessage(\"system.common.request.invalid\"));\n    }\n\n    @Override\n    public Optional\u003cSaasKnowledgeElement\u003e queryContentByCodeAndTenantId(String code, String tenantId) {\n        SaasKnowledgeElement knowledgeElement \u003d saasKnowledgeElementMapper\n                .selectOne(Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, tenantId).eq(SaasKnowledgeElement::getCode, code), false);\n        // Assert.notNull(knowledgeElement, \"system.common.request.invalid\");\n        return Optional.ofNullable(knowledgeElement);\n    }\n\n    @Override\n    public Result\u003cKnowledgeElementResp\u003e queryByCodeNoAuth(String code, Boolean edit, String tenantId) {\n        Optional\u003cSaasKnowledgeElement\u003e  elementOptional\u003dqueryInfoByCodeNoAuth(code,tenantId);\n        if (elementOptional.isEmpty()){\n            return Result.error(i18nMessage.resolveMessage(\"system.common.request.invalid\"));\n        }\n        return buildElementInfoNoAuth(elementOptional.get(),edit,tenantId);\n    }\n\n    @Override\n    public Optional\u003cSaasKnowledgeElement\u003e queryByCode(String code, String tenantId) {\n        // 记录查询日志，包括页面代码和租户ID\n        log.info(\"根据code查询空间页面详情,code:{},tenantId:{}\", code, tenantId);\n        // 使用MyBatis Plus的Lambda查询构造器构建查询条件，包括租户ID和页面代码，\n        // 并执行查询操作，结果是一个KbPage对象或null\n        SaasKnowledgeElement kbPage \u003d saasKnowledgeElementMapper.selectOne(Wrappers.lambdaQuery(SaasKnowledgeElement.class)\n                .eq(StrUtil.isNotEmpty(tenantId), SaasKnowledgeElement::getTenantId, tenantId)\n                .eq(SaasKnowledgeElement::getCode, code), false);\n\n        // 使用Optional.ofNullable包装查询结果，确保即使结果为null也能安全处理\n        return Optional.ofNullable(kbPage);\n    }\n\n    /**\n     * 根据主键id批量删除知识库元素\n     * @param ids 批量删除主键id集合\n     * @return 是否删除成功\n     */\n    @Override\n    public Result\u003cString\u003e delete(List\u003cInteger\u003e ids) {\n        log.info(\"批量删除知识库元素,pageSize:{}\", CollectionUtil.size(ids));\n        int ret \u003d saasKnowledgeElementMapper.deleteBatchIds(ids);\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.delete.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.delete.fail\"));\n    }\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e batchDelete(List\u003cInteger\u003e ids) {\n        log.info(\"批量删除知识库元素,数量:{},ID列表:{}\", ids.size(), ids);\n        if (CollUtil.isEmpty(ids)) {\n            return Result.error(\"删除ID列表不能为空\");\n        }\n        List\u003cSaasKnowledgeElement\u003e elementsToDelete \u003d saasKnowledgeElementMapper.selectBatchIds(ids);\n        Assert.notNull(elementsToDelete, \"system.common.request.invalid\");\n        String tenantId \u003d UserContextHolder.getTenantId();\n        SysUserInfo currentUser \u003d UserContextHolder.getCurrentUser();\n\n        // 验证所有元素的权限和删除条件\n        StringBuilder validationErrors \u003d new StringBuilder();\n        List\u003cSaasKnowledgeElement\u003e validElements \u003d new ArrayList\u003c\u003e();\n\n        for (SaasKnowledgeElement element : elementsToDelete) {\n            try {\n                // 1. 权限验证\n                if (!StrUtil.equalsIgnoreCase(element.getTenantId(), tenantId)) {\n                    validationErrors.append(\"ID[\").append(element.getId()).append(\"]数据无效; \");\n                    continue;\n                }\n                // 2. 文件夹检查\n                if (StrUtil.equalsIgnoreCase(element.getCategory(), KnowledgeElementCategory.DIRECTORY.getName())) {\n                    LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class)\n                            .eq(SaasKnowledgeElement::getTenantId, tenantId)\n                            .eq(SaasKnowledgeElement::getContainerId, element.getContainerId())\n                            .eq(SaasKnowledgeElement::getParentCode, element.getCode());\n                    if (saasKnowledgeElementMapper.exists(lambdaQueryWrapper)) {\n                        validationErrors.append(\"ID[\").append(element.getId()).append(\"]文件夹[\").append(element.getEleName()).append(\"]下存在文件,不允许删除; \");\n                        continue;\n                    }\n                } else {\n                    // 3. 状态检查\n                    ProcessStatusEnum processStatusEnum \u003d ProcessStatusEnum.parse(element.getProcessStatus());\n                    if (processStatusEnum \u003d\u003d ProcessStatusEnum.PROCESSING || processStatusEnum \u003d\u003d ProcessStatusEnum.EMBEDDED || processStatusEnum \u003d\u003d ProcessStatusEnum.EMBEDDING) {\n                        if (ChronoUnit.MINUTES.between(element.getCreateTime(), LocalDateTime.now()) \u003c 120) {\n                            validationErrors.append(\"ID[\").append(element.getId()).append(\"]正在处理中,不允许删除; \");\n                            continue;\n                        }\n                    }\n                }\n                validElements.add(element);\n            } catch (Exception e) {\n                log.error(\"验证元素失败,ID:{}\", element.getId(), e);\n                validationErrors.append(\"ID[\").append(element.getId()).append(\"]验证失败: \").append(e.getMessage()).append(\"; \");\n            }\n        }\n        if (CollUtil.isEmpty(validElements)) {\n            return Result.error(\"没有符合删除条件的元素: \" + validationErrors.toString());\n        }\n\n        List\u003cInteger\u003e validIds \u003d validElements.stream().map(SaasKnowledgeElement::getId).toList();\n        int deletedCount \u003d saasKnowledgeElementMapper.deleteBatchIds(validIds);\n        if (deletedCount \u003e 0) {\n            long totalSizeReleased \u003d 0L;\n            List\u003cString\u003e deletedNames \u003d new ArrayList\u003c\u003e();\n            Map\u003cString, List\u003cSaasKnowledgeElement\u003e\u003e containerElementsMap \u003d new HashMap\u003c\u003e();\n            for (SaasKnowledgeElement element : validElements) {\n                try {\n                    // 统计释放的空间大小\n                    if (element.getEleSize() !\u003d null) {\n                        totalSizeReleased +\u003d element.getEleSize();\n                    }\n                    deletedNames.add(element.getEleName());\n                    containerElementsMap.computeIfAbsent(element.getContainerId(), k -\u003e new ArrayList\u003c\u003e()).add(element);\n\n                    // 删除向量索引数据\n                    knowledgeElementDataService.deleteByDataId(tenantId, element.getContainerId(), element.getCode());\n\n                    if (KnowledgeElementTypes.PAGE.name().equals(element.getCategory())) {\n                        // 删除快照文件\n                        LambdaQueryWrapper\u003cSaasKnowledgeElementVersion\u003e versionQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElementVersion.class)\n                                .eq(SaasKnowledgeElementVersion::getPageCode, element.getCode())\n                                .eq(SaasKnowledgeElementVersion::getTenantId, tenantId);\n                        knowledgeElementVersionService.remove(versionQueryWrapper);\n                        // 删除配置向量\n                        LambdaQueryWrapper\u003cSaasKnowledgeConfigElement\u003e configQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeConfigElement.class)\n                                .eq(SaasKnowledgeConfigElement::getElementId, element.getCode())\n                                .eq(SaasKnowledgeConfigElement::getContainerId, element.getContainerId())\n                                .eq(SaasKnowledgeConfigElement::getTenantId, element.getTenantId());\n                        saasKnowledgeConfigElementService.remove(configQueryWrapper);\n                    }\n                } catch (Exception e) {\n                    log.error(\"清理元素数据失败,ID:{},名称:{}\", element.getId(), element.getEleName(), e);\n                }\n            }\n\n            // 批量释放知识库空间容量\n            if (totalSizeReleased \u003e 0) {\n                try {\n                    for (Map.Entry\u003cString, List\u003cSaasKnowledgeElement\u003e\u003e entry : containerElementsMap.entrySet()) {\n                        String containerId \u003d entry.getKey();\n                        long containerSizeReleased \u003d entry.getValue().stream()\n                                .mapToLong(e -\u003e e.getEleSize() !\u003d null ? e.getEleSize() : 0L)\n                                .sum();\n                        if (containerSizeReleased \u003e 0) {\n                            knowledgeContainerCapacityDataService.flushKnowledge(containerId, containerSizeReleased);\n                        }\n                    }\n                } catch (Exception e) {\n                    log.error(\"释放知识库容量失败,总大小:{}\", totalSizeReleased, e);\n                }\n            }\n            // 空间动态信息新增\n            try {\n                for (Map.Entry\u003cString, List\u003cSaasKnowledgeElement\u003e\u003e entry : containerElementsMap.entrySet()) {\n                    String containerId \u003d entry.getKey();\n                    List\u003cSaasKnowledgeElement\u003e containerElements \u003d entry.getValue();\n\n                    boolean needUpdateTrend \u003d containerElements.stream().anyMatch(element -\u003e {\n                        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e queryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n                        queryWrapper.eq(SaasKnowledgeContainer::getCode, containerId);\n                        queryWrapper.eq(SaasKnowledgeContainer::getTenantId, tenantId);\n                        SaasKnowledgeContainer container \u003d saasKnowledgeContainerMapper.selectOne(queryWrapper);\n                        return container !\u003d null\n                                \u0026\u0026 !ProcessStatusEnum.DRAFT.equals(ProcessStatusEnum.parse(element.getProcessStatus()))\n                                \u0026\u0026 container.getCategory().equals(KnowledgeCategory.COMMON.name());\n                    });\n                    if (needUpdateTrend) {\n                        SaasKnowledgeElement representativeElement \u003d containerElements.get(0);\n                        SaasKnowledgeElementCacheInfo cacheInfo \u003d this.get(containerId, tenantId);\n                        // 批量操作\n                        representativeElement.setEleName(String.format(\"批量删除%d个文件: %s等\",containerElements.size(),\n                                containerElements.stream().limit(3).map(SaasKnowledgeElement::getEleName).collect(Collectors.joining(\", \"))));\n\n                        saasKnowledgeElementTrendService.messageTrend(SaasKnowledgeElementTrendAddReq.of(currentUser, representativeElement,SaasKnowledgeElementEvent.DELETED, cacheInfo));\n                    }\n                }\n            } catch (Exception e) {\n                log.error(\"更新批量删除动态失败\", e);\n            }\n\n            log.info(\"批量删除完成,成功删除{}个元素,释放空间{}bytes,删除列表:{}\",deletedCount, totalSizeReleased, deletedNames);\n        }\n        if (deletedCount \u003d\u003d ids.size()) {\n            return Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.delete.success\"));\n        } else if (deletedCount \u003e 0) {\n            String message \u003d String.format(\"部分删除成功: 成功%d个,失败%d个。失败详情: %s\",deletedCount, ids.size() - deletedCount, validationErrors.toString());\n            return Result.error(message);\n        } else {\n            return Result.error(\"批量删除失败: \" + validationErrors.toString());\n        }\n    }\n\n    /**\n     * 根据主键id删除知识库元素\n     * @param id 主键id\n     * @return 是否删除成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e delete(Integer id) {\n        log.info(\"根据主键id删除知识库元素,id:{}\", id);\n        String tenantId \u003d UserContextHolder.getTenantId();\n        SaasKnowledgeElement saasKnowledgeElement \u003d saasKnowledgeElementMapper.selectById(id);\n        Assert.notNull(saasKnowledgeElement, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(saasKnowledgeElement.getTenantId(), tenantId), \"system.common.request.invalid\");\n        LogContext.putVariable(\"name\", saasKnowledgeElement.getEleName());\n        KnowledgeElementCategory category \u003d KnowledgeElementCategory.getKnowledgeCategory(saasKnowledgeElement.getCategory());\n        LogContext.putVariable(\"type\", category.getDescription());\n        if (StrUtil.equalsIgnoreCase(saasKnowledgeElement.getCategory(), KnowledgeElementCategory.DIRECTORY.getName())) {\n            // 如果是文件夹，需要判断下面是否存在多个文件\n            LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, tenantId)\n                    .eq(SaasKnowledgeElement::getContainerId, saasKnowledgeElement.getContainerId())\n                    .eq(SaasKnowledgeElement::getParentCode, saasKnowledgeElement.getCode());\n            // Assert.isFalse(saasKnowledgeElementMapper.exists(lambdaQueryWrapper), \"文件夹[\" + saasKnowledgeElement.getEleName() + \"]下存在文件,不允许删除\");\n            Assert.isFalse(saasKnowledgeElementMapper.exists(lambdaQueryWrapper), i18nMessage.resolveMessage(\"knowledge.dataset.del.exist\", new String[]{saasKnowledgeElement.getEleName()}));\n        } else {\n            // 判断状态,正在处理中的文件不允许删除\n            ProcessStatusEnum processStatusEnum \u003d ProcessStatusEnum.parse(saasKnowledgeElement.getProcessStatus());\n            if (processStatusEnum \u003d\u003d ProcessStatusEnum.PROCESSING || processStatusEnum \u003d\u003d ProcessStatusEnum.EMBEDDED || processStatusEnum \u003d\u003d ProcessStatusEnum.EMBEDDING) {\n                // 判断创建日期是否超过2小时，如果超过，那么验证通过，直接删除,否则不允许删除\n                if (ChronoUnit.MINUTES.between(saasKnowledgeElement.getCreateTime(), LocalDateTime.now()) \u003c 120) {\n                    // 在2小时内的知识库，不允许删除\n                    throw new IllegalArgumentException(i18nMessage.resolveMessage(\"knowledge.dataset.del.process\"));\n                }\n\n            }\n        }\n        // 查询当前文档类型\n        int ret \u003d saasKnowledgeElementMapper.deleteById(id);\n        // 判断，如果是非文件夹的数据集，那么删除数据集的向量索引内容\n        if (ret \u003e 0) {\n            // 释放知识库的空间容量大小\n            knowledgeContainerCapacityDataService.flushKnowledge(saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getEleSize());\n            // 根据数据集code删除索引的数据\n            knowledgeElementDataService.deleteByDataId(tenantId, saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getCode());\n            if (KnowledgeElementTypes.PAGE.name().equals(saasKnowledgeElement.getCategory())){\n                // 删除快照文件\n                LambdaQueryWrapper\u003cSaasKnowledgeElementVersion\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElementVersion.class)\n                        .eq(SaasKnowledgeElementVersion::getPageCode, saasKnowledgeElement.getCode())\n                        .eq(SaasKnowledgeElementVersion::getTenantId, tenantId);\n                knowledgeElementVersionService.remove(lambdaQueryWrapper);\n                // 删除配置向量\n                LambdaQueryWrapper\u003cSaasKnowledgeConfigElement\u003e saasKnowledgeConfigContainerLambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeConfigElement.class)\n                        .eq(SaasKnowledgeConfigElement::getElementId, saasKnowledgeElement.getCode())\n                        .eq(SaasKnowledgeConfigElement::getContainerId, saasKnowledgeElement.getContainerId())\n                        .eq(SaasKnowledgeConfigElement::getTenantId, saasKnowledgeElement.getTenantId());\n                saasKnowledgeConfigElementService.remove(saasKnowledgeConfigContainerLambdaQueryWrapper);\n            }\n            // 通用知识库文档列入 草稿状态不列入动态信息\n            String containerId \u003d saasKnowledgeElement.getContainerId();\n            LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e queryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n            queryWrapper.eq(SaasKnowledgeContainer::getCode, containerId);\n            queryWrapper.eq(SaasKnowledgeContainer::getTenantId, tenantId);\n            SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectOne(queryWrapper);\n            if (!ProcessStatusEnum.DRAFT.equals(ProcessStatusEnum.parse(saasKnowledgeElement.getProcessStatus()))\n                    \u0026\u0026 saasKnowledgeContainer.getCategory().equals(KnowledgeCategory.COMMON.name())){\n                // 空间动态信息新增\n                SaasKnowledgeElementCacheInfo saasKnowledgeElementCacheInfo \u003d this.get(saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getTenantId());\n                saasKnowledgeElementTrendService.messageTrend(SaasKnowledgeElementTrendAddReq.of(UserContextHolder.getCurrentUser(), saasKnowledgeElement, SaasKnowledgeElementEvent.DELETED, saasKnowledgeElementCacheInfo));\n            }\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.delete.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.delete.fail\"));\n    }\n\n    @Override\n    public void deleteByCode(String tenantId, String containerId, List\u003cString\u003e codes) {\n        log.info(\"删除知识库文件，code:{}，tenant:{}\", codes, tenantId);\n        for (String code : codes) {\n            int ret \u003d saasKnowledgeElementMapper.delete(Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, tenantId).eq(SaasKnowledgeElement::getCode, code));\n            if (ret \u003e 0) {\n                // 根据数据集code删除索引的数据\n                knowledgeElementDataService.deleteByDataId(tenantId, containerId, code);\n            }\n        }\n    }\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e reset(Integer id) {\n        log.info(\"根据主键id重置知识库元素,id:{}\", id);\n        String tenantId \u003d UserContextHolder.getTenantId();\n        SaasKnowledgeElement saasKnowledgeElement \u003d saasKnowledgeElementMapper.selectById(id);\n        Assert.notNull(saasKnowledgeElement, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(saasKnowledgeElement.getTenantId(), tenantId), \"system.common.request.invalid\");\n        LogContext.putVariable(\"name\", saasKnowledgeElement.getEleName());\n        KnowledgeElementCategory category \u003d KnowledgeElementCategory.getKnowledgeCategory(saasKnowledgeElement.getCategory());\n        LogContext.putVariable(\"type\", category.getDescription());\n        // 判断状态,正在处理中的文件不允许删除\n        ProcessStatusEnum processStatusEnum \u003d ProcessStatusEnum.parse(saasKnowledgeElement.getProcessStatus());\n        // 如果已经是待处理或者成功的状态，那么不用二次重置处理\n        if (processStatusEnum \u003d\u003d ProcessStatusEnum.SUCCESS || processStatusEnum \u003d\u003d ProcessStatusEnum.INIT) {\n            return Result.data(\"SUCCESS\");\n        }\n        // 非处理失败的情况下，给一个间隔\n        if (processStatusEnum !\u003d ProcessStatusEnum.FAILURE) {\n            // 计算一下时间，避免误操作\n            if (ChronoUnit.MINUTES.between(saasKnowledgeElement.getModifierTime(), LocalDateTime.now()) \u003c 0.5) {\n                // 在5分钟内，不允许重置\n                throw new IllegalArgumentException(i18nMessage.resolveMessage(\"knowledge.dataset.file.status.reset.process\"));\n            }\n        }\n        // 更新状态\n        SaasKnowledgeElement element \u003d new SaasKnowledgeElement();\n        element.setId(id);\n        element.setModifierTime(LocalDateTime.now());\n        element.setProcessStatus(ProcessStatusEnum.INIT.getCode());\n        // 判断文本的元素类型，如果是wiki类型，那么不需要重置地址,这样在向量化的过程中使用wiki转换过的markdown数据\n        if (!StrUtil.equalsIgnoreCase(saasKnowledgeElement.getCategory(), KnowledgeElementCategory.VIRTUAL_FILE.getName())) {\n            if (StrUtil.isNotBlank(saasKnowledgeElement.getElePreviewUrl())){\n                // 把原始的地址重置回去\n                element.setEleUrl(saasKnowledgeElement.getElePreviewUrl());\n            }\n        }\n        int ret \u003d saasKnowledgeElementMapper.updateById(element);\n        if (ret \u003e 0) {\n            // 根据数据集code删除索引的数据\n            knowledgeElementDataService.deleteByDataId(tenantId, saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getCode());\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"knowledge.dataset.file.status.reset\"))\n                : Result.error(i18nMessage.resolveMessage(\"knowledge.dataset.file.status.reset.fail\"));\n    }\n\n    /**\n     * 根据id查询知识库元素实体详情\n     * @param id 主键id\n     * @return 知识库元素的Optional\n     */\n    @Override\n    public Optional\u003cSaasKnowledgeElement\u003e queryInfoById(Integer id) {\n        log.info(\"根据请求id查询知识库元素实体详情,id:{}\", id);\n        SaasKnowledgeElement saasKnowledgeElement \u003d saasKnowledgeElementMapper.selectById(id);\n        if (saasKnowledgeElement !\u003d null) {\n            return Optional.of(saasKnowledgeElement);\n        }\n        return Optional.empty();\n    }\n\n    @Override\n    public void updatePreviewUrl(Integer id, String previewUrl) {\n        SaasKnowledgeElement knowledgeElement \u003d new SaasKnowledgeElement();\n        knowledgeElement.setId(id);\n        knowledgeElement.setModifierTime(LocalDateTime.now());\n        knowledgeElement.setElePreviewUrl(previewUrl);\n        saasKnowledgeElementMapper.updateById(knowledgeElement);\n    }\n\n    @Override\n    public Optional\u003cSaasKnowledgeElement\u003e queryInfoByCode(String code) {\n        SaasKnowledgeElement knowledgeElement \u003d saasKnowledgeElementMapper\n                .selectOne(Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, UserContextHolder.getTenantId()).eq(SaasKnowledgeElement::getCode, code), false);\n        // Assert.notNull(knowledgeElement, \"system.common.request.invalid\");\n        return Optional.ofNullable(knowledgeElement);\n    }\n    @Override\n    public Optional\u003cSaasKnowledgeElement\u003e queryInfoByCodeNoAuth(String code, String tenantId) {\n        SaasKnowledgeElement knowledgeElement \u003d saasKnowledgeElementMapper\n                .selectOne(Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, tenantId).eq(SaasKnowledgeElement::getCode, code), false);\n        // Assert.notNull(knowledgeElement, \"system.common.request.invalid\");\n        return Optional.ofNullable(knowledgeElement);\n    }\n\n    @Override\n    public void deleteByContainerCode(String containerId, String tenantId) {\n        log.info(\"删除容器下的所有元素,containerId:{},tenantId:{}\", containerId, tenantId);\n        LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, tenantId)\n                .eq(SaasKnowledgeElement::getContainerId, containerId);\n        saasKnowledgeElementMapper.delete(lambdaQueryWrapper);\n    }\n\n    /**\n     * 校验请求id是否非法\n     * @param id 主键id\n     * @return 是否存在\n     */\n    @Override\n    public boolean checkIdExists(Integer id) {\n        log.info(\"校验请求Id是否存在,id:{}\", id);\n        return saasKnowledgeElementMapper.selectById(id) !\u003d null;\n    }\n\n    @Override\n    public void resetStatus(SaasKnowledgeElement element, ProcessStatusEnum statusEnum) {\n        log.info(\"知识重调\");\n        if (element\u003d\u003dnull || element.getId()\u003d\u003dnull){\n            log.warn(\"知识重调失败，元素信息为空\");\n            return;\n        }\n        SaasKnowledgeElement knowledgeElement \u003d new SaasKnowledgeElement();\n        knowledgeElement.setId(element.getId());\n        knowledgeElement.setProcessStatus(statusEnum.getCode());\n        knowledgeElement.setModifierTime(LocalDateTime.now());\n        // 修改地址preview地址为element,doc/docx格式下会重新解析\n        knowledgeElement.setEleUrl(element.getElePreviewUrl());\n        saasKnowledgeElementMapper.updateById(knowledgeElement);\n    }\n\n    @Override\n    public void updateStatus(Integer id, ProcessStatusEnum statusEnum) {\n        SaasKnowledgeElement knowledgeElement \u003d new SaasKnowledgeElement();\n        knowledgeElement.setId(id);\n        knowledgeElement.setProcessStatus(statusEnum.getCode());\n        knowledgeElement.setModifierTime(LocalDateTime.now());\n        saasKnowledgeElementMapper.updateById(knowledgeElement);\n    }\n\n    @Override\n    public void updateEmbeddingStatus(Integer id, KnowledgeEmbeddingStatusReq embeddingStatusReq) {\n        SaasKnowledgeElement knowledgeElement \u003d new SaasKnowledgeElement();\n        knowledgeElement.setId(id);\n        knowledgeElement.setModifierTime(LocalDateTime.now());\n        knowledgeElement.setProcessStatus(embeddingStatusReq.getStatusEnum().getCode());\n        if (embeddingStatusReq.getPageCount() !\u003d null \u0026\u0026 embeddingStatusReq.getPageCount() \u003e 0) {\n            // 处理完成\n            knowledgeElement.setProcessCount(embeddingStatusReq.getPageCount());\n            knowledgeElement.setPageCount(embeddingStatusReq.getPageCount());\n        }\n        if (StrUtil.isNotBlank(embeddingStatusReq.getConvertMarkdownFileUrl())) {\n            // 转换地址不为空\n            knowledgeElement.setEleUrl(embeddingStatusReq.getConvertMarkdownFileUrl());\n        }\n        if (StrUtil.isNotBlank(embeddingStatusReq.getPreviewUrl())) {\n            knowledgeElement.setElePreviewUrl(embeddingStatusReq.getPreviewUrl());\n        }\n        saasKnowledgeElementMapper.updateById(knowledgeElement);\n    }\n\n    @Override\n    public void updateProcessCount(Integer id, int processPage, int pageCount) {\n        SaasKnowledgeElement knowledgeElement \u003d new SaasKnowledgeElement();\n        knowledgeElement.setId(id);\n        knowledgeElement.setModifierTime(LocalDateTime.now());\n        if (processPage \u003e 0) {\n            knowledgeElement.setPageCount(pageCount);\n        }\n        if (pageCount \u003e 0) {\n            knowledgeElement.setProcessCount(processPage);\n        }\n        log.info(\"更新处理进度,id:{},processPage:{},pageCount:{}\", id, processPage, pageCount);\n        if (processPage \u003e 0 \u0026\u0026 pageCount \u003e 0) {\n            log.info(\"exchange,id:{},processPage:{},pageCount:{}\", id, processPage, pageCount);\n            // 如果页码相等，status\u003d完成\n            knowledgeElementProcessService.exchange(id, processPage, pageCount);\n        }\n        // 如果页码相等，status\u003d完成\n        if (processPage \u003d\u003d pageCount) {\n            knowledgeElement.setProcessStatus(ProcessStatusEnum.SUCCESS.getCode());\n        }\n        saasKnowledgeElementMapper.updateById(knowledgeElement);\n    }\n\n    @Override\n    public Result\u003cString\u003e updateContent(KnowledgeElementContentUpdateReq issueReq) {\n        // 获取当前用户信息\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 根据页面代码和租户ID查询页面信息\n        Optional\u003cSaasKnowledgeElement\u003e saasKnowledgeElementOptional \u003d this.queryByCode(issueReq.getCode(), sysUserInfo.getTenantId());\n        if (saasKnowledgeElementOptional.isEmpty()) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        // 获取查询到的页面记录\n        SaasKnowledgeElement record \u003d saasKnowledgeElementOptional.get();\n        // 创建一个新的KbPage对象用于更新\n        SaasKnowledgeElement saasKnowledgeElement \u003d issueReq.update(record);\n        // 草稿状态更新标题\n        // 更新标题和过期时间\n        issueReq.updatePageTitle(saasKnowledgeElement);\n        int ret \u003d saasKnowledgeElementMapper.updateById(saasKnowledgeElement);\n        if (ret \u003e 0) {\n            // 版本存在两种情况，一种是当前的页面本身就是待处理状态，那么就一直更新当前版本的内容，版本号不更新\n            if (Objects.equals(record.getProcessStatus(), ProcessStatusEnum.DRAFT.getCode())){\n                // 草稿状态更新版本信息\n                this.update(record, issueReq, sysUserInfo, KnowledgeElementVersionStatus.DEFAULT);\n            } else if (Objects.equals(record.getProcessStatus(), ProcessStatusEnum.SUCCESS.getCode())) {\n                // 更新一下标题、过期时间、样式 作为版本副本\n                issueReq.updatePageTitle(saasKnowledgeElement);\n                // 如果是已经发布的状态 新增一个版本作为当前页面版本的草稿状态\n                this.merge(saasKnowledgeElement, issueReq.getAttachments(), sysUserInfo, KnowledgeElementVersionStatus.DEFAULT);\n            }\n            // 通用知识库文档列入 草稿状态不列入动态信息\n            String containerId \u003d saasKnowledgeElement.getContainerId();\n            LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e queryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n            queryWrapper.eq(SaasKnowledgeContainer::getCode, containerId);\n            queryWrapper.eq(SaasKnowledgeContainer::getTenantId, sysUserInfo.getTenantId());\n            SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectOne(queryWrapper);\n            if (!ProcessStatusEnum.DRAFT.equals(ProcessStatusEnum.parse(record.getProcessStatus()))\n            \u0026\u0026 saasKnowledgeContainer.getCategory().equals(KnowledgeCategory.COMMON.name())){\n                // 空间动态信息新增\n                SaasKnowledgeElementCacheInfo saasKnowledgeElementCacheInfo \u003d this.get(saasKnowledgeElement.getContainerId(), saasKnowledgeElement.getTenantId());\n                saasKnowledgeElementTrendService.messageTrend(SaasKnowledgeElementTrendAddReq.of(UserContextHolder.getCurrentUser(), saasKnowledgeElement, SaasKnowledgeElementEvent.UPDATED, saasKnowledgeElementCacheInfo));\n            }\n        }\n        return i18nMessage.update(ret);\n    }\n\n    @Override\n    public Result\u003cString\u003e issue(KnowledgeElementContentUpdateReq issueReq, boolean isIssue) {\n        // 记录发布空间页面的日志\n        String code \u003d issueReq.getCode();\n        log.info(\"当前更新的页面变为为,code:{}\", code);\n        // 获取当前用户信息\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 根据页面代码和租户ID查询页面信息\n        Optional\u003cSaasKnowledgeElement\u003e saasKnowledgeElementOptional \u003d this.queryByCode(issueReq.getCode(), sysUserInfo.getTenantId());\n        if (saasKnowledgeElementOptional.isEmpty()){\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        // 获取查询到的页面记录\n        SaasKnowledgeElement data \u003d saasKnowledgeElementOptional.get();\n        // 确保 DEFAULT 版本存在\n        ensureDefaultVersionExists(data, issueReq, sysUserInfo);\n        Long contentSize \u003d 0L;\n        // 发布逻辑：更新状态为已发布\n        if (isIssue) {\n            data.setProcessStatus(ProcessStatusEnum.INIT.getCode());\n            data.setModifierTime(LocalDateTime.now());\n            data.setModifier(sysUserInfo.getCode());\n            data.setEleName(issueReq.getTitle());\n            if (DocTimeStatus.NEVER_EXPIRE.getCode() \u003d\u003d issueReq.getNeverExpire()){\n                data.setNeverExpire(issueReq.getNeverExpire());\n            }else {\n                data.setNeverExpire(issueReq.getNeverExpire());\n                DateTimeFormatter formatter \u003d DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\");\n                String startTimeStr \u003d issueReq.getStartTime();\n                String endTimeStr \u003d issueReq.getEndTime();\n                LocalDateTime start \u003d null;\n                LocalDateTime end \u003d null;\n                try {\n                    if (startTimeStr !\u003d null \u0026\u0026 !startTimeStr.isEmpty()) {\n                        start \u003d LocalDateTime.parse(startTimeStr, formatter);\n                    }\n                    if (endTimeStr !\u003d null \u0026\u0026 !endTimeStr.isEmpty()) {\n                        end \u003d LocalDateTime.parse(endTimeStr, formatter);\n                    }\n                } catch (DateTimeParseException e) {\n                    // 这里可以记录日志或抛出自定义异常\n                     log.error(\"时间格式错误\", e);\n                }\n                data.setStartTime(start);\n                data.setEndTime(end);\n            }\n            // 在发布时计算文件大小\n            contentSize \u003d calculateContentSize(issueReq.getContentMarked());\n            data.setEleSize(contentSize);\n        }\n        // 如果是发布状态，那么需要更新版本信息\n        if (isIssue \u0026\u0026 contentSize\u003e0){\n            // 校验容器大小\n            knowledgeContainerCapacityDataService.validateContainerCapacity(data.getContainerId(), contentSize);\n        }\n        // 更新数据库\n        int ret \u003d saasKnowledgeElementMapper.updateById(data);\n        if (ret \u003e 0) {\n            // 更新页面内容数据\n            SaasKnowledgeElementVersion updateEntity \u003d new SaasKnowledgeElementVersion();\n            updateEntity.setContentMarked(issueReq.getContentMarked());\n            updateEntity.setContent(issueReq.getContent());\n            updateEntity.setStatus(KnowledgeElementVersionStatus.ISSUED.getCode());\n            LambdaQueryWrapper\u003cSaasKnowledgeElementVersion\u003e queryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n            queryWrapper.eq(SaasKnowledgeElementVersion::getPageCode, data.getCode())\n                    .eq(SaasKnowledgeElementVersion::getStatus, KnowledgeElementVersionStatus.DEFAULT.getCode())\n                    .eq(SaasKnowledgeElementVersion::getTenantId, data.getTenantId());\n            saasKnowledgeElementVersionMapper.update(updateEntity, queryWrapper);\n            // 清理旧es数据\n            boolean re \u003d knowledgeElementDataService.deleteByDataId(sysUserInfo.getTenantId(),data.getContainerId(), code);\n            log.info(\"数据库删除成功,ret:{},向量删除:{}\", ret, re);\n            // 空间动态信息新增\n            // 通用知识库文档列入 草稿状态不列入动态信息\n            String containerId \u003d data.getContainerId();\n            LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e saasKnowledgeContainerLambdaQueryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n            saasKnowledgeContainerLambdaQueryWrapper.eq(SaasKnowledgeContainer::getCode, containerId);\n            saasKnowledgeContainerLambdaQueryWrapper.eq(SaasKnowledgeContainer::getTenantId, sysUserInfo.getTenantId());\n            SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectOne(saasKnowledgeContainerLambdaQueryWrapper);\n            if(saasKnowledgeContainer.getCategory().equals(KnowledgeCategory.COMMON.name())){\n                SaasKnowledgeElementCacheInfo saasKnowledgeElementCacheInfo \u003d this.get(data.getContainerId(), data.getTenantId());\n                // 第一次发布是发布后续是修改\n                LambdaQueryWrapper\u003cSaasKnowledgeElementVersion\u003e saasKnowledgeElementVersionLambdaQueryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n                saasKnowledgeElementVersionLambdaQueryWrapper.eq(SaasKnowledgeElementVersion::getPageCode, data.getCode());\n                saasKnowledgeElementVersionLambdaQueryWrapper.eq(SaasKnowledgeElementVersion::getTenantId, sysUserInfo.getTenantId());\n                int size \u003d saasKnowledgeElementVersionMapper.selectList(saasKnowledgeElementVersionLambdaQueryWrapper).size();\n                if (size \u003e 1 ){\n                    saasKnowledgeElementTrendService.messageTrend(SaasKnowledgeElementTrendAddReq.of(UserContextHolder.getCurrentUser(), data,\n                            SaasKnowledgeElementEvent.UPDATED, saasKnowledgeElementCacheInfo));\n                }else {\n                    saasKnowledgeElementTrendService.messageTrend(SaasKnowledgeElementTrendAddReq.of(UserContextHolder.getCurrentUser(), data,\n                            SaasKnowledgeElementEvent.ISSUED, saasKnowledgeElementCacheInfo));\n                }\n\n            }\n        }\n        return i18nMessage.update(ret);\n    }\n\n    /**\n     * 计算内容大小（带详细调试信息）\n     * @param content 原始内容\n     * @return 内容大小（字节）\n     */\n    private Long calculateContentSize(String content) {\n        if (StrUtil.isBlank(content)) {\n            log.info(\"内容为空，返回大小: 0\");\n            return 0L;\n        }\n\n        // 字符数量\n        int charCount \u003d content.length();\n\n        // UTF-8字节数\n        byte[] utf8Bytes \u003d content.getBytes(StandardCharsets.UTF_8);\n        long utf8Size \u003d utf8Bytes.length;\n\n        // 默认编码字节数（用于对比）\n        byte[] defaultBytes \u003d content.getBytes();\n        long defaultSize \u003d defaultBytes.length;\n\n        // 详细日志\n        log.info(\"\u003d\u003d\u003d 内容大小计算详情 \u003d\u003d\u003d\");\n        log.info(\"字符数量: {}\", charCount);\n        log.info(\"UTF-8字节数: {} ({} KB)\", utf8Size, utf8Size / 1024.0);\n        log.info(\"默认编码字节数: {} ({} KB)\", defaultSize, defaultSize / 1024.0);\n        log.info(\"内容类型分析:\");\n        log.info(\"- 是否包含HTML标签: {}\", content.contains(\"\u003c\") \u0026\u0026 content.contains(\"\u003e\"));\n        log.info(\"- 是否包含中文: {}\", content.matches(\".*[\\u4e00-\\u9fa5].*\"));\n        log.info(\"- 内容开头100字符: {}\",\n                content.length() \u003e 100 ? content.substring(0, 100) : content);\n\n        return utf8Size;\n    }\n\n    /**\n     * 确保存在 DEFAULT 版本（UPSERT 逻辑）\n     * 如果不存在则创建，存在则不处理\n     */\n    private void ensureDefaultVersionExists(SaasKnowledgeElement data,\n                                            KnowledgeElementContentUpdateReq issueReq,\n                                            SysUserInfo sysUserInfo) {\n        // 检查是否存在 DEFAULT 版本\n        LambdaQueryWrapper\u003cSaasKnowledgeElementVersion\u003e checkWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n        checkWrapper.eq(SaasKnowledgeElementVersion::getPageCode, data.getCode())\n                .eq(SaasKnowledgeElementVersion::getStatus, KnowledgeElementVersionStatus.DEFAULT.getCode())\n                .eq(SaasKnowledgeElementVersion::getTenantId, data.getTenantId());\n\n        Long count \u003d saasKnowledgeElementVersionMapper.selectCount(checkWrapper);\n\n        // 如果不存在 DEFAULT 版本，则创建一个\n        if (count \u003d\u003d 0) {\n            // 查询已发布的最大版本号\n            LambdaQueryWrapper\u003cSaasKnowledgeElementVersion\u003e queryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElementVersion.class)\n                    .eq(SaasKnowledgeElementVersion::getTenantId, data.getTenantId())\n                    .eq(SaasKnowledgeElementVersion::getPageCode, issueReq.getCode())\n                    .eq(SaasKnowledgeElementVersion::getStatus, KnowledgeElementVersionStatus.ISSUED.getCode());\n            queryWrapper.select(SaasKnowledgeElementVersion::getVersionNo);\n            List\u003cSaasKnowledgeElementVersion\u003e issuedVersions \u003d saasKnowledgeElementVersionMapper.selectList(queryWrapper);\n            int maxVersionNo \u003d issuedVersions.stream()\n                    .map(SaasKnowledgeElementVersion::getVersionNo)\n                    .max(Integer::compareTo)\n                    .orElse(0); // 没有已发布版本则为0\n            int newVersionNo \u003d maxVersionNo + 1;\n            SaasKnowledgeElementVersion record \u003d new SaasKnowledgeElementVersion();\n            record.setVersionNo(newVersionNo);\n            record.setTitle(issueReq.getTitle());\n            record.setDescription(data.getConfig());\n            record.setUserCode(sysUserInfo.getCode());\n            record.setContent(issueReq.getContent());\n            record.setContentMarked(issueReq.getContentMarked());\n            record.setPageCode(issueReq.getCode());\n            record.setTenantId(sysUserInfo.getTenantId());\n            record.setCreator(sysUserInfo.getCode());\n            record.setCreateTime(LocalDateTime.now());\n            record.setModifier(sysUserInfo.getCode());\n            record.setModifierTime(LocalDateTime.now());\n            record.setStatus(KnowledgeElementVersionStatus.DEFAULT.getCode());\n            record.setCode(IdUtil.getSnowflakeNextIdStr());\n            if (CollUtil.isNotEmpty(issueReq.getAttachments())) {\n                record.setAttachmentCode(CollUtil.join(issueReq.getAttachments(), StrUtil.COMMA));\n            }\n            log.info(\"生成一个新的版本号，versionNo:{},versionCode:{}\", record.getVersionNo());\n            // insert\n            int ret \u003d saasKnowledgeElementVersionMapper.insert(record);\n            log.info(\"频繁发布新增默认版本,结果ret:{}\", ret);\n        }\n    }\n\n    @Override\n    public void update(SaasKnowledgeElement saasKnowledgeElement, KnowledgeElementContentUpdateReq knowledgeElementContentUpdateReq, SysUserInfo sysUserInfo, KnowledgeElementVersionStatus status) {\n        // 查询指定页面信息\n        LambdaQueryWrapper\u003cSaasKnowledgeElementVersion\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElementVersion.class)\n                .eq(SaasKnowledgeElementVersion::getTenantId, saasKnowledgeElement.getTenantId())\n                .eq(SaasKnowledgeElementVersion::getPageCode, saasKnowledgeElement.getCode());\n        SaasKnowledgeElementVersion record \u003d new SaasKnowledgeElementVersion();\n        record.setAttachmentCode(CollUtil.join(knowledgeElementContentUpdateReq.getAttachments(), StrUtil.COMMA));\n        record.setDescription(saasKnowledgeElement.getConfig());\n        record.setTitle(saasKnowledgeElement.getEleName());\n        record.setContent(knowledgeElementContentUpdateReq.getContent());\n        record.setContentMarked(knowledgeElementContentUpdateReq.getContentMarked());\n        record.setModifierTime(LocalDateTime.now());\n        record.setCode(IdUtil.getSnowflakeNextIdStr());\n        // 状态\n        record.setStatus(status.name());\n        // 更新当前版本\n        saasKnowledgeElementVersionMapper.update(record, lambdaQueryWrapper);\n    }\n\n    @Override\n    public Result\u003cString\u003e updateOrIssue(KnowledgeElementContentUpdateReq issueReq) {\n        // 页面组件\n        String lockKey \u003d KbCacheConst.KB_LOCK_PAGE_UPDATE + issueReq.getCode();\n        RLock rLock \u003d redissonClient.getLock(lockKey);\n        try {\n            // 尝试获取锁，等待时间和持有时间均为10秒\n            if (rLock.tryLock(10, 10, TimeUnit.SECONDS)) {\n                issueReq.html2Markdown();\n                if (StrUtil.equalsIgnoreCase(issueReq.getOperateType(), \"update\")) {\n                    return this.updateContent(issueReq);\n                } else if (StrUtil.equalsIgnoreCase(issueReq.getOperateType(), \"issue\")) {\n                    return this.issue(issueReq, true);\n                }\n            }\n        } catch (InterruptedException e) {\n            // 如果获取锁失败，记录日志\n            log.info(\"page version number increment。get lock failed...message:{}\", e.getMessage(), e);\n        } finally {\n            // 释放分布式锁\n            if (rLock !\u003d null \u0026\u0026 rLock.isLocked()) {\n                rLock.unlock();\n                log.info(\"free comment lock successful...\");\n            }\n        }\n\n        return Result.error(i18nMessage.resolveMessage(\"system.common.update.fail\"));\n    }\n\n    @Override\n    public Map\u003cString, SaasKnowledgeElement\u003e listPageCountByCodes(List\u003cString\u003e dataIds, String tenantId) {\n        if (CollUtil.isEmpty(dataIds) || StrUtil.isBlank(tenantId)) {\n            return Map.of();\n        }\n        LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d\n                Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, tenantId).in(SaasKnowledgeElement::getCode, dataIds);\n        lambdaQueryWrapper.select(SaasKnowledgeElement::getCode, SaasKnowledgeElement::getPageCount, SaasKnowledgeElement::getCreateTime);\n        List\u003cSaasKnowledgeElement\u003e elements \u003d saasKnowledgeElementMapper.selectList(lambdaQueryWrapper);\n        if (CollUtil.isNotEmpty(elements)) {\n            return elements.stream().collect(Collectors.toMap(SaasKnowledgeElement::getCode, s -\u003e s));\n        }\n        return Map.of();\n    }\n\n    @Override\n    public DataSetChunkInfo buildChunkInfo(double[] vector, String chunkText, SaasKnowledgeElement element, int line, Map\u003cString, Integer\u003e chunkMeta) {\n        DataSetChunkInfo chunkInfo \u003d new DataSetChunkInfo();\n        chunkInfo.setVector(vector);\n        chunkInfo.setContent(chunkText);\n        chunkInfo.setYear(element.getYear());\n        chunkInfo.setContainerId(element.getContainerId());\n        chunkInfo.setTopic(element.getTopic());\n        DocTimeStatus docTimeStatus \u003d DocTimeStatus.parse(element.getNeverExpire());\n        if (docTimeStatus \u003d\u003d DocTimeStatus.NEVER_EXPIRE) {\n            chunkInfo.setTimeStatus(docTimeStatus.getCode());\n            chunkInfo.setStartTime(0L);\n            chunkInfo.setEndTime(0L);\n        } else if (docTimeStatus \u003d\u003d DocTimeStatus.TIME_EXPIRE) {\n            chunkInfo.setTimeStatus(docTimeStatus.getCode());\n            chunkInfo.setStartTime(element.getStartTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());\n            chunkInfo.setEndTime(element.getEndTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());\n        }\n        chunkInfo.setCategory(DataSetChunkType.ORIGINAL.getName());\n        chunkInfo.setCreateTime(LocalDateTime.now().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());\n        chunkInfo.setDataId(element.getCode());\n        // i是从下标0开始的，因此需要+1\n        String key \u003d Objects.toString(line + 1, \"1\");\n        int page \u003d Integer.parseInt(Objects.toString(chunkMeta.get(key), \"1\"));\n        chunkInfo.setPage(page);\n        chunkInfo.setParagraphId(md5.digestHex(chunkInfo.getContainerId() + chunkInfo.getDataId() + page));\n        chunkInfo.setId(md5.digestHex(chunkInfo.getParagraphId() + IdUtil.getSnowflakeNextIdStr()));\n        return chunkInfo;\n    }\n\n    @Override\n    public void merge(SaasKnowledgeElement saasKnowledgeElement, List\u003cString\u003e attachmentCodes, SysUserInfo sysUserInfo, KnowledgeElementVersionStatus status) {\n        String lockKey \u003d StrUtil.format(KbCacheConst.KB_LOCK_PAGE_VERSION, saasKnowledgeElement.getCode());\n        RLock rLock \u003d redissonClient.getLock(lockKey);\n        try {\n            // 尝试获取锁，等待时间和持有时间均为10秒\n            if (rLock.tryLock(10, 10, TimeUnit.SECONDS)) {\n                // 查询指定页面信息，只和页面关联\n                LambdaQueryWrapper\u003cSaasKnowledgeElementVersion\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElementVersion.class)\n                        .eq(SaasKnowledgeElementVersion::getTenantId, saasKnowledgeElement.getTenantId())\n                        .eq(SaasKnowledgeElementVersion::getPageCode, saasKnowledgeElement.getCode())\n                        .eq(SaasKnowledgeElementVersion::getStatus, KnowledgeElementVersionStatus.DEFAULT.getCode());\n                lambdaQueryWrapper.select(SaasKnowledgeElementVersion::getId, SaasKnowledgeElementVersion::getCode);\n                SaasKnowledgeElementVersion pageVersion \u003d saasKnowledgeElementVersionMapper.selectOne(lambdaQueryWrapper, false);\n                SaasKnowledgeElementVersion record \u003d new SaasKnowledgeElementVersion();\n                if (pageVersion !\u003d null) {\n                    // 存在，那么直接更新\n                    record.setAttachmentCode(CollUtil.join(attachmentCodes, StrUtil.COMMA));\n                    record.setTitle(saasKnowledgeElement.getEleName());\n                    record.setDescription(saasKnowledgeElement.getConfig());\n                    // 判断page类型，如果是excel，存储到OSS上面，避免数据太多，超过DB字段的上限。\n                    // dealContent(kbPage, versionCode, record, sysUserInfo);\n                    record.setContent(saasKnowledgeElement.getContent());\n                    record.setContentMarked(saasKnowledgeElement.getContentMarked());\n                    record.setId(pageVersion.getId());\n                    record.setModifierTime(LocalDateTime.now());\n                    record.setModifier(sysUserInfo.getCode());\n                    saasKnowledgeElementVersionMapper.updateById(record);\n                } else {\n                    // 查询已发布的最大版本号\n                    LambdaQueryWrapper\u003cSaasKnowledgeElementVersion\u003e queryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElementVersion.class)\n                            .eq(SaasKnowledgeElementVersion::getTenantId, saasKnowledgeElement.getTenantId())\n                            .eq(SaasKnowledgeElementVersion::getPageCode, saasKnowledgeElement.getCode())\n                            .eq(SaasKnowledgeElementVersion::getStatus, KnowledgeElementVersionStatus.ISSUED.getCode());\n                    queryWrapper.select(SaasKnowledgeElementVersion::getVersionNo);\n                    List\u003cSaasKnowledgeElementVersion\u003e issuedVersions \u003d saasKnowledgeElementVersionMapper.selectList(queryWrapper);\n                    int maxVersionNo \u003d issuedVersions.stream()\n                            .map(SaasKnowledgeElementVersion::getVersionNo)\n                            .max(Integer::compareTo)\n                            .orElse(0); // 没有已发布版本则为0\n                    int newVersionNo \u003d maxVersionNo + 1;\n                    record.setVersionNo(newVersionNo);\n                    record.setTitle(saasKnowledgeElement.getEleName());\n                    record.setDescription(saasKnowledgeElement.getConfig());\n                    record.setUserCode(sysUserInfo.getCode());\n                    record.setContent(saasKnowledgeElement.getContent());\n                    record.setContentMarked(saasKnowledgeElement.getContentMarked());\n                    record.setPageCode(saasKnowledgeElement.getCode());\n                    record.setTenantId(sysUserInfo.getTenantId());\n                    record.setCreator(sysUserInfo.getCode());\n                    record.setCreateTime(LocalDateTime.now());\n                    record.setModifier(sysUserInfo.getCode());\n                    record.setModifierTime(LocalDateTime.now());\n                    record.setStatus(status.name());\n                    record.setCode(IdUtil.getSnowflakeNextIdStr());\n                    if (CollUtil.isNotEmpty(attachmentCodes)) {\n                        record.setAttachmentCode(CollUtil.join(attachmentCodes, StrUtil.COMMA));\n                    }\n                    log.info(\"生成一个新的版本号，versionNo:{},versionCode:{}\", record.getVersionNo());\n                    // insert\n                    int ret \u003d saasKnowledgeElementVersionMapper.insert(record);\n                    log.info(\"新增页面版本,ret:{}\", ret);\n                }\n            }\n        } catch (InterruptedException e) {\n            // 如果获取锁失败，记录日志\n            log.info(\"page version number increment。get lock failed...message:{}\", e.getMessage(), e);\n        } finally {\n            // 释放分布式锁\n            if (rLock !\u003d null \u0026\u0026 rLock.isLocked()) {\n                rLock.unlock();\n                log.info(\"free comment lock successful...\");\n            }\n        }\n    }\n\n    /**\n     * 对象转换Function\n     */\n    private static class SaasKnowledgeElementApplyFunction implements Function\u003cSaasKnowledgeElement, KnowledgeElementResp\u003e {\n\n        @Override\n        public KnowledgeElementResp apply(SaasKnowledgeElement saasKnowledgeElement) {\n            KnowledgeElementResp knowledgeElementResp \u003d new KnowledgeElementResp();\n            BeanUtils.copyProperties(saasKnowledgeElement, knowledgeElementResp);\n            // 设置显示\n            if (saasKnowledgeElement.getEleSize() !\u003d null \u0026\u0026 saasKnowledgeElement.getEleSize() \u003e 0) {\n                knowledgeElementResp.setEleSizeDisplay(DataSizeUtil.format(saasKnowledgeElement.getEleSize()));\n            } else {\n                knowledgeElementResp.setEleSizeDisplay(\"-\");\n            }\n            ProcessStatusEnum processStatusEnum \u003d ProcessStatusEnum.parse(knowledgeElementResp.getProcessStatus());\n            if (processStatusEnum \u003d\u003d ProcessStatusEnum.PROCESSING || processStatusEnum \u003d\u003d ProcessStatusEnum.EMBEDDED || processStatusEnum \u003d\u003d ProcessStatusEnum.EMBEDDING) {\n                // 判断处理时间，如果超过2小时，那么默认按失败处理\n                if (ChronoUnit.HOURS.between(saasKnowledgeElement.getCreateTime(), LocalDateTime.now()) \u003e 4) {\n                    knowledgeElementResp.setProcessStatus(ProcessStatusEnum.FAILURE.getCode());\n                }\n            }\n            // 判断处理进度\n            if (processStatusEnum \u003d\u003d ProcessStatusEnum.INIT) {\n                knowledgeElementResp.setProcessPercent(0);\n            } else if (processStatusEnum \u003d\u003d ProcessStatusEnum.SUCCESS) {\n                knowledgeElementResp.setProcessPercent(100);\n            } else {\n                if (saasKnowledgeElement.getProcessCount() \u003e 0 \u0026\u0026 saasKnowledgeElement.getPageCount() \u003e 0) {\n                    int per \u003d BigDecimal.valueOf(saasKnowledgeElement.getProcessCount()).divide(BigDecimal.valueOf(saasKnowledgeElement.getPageCount()), 4, RoundingMode.HALF_UP)\n                            .multiply(BigDecimal.valueOf(100)).intValue();\n                    knowledgeElementResp.setProcessPercent(per);\n                } else {\n                    knowledgeElementResp.setProcessPercent(0);\n                }\n            }\n            return knowledgeElementResp;\n        }\n    }\n\n    @Override\n    public Pagination\u003cKbPageCreateInfoResp\u003e listSnapshot(String name, Integer pageNo, Integer pageSize) {\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        try (Page\u003cKbPageCreateInfo\u003e page \u003d PageHelper.startPage(pageNo, pageSize)) {\n            PageSnapshotSearchReq searchReq \u003d new PageSnapshotSearchReq();\n            searchReq.setName(name);\n            searchReq.setUserCode(sysUserInfo.getCode());\n            searchReq.setTenantId(sysUserInfo.getTenantId());\n            List\u003cKbPageCreateInfo\u003e kbPageUserInfos \u003d saasKnowledgeElementMapper.listSnapshotPage(searchReq);\n            List\u003cKbPageCreateInfoResp\u003e pageTree \u003d new ArrayList\u003c\u003e();\n            if (CollUtil.isNotEmpty(kbPageUserInfos)) {\n                pageTree \u003d new ArrayList\u003c\u003e(kbPageUserInfos.stream().map(KbPageCreateInfoResp::of).toList());\n            }\n            return Pagination.pagination(pageTree, page.getTotal(), pageNo, pageSize);\n        }\n    }\n\n    @Override\n    public Result\u003cBoolean\u003e deleteSnapshot(List\u003cString\u003e pageCodes) {\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d\n                Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getTenantId, sysUserInfo.getTenantId())\n                        .eq(SaasKnowledgeElement::getCreator, sysUserInfo.getCode()).in(SaasKnowledgeElement::getCode, pageCodes);\n        // 删除页面\n        int ret \u003d saasKnowledgeElementMapper.delete(lambdaQueryWrapper);\n        if (ret \u003e 0) {\n            knowledgeElementVersionService.delete(sysUserInfo.getTenantId(), pageCodes);\n        }\n        if (ret \u003e 0) {\n            return Result.data(Boolean.TRUE, i18nMessage.resolveMessage(\"system.common.delete.success\"));\n        }\n        Result\u003cBoolean\u003e fail \u003d Result.error(i18nMessage.resolveMessage(\"system.common.delete.fail\"));\n        fail.setData(Boolean.FALSE);\n        return fail;\n    }\n\n\n    @Override\n    public SaasKnowledgeElementCacheInfo get(String containerId, String tenantId) {\n        String key \u003d KbCacheConst.KB_SPACE_INFO + containerId;\n        String value \u003d stringRedisTemplate.opsForValue().get(key);\n        if (StrUtil.isNotBlank(value)) {\n            String json \u003d stringRedisTemplate.opsForValue().get(key);\n            return SaasKnowledgeElementCacheInfo.fromJson(json);\n        }\n        // select db\n        SaasKnowledgeElement saasKnowledgeElement \u003d saasKnowledgeElementMapper.selectOne(Wrappers.lambdaQuery(SaasKnowledgeElement.class).eq(SaasKnowledgeElement::getContainerId, containerId).eq(SaasKnowledgeElement::getTenantId, tenantId), false);\n        if (saasKnowledgeElement \u003d\u003d null) {\n            saasKnowledgeElement \u003d new SaasKnowledgeElement();\n            saasKnowledgeElement.setEleName(StrUtil.EMPTY);\n        }\n        SaasKnowledgeElementCacheInfo cacheInfo \u003d SaasKnowledgeElementCacheInfo.fromKbSpace(saasKnowledgeElement);\n        if (saasKnowledgeElement.getId() !\u003d null) {\n            stringRedisTemplate.opsForValue().set(key, cacheInfo.toJson(), 2, TimeUnit.HOURS);\n        }\n        return cacheInfo;\n    }\n\n    @Override\n    public Pagination\u003cKnowledgeElementResp\u003e hotPage(Integer pageNo, Integer pageSize, String containerId) {\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 是否租户管理员\n        boolean adminRole \u003d false;\n        List\u003cString\u003e joinSpaceCodes \u003d null;\n\n        if (StrUtil.isNotBlank(containerId)) {\n            // 如果指定了空间，验证用户是否有权限访问该空间\n            joinSpaceCodes \u003d Collections.singletonList(containerId);\n        } else if (!adminRole) {\n            // 如果不是管理员且未指定空间，获取用户有权限的所有空间\n            joinSpaceCodes \u003d kbSpaceUserService.userSpaceCode(sysUserInfo);\n        }\n\n        try (Page\u003cSaasKnowledgeElement\u003e page \u003d PageHelper.startPage(pageNo, pageSize)) {\n            LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class)\n                    .eq(SaasKnowledgeElement::getTenantId, sysUserInfo.getTenantId())\n                    // 只查询已发布的页面\n                    .eq(SaasKnowledgeElement::getProcessStatus, ProcessStatusEnum.SUCCESS.getCode())\n                    .ne(SaasKnowledgeElement::getCategory, KnowledgeElementTypes.FOLDER.name())\n                    .ne(SaasKnowledgeElement::getCategory, KnowledgeContainerType.DIRECTORY.name())\n                    // 根据热度排序\n                    .orderByDesc(SaasKnowledgeElement::getHotNumber);\n\n            // 如果指定了空间编码，直接在主查询中添加条件\n            if (StrUtil.isNotBlank(containerId)) {\n                lambdaQueryWrapper.eq(SaasKnowledgeElement::getContainerId, containerId);\n            } else if (!adminRole \u0026\u0026 CollUtil.isNotEmpty(joinSpaceCodes)) {\n                // 如果是非管理员且有权限的空间列表不为空，添加空间编码条件\n                lambdaQueryWrapper.in(SaasKnowledgeElement::getContainerId, joinSpaceCodes);\n            }\n\n            // 直接使用lambdaQueryWrapper进行查询\n            List\u003cSaasKnowledgeElement\u003e saasKnowledgeElementList \u003d saasKnowledgeElementMapper.selectList(lambdaQueryWrapper);\n            List\u003cKnowledgeElementResp\u003e pageTree \u003d new ArrayList\u003c\u003e();\n            if (CollUtil.isNotEmpty(saasKnowledgeElementList)) {\n                pageTree \u003d new ArrayList\u003c\u003e(saasKnowledgeElementList.stream().map(KnowledgeElementResp::of).toList());\n                // 批量填充creatorName和modifierName\n                Set\u003cString\u003e userCodes \u003d new HashSet\u003c\u003e();\n                for (KnowledgeElementResp resp : pageTree) {\n                    userCodes.addAll(resp.userCodes());\n                }\n                if (!userCodes.isEmpty()) {\n                    Map\u003cString, String\u003e userMap \u003d userService.selectByCode(new ArrayList\u003c\u003e(userCodes));\n                    for (KnowledgeElementResp resp : pageTree) {\n                        resp.applyUserName(userMap);\n                    }\n                }\n            }\n            return Pagination.pagination(pageTree, page.getTotal(), pageNo, pageSize);\n        }\n    }\n\n    @Override\n    public Result\u003cString\u003e restore(PageVersionRestoreReq issueReq) {\n        // 记录发布空间页面的日志\n        String code \u003d issueReq.getCode();\n        log.info(\"根据code恢复页面版本当前页面快照编码,code:{}\", code);\n        SaasKnowledgeElementVersion saasKnowledgeElementVersion \u003d knowledgeElementVersionService.getVersionByCode(issueReq.getVersionNo(), issueReq.getCode());\n        // 恢复标题\n        issueReq.setTitle(saasKnowledgeElementVersion.getTitle());\n        // 获取当前用户信息\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 根据代码和租户ID查询页面信息\n        Optional\u003cSaasKnowledgeElement\u003e kbPageOptional \u003d this.queryByCode(issueReq.getPageCode(), sysUserInfo.getTenantId());\n        // 如果查询不到页面信息，抛出非法参数异常\n        if (kbPageOptional.isEmpty()) {\n            throw new IllegalArgumentException(\"system.common.request.invalid\");\n        }\n        // 获取查询到的页面信息\n        SaasKnowledgeElement record \u003d kbPageOptional.get();\n        // 创建一个新对象用于更新页面状态\n        SaasKnowledgeElement update \u003d new SaasKnowledgeElement();\n        if (StrUtil.isNotBlank(issueReq.getTitle())) {\n            update.setEleName(issueReq.getTitle());\n        }\n        update.setId(record.getId());\n        update.setModifier(sysUserInfo.getCode());\n        update.setModifierTime(LocalDateTime.now());\n        SaasKnowledgeElementIssueContext issueContext \u003d new SaasKnowledgeElementIssueContext();\n        // 如果是已经发布的状态。新增一个版本作为当前页面版本的草稿状态。\n        issueReq.applyPublish(issueContext, update);\n        // 设置最新的内容\n        update.setContent(issueReq.getContent());\n        update.setContentMarked(issueReq.getContentMarked());\n        update.setProcessStatus(ProcessStatusEnum.INIT.getCode());\n        // 执行页面状态更新操作\n        int ret \u003d saasKnowledgeElementMapper.updateById(update);\n        // 记录更新结果\n        log.info(\"恢复空间页面结果:{}\", ret \u003e 0);\n        // 如果更新成功，进行向量化处理\n        if (ret \u003e 0) {\n            issueReq.updateIssue(update, record);\n            // todo 处理附件\n            // 更新版本信息\n            this.issuePage(issueContext, update, sysUserInfo, issueReq.getAttachments());\n            // 如果原来记录中原本就是发布状态,并且当前页面不需要审核，则更新动态信息\n            // 空间动态信息新增\n//            SaasKnowledgeElementCacheInfo saasKnowledgeElementCacheInfo \u003d this.get(update.getContainerId(), update.getTenantId());\n//            saasKnowledgeElementTrendService.messageTrend(SaasKnowledgeElementTrendAddReq.of(UserContextHolder.getCurrentUser(), update, SaasKnowledgeElementEvent.DELETED, saasKnowledgeElementCacheInfo));\n            if (issueContext.getVersionStatus() \u003d\u003d KnowledgeElementVersionStatus.ISSUED) {\n                // 删除旧的es索引\n                boolean re \u003d knowledgeElementDataService.deleteByDataId(update.getTenantId(),update.getContainerId(), issueReq.getPageCode());\n                log.info(\"数据库删除成功,ret:{},向量删除:{}\", ret, re);\n            }\n        }\n        // 返回成功结果\n        return Result.success(\"SUCCESS\");\n    }\n\n    @Override\n    public void issuePage(SaasKnowledgeElementIssueContext issueContext, SaasKnowledgeElement saasKnowledgeElement, SysUserInfo sysUserInfo, List\u003cString\u003e attachmentCodes) {\n        // 判断是否为新版本\n        if (issueContext.isStartVersion()) {\n            // 新增一个版本\n            this.merge(saasKnowledgeElement, attachmentCodes, sysUserInfo, issueContext.getVersionStatus());\n        } else {\n            // 更新\n            KnowledgeElementContentUpdateReq knowledgeElementContentUpdateReq \u003d new KnowledgeElementContentUpdateReq();\n            BeanUtils.copyProperties(saasKnowledgeElement, knowledgeElementContentUpdateReq);\n            this.update(saasKnowledgeElement, knowledgeElementContentUpdateReq, sysUserInfo, issueContext.getVersionStatus());\n        }\n    }\n\n\n    /**\n     * 根据id查询空间页面详情\n     *\n     * @param code 空间页面主键id\n     * @return 空间页面详情\n     */\n    @Override\n    public Result\u003cKbPageUserStatusResp\u003e queryUserStatusByCode(String code) {\n        log.info(\"根据主键id查询空间页面用户状态详情,code:{}\", code);\n        KbPageUserStatusResp kbPageResp \u003d new KbPageUserStatusResp();\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 查询页面的事件\n        Map\u003cString, KbPageEvent\u003e kbPageEventMap \u003d kbPageEventService.mapByUserCode(code, sysUserInfo.getCode(), sysUserInfo.getTenantId(), List.of(\n                KbEventMessageTypes.EVENT_PAGE_FOLLOW, KbEventMessageTypes.EVENT_PAGE_COLLECT, KbEventMessageTypes.EVENT_PAGE_LIKES));\n        // 设置状态\n        kbPageResp.applyToggleStatus(kbPageEventMap);\n        return Result.data(kbPageResp);\n    }\n\n    /**\n     * 文件名比较方法，支持按数字前缀排序\n     *\n     * @param fileName1 第一个文件名\n     * @param fileName2 第二个文件名\n     * @param sortType 排序类型（1\u003d正序, 0\u003d反序）\n     * @return 比较结果\n     */\n    private int compareFileName(String fileName1, String fileName2, Integer sortType) {\n        if (fileName1 \u003d\u003d null \u0026\u0026 fileName2 \u003d\u003d null) {\n            return 0;\n        }\n        if (fileName1 \u003d\u003d null) {\n            return sortType \u003d\u003d 0 ? -1 : 1;\n        }\n        if (fileName2 \u003d\u003d null) {\n            return sortType \u003d\u003d 0 ? 1 : -1;\n        }\n\n        // 提取文件名前的数字\n        Integer number1 \u003d extractNumberPrefix(fileName1);\n        Integer number2 \u003d extractNumberPrefix(fileName2);\n\n        int result;\n        if (number1 !\u003d null \u0026\u0026 number2 !\u003d null) {\n            // 两个都有数字前缀，按数字比较\n            result \u003d number1.compareTo(number2);\n            if (result \u003d\u003d 0) {\n                // 数字相同，继续按文件名比较\n                result \u003d fileName1.compareTo(fileName2);\n            }\n        } else if (number1 !\u003d null) {\n            // 只有第一个有数字前缀，数字前缀的排在前面\n            result \u003d -1;\n        } else if (number2 !\u003d null) {\n            // 只有第二个有数字前缀，数字前缀的排在前面\n            result \u003d 1;\n        } else {\n            // 都没有数字前缀，按普通字符串比较\n            result \u003d fileName1.compareTo(fileName2);\n        }\n\n        // 根据排序类型决定是否反转结果\n        return sortType \u003d\u003d 1 ? result : -result;\n    }\n\n    /**\n     * 从文件名中提取数字前缀\n     * 匹配模式：数字 + 分隔符（如点、横线、下划线等）\n     *\n     * @param fileName 文件名\n     * @return 提取的数字，如果没有则返回null\n     */\n    private Integer extractNumberPrefix(String fileName) {\n        if (fileName \u003d\u003d null || fileName.trim().isEmpty()) {\n            return null;\n        }\n\n        // 匹配开头的数字，后面跟着分隔符（. - _ 空格等）\n        java.util.regex.Pattern pattern \u003d java.util.regex.Pattern.compile(\"^(\\\\d+)[.\\\\-_\\\\s]+\");\n        java.util.regex.Matcher matcher \u003d pattern.matcher(fileName.trim());\n\n        if (matcher.find()) {\n            try {\n                return Integer.parseInt(matcher.group(1));\n            } catch (NumberFormatException e) {\n                log.debug(\"解析文件名数字前缀失败: {}\", fileName, e);\n                return null;\n            }\n        }\n\n        return null;\n    }\n\n    /**\n     * 查询所有知识库元素列表，包括所有子级，排序规则与list接口保持一致\n     * @param knowledgeElementQueryReq 查询条件Vo\n     * @return 所有知识库元素列表（包括所有层级）\n     */\n    @Override\n    public Result\u003cList\u003cKnowledgeElementResp\u003e\u003e listAllWithSort(KnowledgeElementQueryReq knowledgeElementQueryReq) {\n        log.info(\"根据条件查询所有知识库元素列表（包括所有层级）\");\n        log.info(\"QueryReq:{}\", knowledgeElementQueryReq.toString());\n\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        // 查询全部列表的\n        DepartmentUserOrgPermissions orgPermissions \u003d kbDepartmentUserService.listAccessibleDepartmentCodes(sysUserInfo);\n\n        LambdaQueryWrapper\u003cSaasKnowledgeElement\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeElement.class)\n                .eq(SaasKnowledgeElement::getTenantId, sysUserInfo.getTenantId());\n\n        // 查询条件\n        lambdaQueryWrapper.eq(StrUtil.isNotBlank(knowledgeElementQueryReq.getContainerId()), SaasKnowledgeElement::getContainerId, knowledgeElementQueryReq.getContainerId());\n        // 注意：这里不限制parentCode，要查询所有层级\n        if (StrUtil.isNotBlank(knowledgeElementQueryReq.getCategory())) {\n            List\u003cString\u003e category \u003d StrUtil.split(knowledgeElementQueryReq.getCategory(), StrUtil.COMMA);\n            lambdaQueryWrapper.in(SaasKnowledgeElement::getCategory, category);\n        }\n        lambdaQueryWrapper.like(StrUtil.isNotBlank(knowledgeElementQueryReq.getEleName()), SaasKnowledgeElement::getEleName, knowledgeElementQueryReq.getEleName());\n\n        // 草稿状态只能自己可见\n        lambdaQueryWrapper.and(l-\u003e{\n            l.ne(SaasKnowledgeElement::getProcessStatus,ProcessStatusEnum.DRAFT.getCode()).or(lf-\u003e{\n                lf.eq(SaasKnowledgeElement::getProcessStatus,ProcessStatusEnum.DRAFT.getCode());\n                lf.eq(SaasKnowledgeElement::getCreator, Objects.toString(sysUserInfo.getCode()));\n            });\n        });\n\n        // 过滤权限\n        ElementSearchCondition searchCondition \u003d ElementSearchCondition.from(sysUserInfo.getTenantId(), knowledgeElementQueryReq.getContainerId(), null, orgPermissions.permissionCodesToList());\n        List\u003cString\u003e visibleCodes \u003d saasKnowledgeElementMapper.listVisibleCodes(searchCondition);\n        if (CollUtil.isNotEmpty(visibleCodes)){\n            lambdaQueryWrapper.and(lf-\u003e lf.eq(SaasKnowledgeElement::getPermissionStatus,ToggleStatusEnum.YES.getCode()).or(l1-\u003e{\n                l1.eq(SaasKnowledgeElement::getPermissionStatus,ToggleStatusEnum.NO.getCode());\n                l1.in(SaasKnowledgeElement::getCode,visibleCodes);\n            }));\n        } else {\n            lambdaQueryWrapper.eq(SaasKnowledgeElement::getPermissionStatus,ToggleStatusEnum.YES.getCode());\n        }\n\n        // 设定排序规则\n        SortRules sortRule \u003d SortRules.parse(knowledgeElementQueryReq.getSortRule());\n        if (sortRule \u003d\u003d SortRules.SORT_NUMBER) {\n            lambdaQueryWrapper.orderByAsc(SaasKnowledgeElement::getSort);\n        } else if (sortRule \u003d\u003d SortRules.SORT_CREATE_TIME) {\n            if (knowledgeElementQueryReq.getSortType() \u003d\u003d 0) {\n                lambdaQueryWrapper.orderByAsc(SaasKnowledgeElement::getCreateTime);\n            } else {\n                lambdaQueryWrapper.orderByDesc(SaasKnowledgeElement::getCreateTime);\n            }\n        } else if (sortRule \u003d\u003d SortRules.SORT_MODIFY_TIME) {\n            if (knowledgeElementQueryReq.getSortType() \u003d\u003d 0) {\n                lambdaQueryWrapper.orderByAsc(SaasKnowledgeElement::getModifierTime);\n            } else {\n                lambdaQueryWrapper.orderByDesc(SaasKnowledgeElement::getModifierTime);\n            }\n        }\n        String permissionType \u003d saasKnowledgeContainerPermissionService.getHighestPermission(knowledgeElementQueryReq.getContainerId(),sysUserInfo);\n        log.info(\"当前用户在容器中的最高权限:{}\",permissionType);\n        // 如果是没权限的角色，那么需要判断当前的知识库是否设置为公开，如果是公开的情况下，那么给予只读角色\n        Optional\u003cSaasKnowledgeContainer\u003e containerOptional \u003d knowledgeContainerQueryService.queryInfoByCode(knowledgeElementQueryReq.getContainerId());\n        if (containerOptional.isEmpty()) {\n            return Result.data(new ArrayList\u003c\u003e());\n        }\n        boolean canFilter\u003dtrue;\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d containerOptional.get();\n        if ( KbKnowledgeBaseContainerVisibilityRange.publicRead(saasKnowledgeContainer.getVisibilityRange())){\n            // 公开可读\n            canFilter\u003dfalse;\n        }else{\n            // 非公开可读，那么必须有权限才可以查看\n            if (!StrUtil.equalsIgnoreCase(KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode(),permissionType)){\n                // 公开可读\n                canFilter\u003dfalse;\n            }\n        }\n        List\u003cSaasKnowledgeElement\u003e saasKnowledgeElementInfos \u003d saasKnowledgeElementMapper.selectList(lambdaQueryWrapper);\n        if (canFilter){\n            List\u003cString\u003e elementCodes\u003dsaasKnowledgeElementInfos.stream().map(SaasKnowledgeElement::getCode).toList();\n            ElementFilterSearchCondition searchFilterCondition\u003d ElementFilterSearchCondition.from(sysUserInfo.getTenantId(),knowledgeElementQueryReq.getContainerId(),elementCodes,orgPermissions.permissionCodesToList());\n            List\u003cString\u003e visibleFilterCodes \u003d saasKnowledgeElementMapper.listVisibleFilterCodes(searchFilterCondition);\n            if (CollUtil.isNotEmpty(visibleFilterCodes)){\n                saasKnowledgeElementInfos\u003dsaasKnowledgeElementInfos.stream().filter(e-\u003evisibleFilterCodes.contains(e.getCode())).toList();\n            }\n        }\n        // 对于文件名排序，在内存中进行排序\n        if (sortRule \u003d\u003d SortRules.SORT_TITLE) {\n            saasKnowledgeElementInfos.sort((a, b) -\u003e compareFileName(a.getEleName(), b.getEleName(), knowledgeElementQueryReq.getSortType()));\n        }\n\n        // 构建树形结构并保持每一级的排序\n        List\u003cKnowledgeElementResp\u003e result \u003d buildTreeStructureWithSort(saasKnowledgeElementInfos, knowledgeElementQueryReq);\n\n        return Result.data(result);\n    }\n\n    /**\n     * 构建树形结构并保持每一级的排序\n     */\n    private List\u003cKnowledgeElementResp\u003e buildTreeStructureWithSort(List\u003cSaasKnowledgeElement\u003e elements, KnowledgeElementQueryReq queryReq) {\n        if (CollectionUtil.isEmpty(elements)) {\n            return new ArrayList\u003c\u003e();\n        }\n\n        // 转换为响应对象\n        List\u003cKnowledgeElementResp\u003e allElements \u003d elements.stream()\n                .map(new SaasKnowledgeElementApplyFunction())\n                .collect(Collectors.toList());\n\n        // 批量填充creatorName和modifierName\n        Set\u003cString\u003e userCodes \u003d new HashSet\u003c\u003e();\n\n        // key-code value:parentCode\n        Map\u003cString,String\u003e elementRootMap\u003dnew HashMap\u003c\u003e();\n        for (KnowledgeElementResp resp : allElements) {\n            userCodes.addAll(resp.userCodes());\n            elementRootMap.put(resp.getCode(),resp.getParentCode());\n        }\n        if (!userCodes.isEmpty()) {\n            Map\u003cString, String\u003e userMap \u003d userService.selectByCode(new ArrayList\u003c\u003e(userCodes));\n            for (KnowledgeElementResp resp : allElements) {\n                resp.applyUserName(userMap);\n            }\n        }\n        log.info(\"批量填充creatorName和modifierName{}\" , allElements);\n        // 创建映射：parentCode -\u003e 子元素列表\n        Map\u003cString, List\u003cKnowledgeElementResp\u003e\u003e parentChildMap \u003d new HashMap\u003c\u003e();\n        Map\u003cString,KnowledgeElementResp\u003e rootMap\u003dnew HashMap\u003c\u003e();\n\n        for (KnowledgeElementResp element : allElements) {\n            String parentCode \u003d StrUtil.isBlank(element.getParentCode()) ? \"0\" : element.getParentCode();\n            parentChildMap.computeIfAbsent(parentCode, k -\u003e new ArrayList\u003c\u003e()).add(element);\n           if (!elementRootMap.containsKey(element.getParentCode())){\n               rootMap.put(element.getCode(),element);\n               //parentChildMap.computeIfAbsent(element.getCode(), k -\u003e new ArrayList\u003c\u003e()).add(element);\n           }\n        }\n\n        // 对每一级的子元素进行排序\n        SortRules sortRule \u003d SortRules.parse(queryReq.getSortRule());\n        for (List\u003cKnowledgeElementResp\u003e children : parentChildMap.values()) {\n            sortElementList(children, sortRule, queryReq.getSortType());\n        }\n\n        // 递归构建树形结构\n        List\u003cKnowledgeElementResp\u003e rootElements \u003d parentChildMap.getOrDefault(\"0\", new ArrayList\u003c\u003e());\n        rootElements.addAll(rootMap.values());\n        for (KnowledgeElementResp element : rootElements) {\n            buildChildren(element, parentChildMap);\n        }\n\n        return rootElements;\n    }\n\n    /**\n     * 递归构建子元素\n     */\n    private void buildChildren(KnowledgeElementResp parent, Map\u003cString, List\u003cKnowledgeElementResp\u003e\u003e parentChildMap) {\n        List\u003cKnowledgeElementResp\u003e children \u003d parentChildMap.get(parent.getCode());\n        if (CollectionUtil.isNotEmpty(children)) {\n            parent.setChildrens(children);\n            for (KnowledgeElementResp child : children) {\n                buildChildren(child, parentChildMap);\n            }\n        }\n    }\n\n    /**\n     * 对元素列表进行排序\n     */\n    private void sortElementList(List\u003cKnowledgeElementResp\u003e elements, SortRules sortRule, Integer sortType) {\n        if (CollectionUtil.isEmpty(elements)) {\n            return;\n        }\n\n        switch (sortRule) {\n            case SORT_NUMBER:\n                elements.sort(Comparator.comparing(KnowledgeElementResp::getSort, Comparator.nullsLast(Comparator.naturalOrder())));\n                break;\n            case SORT_CREATE_TIME:\n                if (sortType \u003d\u003d 0) {\n                    elements.sort(Comparator.comparing(KnowledgeElementResp::getCreateTime, Comparator.nullsLast(Comparator.naturalOrder())));\n                } else {\n                    elements.sort(Comparator.comparing(KnowledgeElementResp::getCreateTime, Comparator.nullsLast(Comparator.reverseOrder())));\n                }\n                break;\n            case SORT_MODIFY_TIME:\n                if (sortType \u003d\u003d 0) {\n                    elements.sort(Comparator.comparing(KnowledgeElementResp::getModifierTime, Comparator.nullsLast(Comparator.naturalOrder())));\n                } else {\n                    elements.sort(Comparator.comparing(KnowledgeElementResp::getModifierTime, Comparator.nullsLast(Comparator.reverseOrder())));\n                }\n                break;\n            case SORT_TITLE:\n                elements.sort((a, b) -\u003e compareFileName(a.getEleName(), b.getEleName(), sortType));\n                break;\n            default:\n                // 默认按排序号排序\n                elements.sort(Comparator.comparing(KnowledgeElementResp::getSort, Comparator.nullsLast(Comparator.naturalOrder())));\n                break;\n        }",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 3171
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/knowledge/impl/KnowledgeContainerServiceImpl.java",
      "timestamp": 1761236769029,
      "startOffset": 2324,
      "endOffset": 64416,
      "codeContent": "model.response.SaasTenantInfoCacheResp;\nimport com.torchv.application.user.service.TenantCacheService;\nimport com.torchv.application.user.service.TenantInfoService;\nimport com.torchv.common.constant.Cns;\nimport com.torchv.common.constant.SplitTypes;\nimport com.torchv.common.constant.enums.file.chunk.AnalysisEngineEnum;\nimport com.torchv.common.constant.enums.file.chunk.AnalysisModeEnum;\nimport com.torchv.common.constant.kb.*;\nimport com.torchv.common.constant.knowledge.KnowledgeCategory;\nimport com.torchv.common.constant.knowledge.KnowledgeContainerType;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.infra.common.extra.log.LogContext;\nimport com.torchv.infra.rag.constant.EmbeddingModels;\nimport com.torchv.infra.vector.VectorDBTypes;\nimport com.torchv.infra.vector.VectorIndexDelegate;\nimport com.torchv.infra.vector.model.VectorIndexCreateReq;\nimport com.torchv.infra.web.i18n.I18nMessage;\nimport com.torchv.infra.web.spring.properties.SecureConfig;\nimport com.torchv.kb.admin.model.dto.DepartmentUserOrgPermissions;\nimport com.torchv.kb.admin.service.KbDepartmentUserService;\nimport com.torchv.kb.page.model.response.SaasKnowledgeElementPermissionResp;\nimport com.torchv.kb.page.service.PagePermissionService;\nimport com.torchv.kb.space.model.request.KbKnowledgeBasePermissionReq;\nimport com.torchv.kb.space.model.vo.SaasKnowledgeContainerPermissionUpdateReq;\nimport com.torchv.kb.space.service.KbSpaceFollowService;\nimport com.torchv.kb.space.service.SaasKnowledgeConfigContainerService;\nimport com.torchv.kb.space.service.SaasKnowledgeConfigElementService;\nimport com.torchv.kb.space.service.SaasKnowledgeContainerPermissionService;\nimport com.torchv.kb.system.service.KbDashboardComponentService;\nimport com.torchv.repository.chat.dto.ContainerPermissionConditionV1;\nimport com.torchv.repository.chat.entity.SaasKnowledgeContainer;\nimport com.torchv.repository.chat.entity.SaasKnowledgeElementPermission;\nimport com.torchv.repository.chat.mapper.SaasKnowledgeContainerMapper;\nimport com.torchv.repository.chat.mapper.SaasKnowledgeElementPermissionMapper;\nimport com.torchv.repository.kb.department.dto.KbDepartmentUserTypeInfo;\nimport com.torchv.repository.kb.department.entity.KbDepartment;\nimport com.torchv.repository.kb.department.mapper.KbDepartmentMapper;\nimport com.torchv.repository.kb.department.mapper.KbDepartmentUserMapper;\nimport com.torchv.repository.kb.entity.SaasKnowledgeConfigContainer;\nimport com.torchv.repository.kb.entity.SaasKnowledgeConfigElement;\nimport com.torchv.repository.kb.entity.SaasKnowledgeContainerPermission;\nimport com.torchv.repository.kb.space.entity.KbSpaceFollowing;\nimport com.torchv.repository.kb.system.entity.KbDashboardComponent;\nimport com.torchv.repository.tenant.entity.SaasTenantInfo;\nimport com.torchv.repository.user.entity.SysUser;\nimport com.torchv.repository.user.mapper.SysUserMapper;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.time.LocalDateTime;\nimport java.util.*;\nimport java.util.stream.Collectors;\n\n/**\n * 知识库容器模块-业务Service实现\n * @since torchv_server v0.1-beta.1\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/01/02 19:54\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class KnowledgeContainerServiceImpl implements KnowledgeContainerService {\n\n    final SaasKnowledgeContainerMapper saasKnowledgeContainerMapper;\n    final KnowledgeElementService knowledgeElementService;\n    final PlatformKeyContainerService platformKeyContainerService;\n    final SaasKnowledgeContainerPermissionService saasKnowledgeContainerPermissionService;\n    final SaasKnowledgeConfigContainerService saasKnowledgeConfigContainerService;\n    final SaasKnowledgeConfigElementService saasKnowledgeConfigElementService;\n    final I18nMessage i18nMessage;\n    final KnowledgeTagRelationService knowledgeTagRelationService;\n    final KnowledgeCategoryService knowledgeCategoryService;\n    final KbDepartmentUserMapper kbDepartmentUserMapper;\n    final KbDepartmentUserService kbDepartmentUserService;\n    final KbDepartmentMapper kbDepartmentMapper;\n    final SysUserMapper sysUserMapper;\n    final VectorIndexDelegate vectorDatabaseDelegate;\n    final TenantInfoService tenantInfoService;\n    final ModelProviderService modelProviderService;\n    final KbDashboardComponentService kbDashboardComponentService;\n    final KnowledgeContainerDataService knowledgeContainerDataService;\n    final KnowledgeElementEmbeddingQueryService knowledgeElementEmbeddingQueryService;\n    final KnowledgeElementDataService knowledgeElementDataService;\n    final KbSpaceFollowService kbSpaceFollowService;\n    final PagePermissionService pagePermissionService;\n    final SecureConfig secureConfig;\n\n    private LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e getWrapper(KnowledgeContainerQueryReq knowledgeContainerQueryReq,SysUserInfo sysUserInfo) {\n        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeContainer.class).eq(SaasKnowledgeContainer::getTenantId, sysUserInfo.getTenantId());\n        lambdaQueryWrapper.like(StrUtil.isNotBlank(knowledgeContainerQueryReq.getName()), SaasKnowledgeContainer::getName, knowledgeContainerQueryReq.getName());\n        lambdaQueryWrapper.ne(SaasKnowledgeContainer::getType, KnowledgeContainerType.PERSONAL_KNOWLEDGE.name());\n        lambdaQueryWrapper.eq(StrUtil.isNotBlank(knowledgeContainerQueryReq.getCategory()), SaasKnowledgeContainer::getCategory, knowledgeContainerQueryReq.getCategory());\n        lambdaQueryWrapper.eq(StrUtil.isNotBlank(knowledgeContainerQueryReq.getType()), SaasKnowledgeContainer::getType, knowledgeContainerQueryReq.getType());\n        lambdaQueryWrapper.eq(StrUtil.isNotBlank(knowledgeContainerQueryReq.getClassifyCode()), SaasKnowledgeContainer::getClassifyCode, knowledgeContainerQueryReq.getClassifyCode());\n\n        if (StrUtil.isNotBlank(knowledgeContainerQueryReq.getParentCode())) {\n            lambdaQueryWrapper.eq(SaasKnowledgeContainer::getParentCode, knowledgeContainerQueryReq.getParentCode());\n        } else {\n            lambdaQueryWrapper.eq(SaasKnowledgeContainer::getParentCode, \"0\");\n        }\n        // 时间倒叙\n        lambdaQueryWrapper.orderByDesc(SaasKnowledgeContainer::getCreateTime);\n        return lambdaQueryWrapper;\n    }\n\n    /**\n     * 分页查询-知识库容器列表数据\n     * @param knowledgeContainerQueryReq 查询条件Vo\n     * @param pageNo 当前页码\n     * @param pageSize 每页页码大小\n     * @return 知识库容器列表\n     */\n    @Override\n    public Pagination\u003cKnowledgeContainerResp\u003e list(KnowledgeContainerQueryReq knowledgeContainerQueryReq, Integer pageNo, Integer pageSize) {\n        log.info(\"分页查询知识库容器列表,pageNo:{},pageSize:{}\", pageNo, pageSize);\n        log.info(\"分页QueryReq:{}\", knowledgeContainerQueryReq.toString());\n        // 权限增强获取知识库容器列表\n        SysUserInfo sysUserInfo\u003dUserContextHolder.getCurrentUser();\n        String code \u003d sysUserInfo.getCode();\n        String tenantId \u003d sysUserInfo.getTenantId();\n        List\u003cKnowledgeContainerResp\u003e knowledgeContainerRespInfos \u003d new ArrayList\u003c\u003e();\n        // 我的知识库\n        if (knowledgeContainerQueryReq.getCreator()!\u003d null \u0026\u0026 knowledgeContainerQueryReq.getCreator()){\n            // 如果是标签非空的查询，那么首先需要查询标签关联表\n            List\u003cSaasKnowledgeContainer\u003e saasKnowledgeContainerInfos;\n            long count;\n            try (Page\u003cSaasKnowledgeContainer\u003e saasKnowledgeContainerPageNo \u003d PageHelper.startPage(pageNo, pageSize)) {\n                saasKnowledgeContainerInfos \u003d saasKnowledgeContainerMapper.selectList(Wrappers.lambdaQuery(SaasKnowledgeContainer.class).eq(SaasKnowledgeContainer::getTenantId, tenantId)\n                        .eq(SaasKnowledgeContainer::getCreator, code)\n                                .like(StrUtil.isNotBlank(knowledgeContainerQueryReq.getName()), SaasKnowledgeContainer::getName, knowledgeContainerQueryReq.getName())\n                        .eq(StrUtil.isNotEmpty(knowledgeContainerQueryReq.getClassifyCode()),SaasKnowledgeContainer::getClassifyCode, knowledgeContainerQueryReq.getClassifyCode())\n                        .orderByDesc(SaasKnowledgeContainer::getCreateTime));\n                count \u003d saasKnowledgeContainerPageNo.getTotal();\n            }\n            if (CollectionUtil.isNotEmpty(saasKnowledgeContainerInfos)) {\n                // 获取知识库容器列表\n                List\u003cString\u003e containerId \u003d saasKnowledgeContainerInfos.stream().map(SaasKnowledgeContainer::getCode).toList();\n                // 获取容器下的标签\n                Map\u003cString, List\u003cString\u003e\u003e tagMap \u003d knowledgeTagRelationService.listByContainerIds(containerId, tenantId);\n                Map\u003cString, UniversalEmbeddingConfig\u003e embeddingConfigMap\u003dknowledgeElementEmbeddingQueryService.listEmbeddingModelsByContainerId(containerId);\n                for (SaasKnowledgeContainer container:saasKnowledgeContainerInfos){\n                    KnowledgeContainerResp containerResp\u003d new SaasKnowledgeContainerApplyFunction(tagMap).apply(container);\n                    // 创建者默认就是manage\n                    containerResp.setPermissionType(KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode());\n                    containerResp.applyEmbedding(embeddingConfigMap.get(container.getCode()));\n                    knowledgeContainerRespInfos.add(containerResp);\n                }\n            }\n            return Pagination.pagination(knowledgeContainerRespInfos, count, pageNo, pageSize);\n        }else{\n            List\u003cString\u003e teamCodes \u003d new ArrayList\u003c\u003e();\n            List\u003cString\u003e organizationCodes\u003dnew ArrayList\u003c\u003e();\n            // 开始查询\n            List\u003cSaasKnowledgeContainer\u003e saasKnowledgeContainerInfos;\n            long count;\n            boolean manageKnowledge\u003dsecureConfig.isManageKnowledge() \u0026\u0026 StpUtil.hasRole(Cns.CLI_ADMIN_ROLE);\n            // 启用超管账号，能够看到所有的知识\n            if (manageKnowledge){\n                // 单独查询\n                try (Page\u003cSaasKnowledgeContainer\u003e saasKnowledgeContainerPageNo \u003d PageHelper.startPage(pageNo, pageSize)) {\n                    //List\u003cSaasKnowledgeContainer\u003e saasKnowledgeContainerInfos \u003d saasKnowledgeContainerMapper.listPermissionAllByCondition(ContainerPermissionCondition.of(tenantId,code,teamCodes,processedOrgCodes,knowledgeContainerQueryReq.getName(),null));\n                    saasKnowledgeContainerInfos\u003d saasKnowledgeContainerMapper.selectList(getWrapper(knowledgeContainerQueryReq,sysUserInfo));\n                    count \u003d saasKnowledgeContainerPageNo.getTotal();\n                }\n            }else{\n                // 查询全部列表的\n                DepartmentUserOrgPermissions orgPermissions\u003dkbDepartmentUserService.listAccessibleDepartmentCodes(sysUserInfo);\n                organizationCodes\u003dorgPermissions.getOrganizationCodes();\n                teamCodes\u003dorgPermissions.getTeamCodes();\n                try (Page\u003cSaasKnowledgeContainer\u003e saasKnowledgeContainerPageNo \u003d PageHelper.startPage(pageNo, pageSize)) {\n                    //List\u003cSaasKnowledgeContainer\u003e saasKnowledgeContainerInfos \u003d saasKnowledgeContainerMapper.listPermissionAllByCondition(ContainerPermissionCondition.of(tenantId,code,teamCodes,processedOrgCodes,knowledgeContainerQueryReq.getName(),null));\n                    saasKnowledgeContainerInfos \u003d saasKnowledgeContainerMapper.listPermissionAllByConditionV1(ContainerPermissionConditionV1.of(tenantId, orgPermissions.permissionCodesToList(), knowledgeContainerQueryReq.getName(), null, knowledgeContainerQueryReq.getClassifyCode()));\n                    count \u003d saasKnowledgeContainerPageNo.getTotal();\n                }\n            }\n            if (CollectionUtil.isNotEmpty(saasKnowledgeContainerInfos)) {\n                // 获取知识库容器列表\n                List\u003cString\u003e containerId \u003d saasKnowledgeContainerInfos.stream().map(SaasKnowledgeContainer::getCode).toList();\n                // 批量查询创建者名字\n                Map\u003cString, CreatorInfo\u003e creatorInfoMap \u003d batchQueryCreatorInfo(saasKnowledgeContainerInfos, tenantId);\n                // 查询用户容器的权限列表\n                Map\u003cString,List\u003cSaasKnowledgeContainerPermission\u003e\u003e containerPermissionMap \u003d saasKnowledgeContainerPermissionService.listByContainerId(containerId, tenantId);\n                // 获取容器下的标签\n                Map\u003cString, List\u003cString\u003e\u003e tagMap \u003d knowledgeTagRelationService.listByContainerIds(containerId, tenantId);\n                Map\u003cString, UniversalEmbeddingConfig\u003e embeddingConfigMap\u003dknowledgeElementEmbeddingQueryService.listEmbeddingModelsByContainerId(containerId);\n                for (SaasKnowledgeContainer container:saasKnowledgeContainerInfos){\n                    KnowledgeContainerResp containerResp\u003d new SaasKnowledgeContainerApplyFunction(tagMap).apply(container);\n                    // 设置创建者名字\n                    CreatorInfo creatorInfo \u003d creatorInfoMap.get(container.getCreator());\n                    if (creatorInfo !\u003d null) {\n                        containerResp.setCreatorName(creatorInfo.getName());\n                        containerResp.setCreatorAvatar(creatorInfo.getAvatar());\n                    }\n                    // 判断用户的角色\n                    if (manageKnowledge){\n                        // 默认就是超管\n                        containerResp.setPermissionType(KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode());\n                    }else {\n                        // 创建者默认就是manage\n                        containerResp.setPermissionType(getHighestPermission(containerPermissionMap.get(container.getCode()),organizationCodes,teamCodes,code));\n                    }\n                    containerResp.applyEmbedding(embeddingConfigMap.get(container.getCode()));\n                    knowledgeContainerRespInfos.add(containerResp);\n                }\n            }\n            return Pagination.pagination(knowledgeContainerRespInfos, count, pageNo, pageSize);\n        }\n    }\n\n    /**\n     * 创建知识库容器权限对象\n     * @param containerId 容器ID\n     * @param sysUserInfo 用户信息\n     * @param permissionType 权限类型\n     * @param membershipType 成员类型\n     * @param membershipCode 成员编码\n     * @param owner 是否所有者\n     * @return 权限对象\n     */\n    private SaasKnowledgeContainerPermission createContainerPermission(\n                                                                       String containerId,\n                                                                       String visibilityRange,\n                                                                       SysUserInfo sysUserInfo,\n                                                                       String permissionType,\n                                                                       String membershipType,\n                                                                       String membershipCode,\n                                                                       boolean owner) {\n        return SaasKnowledgeContainerPermission.builder()\n                .containerId(containerId)\n                .creator(sysUserInfo.getCode())\n                .createTime(LocalDateTime.now())\n                .modifier(sysUserInfo.getCode())\n                .modifierTime(LocalDateTime.now())\n                .tenantId(sysUserInfo.getTenantId())\n                .permissionType(permissionType)\n                .membershipType(membershipType)\n                .membershipCode(membershipCode)\n                .owner(owner)\n                .build();\n    }\n\n    /**\n     * 设置知识库容器权限\n     * @param containerId 容器ID\n     * @param sysUserInfo 用户信息\n     * @param permissionReqList 权限请求列表\n     */\n    private void setupContainerPermissions(\n                                           String containerId,\n                                           String visibilityRange,\n                                           SysUserInfo sysUserInfo,\n                                           List\u003cKbKnowledgeBasePermissionReq\u003e permissionReqList) {\n        List\u003cSaasKnowledgeContainerPermission\u003e permissionList \u003d new ArrayList\u003c\u003e();\n\n        // 添加用户自定义权限\n        // 过滤用户自己的权限\n        permissionReqList \u003d permissionReqList.stream().filter(kbKnowledgeBasePermissionReq -\u003e !kbKnowledgeBasePermissionReq.getOwner()).toList();\n        if (CollUtil.isNotEmpty(permissionReqList)) {\n            permissionReqList.forEach(req -\u003e {\n                if (req.getPermissionType() \u003d\u003d null \u0026\u0026 req.getMembershipType() \u003d\u003d null \u0026\u0026 req.getMembershipCode() \u003d\u003d null) {\n                    return;\n                }\n                permissionList.add(createContainerPermission(\n                        containerId,\n                        visibilityRange,\n                        sysUserInfo,\n                        req.getPermissionType(),\n                        req.getMembershipType(),\n                        req.getMembershipCode(),\n                        false));\n            });\n        }\n\n        // 添加创建者权限\n        permissionList.add(createContainerPermission(\n                containerId,\n                visibilityRange,\n                sysUserInfo,\n                KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode(),\n                KbKnowledgeBaseContainerMemberTypes.USER.getCode(),\n                sysUserInfo.getCode(),\n                true));\n\n        saasKnowledgeContainerPermissionService.saveBatch(permissionList);\n    }\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e add(KnowledgeContainerAddReq knowledgeContainerAddReq) {\n        log.info(\"新增知识库容器数据,Vo:{}\", knowledgeContainerAddReq.toString());\n        // 校验tags的长度\n        knowledgeContainerAddReq.validateTagLength();\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        if (StrUtil.equalsIgnoreCase(knowledgeContainerAddReq.getType(), KnowledgeContainerType.PERSONAL_KNOWLEDGE.name())) {\n            // 校验个人知识库\n            knowledgeContainerDataService.checkExists(sysUserInfo, true);\n        }\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d new SaasKnowledgeContainer();\n        BeanUtils.copyProperties(knowledgeContainerAddReq, saasKnowledgeContainer);\n        // 服务端生成唯一编码\n        saasKnowledgeContainer.setCode(IdUtil.getSnowflakeNextIdStr());\n        saasKnowledgeContainer.setCreator(sysUserInfo.getCode());\n        saasKnowledgeContainer.setCreateTime(LocalDateTime.now());\n        saasKnowledgeContainer.setModifier(sysUserInfo.getCode());\n        saasKnowledgeContainer.setModifierTime(LocalDateTime.now());\n        // 设置租户\n        saasKnowledgeContainer.setTenantId(sysUserInfo.getTenantId());\n        // 知识容器的可见性类型\n        saasKnowledgeContainer.setVisibilityRange(knowledgeContainerAddReq.getVisibilityRange());\n        int ret \u003d saasKnowledgeContainerMapper.insert(saasKnowledgeContainer);\n        if (ret \u003e 0) {\n            // 新增标签关联\n            knowledgeTagRelationService.addTags(saasKnowledgeContainer.getCode(), sysUserInfo, knowledgeContainerAddReq.getTag());\n\n            // 设置知识库配置\n            SaasKnowledgeConfigContainer saasKnowledgeConfigContainer \u003d buildKnowledgeConfigContainer(\n                    saasKnowledgeContainer.getCode(),\n                    sysUserInfo,\n                    knowledgeContainerAddReq);\n            saasKnowledgeConfigContainerService.save(saasKnowledgeConfigContainer);\n            log.info(\"知识库配置信息保存成功\");\n            // 设置容器权限\n            setupContainerPermissions(\n                    saasKnowledgeContainer.getCode(),\n                    knowledgeContainerAddReq.getVisibilityRange(),\n                    sysUserInfo,\n                    knowledgeContainerAddReq.getKbKnowledgeBasePermissionReqList());\n\n            Optional\u003cSaasTenantInfo\u003e saasTenantInfo \u003d tenantInfoService.queryByCode(sysUserInfo.getTenantId());\n            if (saasTenantInfo.isEmpty()) {\n                throw new IllegalArgumentException(\"The tenant account does not exist.\");\n            }\n            Optional\u003cUniversalEmbeddingConfig\u003e embeddingConfigOptional\u003dmodelProviderService.loadEmbedding(saasKnowledgeConfigContainer.getEmbeddingModel());\n            if (embeddingConfigOptional.isEmpty()) {\n                throw new IllegalArgumentException(\"The embedding model does not exist.\");\n            }\n\n\n            // 初始化向量数据库\n            VectorIndexCreateReq createReq \u003d\n                    VectorIndexCreateReq.builder().containerId(saasKnowledgeContainer.getCode())\n                            .tenantId(saasKnowledgeContainer.getTenantId())\n                            .embeddingModels(embeddingConfigOptional.get())\n                            .dbTypes(VectorDBTypes.of(saasTenantInfo.get().getDbType())).build();\n            vectorDatabaseDelegate.createIndex(createReq);\n\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.add.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.add.fail\"));\n    }\n\n    /**\n     * 添加个人知识库\n     * \u003cp\u003e\n     * 该方法用于为当前用户创建一个个人知识库容器。会自动设置知识库的基本配置信息，\n     * 包括名称、类型、分类、分析引擎等参数，并将当前用户设置为知识库的管理者。\n     *\n     * @return Result\u003cString\u003e 操作结果，包含创建的知识库ID或错误信息\n     */\n    @Override\n    public Result\u003cString\u003e addPersonal() {\n        // 获取当前登录用户信息\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n\n        // 根据租户ID获取租户信息，用于获取嵌入模型配置\n        SaasTenantInfoCacheResp tenantInfo \u003d tenantInfoService.getByCode(sysUserInfo.getTenantId());\n\n        // 构建知识库权限列表，将当前用户设置为知识库的拥有者和管理者\n        List\u003cKbKnowledgeBasePermissionReq\u003e permissionReqList \u003d new ArrayList\u003c\u003e();\n        permissionReqList.add(KbKnowledgeBasePermissionReq.builder()\n                .membershipCode(sysUserInfo.getCode())\n                .membershipName(sysUserInfo.getLoginUsername())\n                .membershipType(KbKnowledgeBaseContainerMemberTypes.USER.getCode())\n                .permissionType(KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode())\n                .owner(true)\n                .build());\n\n        // 构建知识库添加请求参数\n        KnowledgeContainerAddReq knowledgeContainerAddReq \u003d new KnowledgeContainerAddReq();\n        knowledgeContainerAddReq.setName(sysUserInfo.showName() + \"的个人知识库\");\n        knowledgeContainerAddReq.setType(KnowledgeContainerType.PERSONAL_KNOWLEDGE.name());\n        knowledgeContainerAddReq.setCategory(KnowledgeCategory.COMMON.name());\n        knowledgeContainerAddReq.setAnalysisEngine(AnalysisEngineEnum.DEFAULT.name());\n        knowledgeContainerAddReq.setAnalysisMode(AnalysisModeEnum.FAST_MODE.name());\n        knowledgeContainerAddReq.setEmbeddingModel(tenantInfo.getEmbeddingModel());\n        knowledgeContainerAddReq.setImageOcr(false);\n        knowledgeContainerAddReq.setMaxChunkLength(1024);\n        knowledgeContainerAddReq.setMaxChunkSize(1024);\n        knowledgeContainerAddReq.setOverlapSize(128);\n        knowledgeContainerAddReq.setSplitMode(SplitTypes.SEMANTIC.name());\n        knowledgeContainerAddReq.setVisibilityRange(KbKnowledgeBaseContainerVisibilityRange.MEMBERS_ONLY.getCode());\n        knowledgeContainerAddReq.setKbKnowledgeBasePermissionReqList(permissionReqList);\n\n        // 调用添加知识库方法\n        return this.add(knowledgeContainerAddReq);\n    }\n\n\n    @Override\n    public Result\u003cString\u003e move(KnowledgeContainerMoveReq moveReq) {\n        log.info(\"移动知识库容器,Vo:{}\", moveReq.toString());\n        String tenantId \u003d UserContextHolder.getTenantId();\n        if (!StrUtil.equalsIgnoreCase(moveReq.getParentCode(), \"0\")) {\n            // 校验父id是否存在\n            SaasKnowledgeContainer parentContainer \u003d saasKnowledgeContainerMapper.selectOne(Wrappers.lambdaQuery(SaasKnowledgeContainer.class)\n                    .eq(SaasKnowledgeContainer::getCode, moveReq.getParentCode())\n                    .eq(SaasKnowledgeContainer::getTenantId, tenantId), false);\n            Assert.isTrue(StrUtil.equalsIgnoreCase(KnowledgeContainerType.DIRECTORY.getName(), Objects.requireNonNull(parentContainer, \"knowledge.move.validation.code\").getType()),\n                    \"knowledge.move.validation.dir\");\n        }\n        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeContainer.class)\n                .eq(SaasKnowledgeContainer::getId, moveReq.getId())\n                .eq(SaasKnowledgeContainer::getTenantId, tenantId);\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d new SaasKnowledgeContainer();\n        saasKnowledgeContainer.setParentCode(moveReq.getParentCode());\n        saasKnowledgeContainer.setModifierTime(LocalDateTime.now());\n        int ret \u003d saasKnowledgeContainerMapper.update(saasKnowledgeContainer, lambdaQueryWrapper);\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.update.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.update.fail\"));\n    }\n\n    /**\n     * 更新知识库容器记录\n     * @param knowledgeContainerUpdateReq 更新知识库容器条件Vo\n     * @return 是否更新成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e update(KnowledgeContainerUpdateReq knowledgeContainerUpdateReq) {\n        log.info(\"根据主键id修改知识库容器数据,Vo:{}\", knowledgeContainerUpdateReq.toString());\n        // 校验tags的长度\n        knowledgeContainerUpdateReq.validateTagLength();\n        SaasKnowledgeContainer record \u003d saasKnowledgeContainerMapper.selectById(knowledgeContainerUpdateReq.getId());\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeContainer.class).eq(SaasKnowledgeContainer::getId, knowledgeContainerUpdateReq.getId())\n                .eq(SaasKnowledgeContainer::getTenantId, sysUserInfo.getTenantId());\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d new SaasKnowledgeContainer();\n        BeanUtils.copyProperties(knowledgeContainerUpdateReq, saasKnowledgeContainer);\n        saasKnowledgeContainer.setModifierTime(LocalDateTime.now());\n        int ret \u003d saasKnowledgeContainerMapper.update(saasKnowledgeContainer, lambdaQueryWrapper);\n        if (ret \u003e 0) {\n            // 先删除\n            knowledgeTagRelationService.deleteByContainerId(record.getCode(), sysUserInfo.getTenantId());\n            // 更新标签关联\n            knowledgeTagRelationService.addTags(record.getCode(), sysUserInfo, knowledgeContainerUpdateReq.getTag());\n        }\n        // 更新配置信息\n\n        SaasKnowledgeConfigContainer request \u003d new SaasKnowledgeConfigContainer();\n        BeanUtil.copyProperties(knowledgeContainerUpdateReq, request);\n        request.setSplitDelimiters(knowledgeContainerUpdateReq.delimitersToJson());\n\n        saasKnowledgeConfigContainerService.updateById(request);\n        // 更新权限信息\n        SaasKnowledgeContainerPermissionUpdateReq saasKnowledgeContainerPermissionUpdateReq \u003d new SaasKnowledgeContainerPermissionUpdateReq();\n        saasKnowledgeContainerPermissionUpdateReq.setContainerId(record.getCode());\n        saasKnowledgeContainerPermissionUpdateReq.setVisibilityRange(knowledgeContainerUpdateReq.getVisibilityRange());\n        saasKnowledgeContainerPermissionUpdateReq.setKbKnowledgeBasePermissionReqList(knowledgeContainerUpdateReq.getKbKnowledgeBasePermissionReqList());\n        Result\u003cString\u003e update \u003d saasKnowledgeContainerPermissionService.update(saasKnowledgeContainerPermissionUpdateReq);\n        if (\"更新成功\".equals(update.getMessage())) {\n            ret \u003d 1;\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.update.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.update.fail\"));\n    }\n\n    /**\n     * 根据id查询知识库容器详情\n     * @param id 知识库容器主键id\n     * @return 知识库容器详情\n     */\n    @Override\n    public Result\u003cKnowledgeContainerResp\u003e queryById(Integer id) {\n        log.info(\"根据主键id查询知识库容器详情,Id:{}\", id);\n        String tenantId \u003d UserContextHolder.getTenantId();\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectById(id);\n        Assert.notNull(saasKnowledgeContainer, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(saasKnowledgeContainer.getTenantId(), tenantId), \"system.common.request.invalid\");\n        KnowledgeContainerResp knowledgeContainerResp \u003d new KnowledgeContainerResp();\n        BeanUtils.copyProperties(saasKnowledgeContainer, knowledgeContainerResp);\n        // 查询分类名称\n        if (!StrUtil.equalsIgnoreCase(saasKnowledgeContainer.getClassifyCode(), \"0\")) {\n            // 查询分类\n            knowledgeCategoryService.queryByCode(saasKnowledgeContainer.getClassifyCode(), tenantId).ifPresent(knowledgeCategoryResp -\u003e {\n                knowledgeContainerResp.setClassifyName(knowledgeCategoryResp.getName());\n            });\n        }\n        // 查询标签\n        knowledgeContainerResp.setTag(knowledgeTagRelationService.listByContainerId(saasKnowledgeContainer.getCode(), tenantId));\n        // 查询配置\n        Optional\u003cSaasKnowledgeConfigContainer\u003e saasKnowledgeConfigContainer \u003d saasKnowledgeConfigContainerService.queryInfoByContainerId(saasKnowledgeContainer.getCode());\n        saasKnowledgeConfigContainer.ifPresent(knowledgeConfigContainer -\u003e {\n            BeanUtil.copyProperties(knowledgeConfigContainer, knowledgeContainerResp);\n            knowledgeContainerResp.setSplitDelimiters(JSONArray.parseArray(saasKnowledgeConfigContainer.get().getSplitDelimiters(), String.class));\n        });\n\n        return Result.data(knowledgeContainerResp);\n    }\n\n    @Override\n    public Pagination\u003cKnowledgeContainerTagResp\u003e listTag(String name, Integer pageNo, Integer pageSize) {\n        String tenantId \u003d UserContextHolder.getTenantId();\n        log.info(\"统计标签信息,tenant:{}\", tenantId);\n        return knowledgeTagRelationService.listByTenantId(tenantId, name, pageNo, pageSize);\n    }\n\n    @Override\n    public Result\u003cString\u003e queryPermissionByCode(String code) {\n        boolean manageKnowledge\u003dsecureConfig.isManageKnowledge() \u0026\u0026 StpUtil.hasRole(Cns.CLI_ADMIN_ROLE);\n        if (manageKnowledge){\n            return Result.data(KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode());\n        }\n        return queryPermissionByCode(code,null);\n    }\n\n    @Override\n    public Result\u003cString\u003e queryPermissionByCode(String code, String elementCode) {\n        // 当前用户权限粒度返回 KbKnowledgeBaseContainerPermissionTypes\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        String permissionType \u003d saasKnowledgeContainerPermissionService.getHighestPermission(code,sysUserInfo);\n        // 如果\n        boolean manageKnowledge\u003dsecureConfig.isManageKnowledge() \u0026\u0026 StpUtil.hasRole(Cns.CLI_ADMIN_ROLE);\n        // 启用超管账号，能够看到所有的知识\n        if (manageKnowledge){\n           permissionType \u003d KbKnowledgeBaseContainerPermissionTypes.MANAGE.name();\n        }else {\n            // 如果是没权限的角色，那么需要判断当前的知识库是否设置为公开，如果是公开的情况下，那么给予只读角色\n            Optional\u003cSaasKnowledgeContainer\u003e containerOptional \u003d this.queryInfoByCode(code);\n            if (containerOptional.isEmpty()) {\n                return Result.data(KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode());\n            }\n            SaasKnowledgeContainer saasKnowledgeContainer \u003d containerOptional.get();\n            if (KbKnowledgeBaseContainerVisibilityRange.publicRead(saasKnowledgeContainer.getVisibilityRange())) {\n                log.info(\"知识库是公开的，给予只读权限，知识库code:{}\", code);\n                // 如果是公开的，那么给予只读权限\n                // 如果是公开的，那么给予只读权限\n                permissionType \u003d KbKnowledgeBaseContainerPermissionTypes.VIEW_ONLY.getCode();\n                // 判断文档\n                if (StrUtil.isNotBlank(elementCode)){\n                    // 获取文档的权限列表\n                    List\u003cSaasKnowledgeElementPermissionResp\u003e elementPermissions \u003d pagePermissionService.listPagePermission(elementCode);\n                    if (CollUtil.isNotEmpty(elementPermissions)) {\n                        // 获取当前用户对文档的最低权限（最严格的限制）\n                        String elePermissionType \u003d getLowestElementPermission(elementPermissions, sysUserInfo);\n                        if (!StrUtil.equalsIgnoreCase(elePermissionType, KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode())) {\n                            // 如果文档不是没有权限的，那么就赋予他这个人在这个文档的权限，否则保持知识库的只读权限\n                            permissionType \u003d elePermissionType;\n                        }\n\n                    }\n                }\n            }else{\n                // 如果不是公开的，并且传递了文档code，看这个人在文档code下是否有权限\n                if (StrUtil.isNotBlank(elementCode)){\n                    // 获取文档的权限列表\n                    List\u003cSaasKnowledgeElementPermissionResp\u003e elementPermissions \u003d pagePermissionService.listPagePermission(elementCode);\n                    if (CollUtil.isNotEmpty(elementPermissions)) {\n                        // 获取当前用户对文档的最低权限（最严格的限制）\n                        permissionType \u003d getLowestElementPermission(elementPermissions, sysUserInfo);\n                    }\n                }\n            }\n        }\n        return Result.data(permissionType);\n    }\n\n    @Override\n    public Result\u003cKnowledgeContainerResp\u003e queryByCode(String code) {\n        log.info(\"根据code查询知识库容器详情,code:{}\", code);\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        String tenantId \u003d sysUserInfo.getTenantId();\n        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeContainer.class)\n                .eq(SaasKnowledgeContainer::getCode, code)\n                .eq(SaasKnowledgeContainer::getTenantId, tenantId);\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectOne(lambdaQueryWrapper);\n        // 获取容器下的标签\n        Map\u003cString, List\u003cString\u003e\u003e tagMap \u003d knowledgeTagRelationService.listByContainerIds(List.of(saasKnowledgeContainer.getCode()), tenantId);\n        KnowledgeContainerResp knowledgeContainerResp\u003d new SaasKnowledgeContainerApplyFunction(tagMap).apply(saasKnowledgeContainer);\n        // 查询分类名称\n        if (!StrUtil.equalsIgnoreCase(saasKnowledgeContainer.getClassifyCode(), \"0\")) {\n            // 查询分类\n            knowledgeCategoryService.queryByCode(saasKnowledgeContainer.getClassifyCode(), tenantId).ifPresent(knowledgeCategoryResp -\u003e {\n                knowledgeContainerResp.setClassifyName(knowledgeCategoryResp.getName());\n            });\n        }\n        // 查询权限信息\n        LambdaQueryWrapper\u003cSaasKnowledgeContainerPermission\u003e lambdaQueryWrapperInfo \u003d new LambdaQueryWrapper\u003c\u003e();\n        lambdaQueryWrapperInfo.eq(SaasKnowledgeContainerPermission::getContainerId, saasKnowledgeContainer.getCode());\n        List\u003cSaasKnowledgeContainerPermission\u003e permissionList \u003d saasKnowledgeContainerPermissionService.list(lambdaQueryWrapperInfo);\n        // 分离用户和其他类型的成员编码，并过滤空值\n        List\u003cString\u003e userCodeList \u003d new ArrayList\u003c\u003e();\n        List\u003cString\u003e departmentCodeList \u003d new ArrayList\u003c\u003e();\n        for (SaasKnowledgeContainerPermission permission : permissionList) {\n            if (permission !\u003d null \u0026\u0026 StrUtil.isNotBlank(permission.getMembershipCode())) {\n                if (KbKnowledgeBaseContainerMemberTypes.USER.name().equals(permission.getMembershipType())) {\n                    userCodeList.add(permission.getMembershipCode());\n                } else if (KbKnowledgeBaseContainerMemberTypes.ORGANIZATION.name().equals(permission.getMembershipType())\n                        || KbKnowledgeBaseContainerMemberTypes.TEAM.name().equals(permission.getMembershipType())) {\n                    departmentCodeList.add(permission.getMembershipCode());\n                }\n            }\n        }\n        // 查询部门信息并构建名称映射\n        Map\u003cString, String\u003e departmentNameMap \u003d new HashMap\u003c\u003e();\n        if (CollectionUtil.isNotEmpty(departmentCodeList)) {\n            LambdaQueryWrapper\u003cKbDepartment\u003e departmentWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n            departmentWrapper.eq(KbDepartment::getTenantId, tenantId)\n                    .in(KbDepartment::getCode, departmentCodeList);\n\n            List\u003cKbDepartment\u003e departments \u003d kbDepartmentMapper.selectList(departmentWrapper);\n            if (CollectionUtil.isNotEmpty(departments)) {\n                departmentNameMap \u003d departments.stream()\n                        .filter(dept -\u003e StrUtil.isNotBlank(dept.getCode()) \u0026\u0026 StrUtil.isNotBlank(dept.getName()))\n                        .collect(Collectors.toMap(\n                                KbDepartment::getCode,\n                                KbDepartment::getName,\n                                (existing, replacement) -\u003e existing // 处理重复key的情况\n                        ));\n            }\n        }\n        // 查询用户信息并构建名称映射\n        Map\u003cString, String\u003e userNameMap \u003d new HashMap\u003c\u003e();\n        if (CollectionUtil.isNotEmpty(userCodeList)) {\n            LambdaQueryWrapper\u003cSysUser\u003e userWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n            userWrapper.eq(SysUser::getTenantId, tenantId)\n                    .in(SysUser::getCode, userCodeList);\n\n            List\u003cSysUser\u003e users \u003d sysUserMapper.selectList(userWrapper);\n            if (CollectionUtil.isNotEmpty(users)) {\n                userNameMap \u003d users.stream()\n                        .filter(user -\u003e StrUtil.isNotBlank(user.getCode()) \u0026\u0026 StrUtil.isNotBlank(user.getLoginUsername()))\n                        .collect(Collectors.toMap(\n                                SysUser::getCode,\n                                user -\u003e StrUtil.isNotBlank(user.getRealName()) ? user.getRealName() : user.getLoginUsername(),\n                                (existing, replacement) -\u003e existing // 处理重复key的情况\n                        ));\n            }\n        }\n        // 使用final变量供lambda表达式使用\n        final Map\u003cString, String\u003e finalUserNameMap \u003d userNameMap;\n        final Map\u003cString, String\u003e finalDepartmentNameMap \u003d departmentNameMap;\n        // 将权限信息转换为请求对象列表\n        List\u003cKbKnowledgeBasePermissionReq\u003e permissionReqList \u003d CollUtil.isEmpty(permissionList) ? new ArrayList\u003c\u003e()\n                : permissionList.stream()\n                        .map(permission -\u003e {\n                            String membershipTypeName \u003d null;\n                            if (KbKnowledgeBaseContainerMemberTypes.USER.name().equals(permission.getMembershipType())) {\n                                membershipTypeName \u003d finalUserNameMap.get(permission.getMembershipCode());\n                            } else {\n                                membershipTypeName \u003d finalDepartmentNameMap.get(permission.getMembershipCode());\n                            }\n                            return KbKnowledgeBasePermissionReq.builder()\n                                    .id(permission.getId())\n                                    .permissionType(permission.getPermissionType())\n                                    .membershipType(permission.getMembershipType())\n                                    .membershipCode(permission.getMembershipCode())\n                                    .membershipName(membershipTypeName) // 添加这一行\n                                    .owner(permission.getOwner())\n                                    .build();\n                        })\n                        .sorted((p1, p2) -\u003e {\n                            // 1. 首先按照isOwner排序，true的排在前面\n                            if (Boolean.TRUE.equals(p1.getOwner()) \u0026\u0026 !Boolean.TRUE.equals(p2.getOwner())) {\n                                return -1;\n                            }\n                            if (!Boolean.TRUE.equals(p1.getOwner()) \u0026\u0026 Boolean.TRUE.equals(p2.getOwner())) {\n                                return 1;\n                            }\n                            // 2. 如果isOwner相同，则按照权限类型排序\n                            // 定义权限类型的优先级顺序：MANAGE \u003e EDIT \u003e VIEW_DOWNLOAD \u003e VIEW_ONLY\n                            Map\u003cString, Integer\u003e permissionPriority \u003d Map.of(\n                                    KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode(), 1, // 可管理\n                                    KbKnowledgeBaseContainerPermissionTypes.EDIT.getCode(), 2, // 可编辑\n                                    KbKnowledgeBaseContainerPermissionTypes.VIEW_DOWNLOAD.getCode(), 3, // 可查看/下载\n                                    KbKnowledgeBaseContainerPermissionTypes.VIEW_ONLY.getCode(), 4 // 仅可查看\n                            );\n\n                            // 获取权限类型的优先级，如果不存在则放到最后\n                            int priority1 \u003d permissionPriority.getOrDefault(p1.getPermissionType(), Integer.MAX_VALUE);\n                            int priority2 \u003d permissionPriority.getOrDefault(p2.getPermissionType(), Integer.MAX_VALUE);\n\n                            // 按照优先级排序\n                            return Integer.compare(priority1, priority2);\n                        })\n                        .collect(Collectors.toList());\n        // 当前用户权限粒度返回\n        boolean manageKnowledge\u003dsecureConfig.isManageKnowledge() \u0026\u0026 StpUtil.hasRole(Cns.CLI_ADMIN_ROLE);\n        if (manageKnowledge){\n            knowledgeContainerResp.setPermissionType(KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode());\n        }else{\n            knowledgeContainerResp.setPermissionType(saasKnowledgeContainerPermissionService.getHighestPermission(permissionList,sysUserInfo));\n        }\n        knowledgeContainerResp.setVisibilityRange(saasKnowledgeContainer.getVisibilityRange());\n        knowledgeContainerResp.setKbKnowledgeBasePermissionReqList(permissionReqList);\n        // 查询知识库配置信息\n        LambdaQueryWrapper\u003cSaasKnowledgeConfigContainer\u003e saasKnowledgeBaseConfigLambdaQueryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n        saasKnowledgeBaseConfigLambdaQueryWrapper.eq(SaasKnowledgeConfigContainer::getTenantId, tenantId);\n        saasKnowledgeBaseConfigLambdaQueryWrapper.eq(SaasKnowledgeConfigContainer::getContainerId, saasKnowledgeContainer.getCode());\n        SaasKnowledgeConfigContainer saasKnowledgeBaseConfig \u003d saasKnowledgeConfigContainerService.getOne(saasKnowledgeBaseConfigLambdaQueryWrapper);\n        if (ObjectUtil.isNotEmpty(saasKnowledgeBaseConfig)) {\n            BeanUtils.copyProperties(saasKnowledgeBaseConfig, knowledgeContainerResp);\n            knowledgeContainerResp.setSplitDelimiters(JSONArray.parseArray(saasKnowledgeBaseConfig.getSplitDelimiters(), String.class));\n            // 防止id被篡改，重新设置知识库id\n            knowledgeContainerResp.setId(saasKnowledgeContainer.getId());\n        }\n\n        return Result.data(knowledgeContainerResp);\n    }\n\n    @Override\n    public Result\u003cKnowledgeContainerFollowResp\u003e queryFollowStatus(String code) {\n        List\u003cString\u003e spaceCodes \u003d List.of(code);\n        SysUserInfo currentUser \u003d UserContextHolder.getCurrentUser();\n        Map\u003cString, KbSpaceFollowing\u003e followingMap \u003d kbSpaceFollowService.listFollow(currentUser.getTenantId(), currentUser.getCode(), spaceCodes);\n        KnowledgeContainerFollowResp resp \u003d new KnowledgeContainerFollowResp();\n        resp.setFollowingState(followingMap.containsKey(code));\n        return Result.data(resp);\n    }\n\n\n    public String getHighestPermission(List\u003cSaasKnowledgeContainerPermission\u003e permissionList,List\u003cString\u003e organizationCodes, List\u003cString\u003e teamCodes,String currentUserCode){\n        if (permissionList \u003d\u003d null || permissionList.isEmpty()) {\n            return KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode();\n        }\n\n        // 定义权限优先级，数值越小优先级越高\n        Map\u003cString, Integer\u003e permissionPriority \u003d Map.of(\n                KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode(), 1,\n                KbKnowledgeBaseContainerPermissionTypes.EDIT.getCode(), 2,\n                KbKnowledgeBaseContainerPermissionTypes.VIEW_DOWNLOAD.getCode(), 3,\n                KbKnowledgeBaseContainerPermissionTypes.VIEW_ONLY.getCode(), 4);\n\n        String highestPermission \u003d KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode();\n        int highestPriority \u003d Integer.MAX_VALUE;\n\n        for (SaasKnowledgeContainerPermission permission : permissionList) {\n            String permissionType \u003d permission.getPermissionType();\n            String membershipType \u003d permission.getMembershipType();\n            String membershipCode \u003d permission.getMembershipCode();\n\n            boolean hasPermission \u003d false;\n\n            // 判断权限是否适用于当前用户\n            switch (membershipType) {\n                case \"USER\":\n                    // 如果是USER类型且membershipCode匹配当前用户\n                    hasPermission \u003d membershipCode.equalsIgnoreCase(currentUserCode);\n                    break;\n\n                case \"ORGANIZATION\":\n                    hasPermission\u003d organizationCodes.stream().anyMatch(s -\u003e StrUtil.contains(s, membershipCode));\n                    break;\n                case \"TEAM\":\n                    // 如果是ORGANIZATION或TEAM类型，检查当前用户是否属于该组织/团队\n                    hasPermission \u003d teamCodes.contains(membershipCode);\n                    break;\n\n                default:\n                    // 未知类型，跳过\n                    continue;\n            }\n\n            // 如果当前权限适用于用户，且优先级更高\n            if (hasPermission) {\n                Integer priority \u003d permissionPriority.get(permissionType);\n                if (priority !\u003d null \u0026\u0026 priority \u003c highestPriority) {\n                    highestPriority \u003d priority;\n                    highestPermission \u003d permissionType;\n\n                    // 如果已经是最高权限MANAGE，直接返回\n                    if (KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode().equals(permissionType)) {\n                        return permissionType;\n                    }\n                }\n            }\n        }\n        return highestPermission;\n    }\n\n    /**\n     * 从文档权限列表中获取当前用户的最低权限（最严格的限制）\n     * @param elementPermissions 文档权限列表\n     * @param sysUserInfo 当前用户信息\n     * @return 当前用户的最低权限\n     */\n    private String getLowestElementPermission(List\u003cSaasKnowledgeElementPermissionResp\u003e elementPermissions, SysUserInfo sysUserInfo) {\n        if (elementPermissions \u003d\u003d null || elementPermissions.isEmpty()) {\n            return KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode();\n        }\n\n        String currentUserCode \u003d sysUserInfo.getCode();\n        String tenantId \u003d sysUserInfo.getTenantId();\n\n        // 查询用户所在的部门和团队列表\n        List\u003cKbDepartmentUserTypeInfo\u003e departmentUserTypeInfos \u003d kbDepartmentUserMapper.listDepartmentUsers(tenantId, currentUserCode);\n        List\u003cString\u003e teamCodes \u003d new ArrayList\u003c\u003e();\n        List\u003cString\u003e organizationCodes \u003d new ArrayList\u003c\u003e();\n\n        if (CollUtil.isNotEmpty(departmentUserTypeInfos)) {\n            for (KbDepartmentUserTypeInfo typeInfo : departmentUserTypeInfos) {\n                if (StrUtil.equalsIgnoreCase(typeInfo.getType(), KbDepartmentTypes.TEAM.name())) {\n                    teamCodes.add(typeInfo.getDepartmentCode());\n                } else {\n                    organizationCodes.add(typeInfo.getFullPath());\n                }\n            }\n        }\n\n        // 定义权限级别，数值越大权限越低（限制越严格）\n        Map\u003cString, Integer\u003e permissionLevel \u003d Map.of(\n                KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode(), 1,\n                KbKnowledgeBaseContainerPermissionTypes.EDIT.getCode(), 2,\n                KbKnowledgeBaseContainerPermissionTypes.VIEW_DOWNLOAD.getCode(), 3,\n                KbKnowledgeBaseContainerPermissionTypes.VIEW_ONLY.getCode(), 4\n        );\n\n        String lowestPermission \u003d KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode();\n        int lowestLevel \u003d Integer.MIN_VALUE; // 初始化为最小值，表示还没有找到任何权限\n\n        for (SaasKnowledgeElementPermissionResp permission : elementPermissions) {\n            String permissionType \u003d permission.getPermissionType();\n            String membershipType \u003d permission.getMembershipType();\n            String membershipCode \u003d permission.getMembershipCode();\n\n            boolean hasPermission \u003d false;\n\n            // 判断权限是否适用于当前用户\n            switch (membershipType) {\n                case \"USER\":\n                    hasPermission \u003d membershipCode.equalsIgnoreCase(currentUserCode);\n                    break;\n                case \"ORGANIZATION\":\n                    hasPermission \u003d organizationCodes.stream().anyMatch(s -\u003e StrUtil.contains(s, membershipCode));\n                    break;\n                case \"TEAM\":\n                    hasPermission \u003d teamCodes.contains(membershipCode);\n                    break;\n                default:\n                    continue;\n            }\n\n            // 如果当前权限适用于用户，取级别更大的（权限更低的）\n            if (hasPermission) {\n                Integer level \u003d permissionLevel.get(permissionType);\n                if (level !\u003d null \u0026\u0026 level \u003e lowestLevel) {\n                    lowestLevel \u003d level;\n                    lowestPermission \u003d permissionType;\n\n                    // 如果已经是最低权限VIEW_ONLY，直接返回\n                    if (KbKnowledgeBaseContainerPermissionTypes.VIEW_ONLY.getCode().equals(permissionType)) {\n                        return permissionType;\n                    }\n                }\n            }\n        }\n\n        return lowestPermission;\n    }\n\n    /**\n     * 比较两个权限，返回权限更小的那个\n     * 权限优先级：MANAGE \u003e EDIT \u003e VIEW_DOWNLOAD \u003e VIEW_ONLY \u003e NO_PERMISSION\n     * @param permission1 权限1\n     * @param permission2 权限2\n     * @return 权限更小的那个\n     */\n    private String getMinPermission(String permission1, String permission2) {\n        // 定义权限优先级，数值越大权限越小\n        Map\u003cString, Integer\u003e permissionLevel \u003d Map.of(\n                KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode(), 1,\n                KbKnowledgeBaseContainerPermissionTypes.EDIT.getCode(), 2,\n                KbKnowledgeBaseContainerPermissionTypes.VIEW_DOWNLOAD.getCode(), 3,\n                KbKnowledgeBaseContainerPermissionTypes.VIEW_ONLY.getCode(), 4,\n                KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode(), 5\n        );\n\n        int level1 \u003d permissionLevel.getOrDefault(permission1, Integer.MAX_VALUE);\n        int level2 \u003d permissionLevel.getOrDefault(permission2, Integer.MAX_VALUE);\n\n        // 返回优先级数值更大的（权限更小的）\n        return level1 \u003e level2 ? permission1 : permission2;\n    }\n\n\n    @Override\n    public List\u003cSaasKnowledgeContainer\u003e listByCodes(List\u003cString\u003e codes, String tenantId) {\n        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeContainer.class)\n                .eq(SaasKnowledgeContainer::getTenantId, tenantId)\n                .in(SaasKnowledgeContainer::getCode, codes);\n        return saasKnowledgeContainerMapper.selectList(lambdaQueryWrapper);\n    }\n\n    /**\n     * 根据主键id删除知识库容器\n     * @param id 主键id\n     * @return 是否删除成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e delete(Integer id) {\n        log.info(\"根据主键id删除知识库容器,id:{}\", id);\n        String tenantId \u003d UserContextHolder.getTenantId();\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectById(id);\n        Assert.notNull(saasKnowledgeContainer, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(saasKnowledgeContainer.getTenantId(), tenantId), \"system.common.request.invalid\");\n        LogContext.putVariable(\"name\", saasKnowledgeContainer.getName());\n        // 删除索引\n        knowledgeElementDataService.deleteByContainerId(saasKnowledgeContainer.getCode(), tenantId);\n        // 删除开放平台关联的key\n        platformKeyContainerService.deleteByContainerId(tenantId, saasKnowledgeContainer.getCode());\n        // 删除文件配置信息\n        LambdaQueryWrapper\u003cSaasKnowledgeConfigElement\u003e saasKnowledgeConfigElementLambdaQueryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n        saasKnowledgeConfigElementLambdaQueryWrapper.eq(SaasKnowledgeConfigElement::getContainerId, saasKnowledgeContainer.getCode());\n        saasKnowledgeConfigElementLambdaQueryWrapper.eq(SaasKnowledgeConfigElement::getTenantId, tenantId);\n        saasKnowledgeConfigElementService.remove(saasKnowledgeConfigElementLambdaQueryWrapper);\n        // 删除文件信息\n        knowledgeElementService.deleteByContainerCode(saasKnowledgeContainer.getCode(), tenantId);\n        // 删除标签关系\n        knowledgeTagRelationService.deleteByContainerId(saasKnowledgeContainer.getCode(), tenantId);\n        // 删除权限信息\n        LambdaQueryWrapper\u003cSaasKnowledgeContainerPermission\u003e saasKnowledgeContainerPermissionLambdaQueryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n        saasKnowledgeContainerPermissionLambdaQueryWrapper.eq(SaasKnowledgeContainerPermission::getContainerId, saasKnowledgeContainer.getCode());\n        saasKnowledgeContainerPermissionLambdaQueryWrapper.eq(SaasKnowledgeContainerPermission::getTenantId, tenantId);\n        saasKnowledgeContainerPermissionService.remove(saasKnowledgeContainerPermissionLambdaQueryWrapper);\n        log.info(\"删除删除权限信息成功，知识库id为{}\", saasKnowledgeContainer.getCode());\n        // 删除知识库配置信息\n        LambdaQueryWrapper\u003cSaasKnowledgeConfigContainer\u003e saasKnowledgeConfigContainerLambdaQueryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n        saasKnowledgeConfigContainerLambdaQueryWrapper.eq(SaasKnowledgeConfigContainer::getContainerId, saasKnowledgeContainer.getCode());\n        saasKnowledgeConfigContainerLambdaQueryWrapper.eq(SaasKnowledgeConfigContainer::getTenantId, tenantId);\n        saasKnowledgeConfigContainerService.remove(saasKnowledgeConfigContainerLambdaQueryWrapper);\n        log.info(\"删除知识库配置信息成功，知识库id为{}\", saasKnowledgeContainer.getCode());\n        // 删除布局组件表部署配置信息\n        LambdaQueryWrapper\u003cKbDashboardComponent\u003e kbDashboardComponentLambdaQueryWrapper \u003d new LambdaQueryWrapper\u003c\u003e();\n        kbDashboardComponentLambdaQueryWrapper.eq(KbDashboardComponent::getRegionCode,saasKnowledgeContainer.getCode());\n        kbDashboardComponentService.remove(kbDashboardComponentLambdaQueryWrapper);\n        log.info(\"删除布局组件表部署配置信息成功，知识库id为{}\", saasKnowledgeContainer.getCode());\n        int ret \u003d saasKnowledgeContainerMapper.deleteById(id);\n\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.delete.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.delete.fail\"));\n    }\n\n    /**\n     * 根据id查询知识库容器实体详情\n     * @param id 主键id\n     * @return 知识库容器的Optional\n     */\n    @Override\n    public Optional\u003cSaasKnowledgeContainer\u003e queryInfoById(Integer id) {\n        log.info(\"根据请求id查询知识库容器实体详情,id:{}\", id);\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectById(id);\n        if (saasKnowledgeContainer !\u003d null) {\n            return Optional.of(saasKnowledgeContainer);\n        }\n        return Optional.empty();\n    }\n\n    /**\n     * 校验请求id是否非法\n     * @param id 主键id\n     * @return 是否存在\n     */\n    @Override\n    public boolean checkIdExists(Integer id) {\n        log.info(\"校验请求Id是否存在,id:{}\", id);\n        return saasKnowledgeContainerMapper.selectById(id) !\u003d null;\n    }\n\n    @Override\n    public Result\u003cKnowledgeContainerResp\u003e queryBasicInfoById(Integer id)\n    {\n\n        log.info(\"根据主键id查询知识库容器详情,Id:{}\", id);\n        String tenantId \u003d UserContextHolder.getTenantId();\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectById(id);\n        Assert.notNull(saasKnowledgeContainer, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(saasKnowledgeContainer.getTenantId(), tenantId), \"system.common.request.invalid\");\n        KnowledgeContainerResp knowledgeContainerResp \u003d new KnowledgeContainerResp();\n        BeanUtils.copyProperties(saasKnowledgeContainer, knowledgeContainerResp);\n        // 查询分类名称\n        if (!StrUtil.equalsIgnoreCase(saasKnowledgeContainer.getClassifyCode(), \"0\")) {\n            // 查询分类\n            knowledgeCategoryService.queryByCode(saasKnowledgeContainer.getClassifyCode(), tenantId).ifPresent(knowledgeCategoryResp -\u003e {\n                knowledgeContainerResp.setClassifyName(knowledgeCategoryResp.getName());\n            });\n        }\n        // 查询标签\n        knowledgeContainerResp.setTag(knowledgeTagRelationService.listByContainerId(saasKnowledgeContainer.getCode(), tenantId));\n        return Result.data(knowledgeContainerResp);\n    }\n\n    @Override\n    public Optional\u003cSaasKnowledgeContainer\u003e queryInfoByCode(String code) {\n        log.info(\"根据code查询知识库容器详情1,code:{}\", code);\n        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeContainer.class).eq(SaasKnowledgeContainer::getCode, code);\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectOne(lambdaQueryWrapper,false);\n        return Optional.ofNullable(saasKnowledgeContainer);\n    }\n\n    @Override\n    public Result\u003cKnowledgeContainerResp\u003e queryBasicInfoByCode(String code) {\n        String tenantId \u003d UserContextHolder.getTenantId();\n        log.info(\"根据code查询知识库容器详情1,code:{}\", code);\n        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeContainer.class).eq(SaasKnowledgeContainer::getCode, code).eq(SaasKnowledgeContainer::getTenantId, tenantId);\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d saasKnowledgeContainerMapper.selectOne(lambdaQueryWrapper,false);\n        Assert.notNull(saasKnowledgeContainer, \"system.common.request.invalid\");\n        Assert.isTrue(StrUtil.equalsIgnoreCase(saasKnowledgeContainer.getTenantId(), tenantId), \"system.common.request.invalid\");\n        KnowledgeContainerResp knowledgeContainerResp \u003d new KnowledgeContainerResp();\n        BeanUtils.copyProperties(saasKnowledgeContainer, knowledgeContainerResp);\n        // 查询分类名称\n        if (!StrUtil.equalsIgnoreCase(saasKnowledgeContainer.getClassifyCode(), \"0\")) {\n            // 查询分类\n            knowledgeCategoryService.queryByCode(saasKnowledgeContainer.getClassifyCode(), tenantId).ifPresent(knowledgeCategoryResp -\u003e {\n                knowledgeContainerResp.setClassifyName(knowledgeCategoryResp.getName());\n            });\n        }\n        // 查询标签\n        knowledgeContainerResp.setTag(knowledgeTagRelationService.listByContainerId(saasKnowledgeContainer.getCode(), tenantId));\n        return Result.data(knowledgeContainerResp);\n    }\n\n    @Override\n    public Result\u003cString\u003e updateBasicInfo(KnowledgeContainerUpdateReq knowledgeContainerUpdateReq)\n    {\n\n        log.info(\"根据主键id修改知识库容器数据,Vo:{}\", knowledgeContainerUpdateReq.toString());\n        // 校验tags的长度\n        knowledgeContainerUpdateReq.validateTagLength();\n        SaasKnowledgeContainer record \u003d saasKnowledgeContainerMapper.selectById(knowledgeContainerUpdateReq.getId());\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeContainer.class).eq(SaasKnowledgeContainer::getId, knowledgeContainerUpdateReq.getId())\n                .eq(SaasKnowledgeContainer::getTenantId, sysUserInfo.getTenantId());\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d new SaasKnowledgeContainer();\n        BeanUtils.copyProperties(knowledgeContainerUpdateReq, saasKnowledgeContainer);\n        saasKnowledgeContainer.setModifierTime(LocalDateTime.now());\n        int ret \u003d saasKnowledgeContainerMapper.update(saasKnowledgeContainer, lambdaQueryWrapper);\n        if (ret \u003e 0) {\n            // 先删除\n            knowledgeTagRelationService.deleteByContainerId(record.getCode(), sysUserInfo.getTenantId());\n            // 更新标签关联\n            knowledgeTagRelationService.addTags(record.getCode(), sysUserInfo, knowledgeContainerUpdateReq.getTag());\n        }\n        return ret \u003e 0 ? Result.defaultSuccess(i18nMessage.resolveMessage(\"system.common.update.success\")) : Result.error(i18nMessage.resolveMessage(\"system.common.update.fail\"));\n    }\n\n    /**\n     * 创建知识库配置\n     * @param containerId 容器ID\n     * @param sysUserInfo 用户信息\n     * @param addReq 添加请求\n     * @return 知识库配置\n     */\n    private SaasKnowledgeConfigContainer buildKnowledgeConfigContainer(\n                                                                       String containerId,\n                                                                       SysUserInfo sysUserInfo,\n                                                                       KnowledgeContainerAddReq addReq) {\n        SaasKnowledgeConfigContainer config \u003d SaasKnowledgeConfigContainer.builder()\n                .containerId(containerId)\n                .creator(sysUserInfo.getCode())\n                .createTime(LocalDateTime.now())\n                .modifier(sysUserInfo.getCode())\n                .modifierTime(LocalDateTime.now())\n                .tenantId(sysUserInfo.getTenantId())\n                .embeddingModel(addReq.getEmbeddingModel())\n                .splitMode(addReq.getSplitMode())\n                .maxChunkSize(addReq.getMaxChunkSize())\n                .maxChunkLength(addReq.getMaxChunkLength())\n                .imageOcr(addReq.getImageOcr())\n                .splitDelimiters(addReq.delimitersToJson())\n                .analysisEngine(addReq.getAnalysisEngine())\n                .analysisMode(addReq.getAnalysisMode())\n                .ocrEngine(addReq.getOcrEngine())\n                .multiModalityEngine(addReq.getMultiModalityEngine())\n                .engineType(addReq.getEngineType())\n                .overlapSize(addReq.getOverlapSize())\n                .build();\n\n        return checkBeforeInsert(config, addReq);\n    }\n\n    /**\n     * 根据分割模式设置配置\n     * @param addReq 添加请求\n     * @return 配置对象\n     */\n    private SaasKnowledgeConfigContainer checkBeforeInsert(\n                                                           SaasKnowledgeConfigContainer config,\n                                                           KnowledgeContainerAddReq addReq) {\n        String splitMode \u003d addReq.getSplitMode();\n\n        if (KbDocumentShardingMode.FIXED_SIZE.name().equals(splitMode)) {\n            Assert.isTrue(addReq.getMaxChunkSize() \u003e 0, \"固定片段最大长度不能为空\");\n        } else if (KbDocumentShardingMode.SEMANTIC.name().equals(splitMode)) {\n            Assert.isTrue(addReq.getMaxChunkLength() \u003e 0, \"语义最大长度不能为空\");\n        } else if (KbDocumentShardingMode.DELIMITER.name().equals(splitMode)) {\n            Assert.isTrue(CollectionUtil.isNotEmpty(addReq.getSplitDelimiters()), \"分隔符不能为空\");\n        }\n\n        return config;\n    }\n\n    /**\n     * 创建者信息内部类\n     */\n    private static class CreatorInfo {\n        private final String name;\n        private final String avatar;\n\n        public CreatorInfo(String name, String avatar) {\n            this.name \u003d name;\n            this.avatar \u003d avatar;\n        }\n\n        public String getName() {\n            return name;\n        }\n",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 1120
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/knowledge/impl/KnowledgeContainerDataServiceImpl.java",
      "timestamp": 1761236769154,
      "startOffset": 994,
      "endOffset": 9111,
      "codeContent": "Result;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.kb.space.service.SaasKnowledgeConfigContainerService;\nimport com.torchv.kb.space.service.SaasKnowledgeContainerPermissionService;\nimport com.torchv.kb.system.model.dto.KnowledgeCapacityDirectory;\nimport com.torchv.kb.system.service.KnowledgeCapacityService;\nimport com.torchv.repository.chat.entity.SaasKnowledgeContainer;\nimport com.torchv.repository.chat.mapper.SaasKnowledgeContainerMapper;\nimport com.torchv.repository.kb.entity.SaasKnowledgeConfigContainer;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.redisson.api.RLock;\nimport org.redisson.api.RedissonClient;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.time.LocalDateTime;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2025/8/12 16:00\n * @since ais-server v1.3\n */\n@AllArgsConstructor\n@Slf4j\n@Service\npublic class KnowledgeContainerDataServiceImpl implements KnowledgeContainerDataService {\n\n    final SaasKnowledgeContainerMapper saasKnowledgeContainerMapper;\n    final SaasKnowledgeContainerPermissionService saasKnowledgeContainerPermissionService;\n    final SaasKnowledgeConfigContainerService saasKnowledgeConfigContainerService;\n    final RedissonClient redissonClient;\n    final TenantCacheService tenantCacheService;\n    final KnowledgeCapacityService knowledgeCapacityService;\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public String createPersonKnowledge(SysUserInfo sysUserInfo) {\n        // 查询个人知识库是否存在\n        return createPersonalKnowledge(sysUserInfo,AdminKnowledgePersonalContainerReq.of(sysUserInfo),false);\n    }\n\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public String createPersonalKnowledge(SysUserInfo sysUserInfo, AdminKnowledgePersonalContainerReq containerReq,boolean checkExist) {\n        // 查询个人知识库是否存在\n        Optional\u003cTenantCacheInfo\u003e  cacheInfoOptional \u003d tenantCacheService.getByTenantId(sysUserInfo.getTenantId());\n        if (cacheInfoOptional.isEmpty()) {\n            log.error(\"租户信息不存在，tenantId: {}\", sysUserInfo.getTenantId());\n            throw new IllegalArgumentException(\"请求数据非法\");\n        }\n        TenantCacheInfo tenantCacheInfo \u003d cacheInfoOptional.get();\n        // 查询个人知识库是否存在\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d findPersonalKnowledge(sysUserInfo);\n        if (saasKnowledgeContainer !\u003d null) {\n            if (checkExist){\n                throw new RuntimeException(\"个人知识库已存在，请勿重复创建\");\n            }\n            return saasKnowledgeContainer.getCode();\n        }\n        // 先insert\n        String redisKey \u003d KbCacheConst.KB_LOCK_USER_KNOWLEDGE_PERSON + sysUserInfo.getCode();\n        RLock rLock \u003d redissonClient.getLock(redisKey);\n        boolean lockAcquired \u003d false;\n        try {\n            lockAcquired \u003d rLock.tryLock(10L, 10L, TimeUnit.SECONDS);\n            if (!lockAcquired) {\n                log.warn(\"获取分布式锁失败，key: {}\", redisKey);\n                throw new IllegalArgumentException(\"系统繁忙，请稍后再试\");\n            }\n            // 再次查询个人知识库是否存在\n            // 双重检查\n            saasKnowledgeContainer \u003d findPersonalKnowledge(sysUserInfo);\n            if (saasKnowledgeContainer !\u003d null) {\n                if (checkExist){\n                    throw new RuntimeException(\"个人知识库已存在，请勿重复创建\");\n                }\n                return saasKnowledgeContainer.getCode();\n            }\n            // 创建个人知识库\n            saasKnowledgeContainer \u003d buildKnowledgeContainer(sysUserInfo,containerReq);\n            // 创建知识库，查询个人知识库的容量配置\n            KnowledgeCapacityDirectory knowledgeCapacityDirectory\u003dknowledgeCapacityService.getKnowledgeCapacityDirectory(sysUserInfo.getTenantId());\n            Assert.notNull(knowledgeCapacityDirectory, \"系统繁忙，请稍后再试(请配置知识库容量配置)\");\n            // 设置个人知识库的默认配置\n            saasKnowledgeContainer.setCapacitySize(knowledgeCapacityDirectory.getUserCapacitySize());\n            // 设置个人知识库的默认配置\n            int ret \u003d saasKnowledgeContainerMapper.insert(saasKnowledgeContainer);\n            if (ret\u003c\u003d0){\n                log.error(\"创建个人知识库失败，code: {}, name: {}\", saasKnowledgeContainer.getCode(), saasKnowledgeContainer.getName());\n                throw new RuntimeException(\"系统繁忙，请稍后再试\");\n            }\n            // 设置知识库配置\n            SaasKnowledgeConfigContainer saasKnowledgeConfigContainer \u003d buildKnowledgeConfigContainer(saasKnowledgeContainer.getCode(),sysUserInfo, tenantCacheInfo);\n            saasKnowledgeConfigContainerService.save(saasKnowledgeConfigContainer);\n            log.info(\"知识库配置信息保存成功\");\n            // 添加权限\n            saasKnowledgeContainerPermissionService.addPersonalKnowledgePermission(saasKnowledgeContainer, sysUserInfo);\n            return saasKnowledgeContainer.getCode();\n        } catch (InterruptedException e) {\n            throw new RuntimeException(\"tenant.package.add.result.exception\");\n        }finally {\n            // 安全释放锁\n            if (lockAcquired) {\n                try {\n                    if (rLock.isLocked() \u0026\u0026 rLock.isHeldByCurrentThread()) {\n                        rLock.unlock();\n                        log.debug(\"成功释放分布式锁，key: {}\", redisKey);\n                    }\n                } catch (Exception e) {\n                    log.error(\"释放分布式锁失败，key: {}\", redisKey, e);\n                    // 不重新抛出异常，避免覆盖业务异常\n                }\n            }\n        }\n    }\n\n    /**\n     * 创建知识库配置\n     * @param containerId 容器ID\n     * @param sysUserInfo 用户信息\n     * @return 知识库配置\n     */\n    private SaasKnowledgeConfigContainer buildKnowledgeConfigContainer(\n            String containerId,\n            SysUserInfo sysUserInfo,\n            TenantCacheInfo tenantCacheInfo ) {\n        // 默认最大片段大小\n        // 默认语义最大长度\n        // 默认分析模式\n        // 默认重叠大小\n        return SaasKnowledgeConfigContainer.builder()\n                .containerId(containerId)\n                .creator(sysUserInfo.getCode())\n                .createTime(LocalDateTime.now())\n                .modifier(sysUserInfo.getCode())\n                .modifierTime(LocalDateTime.now())\n                .tenantId(sysUserInfo.getTenantId())\n                .embeddingModel(tenantCacheInfo.getEmbeddingModels())\n                .splitMode(KbDocumentShardingMode.SEMANTIC.name())\n                .maxChunkSize(1024) // 默认最大片段大小\n                .maxChunkLength(1024) // 默认语义最大长度\n                .analysisEngine(\"DEFAULT\")\n                .analysisMode(\"FAST_MODE\") // 默认分析模式\n                .overlapSize(128) // 默认重叠大小\n                .build();\n    }\n\n    /**\n     * 查找个人知识库\n     * @param sysUserInfo 用户信息\n     * @return SaasKnowledgeContainer\n     */\n    private SaasKnowledgeContainer findPersonalKnowledge(SysUserInfo sysUserInfo) {\n        LambdaQueryWrapper\u003cSaasKnowledgeContainer\u003e lambdaQueryWrapper \u003d Wrappers.lambdaQuery(SaasKnowledgeContainer.class)\n                .eq(SaasKnowledgeContainer::getTenantId, sysUserInfo.getTenantId())\n                .eq(SaasKnowledgeContainer::getType, KnowledgeContainerType.PERSONAL_KNOWLEDGE.name())\n                .eq(SaasKnowledgeContainer::getCreator, sysUserInfo.getCode());\n        return saasKnowledgeContainerMapper.selectOne(lambdaQueryWrapper, false);\n    }\n\n    @Override\n    public void checkExists(SysUserInfo sysUserInfo, boolean checkExist) {\n        // 查询个人知识库是否存在\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d findPersonalKnowledge(sysUserInfo);\n        if (saasKnowledgeContainer !\u003d null) {\n            if (checkExist) {\n                throw new RuntimeException(\"个人知识库已存在，请勿重复创建\");\n            }\n        } else {\n            log.info(\"个人知识库不存在，用户: {}\", sysUserInfo.getCode());\n        }\n    }\n\n    @Override\n    public Result\u003cString\u003e checkPersonal(SysUserInfo sysUserInfo, boolean b) {\n        // 查询个人知识库是否存在\n        SaasKnowledgeContainer saasKnowledgeContainer \u003d findPersonalKnowledge(sysUserInfo);\n        if (saasKnowledgeContainer !\u003d null){\n            return Result.data(saasKnowledgeContainer.getCode());\n        }\n        return Result.data(null);",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 184
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/knowledge/impl/KnowledgeElementTableServiceImpl.java",
      "timestamp": 1761236769118,
      "startOffset": 1215,
      "endOffset": 6305,
      "codeContent": "infra.common.utils.SQLUtils;\nimport com.torchv.infra.rag.agent.model.SQLContextReq;\nimport com.torchv.repository.database.entity.BusinessColumn;\nimport com.torchv.repository.database.entity.BusinessDataSource;\nimport com.torchv.repository.database.entity.BusinessTable;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.stereotype.Service;\n\nimport java.util.*;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/8/19 20:57\n * @since torchv_server v1.7.10\n */\n@Slf4j\n@Service\n@AllArgsConstructor\npublic class KnowledgeElementTableServiceImpl implements KnowledgeElementTableService {\n    \n    final BusinessTableService businessTableService;\n    final BusinessColumnService businessColumnService;\n    final BusinessDatasourceDynamicService businessDatasourceDynamicService;\n    final BusinessDataSourceService businessDataSourceService;\n\n    @Override\n    public String buildTxt(List\u003cSQLContextReq\u003e contextReqList) {\n        if (CollUtil.isEmpty(contextReqList)) {\n            return StrUtil.EMPTY;\n        }\n        List\u003cString\u003e codes\u003dcontextReqList.stream().map(SQLContextReq::getCode).toList();\n        List\u003cBusinessTable\u003e tables \u003d businessTableService.listByCodes(codes);\n        if (CollUtil.isEmpty(tables)) {\n            return StrUtil.EMPTY;\n        }\n        Map\u003cString,List\u003cBusinessColumn\u003e\u003e tableColumnsMap\u003dbusinessColumnService.mapByTables(tables);\n        StringBuilder sb \u003d new StringBuilder();\n        for (BusinessTable table:tables){\n            // 更新contextReqList中的数据\n            for (SQLContextReq contextReq : contextReqList) {\n                if (StrUtil.equalsIgnoreCase(contextReq.getCode(), table.getCode())) {\n                    contextReq.setBusinessTable(table);\n                    break;\n                }\n            }\n            List\u003cBusinessColumn\u003e columns\u003dtableColumnsMap.getOrDefault(table.getCode(),List.of());\n            if (CollUtil.isEmpty(columns)){\n                continue;\n            }\n            sb.append(SQLUtils.toTxt(table, columns)).append(\"\\n\");\n        }\n        return sb.toString();\n    }\n\n    @Override\n    public String buildTxt(SQLContextReq contextReq) {\n        Optional\u003cBusinessTable\u003e businessTableOptional \u003d businessTableService.queryInfoByCode(contextReq.getTenantId(), contextReq.getCode());\n        if (businessTableOptional.isEmpty()) {\n            return StrUtil.EMPTY;\n        }\n        BusinessTable businessTable \u003d businessTableOptional.get();\n        contextReq.setBusinessTable(businessTable);\n        List\u003cBusinessColumn\u003e columns \u003d businessColumnService.listColumns(businessTable);\n        return SQLUtils.toTxt(businessTable, columns);\n    }\n    \n    @Override\n    public String runSql(SQLContextReq sqlContextReq) {\n        try {\n            Optional\u003cBusinessDataSource\u003e dataSourceOptional \u003d businessDataSourceService.queryInfoByCode(sqlContextReq.getBusinessTable().getBelongDs(), sqlContextReq.getTenantId());\n            if (dataSourceOptional.isEmpty()) {\n                return StrUtil.EMPTY;\n            }\n            BusinessDataSource dataSource \u003d dataSourceOptional.get();\n            // 这里大模型生成的SQL语句，有可能会存在多个SQL的情况，通过;进行分割，并且分批次执行获取总的结果\n            List\u003cString\u003e sqlCollections \u003d SQLUtils.extractSql(sqlContextReq.getSql());\n            StringBuilder resultBuilder \u003d new StringBuilder();\n            for (String sql : sqlCollections) {\n                if (StrUtil.isEmpty(sql)) {\n                    continue;\n                }\n                try{\n                    List\u003cMap\u003cString, Object\u003e\u003e maps \u003d businessDatasourceDynamicService.executeSql(dataSource.getId(), sql, 1, 100);\n                    // 拼装一个数据结果返回\n                    resultBuilder.append(SQLUtils.rowDataText(sql, maps)).append(\"\\n\");\n                }catch (Exception e){\n                    log.error(e.getMessage(),e);\n                }\n            }\n            //List\u003cMap\u003cString, Object\u003e\u003e maps \u003d businessDatasourceDynamicService.executeSql(dataSource.getId(), sqlContextReq.getSql(), 1, 100);\n            // 拼装一个数据结果返回\n            //return SQLUtils.rowDataText(sqlContextReq.getSql(), maps);\n            return resultBuilder.toString();\n        } catch (Exception e) {\n            log.error(e.getMessage(), e);\n        }\n        return StrUtil.EMPTY;\n    }\n\n    @Override\n    public String runSql(List\u003cSQLContextReq\u003e sqlContextReq) {\n        // 获取ds数据源\n        StringBuilder stringBuilder\u003dnew StringBuilder();\n        // 如果是一个数据源id，执行一次就够了\n        List\u003cString\u003e dsIds \u003d new ArrayList\u003c\u003e();\n        for (SQLContextReq contextReq : sqlContextReq) {\n            if (contextReq.getBusinessTable()\u003d\u003dnull || StrUtil.isEmpty(contextReq.getSql())){\n                continue;\n            }\n            if (dsIds.contains(contextReq.getBusinessTable().getBelongDs())){\n                // 已经执行过了\n                continue;\n            }\n            dsIds.add(contextReq.getBusinessTable().getBelongDs());\n\n            stringBuilder.append(runSql(contextReq));\n            stringBuilder.append(\"\\n\");\n        }\n        dsIds.clear();\n        return stringBuilder.toString()",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 121
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/kb/space/service/impl/SaasKnowledgeConfigElementServiceImpl.java",
      "timestamp": 1761236769257,
      "startOffset": 1129,
      "endOffset": 9511,
      "codeContent": "constant.enums.system.MessageCodeEnum;\nimport com.torchv.common.exception.BizException;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport com.torchv.kb.space.model.dto.SaasKnowledgeConfigElementResp;\nimport com.torchv.kb.space.model.vo.SaasKnowledgeConfigElementAddReq;\nimport com.torchv.kb.space.model.vo.SaasKnowledgeConfigElementQueryReq;\nimport com.torchv.kb.space.service.SaasKnowledgeConfigElementService;\nimport com.torchv.repository.kb.entity.SaasKnowledgeConfigElement;\nimport com.torchv.repository.kb.mapper.SaasKnowledgeConfigElementMapper;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.time.LocalDateTime;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Optional;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\n/**\n * 知识库配置表模块-业务Service实现\n * @since:torchv_server v1.8.9.2\n * @author \u003ca href\u003d\"mailto:yixiaoshu88@163.com\"\u003eyixiaoshu88@163.com\u003c/a\u003e\n * 2025/06/12 22:54\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class SaasKnowledgeConfigElementServiceImpl extends ServiceImpl\u003cSaasKnowledgeConfigElementMapper, SaasKnowledgeConfigElement\u003e implements SaasKnowledgeConfigElementService {\n    \n    final SaasKnowledgeConfigElementMapper saasKnowledgeConfigElementMapper;\n    \n    /**\n     * 分页查询-文件配置表列表数据\n     * @param saasKnowledgeBaseConfigQueryReq 查询条件Vo\n     * @param pageNo 当前页码\n     * @param pageSize 每页页码大小\n     * @return 知识库配置表列表\n     */\n    @Override\n    public Pagination\u003cSaasKnowledgeConfigElementResp\u003e list(SaasKnowledgeConfigElementQueryReq saasKnowledgeBaseConfigQueryReq, Integer pageNo, Integer pageSize) {\n        log.info(\"分页查询知识库配置表列表,pageNo:{},pageSize:{}\", pageNo, pageSize);\n        log.info(\"分页QueryReq:{}\", saasKnowledgeBaseConfigQueryReq.toString());\n        Page\u003cSaasKnowledgeConfigElement\u003e saasKnowledgeBaseConfigPageNo \u003d PageHelper.startPage(pageNo, pageSize);\n        SaasKnowledgeConfigElement queryModel \u003d new SaasKnowledgeConfigElement();\n        BeanUtils.copyProperties(saasKnowledgeBaseConfigQueryReq, queryModel);\n        QueryWrapper\u003cSaasKnowledgeConfigElement\u003e queryWrapper \u003d Wrappers.query(queryModel);\n        List\u003cSaasKnowledgeConfigElement\u003e saasKnowledgeBaseConfigInfos \u003d saasKnowledgeConfigElementMapper.selectList(queryWrapper);\n        List\u003cSaasKnowledgeConfigElementResp\u003e saasKnowledgeBaseConfigRespInfos \u003d new ArrayList\u003c\u003e();\n        long count \u003d saasKnowledgeBaseConfigPageNo.getTotal();\n        if (CollectionUtil.isNotEmpty(saasKnowledgeBaseConfigInfos)) {\n            saasKnowledgeBaseConfigRespInfos.addAll(saasKnowledgeBaseConfigInfos.stream().map(new SaasKnowledgeBaseConfigApplyFunction()).collect(Collectors.toList()));\n        }\n        return Pagination.pagination(saasKnowledgeBaseConfigRespInfos, count, pageNo, pageSize);\n    }\n    /**\n    * 查询所有知识库配置表数据\n    */\n    @Override\n    public List\u003cSaasKnowledgeConfigElementResp\u003e listAll() {\n        log.info(\"查询所有文件配置表数据\");\n        List\u003cSaasKnowledgeConfigElement\u003e saasKnowledgeBaseConfigInfos \u003d saasKnowledgeConfigElementMapper.selectList(Wrappers.query());\n        List\u003cSaasKnowledgeConfigElementResp\u003e saasKnowledgeBaseConfigRespInfos \u003d new ArrayList\u003c\u003e();\n        if (CollectionUtil.isNotEmpty(saasKnowledgeBaseConfigInfos)) {\n            saasKnowledgeBaseConfigRespInfos.addAll(saasKnowledgeBaseConfigInfos.stream().map(new SaasKnowledgeBaseConfigApplyFunction()).collect(Collectors.toList()));\n        }\n        return saasKnowledgeBaseConfigRespInfos;\n    }\n    \n    /**\n     * 查询所有文件配置表列表\n     * @param saasKnowledgeBaseConfigQueryReq 查询条件Vo\n     * @return 所有文件配置表列表\n     */\n    @Override\n    public Result\u003cList\u003cSaasKnowledgeConfigElementResp\u003e\u003e listAll(SaasKnowledgeConfigElementQueryReq saasKnowledgeBaseConfigQueryReq) {\n        log.info(\"根据条件查询所有文件配置表列表\");\n        log.info(\"QueryReq:{}\", saasKnowledgeBaseConfigQueryReq.toString());\n        SaasKnowledgeConfigElement queryModel \u003d new SaasKnowledgeConfigElement();\n        BeanUtils.copyProperties(saasKnowledgeBaseConfigQueryReq, queryModel);\n        QueryWrapper\u003cSaasKnowledgeConfigElement\u003e queryWrapper \u003d Wrappers.query(queryModel);\n        List\u003cSaasKnowledgeConfigElement\u003e saasKnowledgeBaseConfigInfos \u003d saasKnowledgeConfigElementMapper.selectList(queryWrapper);\n        List\u003cSaasKnowledgeConfigElementResp\u003e saasKnowledgeBaseConfigRespInfos \u003d new ArrayList\u003c\u003e();\n        if (CollectionUtil.isNotEmpty(saasKnowledgeBaseConfigInfos)) {\n            saasKnowledgeBaseConfigRespInfos.addAll(saasKnowledgeBaseConfigInfos.stream().map(new SaasKnowledgeBaseConfigApplyFunction()).collect(Collectors.toList()));\n        }\n        return Result.data(saasKnowledgeBaseConfigRespInfos);\n    }\n    \n    /**\n     * 新增文件配置表记录\n     * @param saasKnowledgeBaseConfigAddReq 新增文件配置表条件Vo\n     * @return 是否新增成功\n     */\n    @Transactional(rollbackFor \u003d Exception.class)\n    @Override\n    public Result\u003cString\u003e add(SaasKnowledgeConfigElementAddReq saasKnowledgeBaseConfigAddReq) {\n        log.info(\"新增文件配置表数据,Vo:{}\", saasKnowledgeBaseConfigAddReq.toString());\n        SaasKnowledgeConfigElement saasKnowledgeBaseConfig \u003d new SaasKnowledgeConfigElement();\n        BeanUtils.copyProperties(saasKnowledgeBaseConfigAddReq, saasKnowledgeBaseConfig);\n        saasKnowledgeBaseConfig.setCreateTime(LocalDateTime.now());\n        int ret \u003d saasKnowledgeConfigElementMapper.insert(saasKnowledgeBaseConfig);\n        return ret \u003e 0 ? Result.defaultSuccess(\"新增成功\") : Result.error(\"新增失败\");\n    }\n    \n    /**\n     * 根据id查询文件配置表详情\n     * @param id 文件配置表主键id\n     * @return 文件配置表详情\n     */\n    @Override\n    public Result\u003cSaasKnowledgeConfigElementResp\u003e queryById(Integer id) {\n        log.info(\"根据主键id查询文件配置表详情,Id:{}\", id);\n        SaasKnowledgeConfigElement saasKnowledgeBaseConfig \u003d saasKnowledgeConfigElementMapper.selectById(id);\n        Assert.notNull(saasKnowledgeBaseConfig, \"请求数据非法\");\n        SaasKnowledgeConfigElementResp saasKnowledgeBaseConfigResp \u003d new SaasKnowledgeConfigElementResp();\n        BeanUtils.copyProperties(saasKnowledgeBaseConfig, saasKnowledgeBaseConfigResp);\n        return Result.data(saasKnowledgeBaseConfigResp);\n    }\n    \n    /**\n     * 根据主键id批量删除文件配置表\n     * @param ids 批量删除主键id集合\n     * @return 是否删除成功\n     */\n    @Override\n    public Result\u003cString\u003e delete(List\u003cInteger\u003e ids) {\n        log.info(\"批量删除文件配置表,pageSize:{}\", CollectionUtil.size(ids));\n        int ret \u003d saasKnowledgeConfigElementMapper.deleteBatchIds(ids);\n        return ret \u003e 0 ? Result.defaultSuccess(\"删除成功\") : Result.error(\"删除失败\");\n    }\n    \n    /**\n     * 根据主键id删除文件配置表\n     * @param id 主键id\n     * @return 是否删除成功\n     */\n    @Override\n    public Result\u003cString\u003e delete(Integer id) {\n        log.info(\"根据主键id删除文件配置表,id:{}\", id);\n        SaasKnowledgeConfigElement saasKnowledgeBaseConfig \u003d saasKnowledgeConfigElementMapper.selectById(id);\n        Assert.notNull(saasKnowledgeBaseConfig, \"请求数据非法\");\n        int ret \u003d saasKnowledgeConfigElementMapper.deleteById(id);\n        return ret \u003e 0 ? Result.defaultSuccess(\"删除成功\") : Result.error(\"删除失败\");\n    }\n    \n    /**\n     * 根据id查询文件配置表实体详情\n     * @param id 主键id\n     * @return 文件配置表的Optional\n     */\n    @Override\n    public Optional\u003cSaasKnowledgeConfigElement\u003e queryInfoById(Integer id) {\n        log.info(\"根据请求id查询文件配置表实体详情,id:{}\", id);\n        SaasKnowledgeConfigElement saasKnowledgeBaseConfig \u003d saasKnowledgeConfigElementMapper.selectById(id);\n        if (saasKnowledgeBaseConfig !\u003d null) {\n            return Optional.of(saasKnowledgeBaseConfig);\n        }\n        return Optional.empty();\n    }\n    \n    /**\n     * 校验请求id是否非法\n     * @param id 主键id\n     * @return 是否存在\n     */\n    @Override\n    public boolean checkIdExists(Integer id) {\n        log.info(\"校验请求Id是否存在,id:{}\", id);\n        return saasKnowledgeConfigElementMapper.selectById(id) !\u003d null;\n    }\n    \n    @Override\n    public Result\u003cSaasKnowledgeConfigElementResp\u003e getByElementId(String elementId) {\n        \n        Optional\u003cSaasKnowledgeConfigElement\u003e one \u003d queryByElementId(elementId);\n        //Assert.isTrue(one.isPresent(), CustomerBizExceptionSupplier.instance(MessageCodeEnum.NOT_FOUND_RESOURCE));\n        if (one.isEmpty()) {\n            //return Result.error(\"未找到该文件配置表\");\n            throw new BizException(MessageCodeEnum.NOT_FOUND_RESOURCE",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 184
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/kb/space/service/impl/SaasKnowledgeContainerPermissionServiceImpl.java",
      "timestamp": 1761236769271,
      "startOffset": 1222,
      "endOffset": 10553,
      "codeContent": "DepartmentTypes;\nimport com.torchv.common.constant.kb.KbKnowledgeBaseContainerMemberTypes;\nimport com.torchv.common.constant.kb.KbKnowledgeBaseContainerPermissionTypes;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.kb.space.model.dto.SaasKnowledgeContainerPermissionResp;\nimport com.torchv.kb.space.model.request.KbKnowledgeBasePermissionReq;\nimport com.torchv.kb.space.model.vo.SaasKnowledgeContainerPermissionAddReq;\nimport com.torchv.kb.space.model.vo.SaasKnowledgeContainerPermissionQueryReq;\nimport com.torchv.kb.space.model.vo.SaasKnowledgeContainerPermissionUpdateReq;\nimport com.torchv.kb.space.service.SaasKnowledgeContainerPermissionService;\nimport com.torchv.repository.chat.dto.ElementSearchValueCondition;\nimport com.torchv.repository.chat.entity.SaasKnowledgeContainer;\nimport com.torchv.repository.chat.mapper.SaasKnowledgeContainerMapper;\nimport com.torchv.repository.chat.mapper.SaasKnowledgeElementMapper;\nimport com.torchv.repository.kb.department.dto.KbDepartmentUserTypeInfo;\nimport com.torchv.repository.kb.department.entity.KbDepartment;\nimport com.torchv.repository.kb.department.mapper.KbDepartmentMapper;\nimport com.torchv.repository.kb.department.mapper.KbDepartmentUserMapper;\nimport com.torchv.repository.kb.entity.SaasKnowledgeContainerPermission;\nimport com.torchv.repository.kb.mapper.SaasKnowledgeContainerPermissionMapper;\nimport com.torchv.repository.user.entity.SysUser;\nimport com.torchv.repository.user.mapper.SysUserMapper;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.time.LocalDateTime;\nimport java.util.*;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\n/**\n * 知识库容器权限模块-业务Service实现\n * @since torchv_server v1.8.9.2\n * @author \u003ca href\u003d\"mailto:yixiaoshu88@163.com\"\u003eyixiaoshu88@163.com\u003c/a\u003e\n * 2025/06/12 18:34\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class SaasKnowledgeContainerPermissionServiceImpl extends ServiceImpl\u003cSaasKnowledgeContainerPermissionMapper, SaasKnowledgeContainerPermission\u003e implements SaasKnowledgeContainerPermissionService {\n    \n    final SaasKnowledgeContainerPermissionMapper saasKnowledgeContainerPermissionMapper;\n    final KbDepartmentMapper kbDepartmentMapper;\n    final SaasKnowledgeContainerMapper saasKnowledgeContainerMapper;\n    final KbDepartmentUserMapper kbDepartmentUserMapper;\n    final SysUserMapper sysUserMapper;\n    final SaasKnowledgeElementMapper saasKnowledgeElementMapper;\n\n    @Override\n    public List\u003cString\u003e getDataIds(Map\u003cString, String\u003e stringStringMap, SysUserInfo sysUserInfo,List\u003cString\u003e permissionCodes) {\n        //过滤得到没有权限的知识库id\n        if (CollUtil.isEmpty(stringStringMap) || sysUserInfo\u003d\u003dnull){\n            return List.of();\n        }\n        List\u003cString\u003e containerIds\u003dnew ArrayList\u003c\u003e();\n        for (Map.Entry\u003cString,String\u003e entry:stringStringMap.entrySet()){\n            if (StrUtil.equalsIgnoreCase(KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode(),entry.getValue())){\n                containerIds.add(entry.getKey());\n            }\n        }\n        if (CollUtil.isEmpty(containerIds)){\n            return List.of();\n        }\n        ElementSearchValueCondition condition\u003d ElementSearchValueCondition.from(sysUserInfo.getTenantId(),containerIds,permissionCodes);\n        return saasKnowledgeElementMapper.listVisibleSearchCodes(condition);\n    }\n\n    @Override\n    public Map\u003cString,String\u003e getHighestPermissions(List\u003cString\u003e getContainerId, SysUserInfo sysUserInfo) {\n        LambdaQueryWrapper\u003cSaasKnowledgeContainerPermission\u003e lambdaQueryWrapperInfo \u003d new LambdaQueryWrapper\u003c\u003e();\n        lambdaQueryWrapperInfo.in(SaasKnowledgeContainerPermission::getContainerId, getContainerId);\n        List\u003cSaasKnowledgeContainerPermission\u003e permissionList \u003d this.list(lambdaQueryWrapperInfo);\n        // 做groupby\n        Map\u003cString,String\u003e result\u003dnew HashMap\u003c\u003e();\n        if (CollUtil.isNotEmpty(permissionList)){\n            Map\u003cString,List\u003cSaasKnowledgeContainerPermission\u003e\u003e mapPermission\u003d permissionList.stream().collect(Collectors.groupingBy(SaasKnowledgeContainerPermission::getContainerId));\n            for (String s:getContainerId){\n                List\u003cSaasKnowledgeContainerPermission\u003e r\u003dmapPermission.get(s);\n                if (CollUtil.isNotEmpty(r)){\n                    result.put(s,getHighestPermission(r,sysUserInfo));\n                }else{\n                    result.put(s,KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode());\n                }\n            }\n        }else{\n            for (String s:getContainerId){\n                result.put(s,KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode());\n            }\n        }\n        return result;\n    }\n\n    @Override\n    public String getHighestPermission(String getContainerId, SysUserInfo sysUserInfo) {\n        LambdaQueryWrapper\u003cSaasKnowledgeContainerPermission\u003e lambdaQueryWrapperInfo \u003d new LambdaQueryWrapper\u003c\u003e();\n        lambdaQueryWrapperInfo.eq(SaasKnowledgeContainerPermission::getContainerId, getContainerId);\n        List\u003cSaasKnowledgeContainerPermission\u003e permissionList \u003d this.list(lambdaQueryWrapperInfo);\n        return getHighestPermission(permissionList, sysUserInfo);\n    }\n\n    @Override\n    public String getHighestPermission(List\u003cSaasKnowledgeContainerPermission\u003e permissionList, SysUserInfo sysUserInfo) {\n        if (permissionList \u003d\u003d null || permissionList.isEmpty()) {\n            return KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode();\n        }\n        String currentUserCode \u003d sysUserInfo.getCode();\n        String tenantId \u003d sysUserInfo.getTenantId();\n        // 查询用户所在的列表\n        List\u003cKbDepartmentUserTypeInfo\u003e departmentUserTypeInfos\u003dkbDepartmentUserMapper.listDepartmentUsers(tenantId,currentUserCode);\n        // 获取用户的编码\n        List\u003cString\u003e teamCodes\u003dnew ArrayList\u003c\u003e();\n        // 获取组织的编码\n        List\u003cString\u003e organizationCodes \u003d new ArrayList\u003c\u003e();\n        if (CollUtil.isNotEmpty(departmentUserTypeInfos)){\n            for (KbDepartmentUserTypeInfo typeInfo:departmentUserTypeInfos){\n                if (StrUtil.equalsIgnoreCase(typeInfo.getType(), KbDepartmentTypes.TEAM.name())){\n                    teamCodes.add(typeInfo.getDepartmentCode());\n                }else{\n                    // 获取组织编码的fullPath\n                    organizationCodes.add(typeInfo.getFullPath());\n                }\n            }\n        }\n        return getHighestPermission(permissionList, organizationCodes, teamCodes, currentUserCode);\n    }\n\n    public String getHighestPermission(List\u003cSaasKnowledgeContainerPermission\u003e permissionList,List\u003cString\u003e organizationCodes, List\u003cString\u003e teamCodes,String currentUserCode){\n        if (permissionList \u003d\u003d null || permissionList.isEmpty()) {\n            return KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode();\n        }\n\n        // 定义权限优先级，数值越小优先级越高\n        Map\u003cString, Integer\u003e permissionPriority \u003d Map.of(\n                KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode(), 1,\n                KbKnowledgeBaseContainerPermissionTypes.EDIT.getCode(), 2,\n                KbKnowledgeBaseContainerPermissionTypes.VIEW_DOWNLOAD.getCode(), 3,\n                KbKnowledgeBaseContainerPermissionTypes.VIEW_ONLY.getCode(), 4);\n\n        String highestPermission \u003d KbKnowledgeBaseContainerPermissionTypes.NO_PERMISSION.getCode();\n        int highestPriority \u003d Integer.MAX_VALUE;\n\n        for (SaasKnowledgeContainerPermission permission : permissionList) {\n            String permissionType \u003d permission.getPermissionType();\n            String membershipType \u003d permission.getMembershipType();\n            String membershipCode \u003d permission.getMembershipCode();\n\n            boolean hasPermission \u003d false;\n\n            // 判断权限是否适用于当前用户\n            switch (membershipType) {\n                case \"USER\":\n                    // 如果是USER类型且membershipCode匹配当前用户\n                    hasPermission \u003d membershipCode.equalsIgnoreCase(currentUserCode);\n                    break;\n\n                case \"ORGANIZATION\":\n                    hasPermission\u003d organizationCodes.stream().anyMatch(s -\u003e StrUtil.contains(s, membershipCode));\n                    break;\n                case \"TEAM\":\n                    // 如果是ORGANIZATION或TEAM类型，检查当前用户是否属于该组织/团队\n                    hasPermission \u003d teamCodes.contains(membershipCode);\n                    break;\n\n                default:\n                    // 未知类型，跳过\n                    continue;\n            }\n\n            // 如果当前权限适用于用户，且优先级更高\n            if (hasPermission) {\n                Integer priority \u003d permissionPriority.get(permissionType);\n                if (priority !\u003d null \u0026\u0026 priority \u003c highestPriority) {\n                    highestPriority \u003d priority;\n                    highestPermission \u003d permissionType;\n\n                    // 如果已经是最高权限MANAGE，直接返回\n                    if (KbKnowledgeBaseContainerPermissionTypes.MANAGE.getCode().equals(permissionType)) {\n                        return permissionType;\n                    }\n                }\n            }\n        }\n        return highestPermission;\n    }",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 190
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/openapi/web/OpenApiTest.java",
      "timestamp": 1761236769337,
      "startOffset": 1501,
      "endOffset": 2197,
      "codeContent": "infra.rag.chain.model.ChainCompletionParameter;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.constant.ModelProviders;\nimport com.torchv.infra.rag.http.interceptor.JWTAuthorizationInterceptor;\nimport com.torchv.infra.rag.llm.model.completions.BotCompletionResponse;\nimport com.torchv.infra.rag.llm.model.completions.BotMessage;\nimport com.torchv.infra.rag.llm.model.completions.BotRole;\nimport com.torchv.infra.rag.llm.supplier.AbstractLLMSupplier;\nimport com.torchv.infra.rag.llm.supplier.chatglm.request.ChatGLMTurboCompletion;\nimport com.torchv.infra.rag.llm.supplier.chatglm.response.ChatGLMCompletionResponse;\nimport com.torchv.infra.web.spring.properties",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 11
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/openapi/web/OpenChatAppController.java",
      "timestamp": 1761236769344,
      "startOffset": 890,
      "endOffset": 4308,
      "codeContent": "pojo.OpenAppChatValidationResult;\nimport com.torchv.application.openapi.domain.completion.ChatAppApiV1Completion;\nimport com.torchv.application.openapi.model.req.ChatValidationReq;\nimport com.torchv.application.openapi.model.resp.ChatValidationResp;\nimport com.torchv.application.openapi.service.OpenAPIService;\nimport com.torchv.application.openapi.service.OpenAppService;\nimport com.torchv.application.store.domain.builder.AppChatContextBuilder;\nimport com.torchv.common.constant.ApiCodes;\nimport com.torchv.common.model.Result;\nimport com.torchv.infra.rag.agent.BotAgent;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.common.exception.ApiException;\nimport io.swagger.v3.oas.annotations.Operation;\nimport io.swagger.v3.oas.annotations.Parameter;\nimport io.swagger.v3.oas.annotations.enums.ParameterIn;\nimport io.swagger.v3.oas.annotations.tags.Tag;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport jakarta.validation.Valid;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.web.bind.annotation.*;\n\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/3/20 20:11\n * @since torchv_server v0.1-beta.1.6\n */\n@RestController\n@RequestMapping(\"/openapi/app/api/v1\")\n@AllArgsConstructor\n@Slf4j\n@Tag(name \u003d \"app应用对话\")\npublic class OpenChatAppController {\n    \n    final OpenAppService openAppService;\n    final OpenAPIService openAPIService;\n    final BotAgent botAgent;\n    final BillingSubscribeAccountService billingSubscribeAccountService;\n    final AppChatContextBuilder appChatContextBuilder;\n\n\n    \n    @Operation(summary \u003d \"对话前参数校验\")\n    @Parameter(name \u003d \"x-torchv-site\", description \u003d \"站点,固定值:api.torchv.com\", required \u003d true, in \u003d ParameterIn.HEADER)\n    @PostMapping(\"/chat/validations\")\n    public Result\u003cChatValidationResp\u003e check(@Valid @RequestBody ChatValidationReq req, HttpServletRequest request) {\n        log.info(\"chat开放接口,api:{},prompt:{}\", \"/openapi/app/api/v1/chat/validations\", req.getPrompt());\n        return openAppService.validation(req, request);\n    }\n    \n    /**\n     * 完成对话\n     * @param v1Completion 请求参数\n     * @param response 响应\n     */\n    @Operation(summary \u003d \"一键嵌入-chat对话\")\n    @Parameter(name \u003d \"x-torchv-site\", description \u003d \"站点,固定值:api.torchv.com\", required \u003d true, in \u003d ParameterIn.HEADER)\n    @PostMapping(\"/chat/completions\")\n    public Object completions(@RequestBody ChatAppApiV1Completion v1Completion, HttpServletRequest request, HttpServletResponse response) {\n        log.info(\"chat开放接口,api:{},fromIp:{},fromHeader:{}\", \"/openapi/app/api/v1/chat/completions\", JakartaServletUtil.getClientIP(request), JakartaServletUtil.getHeaderMap(request));\n        // 1. 校验请求参数\n        OpenAppChatValidationResult result \u003d openAppService.validationCompletion(v1Completion);\n        // 校验账户余额\n        String tenantId \u003d result.getAppInfo().getTenantId();\n        boolean ret \u003d billingSubscribeAccountService.validateAvailableAmount(tenantId);\n        Assert.isTrue(ret, ApiException.one(ApiCodes.InsufficientAccountBalance));\n        // 3. 组装请求参数并设置响应ContentType\n        openAPIService.contentType(true, response);\n        v1Completion.setUserId(openAppService.userId(request));\n        // 4. 构建对话上下文\n        ChainContext chainContext \u003d appChatContextBuilder.build(openAppService.buildDebugCompletion(v1Completion, result));\n        //",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 74
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/assistant/service/impl/EChartsDataServiceImpl.java",
      "timestamp": 1761236769393,
      "startOffset": 1176,
      "endOffset": 1352,
      "codeContent": "infra.rag.agent.BotAgent;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.llm.model.completions.BotCompletionResponse;\nimport com.torchv.infra",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 4
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/system/security/TokenWebConfiguration.java",
      "timestamp": 1761236769445,
      "startOffset": 779,
      "endOffset": 3069,
      "codeContent": "infra.interceptor.PaasAuthorizationInterceptor;\nimport com.torchv.infra.interceptor.PlatformLoginInterceptor;\nimport com.torchv.infra.interceptor.StoreAuthorizationInterceptor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.servlet.config.annotation.InterceptorRegistry;\nimport org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n\nimport java.util.ArrayList;\nimport java.util.List;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2023/8/23 22:52\n * @since knife4j-insight-plus\n */\n@Slf4j\n@Configuration\npublic class TokenWebConfiguration implements WebMvcConfigurer {\n\n    private List\u003cString\u003e excludeClientApi() {\n        List\u003cString\u003e excludes \u003d new ArrayList\u003c\u003e();\n        excludes.add(\"/client/api/auth/wechat/login\");\n        // xxl-job\n        excludes.add(\"/**/job/beat\");\n        excludes.add(\"/**/job/idleBeat\");\n        excludes.add(\"/**/job/run\");\n        excludes.add(\"/**/job/kill\");\n        excludes.add(\"/**/job/log\");\n        return excludes;\n    }\n\n    @Override\n    public void addInterceptors(InterceptorRegistry registry) {\n        List\u003cString\u003e excludeList \u003d new ArrayList\u003c\u003e();\n        excludeList.add(\"index.html\");\n        excludeList.add(\"/favicon.ico\");\n        excludeList.add(\"/swagger-resources/**\");\n        excludeList.add(\"/webjars/**\");\n        excludeList.add(\"/v2/**\");\n        excludeList.add(\"/**/v2/api-docs\");\n        excludeList.add(\"/swagger-ui.html/**\");\n        excludeList.add(\"/doc.html/**\");\n        excludeList.add(\"/error\");\n        excludeList.add(\"/**/health\");\n        excludeList.add(\"/**/mock/**\");\n        excludeList.add(\"/user/api/auth/login\");\n        excludeList.add(\"/user/api/auth/token\");\n        excludeList.add(\"/user/api/auth/apiToken\");\n        excludeList.add(\"/user/api/auth/loginAuto\");\n        excludeList.add(\"/user/api/auth/verifyCode\");\n        excludeList.add(\"/kb/page/getPageContentFast\");\n        excludeList.add(\"/kl/api/saas/element/queryContentByCode\");\n        excludeList.add(\"/kl/api/saas/element/getEncryptCode\");\n        excludeList.add(\"/kl/api/saas/element/getDecryptCode\");\n        // 开放平台\n        excludeList.add(\"/openapi/**\");\n        // license\n        excludeList.add(\"/kb/license",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 59
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/billing/web/BillingMessageController.java",
      "timestamp": 1761236769450,
      "startOffset": 987,
      "endOffset": 1438,
      "codeContent": "infra.common.external.queue.RabbitMessageService;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.utils.GsonUtils;\nimport com.torchv.infra.rag.chain.model.billing.BillingDetailOrder;\nimport com.torchv.infra.rag.chain.model.billing.BillingMessageBody;\nimport com.torchv.infra.rag.constant.BillingProcessTypes;\nimport com.torchv.infra.rag.constant.BillingTypes;\nimport com.torchv.infra.rag.constant.LLMModels;\nimport com.torchv.infra.web",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 9
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/builder/InnerWebChatV1ContextBuilder.java",
      "timestamp": 1761236769530,
      "startOffset": 1343,
      "endOffset": 5227,
      "codeContent": "infra.rag.chain.context.ContextBuilder;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.chain.model.ChainRequest;\nimport com.torchv.infra.rag.constant.AgentPromptSteps;\nimport com.torchv.infra.rag.constant.LLMDispatchers;\nimport com.torchv.kb.space.service.SaasKnowledgeContainerPermissionService;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.jetbrains.annotations.NotNull;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\nimport java.util.Map;\n\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/4/21 12:07\n * @since torchv_server v1.7.2\n */\n@Slf4j\n@AllArgsConstructor\n@Component(\"innerWebChatV1ContextBuilder\")\npublic class InnerWebChatV1ContextBuilder implements ContextBuilder\u003cInnerWebChatV1Completion\u003e {\n\n    final ChatPromptService chatPromptService;\n    final ChatIntegrationService chatIntegrationService;\n    final KnowledgeEmbeddingChangeService knowledgeEmbeddingChangeService;\n    final KbDepartmentUserService kbDepartmentUserService;\n    final SaasKnowledgeContainerPermissionService saasKnowledgeContainerPermissionService;\n    @Override\n    public ChainContext build(InnerWebChatV1Completion completion) {\n        log.info(\"构建内部web(V1版本)对话上下文\");\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        PromptInfoResp promptInfoResp \u003d completion.promptConfig();\n        ChainContext chainContext \u003d new ChainContext();\n        chainContext.setTenantId(sysUserInfo.getTenantId());\n        chainContext.setUserId(sysUserInfo.getCode());\n        // 构建请求对象\n        ChainRequest chainRequest \u003d getChainRequest(completion);\n        // 查询权限编码,并且透传进行查询控制\n        DepartmentUserOrgPermissions userOrgPermissions\u003dkbDepartmentUserService.listAccessibleDepartmentCodes(sysUserInfo);\n        // set\n        chainRequest.setPermissionCodes(userOrgPermissions.permissionCodesToList());\n        // 设置系统的Prompt\n        //String currentTime \u003d DateUtil.format(LocalDateTime.now(), \"yyyy-MM-dd HH:mm:ss E\");\n        //String sysPrompt \u003d StrUtil.format(PromptSystemTemplates.SYSTEM_RAG, currentTime);\n        // 设置系统的Prompt\n        //chainRequest.setSystemPrompt(PromptSystemTemplates.SYSTEM_RAG_V1);\n        //设置添加系统prompt  读取全局配置\n        PromptInfoResp info \u003d chatPromptService.queryPrompt(sysUserInfo.getTenantId());\n        chainContext.getPrompts().addPrompt(AgentPromptSteps.SYSTEM,info.getSystemPrompt());\n        chainContext.setChatRequest(chainRequest);\n        // 是否开启turbo+RAG搜索\n        chainContext.getSearchContext().setTurbo(completion.isTurbo());\n        chainContext.getSearchContext().setRagSearch(completion.isRagSearch());\n        chainContext.getSearchContext().setSearchTopK(completion.getTopK());\n        chainContext.getSearchContext().setRrf(completion.isRrf());\n        if (completion.isChatDebug()){\n            // 是知识的问答调试\n            chainContext.getSearchContext().setEnableReRanker(completion.getUseReranker());\n            // 设置reranker的模型\n            chainContext.getSearchContext().setRankerModelName(completion.getRankerModelName());\n        }\n        // 判断知识库的id类型\n        if (CollUtil.isNotEmpty(completion.getContainerId())){\n            // 设置embedding得名称\n            chainContext.getSearchContext().applyEmbeddingModel(knowledgeEmbeddingChangeService.checkKnowledgeConsistency(completion.getContainerId()));\n            // 要对知识库id鉴权\n            Map\u003cString,String\u003e stringStringMap\u003dsaasKnowledgeContainerPermissionService.getHighestPermissions(completion.getContainerId(),sysUserInfo);\n            // 如果我不在知识库里面，那么要把不在知识库里面的dataId查询出来\n            List\u003cString\u003e  dataIds\u003dsaasKnowledgeContainerPermissionService.getDataIds(stringStringMap,sysUserInfo,chainRequest.getPermissionCodes());\n            if (CollUtil.isNotEmpty(dataIds)){\n                chainContext.getChatRequest().setDataIds(dataIds);\n            }",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 75
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/openapi/domain/builder/OpenApiCommunityContextBuilder.java",
      "timestamp": 1761236769631,
      "startOffset": 1734,
      "endOffset": 1958,
      "codeContent": "infra.rag.chain.context.ContextBuilder;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.chain.model.ChainRequest;\nimport com.torchv.infra.rag.constant.LLMDispatchers;\nimport com.torchv.infra",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 5
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/openapi/domain/builder/EmbedStoreChatContextBuilder.java",
      "timestamp": 1761236769626,
      "startOffset": 1605,
      "endOffset": 1884,
      "codeContent": "infra.rag.chain.context.ContextBuilder;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.chain.model.ChainRequest;\nimport com.torchv.infra.rag.constant.AgentPromptSteps;\nimport com.torchv.infra.rag.constant.LLMDispatchers;\nimport com.torchv.infra",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 6
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/openapi/domain/builder/EmbedChatContextBuilder.java",
      "timestamp": 1761236769616,
      "startOffset": 837,
      "endOffset": 7723,
      "codeContent": "knowledge.model.response.chat.ChatIntegration;\nimport com.torchv.application.knowledge.service.ChatIntegrationService;\nimport com.torchv.application.openapi.domain.completion.ChatAppApiV1Completion;\nimport com.torchv.application.openapi.domain.pojo.OpenAppChatValidationResult;\nimport com.torchv.application.knowledge.domain.completion.EmbedChatCompletion;\nimport com.torchv.application.knowledge.model.dto.PromptInfoResp;\nimport com.torchv.application.store.domain.completion.LiteAgentContextCompletion;\nimport com.torchv.application.store.model.dto.AppSettingsResp;\nimport com.torchv.application.store.service.AppContainerService;\nimport com.torchv.application.store.service.AppSettingsService;\nimport com.torchv.common.constant.AppTypes;\nimport com.torchv.common.constant.Platforms;\nimport com.torchv.common.constant.llm.AgentIntegrations;\nimport com.torchv.common.extra.filter.ThreadLocalHolder;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.kb.space.service.KnowledgeEmbeddingChangeService;\nimport com.torchv.infra.rag.chain.context.ContextBuilder;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.chain.model.ChainRequest;\nimport com.torchv.infra.rag.constant.AgentPromptSteps;\nimport com.torchv.infra.rag.constant.LLMDispatchers;\nimport com.torchv.infra.rag.llm.prompt.builder.LiteAgentContextPromptBuilder;\nimport com.torchv.repository.store.entity.AppInfo;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.stereotype.Component;\n\nimport java.util.List;\n\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/5/29 14:19\n * @since torchv_server v1.7.5\n */\n@Slf4j\n@AllArgsConstructor\n@Component(\"embedChatContextBuilder\")\npublic class EmbedChatContextBuilder implements ContextBuilder\u003cEmbedChatCompletion\u003e {\n    \n    final AppContainerService appContainerService;\n    final KnowledgeEmbeddingChangeService knowledgeEmbeddingChangeService;\n    final AppSettingsService appSettingsService;\n    final ChatIntegrationService chatIntegrationService;\n\n    @Override\n    public ChainContext build(EmbedChatCompletion completion) {\n        ChatAppApiV1Completion v1Completion \u003d completion.getCompletion();\n        OpenAppChatValidationResult result \u003d completion.getResult();\n        String tenantId \u003d result.getAppInfo().getTenantId();\n\n        ChainContext chainContext \u003d new ChainContext();\n        chainContext.setTenantId(tenantId);\n        if (StrUtil.isNotBlank(v1Completion.getUserId())) {\n            chainContext.setUserId(v1Completion.getUserId());\n        } else {\n            String signUser \u003d MD5.create().digestHex(result.getAppInfo().getTenantId());\n            chainContext.setUserId(StrUtil.hide(MD5.create().digestHex(signUser), 5, 26));\n        }\n        // 复制给LocalContext上下文,在UserContextHolder中使用\n        ThreadLocalHolder.setUser(SysUserInfo.webClient(chainContext.getUserId(), tenantId));\n\n        ChainRequest chainRequest \u003d new ChainRequest();\n        chainRequest.setMessageId(v1Completion.getMessageId());\n        chainRequest.setPlatform(Platforms.API);\n        // 是openapi接口\n        // chainRequest.setOpenapi(true);\n        if (StrUtil.isNotBlank(v1Completion.getPrompt())) {\n            chainRequest.setQuestion(v1Completion.getPrompt());\n            chainRequest.setReviseQuestion(v1Completion.getPrompt());\n        }\n        AppInfo appInfo \u003d result.getAppInfo();\n        AppTypes appTypes \u003d AppTypes.ofDefault(appInfo.getCategory());\n        chainRequest.setAppTypes(appTypes);\n        if (appTypes \u003d\u003d AppTypes.LITE_AGENT) {\n            // 如果是轻量级Agent，那么query和prompt需要处理\n            log.info(\"setting-prompt:{}\",result.getSettings().getPrompt());\n            String prompt \u003d new LiteAgentContextPromptBuilder().build(LiteAgentContextCompletion.builder().question(v1Completion.getPrompt()).prompt(result.getSettings().getPrompt()).build());\n            log.info(\"lite-agent-prompt:{}\",prompt);\n            chainRequest.setPrompt(prompt);\n            // 轻量级Agent，不搜索知识库\n            chainContext.getSearchContext().setRagSearch(false);\n            chainContext.getSearchContext().setEnableEmbedding(false);\n            // 禁用reranker\n            chainContext.getSearchContext().setEnableReRanker(false);\n        } else {\n            chainRequest.setPrompt(result.getSettings().getPrompt());\n            // 设置知识库id\n            List\u003cString\u003e containerIds \u003d appContainerService.listContainers(result.getAppInfo());\n            log.info(\"containerIds-size:{}\", CollUtil.size(containerIds));\n            chainRequest.setContainerId(containerIds);\n            if (CollUtil.isEmpty(containerIds)){\n                // 没有知识库，不能使用RAG\n                chainContext.getSearchContext().setRagSearch(false);\n                chainContext.getSearchContext().setEnableEmbedding(false);\n                // 禁用reranker\n                chainContext.getSearchContext().setEnableReRanker(false);\n            }else{\n                // 设置embedding的模型\n                chainContext.getSearchContext().applyEmbeddingModel(knowledgeEmbeddingChangeService.checkKnowledgeConsistency(containerIds));\n            }\n            // 如果是chatBot类型，需要赋予prompt\n            AppSettingsResp appSettingsResp \u003d appSettingsService.querySettingsByAppId(appInfo.getAppid(),tenantId,AppTypes.of(appInfo.getCategory()));\n            // 设置添加prompt\n            chainContext.getPrompts().addPrompt(AgentPromptSteps.SYSTEM,appSettingsResp.getSystemPrompt());\n            chainContext.getPrompts().addPrompt(AgentPromptSteps.REWRITE,appSettingsResp.getRewritePrompt());\n            chainContext.getPrompts().addPrompt(AgentPromptSteps.SUB_QUERY,appSettingsResp.getSubQueryPrompt());\n        }\n        // 设置应用的appid\n        chainRequest.setAppId(appInfo.getAppid());\n        chainRequest.setStream(true);\n        chainRequest.setEncode(false);\n        chainRequest.setStatus(false);\n        // 设置app是否为多轮对话，根据配置文件\n        chainRequest.setMultipleDialog(result.getSettings().getConfigObject().roundSessionChat());\n        chainRequest.setConversationId(v1Completion.getConversationId());\n        chainContext.setChatRequest(chainRequest);\n        PromptInfoResp settings \u003d result.getSettings();\n        chainContext.getLlmContext().setLlmConfig(settings);\n        chainContext.getSearchContext().applySettings(settings);\n        // 设置大模型的类别\n        chainContext.getLlmContext().setDispatcherType(LLMDispatchers.getLLMDispatcher(settings.getConfigObject().getLlmDispatcherName()));\n        chainContext.getLlmContext().setModel(settings.getConfigObject().getModelName());\n        // 账户可用，不用再次验证了\n        chainContext.getBillingCounter().setAccountAvailable(true);\n        // 设置是否开启Turbo+RAG搜索\n        List\u003cChatIntegration\u003e chatIntegrations\u003d List.of(ChatIntegration.from(AgentIntegrations.INNER_INTENT));\n        chatIntegrationService.applyIntegrationSettings(chainContext, chatIntegrations",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 127
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/openapi/domain/builder/OpenApiContextBuilder.java",
      "timestamp": 1761236769609,
      "startOffset": 1619,
      "endOffset": 1843,
      "codeContent": "infra.rag.chain.context.ContextBuilder;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.chain.model.ChainRequest;\nimport com.torchv.infra.rag.constant.LLMDispatchers;\nimport com.torchv.infra",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 5
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/kb/common/service/message/DepartmentImportMessageHandler.java",
      "timestamp": 1761236769595,
      "startOffset": 2231,
      "endOffset": 50172,
      "codeContent": "infra.vector.VectorIndexDelegate;\nimport com.torchv.repository.kb.department.entity.KbDepartment;\nimport com.torchv.repository.kb.department.entity.KbDepartmentUser;\nimport com.torchv.repository.kb.department.mapper.KbDepartmentMapper;\nimport com.torchv.repository.kb.department.mapper.KbDepartmentUserMapper;\nimport com.torchv.repository.kb.system.entity.KbAsyncTasksStatus;\nimport com.torchv.repository.kb.system.mapper.KbAsyncTasksStatusMapper;\nimport com.torchv.repository.kb.thirdPartImport.entity.KbThirdPartImportConfig;\nimport com.torchv.repository.kb.thirdPartImport.mapper.KbThirdPartImportConfigMapper;\nimport com.torchv.repository.user.entity.SysUser;\nimport com.torchv.repository.user.mapper.SysUserMapper;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.commons.lang3.StringUtils;\nimport org.springframework.beans.BeanUtils;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.stereotype.Component;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.time.LocalDateTime;\nimport java.util.*;\nimport java.util.concurrent.TimeUnit;\nimport java.util.stream.Collectors;\n\n/**\n * 描述\n *\n * @author liuchuan\u003ca href \u003d \" lanhaichen2021 @ gmail.com \"\u003elanhaichen2021@gmail.com\u003c/a\u003e\n * 12/28/24 15:24\n * @since torchv_server vkb-v 0.0.1\n */\n@Slf4j\n@Component\n@AllArgsConstructor\npublic class DepartmentImportMessageHandler implements KbEventMessageHandler {\n\n    final KbDepartmentUserMapper kbDepartmentUserMapper;\n    final SysUserMapper sysUserMapper;\n    final UserService userService;\n    final MaterialService materialService;\n    final VectorIndexDelegate vectorIndexDelegate;\n    final KbDepartmentMapper kbDepartmentMapper;\n    final KbAsyncTasksStatusMapper kbAsyncTasksStatusMapper;\n    final KbThirdPartImportConfigMapper kbThirdPartImportConfigMapper;\n    final RedisTemplate\u003cString, String\u003e redisTemplate;\n    // 钉钉客户端限流器\n    private static final RateLimiter subDepClientRateLimiter \u003d RateLimiter.create(20.0);\n    private static final RateLimiter userClientRateLimiter \u003d RateLimiter.create(20.0);\n    private static final RateLimiter depInfoClientRateLimiter \u003d RateLimiter.create(20.0);\n\n    /**\n     * 更新导入进度\n     *\n     * @param taskId  任务ID\n     * @param step    当前步骤\n     * @param message 进度消息\n     */\n    private void updateProgress(String taskId, int step, String message) {\n        if (StringUtils.isBlank(taskId)) {\n            return;\n        }\n        String key \u003d Cns.IMPORT_PROGRESS_KEY_PREFIX + taskId;\n        // 计算百分比\n        int percentage \u003d Math.min(step, 100);\n        String progressInfo \u003d percentage + \":\" + message;\n        // 设置10分钟过期\n        redisTemplate.opsForValue().set(key, progressInfo, 10, TimeUnit.MINUTES);\n    }\n\n    @Override\n    public boolean handle(KbEventMessageCallbackDTO message) {\n        log.info(\"收到第三方导入组织架构消息:{}\", message);\n        DepartmentThirdPartImportMessage depMessage \u003d message.parseObject(DepartmentThirdPartImportMessage.class);\n        String tenantId \u003d depMessage.getTenantId();\n        String currentUserId \u003d depMessage.getUserId();\n        String thirdPartId \u003d depMessage.getThirdPartId();\n        String thirdPartSecret \u003d depMessage.getThirdPartSecret();\n        String taskId \u003d depMessage.getTaskId();\n\n        // 更新任务处理状态\n        updateTaskStatus(taskId, KbAsyncTasksStatusTypes.IN_PROGRESS, currentUserId);\n\n        boolean isNotSave \u003d true;\n        try {\n            switch (Objects.requireNonNull(Platforms.of(depMessage.getThirdPartPlatformName()))) {\n                case DING_TALK -\u003e {\n                    updateDingTalk(tenantId, currentUserId, thirdPartId, thirdPartSecret, taskId);\n                }\n                // 发送前已拦截\n                case LARK, QY_WECHAT -\u003e {\n                    return true;\n                }\n            }\n        } catch (Exception e) {\n            log.error(\"导入组织架构失败:{}\", e.getMessage(), e);\n            updateProgress(taskId, -1, \"任务执行失败\");\n            updateTaskStatus(taskId, KbAsyncTasksStatusTypes.FAILED, currentUserId);\n            isNotSave \u003d false;\n        } finally {\n            if (isNotSave) {\n                // 确保任务状态被正确更新，增加重试机制\n                markTaskAsCompleted(taskId, currentUserId);\n            }\n        }\n        return true;\n    }\n\n    /**\n     * 钉钉导入组织架构\n     *\n     * @param id\n     * @param secret\n     */\n    public void importDingTalk(String tenantId, String currentUserId, String id, String secret, String taskId, DingTalkExportInfoDTO remoteInfo) {\n        log.info(\"钉钉导入组织架构\");\n\n        // 1. 从钉钉获取所有信息\n        if (remoteInfo \u003d\u003d null) {\n            updateProgress(taskId, 10, \"正在获取钉钉数据\");\n            remoteInfo \u003d getDingTalkInfo(tenantId, currentUserId, id, secret, taskId);\n        }\n        updateProgress(taskId, 30, \"钉钉数据获取完成\");\n        ArrayList\u003cKbDepartment\u003e kbDepartmentList \u003d remoteInfo.getKbDepartmentList();\n        ArrayList\u003cKbDepartmentUser\u003e kbDepartmentUserList \u003d remoteInfo.getKbDepartmentUserList();\n        ArrayList\u003cSysUser\u003e sysUserList \u003d remoteInfo.getSysUserList();\n\n        // 2. 保存数据\n        saveImportData(tenantId, currentUserId, taskId, kbDepartmentList, kbDepartmentUserList, sysUserList);\n    }\n//\n//    private void saveUser2ES(SysUser kbUser, Map\u003cString, KbDepartment\u003e searchMap, String tenantId) {\n//        log.info(\"触发保存用户到ES:{}\", kbUser.getCode());\n//        // 准备event对象\n//        List\u003cString\u003e departmentNoList \u003d kbUser.toDepartmentNoList().stream().distinct().toList();\n//        UserCreateIndexEvent createEvent \u003d UserCreateIndexEvent.of(kbUser, departmentNoList);\n//        DataSetReference dataSetReference \u003d new DataSetReference();\n//\n//        // 用户没有知识空间\n//        dataSetReference.setContainerId(\"0\");\n//        dataSetReference.setDataId(createEvent.getUserCode());\n//        dataSetReference.setContent(createEvent.getUserName());\n//        dataSetReference.setCategory(DataSetReferenceType.user.getName());\n//        // 元数据\n//        Map\u003cString, Object\u003e meta \u003d createEvent.getMetadata().metaMap();\n//        String departmentName \u003d \" - \";\n//        // 一个人员属于多个部门，要得到每个部门的全路径，如： liuchuan的测试企业 \u003e 销售部,liuchuan的测试企业 \u003e 销售部 \u003e 2组,浙江XXX股份有限公司 \u003e 研发中心\n//        if (CollUtil.isNotEmpty(departmentNoList)) {\n//            // 遍历每个所属部门\n//            List\u003cString\u003e totalName \u003d new ArrayList\u003c\u003e();\n//            for (String s : departmentNoList) {\n//                if (StrUtil.isBlank(s))\n//                    continue;\n//                // 获取当前部门的全路径\n//                List\u003cString\u003e depNameList \u003d new ArrayList\u003c\u003e();\n//                // 获取当前部门的父部门名称\n//                // 情况 1. 用户的部门属于当前组织树，从加速Map获取。 2. 用户的部门属于其他组织树（跨组织用户），从DB获取。\n//                if (searchMap.containsKey(s)) {\n//\n//                    while (!Objects.equals(searchMap.get(s).getPid(), \"0\")) {\n//                        depNameList.add(0, searchMap.get(s).getName());\n//                        s \u003d searchMap.get(s).getPid();\n//                    }\n//                    depNameList.add(0, searchMap.get(s).getName());\n//                } else {\n//                    // 从DB获取\n//                    KbDepartment dbDepartment \u003d kbDepartmentMapper.selectOne(Wrappers.\u003cKbDepartment\u003elambdaQuery()\n//                            .eq(KbDepartment::getTenantId, tenantId)\n//                            .eq(KbDepartment::getCode, s));\n//                    if (dbDepartment \u003d\u003d null) {\n//                        continue;\n//                    }\n//                    List\u003cString\u003e fullPath \u003d StrUtil.split(dbDepartment.getFullPath(), \",\");\n//                    String pid \u003d dbDepartment.getPid();\n//                    if (pid.equals(\"0\")) {\n//                        depNameList.add(dbDepartment.getName());\n//                    } else {\n//                        // 获取fullPath上所有部门\n//                        Map\u003cString, String\u003e DepIdName \u003d kbDepartmentMapper.selectList(Wrappers.\u003cKbDepartment\u003elambdaQuery().eq(KbDepartment::getTenantId, tenantId).in(KbDepartment::getCode, fullPath))\n//                                .stream().collect(Collectors.toMap(KbDepartment::getCode, KbDepartment::getName));\n//                        for (String string : fullPath) {\n//                            String depName \u003d DepIdName.getOrDefault(string, null);\n//                            if (depName !\u003d null) {\n//                                depNameList.add(depName);\n//                            }\n//                        }\n//                    }\n//                }\n//\n//                totalName.add(StrUtil.join(\" \u003e \", depNameList));\n//            }\n//            departmentName \u003d StrUtil.join(\",\", totalName);\n//        }\n//        log.info(\"用户code:{},departmentName:{}\", kbUser.getCode(), departmentName);\n//        // 重置部门名称\n//        meta.put(\"departmentName\", departmentName);\n//        dataSetReference.setMetadata(meta);\n//        dataSetReference.setPage(1);\n//        dataSetReference.genId();\n//        vectorIndexDelegate.saveReferences(List.of(dataSetReference), kbUser.getTenantId());\n//        log.info(\"完成保存用户到ES:{}\", kbUser.getCode());\n//    }\n\n    /**\n     * 钉钉导入组织架构\n     *\n     * @param id\n     * @param secret\n     */\n    public void updateDingTalk(String tenantId, String currentUserId, String id, String secret, String taskId) {\n        log.info(\"钉钉更新组织架构\");\n\n        // 1. 获取远端信息（钉钉）\n        DingTalkExportInfoDTO remoteDingTalkInfo \u003d getDingTalkInfo(tenantId, currentUserId, id, secret, taskId);\n        updateProgress(taskId, 20, \"远端数据获取完成\");\n\n        // 2. 获取本地信息\n        DingTalkExportInfoDTO localDingTalkInfo \u003d getLocalDingTalkInfo(tenantId);\n        updateProgress(taskId, 25, \"本地数据获取完成\");\n\n        // 3. 检查根部门是否被修改，若被修改则新建企业\n        KbDepartment remoteRootDept \u003d remoteDingTalkInfo.getKbDepartmentList().stream()\n                .filter(dept -\u003e \"0\".equals(dept.getPid()))\n                .findFirst()\n                .orElseThrow(() -\u003e new RuntimeException(\"远程数据中未找到根部门\"));\n\n        // 获取所有本地根部门\n        List\u003cKbDepartment\u003e localRootDepts \u003d localDingTalkInfo.getKbDepartmentList().stream()\n                .filter(dept -\u003e \"0\".equals(dept.getPid()))\n                .toList();\n\n        // 重新导入新组织\n        if (localRootDepts.stream().noneMatch(dept -\u003e dept.getName().equals(remoteRootDept.getName()))) {\n            log.info(\"远程根部门[{}]不存在于本地根部门中，执行重新导入\", remoteRootDept.getName());\n            importDingTalk(tenantId, currentUserId, id, secret, taskId, remoteDingTalkInfo);\n            return;\n        }\n\n        updateProgress(taskId, 30, \"开始处理组织架构数据\");\n\n        // 4. 找到匹配的本地根部门，收集需要保留的部门code\n        log.info(\"开始筛选目标组织树\");\n        KbDepartment targetLocalRoot \u003d localRootDepts.stream()\n                .filter(dept -\u003e dept.getName().equals(remoteRootDept.getName()))\n                .findFirst()\n                .orElseThrow(() -\u003e new RuntimeException(\"未找到匹配的本地根部门\"));\n\n        // 收集目标组织树的所有部门code\n        Set\u003cString\u003e retainedDeptCodes \u003d new HashSet\u003c\u003e();\n        collectDepartmentCodes(targetLocalRoot.getCode(), localDingTalkInfo.getKbDepartmentList(), retainedDeptCodes);\n\n        // 5. 更新localDingTalkInfo，只保留目标组织树\n        updateProgress(taskId, 40, \"筛选目标组织树完成\");\n        log.info(\"开始清理其他组织树数据\");\n\n        // 5.1 仅保留要更新的组织部门\n        ArrayList\u003cKbDepartment\u003e filteredDepts \u003d localDingTalkInfo.getKbDepartmentList().stream()\n                .filter(dept -\u003e retainedDeptCodes.contains(dept.getCode()))\n                .collect(Collectors.toCollection(ArrayList::new));\n        localDingTalkInfo.setKbDepartmentList(filteredDepts);\n\n        // 5.2 仅保留要更新的部门用户关系列表\n        ArrayList\u003cKbDepartmentUser\u003e filteredRelations \u003d localDingTalkInfo.getKbDepartmentUserList().stream()\n                .filter(relation -\u003e retainedDeptCodes.contains(relation.getDepartmentCode()))\n                .collect(Collectors.toCollection(ArrayList::new));\n        localDingTalkInfo.setKbDepartmentUserList(filteredRelations);\n\n        // 允许跨组织用户存在，不重复创建\n        // // 5.3 更新用户列表（只保留在过滤后的关系中的用户）\n        // Set\u003cString\u003e retainedUserCodes \u003d filteredRelations.stream()\n        // .map(KbDepartmentUser::getUserCode)\n        // .collect(Collectors.toSet());\n        // ArrayList\u003cKbUser\u003e filteredUsers \u003d localDingTalkInfo.getKbUserList().stream()\n        // .filter(user -\u003e retainedUserCodes.contains(user.getCode()))\n        // .collect(Collectors.toCollection(ArrayList::new));\n        // localDingTalkInfo.setKbUserList(filteredUsers);\n        //\n        // // 5.4 更新系统用户列表\n        // ArrayList\u003cSysUser\u003e filteredSysUsers \u003d localDingTalkInfo.getSysUserList().stream()\n        // .filter(user -\u003e retainedUserCodes.contains(user.getCode()))\n        // .collect(Collectors.toCollection(ArrayList::new));\n        // localDingTalkInfo.setSysUserList(filteredSysUsers);\n\n        updateProgress(taskId, 50, \"本地组织树筛选完成\");\n\n        // 6. 处理所有数据库操作\n        processUpdateInTransaction(tenantId, currentUserId, taskId, remoteDingTalkInfo, localDingTalkInfo);\n        updateProgress(taskId, 100, \"更新完成\");\n    }\n\n    /**\n     * 同步远端人员信息，将远端的用户信息覆盖本地用户信息，但保留本地的用户编码\n     *\n     * @param remoteInfo    远端信息\n     * @param localInfo     本地信息\n     * @param tenantId      租户ID\n     * @param currentUserId 当前用户ID\n     */\n    private void syncRemoteUserInfo(DingTalkExportInfoDTO remoteInfo, DingTalkExportInfoDTO localInfo,\n            String tenantId, String currentUserId) {\n        log.info(\"开始同步远端人员信息\");\n\n        // 构建部门Map，用于后续查找\n        Map\u003cString, KbDepartment\u003e searchMap \u003d localInfo.getKbDepartmentList().stream()\n                .collect(Collectors.toMap(KbDepartment::getCode, s -\u003e s));\n\n        // 存储需要更新的用户列表\n        List\u003cSysUser\u003e usersToUpdate \u003d new ArrayList\u003c\u003e();\n\n        // 遍历所有远端用户\n        for (SysUser remoteUser : remoteInfo.getSysUserList()) {\n            String remoteUserTel \u003d remoteUser.getTel();\n            // 查找本地是否存在相同手机号的用户\n            SysUser existingUser \u003d localInfo.getSysUserList().stream()\n                    .filter(u -\u003e u.getTel().equals(remoteUserTel))\n                    .findFirst()\n                    .orElse(null);\n            if (existingUser !\u003d null) {\n                String localUserCode \u003d existingUser.getCode();\n                Long localUserId \u003d existingUser.getId();\n                BeanUtils.copyProperties(remoteUser, existingUser);\n                existingUser.setCode(localUserCode);\n                existingUser.setId(localUserId);\n                existingUser.setModifier(currentUserId);\n                existingUser.setModifierTime(LocalDateTime.now());\n                usersToUpdate.add(existingUser);\n            }\n        }\n\n        // 批量更新数据库\n        if (!usersToUpdate.isEmpty()) {\n            log.info(\"开始更新用户信息，共{}个用户\", usersToUpdate.size());\n            for (SysUser user : usersToUpdate) {\n                sysUserMapper.updateById(user);\n//                saveUser2ES(user, searchMap, tenantId);\n                userService.updateLoginUserByDingtalk(user, UserTypes.OFFICIAL, null, null);\n            }\n            log.info(\"批量用户信息完成\");\n        }\n        log.info(\"远端人员信息同步完成\");\n    }\n\n    /**\n     * 递归收集部门及其子部门的code\n     */\n    private void collectDepartmentCodes(String deptCode, List\u003cKbDepartment\u003e allDepts, Set\u003cString\u003e codes) {\n        codes.add(deptCode);\n        // 查找所有子部门\n        allDepts.stream()\n                .filter(dept -\u003e deptCode.equals(dept.getPid()))\n                .forEach(dept -\u003e collectDepartmentCodes(dept.getCode(), allDepts, codes));\n    }\n\n    private void updateDepartmentsByGrade(DingTalkExportInfoDTO remoteInfo, DingTalkExportInfoDTO localInfo,\n            String tenantId, String currentUserId) {\n        // 1. 获取最大层级\n        int maxGrade \u003d Math.max(\n                remoteInfo.getKbDepartmentList().stream().mapToInt(KbDepartment::getGrade).max().orElse(0),\n                localInfo.getKbDepartmentList().stream().mapToInt(KbDepartment::getGrade).max().orElse(0));\n\n        // 用于跟踪已废弃的部门的code\n        Set\u003cString\u003e deprecatedDeptCodes \u003d new HashSet\u003c\u003e();\n\n        // 2. 从上到下按层级处理\n        for (int grade \u003d 1; grade \u003c\u003d maxGrade; grade++) {\n            int currentGrade \u003d grade;\n            log.info(\"开始处理第 {} 层级\", currentGrade);\n\n            // 2.1 获取当前层级的远程和本地部门\n            List\u003cKbDepartment\u003e remoteDepts \u003d remoteInfo.getKbDepartmentList().stream()\n                    .filter(dept -\u003e dept.getGrade() \u003d\u003d currentGrade)\n                    .toList();\n            log.info(\"当前层级远端部门:{}\", remoteDepts.toString());\n\n            List\u003cKbDepartment\u003e localDepts \u003d localInfo.getKbDepartmentList().stream()\n                    .filter(dept -\u003e dept.getGrade() \u003d\u003d currentGrade)\n                    .toList();\n            log.info(\"当前层级本地部门:{}\", remoteDepts.toString());\n\n            // 2.2 处理本地有远程无的部门（标记废弃）\n            for (KbDepartment localDept : localDepts) {\n                boolean existsInRemote \u003d remoteDepts.stream()\n                        .anyMatch(remoteDept -\u003e remoteDept.getName().equals(localDept.getName()));\n                // 如果部门不存在于远程，或其父部门已被废弃，则废弃该部门\n                if (!existsInRemote || deprecatedDeptCodes.contains(localDept.getPid())) {\n                    log.info(\"本地部门不存在于远程，或父部门已被废弃，标记废弃：{}\", localDept.getName());\n                    localDept.setDeprecateTag(1);\n                    localDept.setModifier(currentUserId);\n                    localDept.setModifierTime(LocalDateTime.now());\n                    kbDepartmentMapper.updateById(localDept);\n                    // 将该部门添加到已废弃集合中\n                    deprecatedDeptCodes.add(localDept.getCode());\n                }\n            }\n\n            // 2.3 处理远程有本地无的部门（新增）\n            for (KbDepartment remoteDept : remoteDepts) {\n                boolean existsInLocal \u003d localDepts.stream()\n                        .anyMatch(localDept -\u003e localDept.getName().equals(remoteDept.getName()));\n                if (!existsInLocal) {\n                    log.info(\"远程部门不存在于本地，新增：{}\", remoteDept.getName());\n                    // 查找父部门的本地ID\n                    String localParentId \u003d findLocalParentId(remoteDept.getPid(), remoteInfo, localInfo);\n                    remoteDept.setPid(localParentId);\n                    // 获取层级和全路径\n                    ArrayList\u003cString\u003e path \u003d new ArrayList\u003c\u003e();\n                    // map 每次重建防止新入数据未索引到\n                    Map\u003cString, KbDepartment\u003e pidMap \u003d localInfo.getKbDepartmentList().stream().collect(Collectors.toMap(KbDepartment::getCode, s -\u003e s));\n                    while (!\"0\".equals(localParentId)) {\n                        // 父节点添加到最前端\n                        path.add(0, localParentId);\n                        // 从父节点Map获取\n                        KbDepartment parentDepartment \u003d pidMap.get(localParentId);\n                        if (ObjectUtil.isNull(parentDepartment)) {\n                            break;\n                        }\n                        localParentId \u003d parentDepartment.getPid(); // 继续向上遍历\n                    }\n                    path.add(remoteDept.getCode());\n                    remoteDept.setGrade(path.size());\n                    remoteDept.setFullPath(String.join(\",\", path));\n                    kbDepartmentMapper.insert(remoteDept);\n\n                    // 添加到localInfo中，确保后续处理可以使用\n                    localInfo.getKbDepartmentList().add(remoteDept);\n                }\n            }\n        }\n    }\n\n    private String findLocalParentId(String remotePid, DingTalkExportInfoDTO remoteInfo, DingTalkExportInfoDTO localInfo) {\n        // 获取远程父部门\n        KbDepartment remoteParent \u003d remoteInfo.getKbDepartmentList().stream()\n                .filter(dept -\u003e dept.getCode().equals(remotePid))\n                .findFirst()\n                .orElse(null);\n\n        if (remoteParent \u003d\u003d null)\n            return \"0\";\n\n        // 使用grade和name匹配本地父部门\n        return localInfo.getKbDepartmentList().stream()\n                .filter(dept -\u003e Objects.equals(dept.getGrade(), remoteParent.getGrade())\n                        \u0026\u0026 dept.getName().equals(remoteParent.getName()))\n                .map(KbDepartment::getCode)\n                .findFirst()\n                .orElse(\"0\");\n    }\n\n    private void updateUsersAndRelations(DingTalkExportInfoDTO remoteInfo, DingTalkExportInfoDTO localInfo,\n            String tenantId, String currentUserId) {\n        // 1. 遍历每个远程部门\n        for (KbDepartment remoteDept : remoteInfo.getKbDepartmentList()) {\n            // 找到对应的本地部门\n            KbDepartment localDept \u003d localInfo.getKbDepartmentList().stream()\n                    .filter(dept -\u003e Objects.equals(dept.getGrade(), remoteDept.getGrade())\n                            \u0026\u0026 dept.getName().equals(remoteDept.getName()))\n                    .findFirst()\n                    .orElse(null);\n\n            if (localDept \u003d\u003d null)\n                continue;\n\n            // 2. 获取远程部门下的所有用户\n            List\u003cSysUser\u003e remoteDeptUsers \u003d remoteInfo.getSysUserList().stream()\n                    .filter(user -\u003e remoteInfo.getKbDepartmentUserList().stream()\n                            // 关系的\n                            .anyMatch(du -\u003e du.getDepartmentCode().equals(remoteDept.getCode()) \u0026\u0026 du.getUserCode().equals(user.getCode())))\n                    .toList();\n\n            // 3. 获取本地部门下的所有用户关系\n            List\u003cKbDepartmentUser\u003e localDeptUserRelations \u003d localInfo.getKbDepartmentUserList().stream()\n                    .filter(relation -\u003e relation.getDepartmentCode().equals(localDept.getCode()))\n                    .toList();\n\n            // 4. 处理本地有远程无的关系（标记废弃）\n            for (KbDepartmentUser localRelation : localDeptUserRelations) {\n                boolean existsInRemote \u003d remoteDeptUsers.stream()\n                        .anyMatch(remoteUser -\u003e {\n                            SysUser localUser \u003d localInfo.getSysUserList().stream()\n                                    .filter(u -\u003e u.getCode().equals(localRelation.getUserCode()))\n                                    .findFirst()\n                                    .orElse(null);\n                            return localUser !\u003d null \u0026\u0026 localUser.getTel().equals(remoteUser.getTel());\n                        });\n\n                if (!existsInRemote) {\n                    localRelation.setDeprecateTag(1);\n                    localRelation.setModifier(currentUserId);\n                    localRelation.setModifierTime(LocalDateTime.now());\n                    kbDepartmentUserMapper.updateById(localRelation);\n                }\n            }\n\n            Map\u003cString, KbDepartment\u003e searchMap \u003d localInfo.getKbDepartmentList().stream().collect(Collectors.toMap(KbDepartment::getCode, s -\u003e s));\n            // 5. 处理远程有本地无的用户\n            for (SysUser remoteUser : remoteDeptUsers) {\n                try {\n                    String remoteUserTel \u003d remoteUser.getTel();\n\n                    // 5.1 检查用户是否在本地部门存在\n                    boolean existsInLocalDept \u003d localDeptUserRelations.stream()\n                            .anyMatch(relation -\u003e {\n                                SysUser localUser \u003d localInfo.getSysUserList().stream()\n                                        .filter(u -\u003e u.getCode().equals(relation.getUserCode()))\n                                        .findFirst()\n                                        .orElse(null);\n                                return localUser !\u003d null \u0026\u0026 localUser.getTel().equals(remoteUserTel);\n                            });\n\n                    if (!existsInLocalDept) {\n                        // 5.2 检查用户是否在本地（可能是其他部门）中存在\n                        SysUser existingUser \u003d localInfo.getSysUserList().stream()\n                                .filter(u -\u003e u.getTel() !\u003d null \u0026\u0026 u.getTel().equals(remoteUserTel))\n                                .findFirst()\n                                .orElse(null);\n\n                        if (existingUser \u003d\u003d null) {\n                            // 5.2.1 完全新用户，需要新增用户\n                            log.info(\"更新用户\u003e保存用户:{}\", remoteUser.getCode());\n                            if (StrUtil.isEmpty(remoteUser.getLoginUsername())) {\n                                if (StrUtil.isNotEmpty(remoteUser.getTel()))\n                                    remoteUser.setLoginUsername(remoteUser.getTel());\n                                else if (StrUtil.isNotEmpty(remoteUser.getRealName()))\n                                    remoteUser.setRealName(remoteUser.getRealName());\n                                else if (StrUtil.isNotEmpty(remoteUser.getEmail()))\n                                    remoteUser.setEmail(remoteUser.getEmail());\n                                else if (StrUtil.isEmpty(remoteUser.getNickName()))\n                                    remoteUser.setNickName(remoteUser.getTel());\n                            }\n                            if (sysUserMapper.insert(remoteUser) \u003e 0) {\n                                userService.addLoginUser(remoteUser, UserTypes.OFFICIAL);\n                            }\n//                        saveUser2ES(remoteUser, searchMap, tenantId);\n                            // 同时新增系统用户\n                            SysUser sysUser \u003d remoteInfo.getSysUserList().stream()\n                                    .filter(su -\u003e su.getTel().equals(remoteUserTel))\n                                    .findFirst()\n                                    .orElseThrow(() -\u003e new RuntimeException(\"未找到对应的系统用户\"));\n                            // sysUserMapper.insert(sysUser);\n                            // 同时建立和本地部门关系\n                            KbDepartmentUser newRelation \u003d new KbDepartmentUser();\n                            newRelation.setDepartmentCode(localDept.getCode());\n                            newRelation.setUserCode(remoteUser.getCode());\n                            newRelation.setCreator(currentUserId);\n                            newRelation.setCreateTime(LocalDateTime.now());\n                            newRelation.setModifier(currentUserId);\n                            newRelation.setModifierTime(LocalDateTime.now());\n                            newRelation.setTenantId(tenantId);\n                            kbDepartmentUserMapper.insert(newRelation);\n                            // 加入本地列表\n                            localInfo.getKbDepartmentUserList().add(newRelation);\n                            localInfo.getSysUserList().add(remoteUser);\n                            continue;\n                        }\n                        // 5.2.2 已有用户，更新用户部门关联、用户的部门字符串\n                        // 创建新的部门用户关系\n                        KbDepartmentUser newRelation \u003d new KbDepartmentUser();\n                        newRelation.setTenantId(tenantId);\n                        newRelation.setDepartmentCode(localDept.getCode()); // 使用本地部门ID\n                        newRelation.setUserCode(existingUser.getCode());\n                        newRelation.setCreator(currentUserId);\n                        newRelation.setCreateTime(LocalDateTime.now());\n                        newRelation.setModifier(currentUserId);\n                        newRelation.setModifierTime(LocalDateTime.now());\n                        kbDepartmentUserMapper.insert(newRelation);\n                        localInfo.getKbDepartmentUserList().add(newRelation);\n\n                    }\n                } catch (Exception e) {\n                    log.info(e.getMessage(), e);\n                    continue;\n                }\n            }\n        }\n    }\n\n    private void processDepartmentRecursively(DepartmentImport department, String accessToken, DingTalkClient depInfoClient,\n            DingTalkClient subDepClient, DingTalkClient userClient,\n            List\u003cDepartmentImport\u003e departmentList, List\u003cUserImport\u003e userList) {\n        log.info(\"远端获取-处理导入部门开始，当前部门ID：{}\", department.getId());\n\n        // 1. 获取该部门的详细信息，并加入部门列表\n        getDepartmentInfo(department, accessToken, depInfoClient);\n        departmentList.add(department);\n\n        // 2. 获取该部门下所有用户\n        List\u003cUserImport\u003e users \u003d getUserInfoByDepId(department.getId(), accessToken, userClient);\n        userList.addAll(users);\n        log.info(\"远端获取-处理导入部门中，当前已获取到的用户数量：{}\", userList.size());\n\n        // 3. 获取该部门的所有子部门\n        List\u003cDepartmentImport\u003e subDepartments \u003d getDepartmentList(subDepClient, accessToken, department.getId());\n\n        // 4. 递归处理每个子部门\n        if (CollUtil.isNotEmpty(subDepartments)) {\n            log.info(\"远端获取-处理导入部门中，当前部门ID {} 获取到的子部门数量：{}\", department.getId(), subDepartments.size());\n            for (DepartmentImport subDep : subDepartments) {\n                processDepartmentRecursively(subDep, accessToken, depInfoClient, subDepClient, userClient, departmentList, userList);\n            }\n        }\n\n        log.info(\"远端获取-处理导入部门完成，当前部门ID：{}\", department.getId());\n    }\n\n    /**\n     * 从钉钉获取完整组织架构\n     *\n     * @param id\n     * @param secret\n     */\n    private DingTalkExportInfoDTO getDingTalkInfo(String tenantId, String currentUserId, String id, String secret, String taskId) {\n        // 定义请求客户端\n        DingTalkClient tokenClient \u003d new DefaultDingTalkClient(\"https://oapi.dingtalk.com/gettoken\");\n        DingTalkClient subDepClient \u003d new DefaultDingTalkClient(\"https://oapi.dingtalk.com/topapi/v2/department/listsubid\");\n        DingTalkClient userClient \u003d new DefaultDingTalkClient(\"https://oapi.dingtalk.com/topapi/v2/user/list\");\n        DingTalkClient depInfoClient \u003d new DefaultDingTalkClient(\"https://oapi.dingtalk.com/topapi/v2/department/get\");\n\n        // 获取token\n        OapiGettokenRequest req \u003d new OapiGettokenRequest();\n        req.setAppkey(id);\n        req.setAppsecret(secret);\n        req.setHttpMethod(\"GET\");\n        OapiGettokenResponse rsp \u003d null;\n        try {\n            rsp \u003d tokenClient.execute(req);\n        } catch (Exception e) {\n            throw new RuntimeException(\"请检查钉钉的id和sercet配置是否正确\");\n        }\n        Assert.notNull(rsp, \"请检查钉钉的id和sercet配置是否正确\");\n        String accessToken \u003d rsp.getAccessToken();\n\n        // 获取部门、部门下用户\n        // 1. 获取根组织（公司）和详细信息\n        DepartmentImport rootDep \u003d DepartmentImport.builder().id(1L).build();\n        getDepartmentInfo(rootDep, accessToken, depInfoClient);\n        // 2. 初始化部门、人员列表\n        List\u003cDepartmentImport\u003e departmentList \u003d new ArrayList\u003c\u003e();\n        List\u003cUserImport\u003e userList \u003d new ArrayList\u003c\u003e();\n\n        // 3. 开始递归处理根部门\n        processDepartmentRecursively(rootDep, accessToken, depInfoClient, subDepClient, userClient, departmentList, userList);\n\n        log.info(\"远端获取-人员部门已从远端导入：人员列表：{}，部门列表：{}\", userList.size(), departmentList.size());\n        // 4. 用户去重（若用户属于多个部门，会导致计入多次）\n        userList \u003d userList.stream().distinct().collect(Collectors.toList());\n        log.info(\"远端获取-人员去重完成，列表大小：{} \", userList.size());\n\n        // 更新id\n\n        // 1. 生成所有ID\n        Assert.notNull(departmentList);\n        departmentList.forEach(DepartmentImport::generateId);\n        Assert.notNull(userList);\n        userList.forEach(UserImport::generateId);\n\n        log.info(\"远端获取-更新id完成\");\n        // 2. 更新本系统的部门层级的id\n        departmentList.forEach(departmentImport -\u003e {\n            // 遍历每个部门，按第三方Id找到父部门再取得生成的本系统id（code）\n            departmentImport.setSelfParentId(\n                    departmentList.stream()\n                            .filter(department -\u003e department.getId().equals(departmentImport.getParentId()))\n                            .findFirst()\n                            .orElse(DepartmentImport.builder().selfDepId(\"0\").build())\n                            .getSelfDepId());\n        });\n        log.info(\"远端获取-部门层级建立完成\");\n\n        // 3. 更新用户层级id\n        userList.forEach(user -\u003e {\n            // 遍历每个用户的所属部门list，按第三方Id找到父部门再取得生成的本系统id（code）\n            ArrayList\u003cLong\u003e deptIdList \u003d user.getDeptIdList();\n            user.setSelfDeptIdList(new ArrayList\u003c\u003e());\n            deptIdList.forEach(\n                    deptId -\u003e {\n                        String selfDepId \u003d departmentList.stream()\n                                .filter(department -\u003e deptId.equals(department.getId()))\n                                .findFirst()\n                                .orElse(DepartmentImport.builder().selfDepId(\"0\").build())\n                                .getSelfDepId();\n                        user.getSelfDeptIdList().add(Long.valueOf(selfDepId));\n                    });\n        });\n        log.info(\"远端获取-用户层级建立完成\");\n\n        // 4. 用户头像上传OSS\n        userList.forEach(userImport -\u003e {\n            userImport.upload_avatar(materialService, tenantId);\n        });\n        log.info(\"远端获取-用户头像上传OSS完成\");\n\n        // 开始保存\n\n        // 1. KbDepartment表存储\n        // 建立部门Map加快索引速度\n        ArrayList\u003cKbDepartment\u003e kbDepartmentList \u003d departmentList.stream().map(departmentImport -\u003e departmentImport.toKbDepartment(tenantId)).collect(Collectors.toCollection(ArrayList::new));\n        Map\u003cString, KbDepartment\u003e pidMap \u003d kbDepartmentList.stream()\n                .collect(Collectors.toMap(KbDepartment::getCode, department -\u003e department));\n        kbDepartmentList.forEach(kbDepartment -\u003e {\n            // 处理层级、全路径\n            ArrayList\u003cString\u003e path \u003d new ArrayList\u003c\u003e();\n            String pid \u003d kbDepartment.getPid();\n            while (!\"0\".equals(pid)) {\n                // 父节点添加到最前端\n                path.add(0, pid);\n                // 从父节点Map获取\n                KbDepartment parentDepartment \u003d pidMap.get(pid);\n                if (ObjectUtil.isNull(parentDepartment)) {\n                    break;\n                }\n                pid \u003d parentDepartment.getPid(); // 继续向上遍历\n            }\n            path.add(kbDepartment.getCode());\n            kbDepartment.setGrade(path.size());\n            kbDepartment.setFullPath(String.join(\",\", path));\n            // 设置辅助字段\n            kbDepartment.setCreator(String.valueOf(currentUserId));\n            kbDepartment.setCreateTime(LocalDateTime.now());\n            kbDepartment.setModifier(String.valueOf(currentUserId));\n            kbDepartment.setModifierTime(LocalDateTime.now());\n        });\n        log.info(\"远端获取-部门转化为TorchV系统对象完成\");\n\n        // 3. KbDepartmentUser表存储\n        ArrayList\u003cKbDepartmentUser\u003e kbDepartmentUserArrayList \u003d new ArrayList\u003c\u003e();\n        userList.forEach(user -\u003e {\n            // 单个用户会处于多个部门。因此要遍历该list，每个部门都要生成一条记录\n            user.toKbDepartmentUserList(tenantId).forEach(kbDepartmentUser -\u003e {\n                kbDepartmentUser.setCreator(String.valueOf(currentUserId));\n                kbDepartmentUser.setCreateTime(LocalDateTime.now());\n                kbDepartmentUser.setModifier(String.valueOf(currentUserId));\n                kbDepartmentUser.setModifierTime(LocalDateTime.now());\n                kbDepartmentUserArrayList.add(kbDepartmentUser);\n            });\n        });\n        log.info(\"远端获取-部门用户关系转化为TorchV系统对象完成\");\n\n        // 4. SysUser表存储\n        ArrayList\u003cSysUser\u003e sysUserArrayList \u003d userList.stream().map(user -\u003e {\n            // 先转SysUser\n            SysUser sysUser \u003d user.toSysUser(tenantId);\n            // 设置辅助字段\n            sysUser.setCreator(String.valueOf(currentUserId));\n            sysUser.setType(\"OFFICIAL\");\n            sysUser.setCreateTime(LocalDateTime.now());\n            sysUser.setModifier(String.valueOf(currentUserId));\n            sysUser.setModifierTime(LocalDateTime.now());\n            return sysUser;\n        }).collect(Collectors.toCollection(ArrayList::new));\n        log.info(\"远端获取-用户转化为TorchV系统注册对象完成\");\n\n        return DingTalkExportInfoDTO.builder()\n                .kbDepartmentList(kbDepartmentList)\n                .kbDepartmentUserList(kbDepartmentUserArrayList)\n                .sysUserList(sysUserArrayList)\n                .build();\n    }\n\n    /**\n     * 获取部门列表\n     *\n     * @param depClient\n     * @param accessToken\n     * @param deptId\n     * @return 部门列表\n     */\n    private ArrayList\u003cDepartmentImport\u003e getDepartmentList(DingTalkClient depClient, String accessToken, Long deptId) {\n        OapiV2DepartmentListsubidRequest req \u003d new OapiV2DepartmentListsubidRequest();\n        req.setDeptId(deptId);\n        OapiV2DepartmentListsubidResponse rsp \u003d null;\n\n        int maxRetries \u003d 3;\n        long baseDelay \u003d 4000; // 4秒基础延迟\n\n        for (int attempt \u003d 1; attempt \u003c\u003d maxRetries; attempt++) {\n            try {\n                subDepClientRateLimiter.acquire();\n                rsp \u003d depClient.execute(req, accessToken);\n                return rsp.getResult().getDeptIdList().stream().map(id -\u003e DepartmentImport.builder().id(id).parentId(deptId).build()).collect(Collectors.toCollection(ArrayList::new));\n            } catch (ApiException e) {\n                if (attempt \u003d\u003d maxRetries) {\n                    log.warn(\"获取部门列表失败，已达最大重试次数 {} 次，部门ID: {}\", maxRetries, deptId, e);\n                    return new ArrayList\u003c\u003e();\n                }\n                long delay \u003d baseDelay * (long) Math.pow(2, attempt - 1);\n                log.warn(\"获取部门列表失败，第 {} 次重试，延迟 {} ms，部门ID: {}\", attempt, delay, deptId, e);\n                try {\n                    Thread.sleep(delay);\n                } catch (InterruptedException ie) {\n                    Thread.currentThread().interrupt();\n                    return new ArrayList\u003c\u003e();\n                }\n            }\n        }\n\n        return new ArrayList\u003c\u003e();\n    }\n\n    /**\n     * 获取部门详细信息\n     *\n     * @param dep\n     * @param accessToken\n     * @param depInfoClient\n     */\n    public void getDepartmentInfo(DepartmentImport dep, String accessToken, DingTalkClient depInfoClient) {\n        OapiV2DepartmentGetRequest req \u003d new OapiV2DepartmentGetRequest();\n        req.setDeptId(dep.getId());\n        OapiV2DepartmentGetResponse rsp;\n        try {\n            depInfoClientRateLimiter.acquire();\n            rsp \u003d depInfoClient.execute(req, accessToken);\n        } catch (ApiException e) {\n            throw new RuntimeException(e);\n        }\n        dep.setName(rsp.getResult().getName());\n        dep.setSourceIdentifier(rsp.getResult().getSourceIdentifier());\n    }\n\n    /**\n     * 获取部门下所有用户\n     *\n     * @param depId       部门ID\n     * @param accessToken 访问令牌\n     * @param userClient  DingTalkClient 实例\n     * @return 用户列表\n     */\n    public ArrayList\u003cUserImport\u003e getUserInfoByDepId(Long depId, String accessToken, DingTalkClient userClient) {\n        // 初始游标设为0\n        long cursor \u003d 0L;\n        ArrayList\u003cUserImport\u003e userList \u003d new ArrayList\u003c\u003e();\n\n        try {\n            while (true) {\n                OapiV2UserListRequest req \u003d new OapiV2UserListRequest();\n                req.setDeptId(depId);\n                req.setCursor(cursor);\n                req.setSize(10L);\n                req.setOrderField(\"modify_desc\");\n                // 是否返回访问受限的员工\n                req.setContainAccessLimit(false);\n                req.setLanguage(\"zh_CN\");\n\n                // 获取访问令牌的速率限制\n                userClientRateLimiter.acquire();\n                OapiV2UserListResponse rsp \u003d userClient.execute(req, accessToken);\n\n                // 检查响应是否成功\n                if (rsp \u003d\u003d null || !rsp.isSuccess() || rsp.getResult() \u003d\u003d null) {\n                    log.error(\"请求失败或返回结果为空: {}\", rsp);\n                    break;\n                }\n\n                List\u003cOapiV2UserListResponse.ListUserResponse\u003e list \u003d rsp.getResult().getList();\n\n                // 如果用户列表为空，终止循环\n                if (list \u003d\u003d null || list.isEmpty()) {\n                    log.info(\"当前分页用户列表为空，终止循环。游标: {}\", cursor);\n                    break;\n                }\n\n                log.info(\"获取部门下用户列表中, 当前页游标: {}, 当前页人数：{}\", cursor, list.size());\n\n                // 处理并添加用户信息到用户列表\n                userList.addAll(list.stream()\n                        .filter(Objects::nonNull)\n                        .map(userInfo -\u003e {\n                            UserImport userImport \u003d UserImport.builder().build();\n                            BeanUtils.copyProperties(userInfo, userImport);\n                            userImport.setDeptIdList(new ArrayList\u003c\u003e(userInfo.getDeptIdList()));\n                            // 优先放企业邮箱，如果企业邮箱为空，则放个人邮箱\n                            userImport.setEmail(StrUtil.isEmpty(userInfo.getOrgEmail()) ? userInfo.getEmail() : userInfo.getOrgEmail());\n                            return userImport;\n                        })\n                        .collect(Collectors.toList()));\n\n                // 获取下一个游标\n                Long nextCursor \u003d rsp.getResult().getNextCursor();\n                log.info(\"下一页游标: {}\", nextCursor);\n\n                // 如果下一个游标为0，表示没有更多数据，终止循环\n                if (nextCursor \u003d\u003d null || nextCursor \u003d\u003d 0L) {\n                    break;\n                }\n\n                // 更新游标为下一个游标\n                cursor \u003d nextCursor;\n            }\n        } catch (ApiException e) {\n            log.error(\"请求部门下用户API 请求异常: \", e);\n        }\n        return userList;\n    }\n\n    /**\n     * 标记任务为完成状态\n     *\n     * @param taskId 任务ID\n     * @param currentUserId 当前用户ID\n     */\n    private void markTaskAsCompleted(String taskId, String currentUserId) {\n        if (StringUtils.isBlank(taskId)) {\n            return;\n        }\n\n        int maxRetries \u003d 3;\n        for (int attempt \u003d 1; attempt \u003c\u003d maxRetries; attempt++) {\n            try {\n                int updateCount \u003d kbAsyncTasksStatusMapper.update(Wrappers.\u003cKbAsyncTasksStatus\u003elambdaUpdate()\n                        .eq(KbAsyncTasksStatus::getCode, taskId)\n                        .set(KbAsyncTasksStatus::getStatus, KbAsyncTasksStatusTypes.COMPLETED.getStatus())\n                        .set(KbAsyncTasksStatus::getModifier, currentUserId)\n                        .set(KbAsyncTasksStatus::getModifierTime, LocalDateTime.now()));\n\n                if (updateCount \u003e 0) {\n                    log.info(\"任务{}已成功标记为完成状态\", taskId);\n                    return;\n                } else {\n                    log.warn(\"任务{}状态更新失败，未找到匹配的任务记录，尝试次数: {}\", taskId, attempt);\n                }\n            } catch (Exception e) {\n                log.error(\"更新任务{}状态为完成时发生异常，尝试次数: {}/{}\", taskId, attempt, maxRetries, e);\n            }\n\n            if (attempt \u003c maxRetries) {\n                try {\n                    Thread.sleep(1000 * attempt); // 递增延迟\n                } catch (InterruptedException ie) {\n                    Thread.currentThread().interrupt();\n                    break;\n                }\n            }\n        }\n\n        log.error(\"任务{}状态更新失败，已达到最大重试次数\", taskId);\n    }\n\n    /**\n     * 更新任务状态\n     *\n     * @param taskId 任务ID\n     * @param status 状态\n     * @param currentUserId 当前用户ID\n     */\n    @Transactional\n    public void updateTaskStatus(String taskId, KbAsyncTasksStatusTypes status, String currentUserId) {\n        if (StringUtils.isBlank(taskId)) {\n            return;\n        }\n        try {\n            kbAsyncTasksStatusMapper.update(Wrappers.\u003cKbAsyncTasksStatus\u003elambdaUpdate()\n                    .eq(KbAsyncTasksStatus::getCode, taskId)\n                    .set(KbAsyncTasksStatus::getStatus, status.getStatus())\n                    .set(KbAsyncTasksStatus::getModifier, currentUserId)\n                    .set(KbAsyncTasksStatus::getModifierTime, LocalDateTime.now()));\n        } catch (Exception e) {\n            log.error(\"更新任务{}状态失败: {}\", taskId, e.getMessage(), e);\n            throw e;\n        }\n    }\n\n    /**\n     * 获取本地钉钉信息\n     *\n     * @param tenantId 租户ID\n     * @return 本地钉钉信息\n     */\n    @Transactional\n    public DingTalkExportInfoDTO getLocalDingTalkInfo(String tenantId) {\n        return DingTalkExportInfoDTO.builder()\n                .kbDepartmentList((ArrayList\u003cKbDepartment\u003e) kbDepartmentMapper.selectList(Wrappers.\u003cKbDepartment\u003elambdaQuery().eq(KbDepartment::getTenantId, tenantId)))\n                .kbDepartmentUserList((ArrayList\u003cKbDepartmentUser\u003e) kbDepartmentUserMapper.selectList(Wrappers.\u003cKbDepartmentUser\u003elambdaQuery().eq(KbDepartmentUser::getTenantId, tenantId)))\n                .sysUserList((ArrayList\u003cSysUser\u003e) sysUserMapper.selectList(Wrappers.\u003cSysUser\u003elambdaQuery().eq(SysUser::getTenantId, tenantId).isNotNull(SysUser::getTel).ne(SysUser::getTel, \"\")))\n                .build();\n    }\n\n    /**\n     * 保存导入数据\n     *\n     * @param tenantId 租户ID\n     * @param currentUserId 当前用户ID\n     * @param taskId 任务ID\n     * @param kbDepartmentList 部门列表\n     * @param kbDepartmentUserList 部门用户关系列表\n     * @param sysUserList 用户列表\n     */\n    @Transactional\n    public void saveImportData(String tenantId, String currentUserId, String taskId,\n                               ArrayList\u003cKbDepartment\u003e kbDepartmentList,\n                               ArrayList\u003cKbDepartmentUser\u003e kbDepartmentUserList,\n                               ArrayList\u003cSysUser\u003e sysUserList) {\n        // 2. 保存部门\n        updateProgress(taskId, 40, \"正在保存部门数据\");\n        kbDepartmentList.forEach(kbDepartmentMapper::insert);\n        updateProgress(taskId, 50, \"部门数据保存完成\");\n\n        // 3. 保存用户\n        Map\u003cString, KbDepartment\u003e searchMap \u003d kbDepartmentList.stream().collect(Collectors.toMap(KbDepartment::getCode, s -\u003e s));\n        updateProgress(taskId, 60, \"正在保存用户数据\");\n        sysUserList.forEach(user -\u003e {\n            // 先判断是否存在重复用户\n            SysUser sysUser \u003d sysUserMapper.selectOne(Wrappers.\u003cSysUser\u003elambdaQuery().eq(SysUser::getTenantId, tenantId).eq(SysUser::getTel, user.getTel()));\n            // 3.1 不存在直接保存\n            if (ObjectUtil.isNull(sysUser)) {\n                log.info(\"导入用户\u003e保存用户:{}\", user.getCode());\n                if (sysUserMapper.insert(user) \u003e 0) {\n                    userService.addLoginUser(user, UserTypes.OFFICIAL);\n                }\n            } else {\n                // 3.2 存在，更新部门用户关联、用户信息\n                ArrayList\u003cString\u003e deptIdList \u003d new ArrayList\u003c\u003e();\n                kbDepartmentUserList.forEach(kbDepartmentUser -\u003e {\n                    if (kbDepartmentUser.getUserCode().equals(user.getCode())) {\n                        kbDepartmentUser.setUserCode(sysUser.getCode());\n                        deptIdList.add(kbDepartmentUser.getDepartmentCode());\n                    }\n                });\n            }\n        });\n        updateProgress(taskId, 70, \"用户数据保存完成\");\n\n        // 4. 保存部门用户关联\n        updateProgress(taskId, 80, \"正在保存部门用户关系\");\n        kbDepartmentUserList.forEach(kbDepartmentUserMapper::insert);\n        updateProgress(taskId, 90, \"部门用户关系保存完成\");\n\n        // 6. 更新第三方导入次数\n        Integer importTimes \u003d kbThirdPartImportConfigMapper.selectOne(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaQuery()\n                .eq(KbThirdPartImportConfig::getTenantId, tenantId)).getImportTimes();\n        kbThirdPartImportConfigMapper.update(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaUpdate()\n                .eq(tenantId !\u003d null, KbThirdPartImportConfig::getTenantId, tenantId)\n                .set(KbThirdPartImportConfig::getImportTimes, importTimes + 1)\n                .set(KbThirdPartImportConfig::getModifier, currentUserId)\n                .set(KbThirdPartImportConfig::getModifierTime, LocalDateTime.now()));\n\n        updateProgress(taskId, 100, \"导入完成\");\n    }\n\n    /**\n     * 处理数据库所有更新操作\n     *\n     * @param tenantId 租户ID\n     * @param currentUserId 当前用户ID\n     * @param taskId 任务ID\n     * @param remoteDingTalkInfo 远端钉钉信息\n     * @param localDingTalkInfo 本地钉钉信息\n     */\n    @Transactional\n    public void processUpdateInTransaction(String tenantId, String currentUserId, String taskId,\n                                         DingTalkExportInfoDTO remoteDingTalkInfo,\n                                         DingTalkExportInfoDTO localDingTalkInfo) {\n        // 6. 按层级处理部门\n        updateDepartmentsByGrade(remoteDingTalkInfo, localDingTalkInfo, tenantId, currentUserId);\n        updateProgress(taskId, 75, \"更新部门数据完成\");\n\n        // 7. 处理用户和部门用户关系\n        updateUsersAndRelations(remoteDingTalkInfo, localDingTalkInfo, tenantId, currentUserId);\n        updateProgress(taskId, 80, \"更新用户及用户关系完成\");\n\n        // 7.5 同步远端人员信息\n        syncRemoteUserInfo(remoteDingTalkInfo, localDingTalkInfo, tenantId, currentUserId);\n        updateProgress(taskId, 85, \"同步远端人员信息完成\");\n\n        // 8. 更新第三方导入次数\n        Integer importTimes \u003d kbThirdPartImportConfigMapper.selectOne(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaQuery()\n                .eq(KbThirdPartImportConfig::getTenantId, tenantId)).getImportTimes();\n        kbThirdPartImportConfigMapper.update(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaUpdate()\n                .eq(tenantId !\u003d null, KbThirdPartImportConfig::getTenantId, tenantId)\n                .set(KbThirdPartImportConfig::getImportTimes, importTimes + 1)\n                .set(KbThirdPartImportConfig::getModifier, currentUserId)\n                .set(KbThirdPartImportConfig::getModifierTime, LocalDateTime.now()))",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 1071
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/database/provider/MySQLDatabaseAccessProvider.java",
      "timestamp": 1761236769585,
      "startOffset": 911,
      "endOffset": 4638,
      "codeContent": "application.knowledge.model.response.database.DataQueryResult;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.repository.database.entity.BusinessDataSource;\nimport com.torchv.repository.database.entity.DataBaseTable;\nimport com.torchv.repository.database.entity.DatabaseColumn;\nimport com.torchv.repository.database.mapper.MySQLMetadataMapper;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.ibatis.session.SqlSession;\nimport org.springframework.stereotype.Component;\n\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Map;\n\n/**\n * MySQL数据库访问的实现\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/7/23 19:18\n * @since torchv_server v1.7.8\n */\n@Component(\"mySQLDatabaseAccessProvider\")\n@Slf4j\npublic class MySQLDatabaseAccessProvider extends AbstractDatabaseAccessProvider {\n    \n    public MySQLDatabaseAccessProvider(DynamicSessionProvider dynamicSessionProvider) {\n        super(dynamicSessionProvider);\n    }\n    \n    @Override\n    public Pagination\u003cDataBaseTable\u003e listTables(Integer pageNo, Integer pageSize, BusinessDataSource dataSource) {\n        Page\u003cDataBaseTable\u003e tablePage \u003d PageHelper.startPage(pageNo, pageSize);\n        List\u003cDataBaseTable\u003e tables \u003d new ArrayList\u003c\u003e();\n        SqlSession sqlSession \u003d null;\n        try {\n            sqlSession \u003d dynamicSessionProvider.getSqlSession(dataSource.getCode());\n            tables \u003d sqlSession.getMapper(MySQLMetadataMapper.class).getTables(dataSource.getDbName());\n        } catch (Exception e) {\n            log.error(\"获取数据源连接失败\", e);\n        } finally {\n            IoUtil.close(sqlSession);\n        }\n        return Pagination.pagination(tables, tablePage.getTotal(), pageNo, pageSize);\n    }\n    \n    @Override\n    public DataBaseTable getTable(BusinessDataSource dataSource, String tableName) {\n        SqlSession sqlSession \u003d null;\n        DataBaseTable dtable \u003d null;\n        try {\n            sqlSession \u003d dynamicSessionProvider.getSqlSession(dataSource.getCode());\n            dtable \u003d sqlSession.getMapper(MySQLMetadataMapper.class).getTable(dataSource.getDbName(), tableName);\n        } catch (Exception e) {\n            log.error(\"获取数据源-表信息连接失败\", e);\n        } finally {\n            IoUtil.close(sqlSession);\n        }\n        return dtable;\n    }\n    \n    @Override\n    public List\u003cDatabaseColumn\u003e listColumns(BusinessDataSource dataSource, String tableName) {\n        SqlSession sqlSession \u003d null;\n        List\u003cDatabaseColumn\u003e columns \u003d new ArrayList\u003c\u003e();\n        try {\n            sqlSession \u003d dynamicSessionProvider.getSqlSession(dataSource.getCode());\n            columns \u003d sqlSession.getMapper(MySQLMetadataMapper.class).getColumns(dataSource.getDbName(), tableName);\n        } catch (Exception e) {\n            log.error(\"获取数据源连接失败\", e);\n        } finally {\n            IoUtil.close(sqlSession);\n        }\n        return columns;\n    }\n    \n    @Override\n    public DataQueryResult executeQuery(BusinessDataSource dataSource, String sql, int page, int size) {\n        SqlSession sqlSession \u003d null;\n        List\u003cMap\u003cString, Object\u003e\u003e mapList;\n        long total;\n        try (Page\u003cMap\u003cString, Object\u003e\u003e pages \u003d PageHelper.startPage(page, size)) {\n            sqlSession \u003d dynamicSessionProvider.getSqlSession(dataSource.getCode());\n            mapList \u003d sqlSession.getMapper(MySQLMetadataMapper.class).executeSQL(sql);\n            total \u003d pages.getTotal();\n            log.info(\"executeQuery result size:{}, total:{}\", mapList.size(), total);\n            return DataQueryResult.of(mapList, total);\n        } catch (Exception e) {\n            log.error(e.getMessage(), e);\n            return DataQueryResult.of(List.of(), 0L);\n        } finally {\n            IoUtil.close(sqlSession);\n        }",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 91
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/assistant/domain/builder/EChartsDataContextBuilder.java",
      "timestamp": 1761236769556,
      "startOffset": 1296,
      "endOffset": 1467,
      "codeContent": "infra.rag.chain.context.ContextBuilder;\nimport com.torchv.infra.rag.chain.model.ChainContext;\nimport com.torchv.infra.rag.chain.model.ChainRequest;\nimport com.torchv.infra",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 4
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/domain/knowledge/KnowledgeElementService.java",
      "timestamp": 1761236769548,
      "startOffset": 2450,
      "endOffset": 6145,
      "codeContent": "infra.vector.model.dataset.DataSetChunkInfo;\nimport com.torchv.repository.chat.entity.SaasKnowledgeElement;\nimport com.torchv.repository.database.entity.BusinessColumn;\nimport com.torchv.repository.database.entity.BusinessTable;\nimport com.torchv.repository.kb.space.entity.KbSpace;\nimport jakarta.validation.Valid;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Optional;\n\n/**\n * 知识库元素模块-业务Service\n * @since torchv_server v0.1-beta.1\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/01/03 11:44\n */\npublic interface KnowledgeElementService extends IService\u003cSaasKnowledgeElement\u003e {\n    \n    /**\n     * 批量上传web地址\n     * @param webReq wen请求数据\n     * @return 是否成功\n     */\n    Result\u003cString\u003e importWebs(KnowledgeElementBatchWebReq webReq);\n    \n    /**\n     * 直接批量导入文件，开放给paas层接口使用\n     * @param multipartFiles 文件流\n     * @return 是否导入成功\n     */\n    Result\u003cString\u003e importFiles(KnowledgeElementBatchFileReq batchFileReq, MultipartFile[] multipartFiles);\n    \n    /**\n     * 获取当前文档的全部内容\n     * @param id 文档id\n     * @return 文档内容\n     */\n    Result\u003cString\u003e getElementContent(Integer id);\n    \n    /**\n     * 统计知识库数量\n     * @param tenantId 租户id\n     * @param containerId 容器id\n     * @return 数量\n     */\n    Long countContainerSize(String tenantId, String containerId);\n    \n    /**\n     * 新增一个表类型的知识库信息\n     * @param table 表信息\n     * @param columns 列信息\n     * @param sysUserInfo 用户信息\n     */\n    void addKnowledge(BusinessTable table, List\u003cBusinessColumn\u003e columns, SysUserInfo sysUserInfo, String containerId);\n    \n    /**\n     * 处理回调\n     * @param callbackReq 回调函数\n     */\n    void callback(DataSetChunkCallbackReq callbackReq);\n    \n    /**\n     * 查询待处理待文件\n     * @param page 当前页码\n     * @param size 页码大小\n     * @return 文件集合\n     */\n    Pagination\u003cSaasKnowledgeElement\u003e listChunkFiles(Integer page, Integer size);\n    \n    /**\n     * 查询chunk状态信息\n     * @param page 分页\n     * @param size size\n     * @param statusEnum 状态\n     * @return 文件集合\n     */\n    Pagination\u003cSaasKnowledgeElement\u003e listChunkFiles(Integer page, Integer size, ProcessStatusEnum statusEnum);\n    \n    /**\n     * 构建chunk的提交任务处理的参数\n     * @param knowledgeElement 参数\n     * @return chunk参数结果\n     */\n    DataSetChunkSubmitModel buildChunkParams(SaasKnowledgeElement knowledgeElement, String callbackUrl);\n    \n    /**\n     * 处理变更状态\n     * @param knowledgeElement 知识元素\n     * @param processStatusEnum 状态\n     */\n    void updateElementStatus(SaasKnowledgeElement knowledgeElement, ProcessStatusEnum processStatusEnum);\n    \n    /**\n     * 更新转换状态\n     * @param convertReq 转换请求\n     * @param convertResult 转换结果\n     */\n    void updateConvert(MessageFileConvertReq convertReq, KnowledgeFileConvertResult convertResult);\n    /**\n     * 分页查询-知识库元素\n     * @param knowledgeElementQueryReq 查询条件Vo\n     * @param pageNo 当前页码\n     * @param pageSize 每页页码大小\n     * @return 知识库元素列表\n     */\n    Pagination\u003cKnowledgeElementResp\u003e list(KnowledgeElementQueryReq knowledgeElementQueryReq, Integer pageNo, Integer pageSize);\n    /**\n     * 根据code查名称\n     * @param code  code\n     * @return 名称\n     */\n    Result\u003cList\u003cKnowledgeElementResp\u003e\u003e queryParentName(String code);\n    \n    /**\n    * 查询所有知识库元素数据\n    */\n    List\u003cKnowledgeElementResp\u003e listAll();\n    \n    /**\n     * 查询所有知识库元素列表\n     * @param knowledgeElementQueryReq 查询条件Vo\n     * @return 所有知识库元素列表\n     */\n    Result\u003cList\u003cKnowledgeElementResp\u003e\u003e listAll(KnowledgeElementQueryReq knowledgeElementQueryReq);\n    \n    /**\n     * 查询所有知识库元素列表，包括所有子级，排序规则与list接口保持一致\n     * @param knowledgeElementQueryReq 查询条件Vo\n     * @return 所有知识库元素列表（包括所有层级）\n     */\n    Result\u003cList\u003cKnowledgeElementResp\u003e\u003e listAllWithSort",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 133
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/web/KnowledgeElementController.java",
      "timestamp": 1761236769689,
      "startOffset": 1813,
      "endOffset": 10982,
      "codeContent": "infra.common.extra.log.LogContext;\nimport com.torchv.infra.common.extra.log.annotation.SysLog;\nimport com.torchv.infra.common.utils.EmitterUtil;\nimport com.torchv.infra.license.LicenseBootstrap;\nimport com.torchv.kb.page.model.request.KnowledgeElementAddReq;\nimport com.torchv.kb.page.model.request.KnowledgeElementContentUpdateReq;\nimport com.torchv.kb.page.model.response.KbPageCreateInfoResp;\nimport jakarta.servlet.http.HttpServletResponse;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\n\nimport cn.hutool.core.lang.Assert;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport org.springframework.web.bind.annotation.*;\n\nimport io.swagger.v3.oas.annotations.Operation;\nimport io.swagger.v3.oas.annotations.Parameter;\nimport io.swagger.v3.oas.annotations.Parameters;\nimport io.swagger.v3.oas.annotations.enums.ParameterIn;\nimport io.swagger.v3.oas.annotations.tags.Tag;\n\nimport jakarta.validation.Valid;\nimport org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter;\nimport org.springframework.web.servlet.mvc.method.annotation.SseEmitter;\n\nimport java.io.IOException;\nimport java.util.List;\n\n/**\n * 知识库元素-接口API\n * @since torchv_server v0.1-beta.1\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/01/03 11:44\n */\n@Slf4j\n@AllArgsConstructor\n@Tag(name \u003d \"知识库元素\")\n@RestController\n@RequestMapping(\"/kl/api/saas/element\")\n//@SaCheckPermission(value \u003d {\"RES_LLM_FILE\", \"RES_LLM_FILE_ADD\", \"RES_LLM_FILE_PREVIEW\", \"RES_LLM_FILE_ADD_BATCH\", \"RES_LLM_FILE_EDIT\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_CLI_ADMIN\"})\npublic class KnowledgeElementController {\n    \n    final KnowledgeElementService knowledgeElementService;\n    final KnowledgeTxtService knowledgeTxtService;\n    final KnowledgeElementProcessService knowledgeElementProcessService;\n    final OpenAPIService openAPIService;\n    \n    @Operation(summary \u003d \"中断当前文件embedding进度信息查询信息\")\n    @GetMapping(\"/abort\")\n    public Result\u003cBoolean\u003e abort(@RequestParam(\"messageId\") String messageId) {\n        log.info(\"中断文件embedding进度信息,api:{},messageId:{}\", \"/kl/api/saas/element/abort\", messageId);\n        knowledgeElementProcessService.abort(messageId);\n        return Result.data(true);\n    }\n    \n    @Operation(summary \u003d \"长链接查询文件的处理进度。\")\n    @PostMapping(\"/process\")\n    public ResponseBodyEmitter process(@RequestBody KnowledgeProcessReq processReq, HttpServletResponse response) {\n        // 10分钟超时\n        log.info(\"获取文件embedding进度信息,api:{}\", \"/kl/api/saas/element/process\");\n        openAPIService.contentType(true, response);\n        return knowledgeElementProcessService.process(processReq);\n    }\n    \n    @PostMapping(\"/file-status\")\n    public SseEmitter streamFileStatus(@RequestBody KnowledgeProcessReq processReq, HttpServletResponse response) {\n        SseEmitter emitter \u003d new SseEmitter();\n        openAPIService.contentType(true, response);\n        emitter.onTimeout(() -\u003e {\n            log.info(\"Process Timeout.\");\n        });\n        emitter.onCompletion(() -\u003e {\n            log.info(\"Process Complete.\");\n        });\n        emitter.onError((e) -\u003e {\n            log.error(\"Process Error.\", e);\n        });\n        \n        ThreadUtil.execAsync(() -\u003e {\n            try {\n                List\u003cInteger\u003e ids \u003d processReq.getIds();\n                for (int id : ids) {\n                    // 模拟文件处理过程\n                    for (int i \u003d 0; i \u003c\u003d 100; i +\u003d 10) {\n                        // 模拟一些处理时间\n                        Thread.sleep(100); // 模拟处理时间\n                        send(emitter, id, i);\n                    }\n                }\n                emitter.complete();\n            } catch (Exception e) {\n                emitter.completeWithError(e);\n            }\n        });\n        return emitter;\n    }\n    public void send(SseEmitter emitter, Integer dataId, Integer percent) {\n        try {\n            String json \u003d KnowledgeProcessStatusResult.of(dataId, percent).toJson();\n            log.info(\"send message:{}\", json);\n            emitter.send(EmitterUtil.eventBuilder(json));\n        } catch (IOException e) {\n            log.error(e.getMessage());\n        }\n    }\n    \n    @Operation(summary \u003d \"测试文件进度，前端不需要关注\")\n    @GetMapping(\"/exchange\")\n    public Result\u003cLong\u003e exchange(@RequestParam(\"id\") Integer id, @RequestParam(\"currentPage\") Integer currentPage, @RequestParam(\"totalPage\") Integer totalPage) {\n        knowledgeElementProcessService.exchange(id, currentPage, totalPage);\n        return Result.data(System.currentTimeMillis());\n    }\n    \n    @GetMapping(\"/content\")\n    public Result\u003cString\u003e content(@RequestParam(value \u003d \"id\") Integer id) {\n        return knowledgeElementService.getElementContent(id);\n    }\n    \n    @Operation(summary \u003d \"查询树结构\")\n    @Parameter(name \u003d \"parentCode\", description \u003d \"父级编码\", required \u003d true)\n    @GetMapping(\"/queryParentName\")\n    public Result\u003cList\u003cKnowledgeElementResp\u003e\u003e queryParentName(@RequestParam(\"parentCode\") String parentCode) {\n        return knowledgeElementService.queryParentName(parentCode);\n    }\n    /**\n     * 分页查询知识库元素\n     * @param knowledgeElementQueryReq 查询条件vo\n     * @param pageNo 当前页码\n     * @param pageSize 页码大小\n     * @return 分页列表\n     */\n    @Operation(summary \u003d \"分页查询知识库元素\")\n    @Parameters({\n            @Parameter(name \u003d \"pageNo\", description \u003d \"当前页码,默认1\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"1\"),\n            @Parameter(name \u003d \"pageSize\", description \u003d \"页码大小,默认10\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"10\")\n    })\n    @GetMapping(\"/list\")\n    public Pagination\u003cKnowledgeElementResp\u003e list(KnowledgeElementQueryReq knowledgeElementQueryReq,\n                                                 @RequestParam(value \u003d \"pageNo\", defaultValue \u003d \"1\") Integer pageNo,\n                                                 @RequestParam(value \u003d \"pageSize\", defaultValue \u003d \"10\") Integer pageSize) {\n        log.info(\"分页查询知识库元素,API:{},page:{},size:{}\", \"/kl/api/saas/element/list\", pageNo, pageSize);\n        log.info(\"查询条件Vo:{}\", knowledgeElementQueryReq.toString());\n        return knowledgeElementService.list(knowledgeElementQueryReq, pageNo, pageSize);\n    }\n\n    /**\n     * 查询所有知识库元素（包括所有层级子目录）\n     * @param knowledgeElementQueryReq 查询条件vo\n     * @return 所有知识库元素列表（树形结构）\n     */\n    @Operation(summary \u003d \"查询所有知识库元素（包括所有层级子目录）\")\n    @GetMapping(\"/listAll\")\n    public Result\u003cList\u003cKnowledgeElementResp\u003e\u003e listAll(KnowledgeElementQueryReq knowledgeElementQueryReq) {\n        log.info(\"查询所有知识库元素（包括所有层级子目录）,API:{}\", \"/kl/api/saas/element/listAll\");\n        log.info(\"查询条件Vo:{}\", knowledgeElementQueryReq.toString());\n        return knowledgeElementService.listAllWithSort(knowledgeElementQueryReq);\n    }\n    \n    /**\n     * 新增知识库元素(文件导入方式)\n     * @param addFileReq 新增vo\n     * @return 新增是否成功\n     */\n    @Operation(summary \u003d \"新增知识库元素(文件/web)导入方式)\")\n    @PostMapping(\"/addFiles\")\n    @SysLog(module \u003d SystemModule.LLM_KNOWLEDGE, value \u003d \"批量导入知识文件,数量:#{ #size }\")\n    public Result\u003cString\u003e addFiles(@Valid @RequestBody KnowledgeElementAddFileReq addFileReq) {\n        log.info(\"新增知识库元素,API:{}\", \"/kl/api/saas/element/addFiles\");\n        log.info(\"新增知识库元素模块Vo:{}\", addFileReq.toString());\n        LogContext.putVariable(\"size\", CollUtil.size(addFileReq.getDataSets()));\n        return knowledgeElementService.addFiles(addFileReq);\n    }\n    /**\n     * 新增知识库元素(文件导入方式)\n     * @param addFileReq 新增vo\n     * @return 新增是否成功\n     */\n    @Operation(summary \u003d \"新增文件夹或者虚拟文件\")\n    @PostMapping(\"/addSingleDataSet\")\n    @SysLog(module \u003d SystemModule.LLM_KNOWLEDGE, value \u003d \"新增文件夹或者虚拟文件,名称:#{ #name },类型: #{ #type }\")\n    public Result\u003cString\u003e addSingleDataSet(@Valid @RequestBody KnowledgeSingleElementAddFileReq addFileReq) {\n        log.info(\"新增文件夹或者虚拟文件,API:{}\", \"/kl/api/saas/element/addSingleDataSet\");\n        log.info(\"新增文件夹或者虚拟文件:{}\", addFileReq.toString());\n        LogContext.putVariable(\"name\", addFileReq.getName());\n        LogContext.putVariable(\"type\", addFileReq.getCategory());\n        return knowledgeElementService.addSingle(addFileReq);\n    }\n\n    /**\n     * 新增空间页面\n     *\n     * @param knowledgeElementAddReq 新增vo\n     * @return 新增是否成功\n     */\n    @Operation(summary \u003d \"新增知识库页面\")\n    @PostMapping(\"/add\")\n    @SysLog(module \u003d SystemModule.KB_PAGE, value \u003d \"新增空间页面，页面标题:\\\"#{ #title } \\\"，所属知识空间编码:\\\"#{ #spaceCode } \\\"，父页面编码:\\\"#{ #parentCode } \\\"\")\n    public Result\u003cKnowledgeElementTreeResp\u003e add(@Valid @RequestBody KnowledgeElementAddReq knowledgeElementAddReq) {\n        log.info(\"新增知识库页面,API:{}\", \"/kl/api/saas/element/add\");\n        log.info(\"新增知识库页面模块Vo:{}\", knowledgeElementAddReq.toString());\n        LogContext.putVariable(\"title\", knowledgeElementAddReq.getTitle());\n        LogContext.putVariable(\"spaceCode\", knowledgeElementAddReq.getSpaceCode());\n        LogContext.putVariable(\"parentCode\", knowledgeElementAddReq.getParentCode());\n        KnowledgeElementTypes types \u003d KnowledgeElementTypes.PAGE;\n        if (StrUtil.equalsIgnoreCase(knowledgeElementAddReq.getType(), KnowledgeElementTypes.EXCEL.name())) {\n            types \u003d KnowledgeElementTypes.EXCEL;\n            // 如果是excel，全部走oss，避免文件太大。\n        }\n        // 校验license，登录的时候校验\n        LicenseBootstrap.checkLicense();",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 211
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/web/BusinessDataSourceController.java",
      "timestamp": 1761236769709,
      "startOffset": 3824,
      "endOffset": 7379,
      "codeContent": "@RequestParam(value \u003d \"containerCode\", required \u003d false) String containerCode) {\n        log.info(\"统计数据源类型\u0026数量,API:{}\", \"/kl/api/saas/database/group\");\n        return businessDataSourceService.listCount(containerCode);\n    }\n    \n    /**\n     * 新增数据源\n     * @param businessDataSourceAddReq 新增vo\n     * @return 新增是否成功\n     */\n    @Operation(summary \u003d \"新增数据源\")\n    @PostMapping(\"/add\")\n    public Result\u003cString\u003e add(@Valid @RequestBody BusinessDataSourceAddReq businessDataSourceAddReq) {\n        log.info(\"新增数据源,API:{}\", \"/kl/api/saas/database/add\");\n        log.info(\"新增数据源模块Vo:{}\", businessDataSourceAddReq.toString());\n        return businessDataSourceService.add(businessDataSourceAddReq);\n    }\n    \n    /**\n     * 新增数据源\n     * @param businessDataSourceAddReq 新增vo\n     * @return 新增是否成功\n     */\n    @Operation(summary \u003d \"测试数据源连接是否可用\")\n    @PostMapping(\"/connect/test\")\n    public Result\u003cBoolean\u003e test(@Valid @RequestBody BusinessDataSourceTestConnectionReq businessDataSourceAddReq) {\n        log.info(\"测试数据源是否链接可用,API:{}\", \"/kl/api/saas/database/connect/test\");\n        return businessDataSourceService.testDs(businessDataSourceAddReq);\n    }\n    \n    /**\n     * 更新数据源\n     * @param businessDataSourceUpdateReq 更新vo（根据containerCode批量更新）\n     * @return 更新是否成功\n     */\n    @Operation(summary \u003d \"根据containerCode修改数据源\")\n    @PutMapping(\"/update\")\n    public Result\u003cString\u003e update(@Valid @RequestBody BusinessDataSourceUpdateReq businessDataSourceUpdateReq) {\n        log.info(\"修改数据源,API:{}\", \"/kl/api/saas/database/update\");\n        log.info(\"修改Vo:{}\", businessDataSourceUpdateReq.toString());\n        return businessDataSourceService.update(businessDataSourceUpdateReq);\n    }\n    \n    /**\n     * 根据containerCode查询数据源详情\n     * @param containerCode 容器编码\n     * @return 数据源详情列表\n     */\n    @Operation(summary \u003d \"根据containerCode查询数据源详情\")\n    @Parameter(name \u003d \"containerCode\", description \u003d \"容器编码\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/queryById\")\n    public Result\u003cList\u003cBusinessDataSourceResp\u003e\u003e queryById(@RequestParam(value \u003d \"containerCode\") String containerCode) {\n        log.info(\"根据containerCode查询数据源详情,API:{},containerCode:{}\", \"/kl/api/saas/database/queryById\", containerCode);\n        return businessDataSourceService.queryById(containerCode);\n    }\n    \n    /**\n     * 批量删除\n     * @param id 批量删除主键id,多个以逗号分隔,例如：id1,id2,id3\n     * @return 删除是否成功\n     */\n    @Operation(summary \u003d \"批量删除数据源\", description \u003d \"主键id字段多个以逗号分隔,例如：id1,id2,id3\")\n    @Parameter(name \u003d \"id\", description \u003d \"主键id\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @DeleteMapping(\"/deleteBatch\")\n    public Result\u003cString\u003e deleteBatch(@RequestParam(value \u003d \"id\") String id) {\n        log.info(\"根据主键id批量删除,API:{},ids:{}\", \"/kl/api/saas/database/deleteBatch\", id);\n        Assert.notNull(id, \"id不能为空\");\n        List\u003cInteger\u003e ids \u003d StrUtil.split(id, StrUtil.C_COMMA).stream().map(Integer::parseInt).collect(Collectors.toList());\n        return businessDataSourceService.delete(ids);\n    }\n    \n    /**\n     * 删除数据源\n     * @param containerCode 容器编码\n     * @return 删除是否成功\n     */\n    @Operation(summary \u003d \"根据containerCode删除数据源\")\n    @Parameter(name \u003d \"containerCode\", description \u003d \"容器编码\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @DeleteMapping(\"/delete\")\n    public Result\u003cString\u003e delete(@RequestParam(value \u003d \"containerCode\") String containerCode) {\n        log.info(\"删除数据源,API:{},ID:{}\", \"/kl/api/saas/database/delete\", containerCode);\n        Assert.notNull(containerCode, \"containerCode不能为空\");\n        return businessDataSourceService.delete(containerCode",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 83
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/repository/kb/page/mapper/KbPageEventMapper.java",
      "timestamp": 1761236769749,
      "startOffset": 757,
      "endOffset": 2821,
      "codeContent": "kb.page.model.dto.PageEventNameInfo;\nimport com.torchv.repository.kb.page.dto.PageEventUserInfo;\nimport com.torchv.repository.kb.page.entity.KbPageEvent;\nimport com.torchv.repository.kb.page.entity.KbUserPageFollowInfo;\nimport com.torchv.repository.kb.page.entity.KbUserPageFollowInfoSearch;\nimport org.apache.ibatis.annotations.Param;\n\nimport java.util.Date;\nimport java.util.List;\n\n/**\n * \u003cp\u003e\n * 页面事件行为明细表;对于Toggle类型的事件，放这里进行展示，如果是正向，那么插入一条数据，如果是反向，那么delete Mapper 接口\n * \u003c/p\u003e\n *\n * @author xiaoymin@foxmail.com\n * @since 2024-10-30\n */\npublic interface KbPageEventMapper extends BaseMapper\u003cKbPageEvent\u003e {\n\n    /**\n     * 查询页面事件用户信息\n     * @param tenantId 租户id\n     * @param pageCode 页面编码\n     * @param event 事件类型\n     * @return 用户信息列表\n     */\n    List\u003cPageEventUserInfo\u003e listEventUserInfo(@Param(\"tenantId\") String tenantId, @Param(\"pageCode\") String pageCode, @Param(\"event\") String event);\n    \n    \n    /**\n     * 获取用户关注页面编码\n     * @param pageCode 页面编码\n     * @param tenantId 租户id\n     * @param userCodes 用户编码\n     * @return 用户关注页面编码\n     */\n    List\u003cString\u003e filterFollowUserCode(@Param(\"pageCode\") String pageCode, @Param(\"tenantId\") String tenantId, @Param(\"userCodes\") List\u003cString\u003e userCodes);\n    \n    /**\n     * 获取用户关注页面编码\n     * @param pageCode 页面编码\n     * @param tenantId 租户id\n     * @param userCodes 用户编码\n     * @return 用户关注页面编码\n     */\n    List\u003cString\u003e filterFollowChildrenUserCode(@Param(\"pageCode\") String pageCode, @Param(\"tenantId\") String tenantId, @Param(\"userCodes\") List\u003cString\u003e userCodes);\n    /**\n     * 获取用户关注页面列表\n     * @param followInfoSearch 关注页面查询条件\n     * @return 用户关注页面列表\n     */\n    List\u003cKbUserPageFollowInfo\u003e listFollowPage(KbUserPageFollowInfoSearch followInfoSearch);\n    \n    /**\n     * 获取用户操作页面事件信息\n     * @param tenantId 租户id\n     * @param userCode 用户编码\n     * @return 用户浏览页面信息\n     */\n    List\u003cPageEventNameInfo\u003e listUserEvent(@Param(\"tenantId\") String tenantId, @Param(\"userCode\") String userCode, @Param(\"eventTypes\") List\u003cString\u003e eventTypes, @Param(\"eventLeaseTime\") Date date,@Param(\"creator\") Integer creator);\n    \n    ",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 63
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/web/BusinessDataSourceMetaController.java",
      "timestamp": 1761236769732,
      "startOffset": 1665,
      "endOffset": 4433,
      "codeContent": "\n/**\n * @author \u003ca href\u003d\"xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/7/16 20:28\n * @since torchv_server v1.7.8\n */\n@Slf4j\n@AllArgsConstructor\n@Tag(name \u003d \"数据源-Meta信息\")\n@RestController\n@RequestMapping(\"/kl/api/saas/database/meta\")\n@SaCheckPermission(value \u003d {\"RES_LLM_FILE\", \"RES_LLM_FILE_ADD\", \"RES_LLM_FILE_PREVIEW\", \"RES_LLM_FILE_ADD_BATCH\", \"RES_LLM_FILE_EDIT\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_CLI_ADMIN\"})\npublic class BusinessDataSourceMetaController {\n    \n    final BusinessDatasourceDynamicService businessDatasourceDynamicService;\n    \n    @Operation(summary \u003d \"分页查询该数据源下所有的表信息\")\n    @Parameters({\n            @Parameter(name \u003d \"dsId\", description \u003d \"数据源id\", required \u003d true, in \u003d ParameterIn.QUERY),\n            @Parameter(name \u003d \"pageNo\", description \u003d \"当前页码,默认1\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"1\"),\n            @Parameter(name \u003d \"pageSize\", description \u003d \"页码大小,默认10\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"10\")\n    })\n    @GetMapping(\"/tables\")\n    public Pagination\u003cDataTableResp\u003e tables(@RequestParam(value \u003d \"pageNo\", defaultValue \u003d \"1\") Integer pageNo,\n                                            @RequestParam(value \u003d \"pageSize\", defaultValue \u003d \"10\") Integer pageSize,\n                                            @RequestParam(value \u003d \"dsId\") Integer dsId) {\n        log.info(\"分页查询该数据源下所有的表信息,api:{}\", \"/kl/api/saas/database/meta/tables\");\n        return businessDatasourceDynamicService.list(pageNo, pageSize, dsId);\n    }\n    \n    @Operation(summary \u003d \"查询表的列信息\")\n    @Parameters({\n            @Parameter(name \u003d \"dsId\", description \u003d \"数据源id\", required \u003d true, in \u003d ParameterIn.QUERY),\n            @Parameter(name \u003d \"tableName\", description \u003d \"表名称\", required \u003d true, in \u003d ParameterIn.QUERY)\n    })\n    @GetMapping(\"/columns\")\n    public Result\u003cList\u003cDataTableColumnResp\u003e\u003e listColumns(@RequestParam(value \u003d \"dsId\") Integer dsId, @RequestParam(value \u003d \"tableName\") String tableName) {\n        log.info(\"查询表的列信息,api:{}\", \"/kl/api/saas/database/meta/columns\");\n        log.info(\"dsId:{},tableName:{}\", dsId, tableName);\n        return businessDatasourceDynamicService.listColumns(dsId, tableName);\n    }\n    \n    /**\n     * 执行查询SQL\n     * @param bodyReq 数据源\n     * @return 查询结果\n     */\n    @Operation(summary \u003d \"执行查询SQL\")\n    @PostMapping(\"/executeQuery\")\n    public Result\u003cDataSQLResp\u003e executeQuery(@RequestBody SQLExecuteBodyReq bodyReq) {\n        log.info(\"执行查询SQL,api:{}\", \"/kl/api/saas/database/meta/executeQuery\");\n        Integer pageNo \u003d bodyReq.getPageNo() !\u003d null ? bodyReq.getPageNo() : 1;\n        Integer pageSize \u003d bodyReq.getPageSize() !\u003d null ? bodyReq.getPageSize() : 10;\n        return businessDatasourceDynamicService.executeQuery(bodyReq.getDsId(), bodyReq.getSql(), pageNo, pageSize",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 54
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/application/knowledge/web/KnowledgeContainerController.java",
      "timestamp": 1761236769716,
      "startOffset": 905,
      "endOffset": 14261,
      "codeContent": "ContainerDataService;\nimport com.torchv.application.knowledge.domain.knowledge.KnowledgeModelService;\nimport com.torchv.application.knowledge.domain.knowledge.KnowledgeStatisticsService;\nimport com.torchv.application.knowledge.model.request.knowledge.*;\nimport com.torchv.application.knowledge.model.response.knowledge.KnowledgeContainerFollowResp;\nimport com.torchv.application.knowledge.model.response.knowledge.KnowledgeContainerResp;\nimport com.torchv.application.knowledge.model.response.knowledge.KnowledgeContainerTagResp;\nimport com.torchv.application.knowledge.model.response.knowledge.KnowledgeEmbeddingModelResp;\nimport com.torchv.common.constant.enums.system.SystemModule;\nimport com.torchv.common.context.UserContextHolder;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.infra.common.extra.log.LogContext;\nimport com.torchv.infra.common.extra.log.annotation.SysLog;\nimport com.torchv.infra.license.LicenseBootstrap;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\n\nimport cn.hutool.core.lang.Assert;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport org.springframework.web.bind.annotation.*;\n\nimport io.swagger.v3.oas.annotations.Operation;\nimport io.swagger.v3.oas.annotations.Parameter;\nimport io.swagger.v3.oas.annotations.Parameters;\nimport io.swagger.v3.oas.annotations.enums.ParameterIn;\nimport io.swagger.v3.oas.annotations.tags.Tag;\n\nimport com.torchv.application.knowledge.domain.knowledge.KnowledgeContainerService;\n\nimport jakarta.validation.Valid;\n\nimport java.util.List;\n\n/**\n * 知识库容器-接口API\n * @since torchv_server v0.1-beta.1\n * @author \u003ca href\u003d\"mailto:xiaoymin@foxmail.com\"\u003exiaoymin@foxmail.com\u003c/a\u003e\n * 2024/01/02 19:54\n */\n@Slf4j\n@AllArgsConstructor\n@Tag(name \u003d \"知识库容器\")\n@RestController\n@RequestMapping(\"/kl/api/saas/container\")\npublic class KnowledgeContainerController {\n\n    final KnowledgeContainerService knowledgeContainerService;\n    final KnowledgeStatisticsService knowledgeStatisticsService;\n    final KnowledgeModelService knowledgeModelService;\n    final KnowledgeContainerDataService knowledgeContainerDataService;\n    /**\n     * 获取所有支持的嵌入模型\n     * @return 嵌入模型列表\n     */\n    @Operation(summary \u003d \"获取所有支持的嵌入模型\")\n    @GetMapping(\"/embeddings/all\")\n    public Result\u003cList\u003cKnowledgeEmbeddingModelResp\u003e\u003e listAllEmbeddingModels() {\n        log.info(\"获取所有支持的嵌入模型,API:{}\", \"/kl/api/saas/container/embeddings/all\");\n        return knowledgeModelService.listAllSupportEmbeddingModels(UserContextHolder.getTenantId());\n    }\n    /**\n     * 获取所有支持的嵌入模型\n     * @return 嵌入模型列表\n     */\n    @Operation(summary \u003d \"获取所有支持的嵌入模型\")\n    @GetMapping(\"/embeddings\")\n    public Result\u003cList\u003cKnowledgeEmbeddingModelResp\u003e\u003e listEmbeddingModels() {\n        return knowledgeModelService.listAllSupportEmbeddingModels(UserContextHolder.getTenantId());\n    }\n    /**\n     * 分页查询知识库容器\n     * @param knowledgeContainerQueryReq 查询条件vo\n     * @param pageNo 当前页码\n     * @param pageSize 页码大小\n     * @return 分页列表\n     */\n    @Operation(summary \u003d \"分页查询知识库容器\")\n    @Parameters({\n            @Parameter(name \u003d \"pageNo\", description \u003d \"当前页码,默认1\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"1\"),\n            @Parameter(name \u003d \"pageSize\", description \u003d \"页码大小,默认10\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"10\")\n    })\n    @GetMapping(\"/list\")\n    public Pagination\u003cKnowledgeContainerResp\u003e list(KnowledgeContainerQueryReq knowledgeContainerQueryReq,\n                                                   @RequestParam(value \u003d \"pageNo\", defaultValue \u003d \"1\") Integer pageNo,\n                                                   @RequestParam(value \u003d \"pageSize\", defaultValue \u003d \"10\") Integer pageSize) {\n        log.info(\"分页查询知识库容器,API:{},page:{},size:{}\", \"/kl/api/saas/container/list\", pageNo, pageSize);\n        log.info(\"查询条件Vo:{}\", knowledgeContainerQueryReq.toString());\n        return knowledgeContainerService.list(knowledgeContainerQueryReq, pageNo, pageSize);\n    }\n\n    /**\n     * 统计\n     * @param statisticalReq 参数\n     * @return 统计数据\n     */\n    @Operation(summary \u003d \"统计知识库容量\")\n    @PutMapping(\"/statistical\")\n    public Result\u003cKnowledgeContainerResp\u003e statistical(@Valid @RequestBody KnowledgeContainerStatisticalReq statisticalReq) {\n        log.info(\"统计知识库容量,api:{}\", \"/kl/api/saas/container/statistical\");\n        return knowledgeStatisticsService.statistical(statisticalReq);\n    }\n\n    /**\n     * 新增知识库容器\n     * @param knowledgeContainerAddReq 新增vo\n     * @return 新增是否成功\n     */\n    @SaCheckPermission(value \u003d {\"RES_LLM_FILE\", \"RES_LLM_FILE_ADD\", \"RES_LLM_FILE_PREVIEW\", \"RES_LLM_FILE_ADD_BATCH\", \"RES_LLM_FILE_EDIT\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_CLI_ADMIN\"})\n    @Operation(summary \u003d \"新增知识库容器\")\n    @PostMapping(\"/add\")\n    @SysLog(module \u003d SystemModule.LLM_KNOWLEDGE, value \u003d \"新增知识库,名称:#{ #name }\")\n    public Result\u003cString\u003e add(@Valid @RequestBody KnowledgeContainerAddReq knowledgeContainerAddReq) throws JsonProcessingException {\n        log.info(\"新增知识库容器,API:{}\", \"/kl/api/saas/container/add\");\n        log.info(\"新增知识库容器模块Vo:{}\", knowledgeContainerAddReq.toString());\n        LogContext.putVariable(\"name\", knowledgeContainerAddReq.getName());\n        // 校验license，登录的时候校验\n        LicenseBootstrap.checkLicense();\n        return knowledgeContainerService.add(knowledgeContainerAddReq);\n    }\n\n    /**\n     * 新增个人知识库容器\n     * @return 新增是否成功\n     */\n    @SaCheckPermission(value \u003d {\"RES_LLM_FILE\", \"RES_LLM_FILE_ADD\", \"RES_LLM_FILE_PREVIEW\", \"RES_LLM_FILE_ADD_BATCH\", \"RES_LLM_FILE_EDIT\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_CLI_ADMIN\"})\n    @Operation(summary \u003d \"新增知识库容器\")\n    @GetMapping(\"/addPersonal\")\n    @SysLog(module \u003d SystemModule.LLM_KNOWLEDGE, value \u003d \"新增知识库,名称:#{ #name }\")\n    public Result\u003cString\u003e add() throws JsonProcessingException {\n        log.info(\"新增知识库容器,API:{}\", \"/kl/api/saas/container/addPersonal\");\n        // 校验license，登录的时候校验\n        LicenseBootstrap.checkLicense();\n        return knowledgeContainerService.addPersonal();\n    }\n\n    /**\n     * 校检个人知识库是否存在\n     * @return 是否存在\n     */\n    @SaCheckPermission(value \u003d {\"RES_LLM_FILE\", \"RES_LLM_FILE_ADD\", \"RES_LLM_FILE_PREVIEW\", \"RES_LLM_FILE_ADD_BATCH\", \"RES_LLM_FILE_EDIT\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_CLI_ADMIN\"})\n    @Operation(summary \u003d \"校检个人知识库是否存在\")\n    @GetMapping(\"/checkPersonal\")\n    @SysLog(module \u003d SystemModule.LLM_KNOWLEDGE, value \u003d \"校检个人知识库是否存在\")\n    public Result\u003cString\u003e check(){\n        log.info(\"新增知识库容器,API:{}\", \"/kl/api/saas/container/checkPersonal\");\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        return knowledgeContainerDataService.checkPersonal(sysUserInfo, true);\n    }\n    /**\n     * 更新知识库容器\n     * @param knowledgeContainerUpdateReq 更新vo\n     * @return 更新是否成功\n     */\n    @SaCheckPermission(value \u003d {\"RES_LLM_FILE\", \"RES_LLM_FILE_ADD\", \"RES_LLM_FILE_PREVIEW\", \"RES_LLM_FILE_ADD_BATCH\", \"RES_LLM_FILE_EDIT\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_CLI_ADMIN\"})\n    @Operation(summary \u003d \"修改知识库容器\")\n    @PutMapping(\"/update\")\n    @SysLog(module \u003d SystemModule.LLM_KNOWLEDGE, value \u003d \"编辑知识库,名称:#{ #name }\")\n    public Result\u003cString\u003e update(@Valid @RequestBody KnowledgeContainerUpdateReq knowledgeContainerUpdateReq) {\n        log.info(\"修改知识库容器,API:{}\", \"/kl/api/saas/container/update\");\n        log.info(\"修改Vo:{}\", knowledgeContainerUpdateReq.toString());\n        LogContext.putVariable(\"name\", knowledgeContainerUpdateReq.getName());\n        return knowledgeContainerService.update(knowledgeContainerUpdateReq);\n    }\n\n    @SaCheckPermission(value \u003d {\"RES_LLM_FILE\", \"RES_LLM_FILE_ADD\", \"RES_LLM_FILE_PREVIEW\", \"RES_LLM_FILE_ADD_BATCH\", \"RES_LLM_FILE_EDIT\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_CLI_ADMIN\"})\n    @Operation(summary \u003d \"移动知识库\")\n    @PutMapping(\"/move\")\n    @SysLog(module \u003d SystemModule.LLM_KNOWLEDGE, value \u003d \"移动知识库\")\n    public Result\u003cString\u003e move(@Valid @RequestBody KnowledgeContainerMoveReq moveReq) {\n        log.info(\"移动知识库,API:{}\", \"/kl/api/saas/container/move\");\n        log.info(\"移动知识库Vo:{}\", moveReq.toString());\n        return knowledgeContainerService.move(moveReq);\n    }\n\n    /**\n     * 根据id查询知识库容器详情\n     * @param id 主键id\n     * @return 知识库容器详情\n     */\n    @Operation(summary \u003d \"根据主键id查询知识库容器详情\")\n    @Parameter(name \u003d \"id\", description \u003d \"主键id\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/queryById\")\n    public Result\u003cKnowledgeContainerResp\u003e queryById(@RequestParam(value \u003d \"id\") Integer id) {\n        log.info(\"根据主键id查询知识库容器详情,API:{},主键id:{}\", \"/kl/api/saas/container/queryById\", id);\n        return knowledgeContainerService.queryById(id);\n    }\n\n    @Operation(summary \u003d \"根据code查询知识库容器详情\")\n    @Parameter(name \u003d \"code\", description \u003d \"code\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/queryByCode\")\n    public Result\u003cKnowledgeContainerResp\u003e queryByCode(@RequestParam(value \u003d \"code\") String code) {\n        log.info(\"根据code查询知识库容器详情,API:{},code:{}\", \"/kl/api/saas/container/queryByCode\", code);\n        return knowledgeContainerService.queryByCode(code);\n    }\n\n    @Operation(summary \u003d \"查询收藏状态\")\n    @Parameter(name \u003d \"code\", description \u003d \"code\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/queryFollowStatus\")\n    public Result\u003cKnowledgeContainerFollowResp\u003e queryFollowStatus(@RequestParam(value \u003d \"code\") String code) {\n        log.info(\"根据code查询知识库容器详情,API:{},code:{}\", \"/kl/api/saas/container/queryByCode\", code);\n        return knowledgeContainerService.queryFollowStatus(code);\n    }\n\n    @Operation(summary \u003d \"根据id查询知识库基础配置详情\")\n    @Parameter(name \u003d \"id\", description \u003d \"id\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/queryBasicInfoByCode\")\n    public Result\u003cKnowledgeContainerResp\u003e queryBasicInfoByCode(@RequestParam(value \u003d \"code\") String code) {\n        log.info(\"根据code查询知识库基础配置详情,API:{},code:{}\", \"/kl/api/saas/container/queryBasicInfoByCode\", code);\n        return knowledgeContainerService.queryBasicInfoByCode(code);\n    }\n\n    @Operation(summary \u003d \"根据id查询知识库基础配置详情\")\n    @Parameter(name \u003d \"id\", description \u003d \"id\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/queryBasicInfoById\")\n    public Result\u003cKnowledgeContainerResp\u003e queryBasicInfoById(@RequestParam(value \u003d \"id\") Integer id) {\n        log.info(\"根据id查询知识库基础配置详情,API:{},code:{}\", \"/kl/api/saas/container/queryBasicInfoById\", id);\n        return knowledgeContainerService.queryBasicInfoById(id);\n    }\n\n    @SaCheckPermission(value \u003d {\"RES_LLM_FILE\", \"RES_LLM_FILE_ADD\", \"RES_LLM_FILE_PREVIEW\", \"RES_LLM_FILE_ADD_BATCH\", \"RES_LLM_FILE_EDIT\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_CLI_ADMIN\"})\n    @Operation(summary \u003d \"更新知识库基础配置详情\")\n    @PutMapping(\"/updateBasicInfo\")\n    public Result\u003cString\u003e updateBasicInfo(@Valid @RequestBody KnowledgeContainerUpdateReq knowledgeContainerUpdateReq) {\n        log.info(\"根据code更新知识库基础配置详情,API:{},code:{}\", \"/kl/api/saas/container/updateBasicInfo\", knowledgeContainerUpdateReq);\n        return knowledgeContainerService.updateBasicInfo(knowledgeContainerUpdateReq);\n    }\n\n    @Operation(summary \u003d \"根据code查询当前知识库容器用户权限\" +\n            \"description \u003d \\\"权限类型，取值示例：MANAGE\u003d可管理，EDIT\u003d可编辑，VIEW_DOWNLOAD\u003d可查看/下载，VIEW_ONLY\u003d仅可查看\\\"\")\n    @Parameter(name \u003d \"code\", description \u003d \"code\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @GetMapping(\"/queryPermissionByCode\")\n    public Result\u003cString\u003e queryPermissionByCode(@RequestParam(value \u003d \"code\") String code,@RequestParam(value \u003d \"elementCode\",required \u003d false) String elementCode) {\n        log.info(\"根据code查询当前知识库容器用户权限,API:{},code:{},elementCode:{}\", \"/kl/api/saas/container/queryPermissionByCode\", code,elementCode);\n        return knowledgeContainerService.queryPermissionByCode(code,elementCode);\n    }\n\n    @Operation(summary \u003d \"统计查询知识库标签信息-列表\")\n    @Parameters({\n            @Parameter(name \u003d \"pageNo\", description \u003d \"当前页码,默认1\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"1\"),\n            @Parameter(name \u003d \"pageSize\", description \u003d \"页码大小,默认10\", required \u003d true, in \u003d ParameterIn.QUERY, example \u003d \"10\"),\n            @Parameter(name \u003d \"name\", description \u003d \"名称\", in \u003d ParameterIn.QUERY)\n    })\n    @GetMapping(\"/tags\")\n    public Pagination\u003cKnowledgeContainerTagResp\u003e tags(@RequestParam(value \u003d \"name\", required \u003d false) String name,\n                                                      @RequestParam(value \u003d \"pageNo\", defaultValue \u003d \"1\") Integer pageNo,\n                                                      @RequestParam(value \u003d \"pageSize\", defaultValue \u003d \"10\") Integer pageSize) {\n        log.info(\"统计查询知识库标签信息-列表,API:{}\", \"/kl/api/saas/container/tags\");\n        return knowledgeContainerService.listTag(name, pageNo, pageSize);\n    }\n\n    /**\n     * 删除知识库容器\n     * @param id 主键id\n     * @return 删除是否成功\n     */\n    @SaCheckPermission(value \u003d {\"RES_LLM_FILE\", \"RES_LLM_FILE_ADD\", \"RES_LLM_FILE_PREVIEW\", \"RES_LLM_FILE_ADD_BATCH\", \"RES_LLM_FILE_EDIT\"}, mode \u003d SaMode.OR, orRole \u003d {\"SYS_ROLE_CLI_ADMIN\"})\n    @Operation(summary \u003d \"删除知识库容器\")\n    @Parameter(name \u003d \"id\", description \u003d \"主键id\", required \u003d true, in \u003d ParameterIn.QUERY)\n    @DeleteMapping(\"/delete\")\n    @SysLog(module \u003d SystemModule.LLM_KNOWLEDGE, value \u003d \"删除知识库,名称:#{ #name }\")\n    public Result\u003cString\u003e delete(@RequestParam(value \u003d \"id\") Integer id) {\n        log.info(\"删除知识库容器,API:{},ID:{}\", \"/kl/api/saas/container/delete\", id);\n        Assert.notNull(id, \"system.common.null.id\");\n        return knowledgeContainerService.delete(id);\n    }\n",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 267
    },
    {
      "filePath": "E:/Project/hzmj/ais-server/src/main/java/com/torchv/kb/admin/service/impl/KbThirdPartServiceImpl.java",
      "timestamp": 1761236769898,
      "startOffset": 1697,
      "endOffset": 27851,
      "codeContent": "infra.common.external.queue.RabbitMessageService;\nimport com.torchv.common.model.Pagination;\nimport com.torchv.common.model.Result;\nimport com.torchv.common.model.session.SysUserInfo;\nimport com.torchv.kb.admin.model.event.DepartmentThirdPartImportMessage;\nimport com.torchv.kb.admin.model.request.KbConfigThirdPartReq;\nimport com.torchv.kb.admin.model.response.*;\nimport com.torchv.kb.admin.service.KbThirdPartService;\nimport com.torchv.kb.common.constant.KbAsyncTasksStatusTypes;\nimport com.torchv.kb.common.constant.KbEventMessageTypes;\nimport com.torchv.kb.common.model.KbEventMessageCallbackDTO;\nimport com.torchv.repository.kb.system.entity.KbAsyncTasksStatus;\nimport com.torchv.repository.kb.system.mapper.KbAsyncTasksStatusMapper;\nimport com.torchv.repository.kb.thirdPartImport.entity.KbThirdPartDingTalk;\nimport com.torchv.repository.kb.thirdPartImport.entity.KbThirdPartImportConfig;\nimport com.torchv.repository.kb.thirdPartImport.mapper.KbThirdPartDingTalkMapper;\nimport com.torchv.repository.kb.thirdPartImport.mapper.KbThirdPartImportConfigMapper;\nimport com.torchv.infra.web.i18n.I18nMessage;\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.commons.lang3.StringUtils;\nimport org.redisson.api.RLock;\nimport org.redisson.api.RedissonClient;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport java.time.LocalDateTime;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.Objects;\n\n/**\n * 第三方平台导入\n *\n * @author liuchuan\u003ca href \u003d \" lanhaichen2021 @ gmail.com \"\u003elanhaichen2021@gmail.com\u003c/a\u003e\n * 1/2/25 13:38\n * @since torchv_server kb-v0.0.1\n */\n@Slf4j\n@AllArgsConstructor\n@Service\npublic class KbThirdPartServiceImpl extends ServiceImpl\u003cKbThirdPartImportConfigMapper, KbThirdPartImportConfig\u003e implements KbThirdPartService {\n\n    final KbAsyncTasksStatusMapper kbAsyncTasksStatusMapper;\n    final RabbitMessageService rabbitMessageService;\n    final KbThirdPartImportConfigMapper kbThirdPartImportConfigMapper;\n    final KbThirdPartDingTalkMapper kbThirdPartDingTalkMapper;\n    final I18nMessage i18nMessage;\n    final RedisTemplate\u003cString, String\u003e redisTemplate;\n    final RedissonClient redissonClient;\n\n    /**\n     * 验证钉钉API权限\n     *\n     * @param appKey    钉钉应用的AppKey\n     * @param appSecret 钉钉应用的AppSecret\n     * @throws RuntimeException 当权限验证失败时抛出异常\n     */\n    public void validateDingTalkPermissions(String appKey, String appSecret) {\n        // 定义请求客户端\n        DingTalkClient tokenClient \u003d new DefaultDingTalkClient(\"https://oapi.dingtalk.com/gettoken\");\n        DingTalkClient subDepClient \u003d new DefaultDingTalkClient(\"https://oapi.dingtalk.com/topapi/v2/department/listsubid\");\n        DingTalkClient userClient \u003d new DefaultDingTalkClient(\"https://oapi.dingtalk.com/topapi/v2/user/list\");\n\n        // 1. 获取token\n        OapiGettokenRequest req \u003d new OapiGettokenRequest();\n        req.setAppkey(appKey);\n        req.setAppsecret(appSecret);\n        req.setHttpMethod(\"GET\");\n\n        OapiGettokenResponse rsp;\n        try {\n            rsp \u003d tokenClient.execute(req);\n        } catch (Exception e) {\n            throw new RuntimeException(i18nMessage.resolveMessage(\"kb.system.department.sync.get.access.token\"));\n        }\n        Assert.equals(rsp.getErrcode(), 0L, i18nMessage.resolveMessage(\"kb.system.department.sync.get.access.token\"));\n        Assert.notNull(rsp.getAccessToken(), i18nMessage.resolveMessage(\"kb.system.department.sync.get.access.token\"));\n        String accessToken \u003d rsp.getAccessToken();\n\n        // 2. 测试部门信息读权限\n        OapiV2DepartmentListsubidRequest reqDepList \u003d new OapiV2DepartmentListsubidRequest();\n        reqDepList.setDeptId(1L);\n        OapiV2DepartmentListsubidResponse rspDepList \u003d null;\n        try {\n            rspDepList \u003d subDepClient.execute(reqDepList, accessToken);\n        } catch (ApiException e) {\n            throw new RuntimeException(e);\n        }\n        Assert.equals(rspDepList.getErrcode(), 0L, rspDepList.getMsg());\n\n        // 3. 测试部门成员读权限\n        OapiV2UserListRequest userReq \u003d new OapiV2UserListRequest();\n        userReq.setDeptId(1L);\n        userReq.setCursor(0L);\n        userReq.setSize(1L);\n        OapiV2UserListResponse userRsp \u003d null;\n        try {\n            userRsp \u003d userClient.execute(userReq, accessToken);\n        } catch (Exception e) {\n            throw new RuntimeException(i18nMessage.resolveMessage(\"kb.system.department.sync.get.department.user\"));\n        }\n        Assert.equals(userRsp.getErrcode(), 0L, i18nMessage.resolveMessage(\"kb.system.department.sync.get.department.user\"));\n        // 4. 测试手机号和个人信息权限\n        List\u003cOapiV2UserListResponse.ListUserResponse\u003e list \u003d userRsp.getResult().getList();\n\n        // Assert.isTrue(CollUtil.isNotEmpty(list), i18nMessage.resolveMessage(\"kb.system.department.sync.get.department.user\"));\n        // OapiV2UserListResponse.ListUserResponse userResponse \u003d list.get(0);\n        // // mobile字段，如果没有开通的情况下，钉钉接口不回返回，直接校验这个字段即可。\n        // Assert.isTrue(StrUtil.isNotBlank(userResponse.getMobile()), i18nMessage.resolveMessage(\"kb.system.department.sync.null.user\"));\n        // 用户根部门下不一定有用户，故为空就不判断\n        if (CollUtil.isNotEmpty(list)) {\n            OapiV2UserListResponse.ListUserResponse userResponse \u003d list.get(0);\n            // mobile字段，如果没有开通的情况下，钉钉接口不回返回，直接校验这个字段即可。\n            Assert.isTrue(StrUtil.isNotBlank(userResponse.getMobile()), i18nMessage.resolveMessage(\"kb.system.department.sync.null.user\"));\n        }\n\n        /**\n         UserImport foundUser \u003d null;\n         // 获取部门id列表，用于尝试获取一个用户\n         List\u003cLong\u003e depIdList \u003d rspDepList.getResult().getDeptIdList();\n         for (Long depId : depIdList) {\n         OapiV2UserListRequest reqUser \u003d new OapiV2UserListRequest();\n         reqUser.setDeptId(depId);\n         reqUser.setCursor(0L);\n         reqUser.setSize(10L);\n         reqUser.setOrderField(\"modify_desc\");\n         // 是否返回访问受限的员工\n         reqUser.setContainAccessLimit(false);\n         reqUser.setLanguage(\"zh_CN\");\n         OapiV2UserListResponse rspUser \u003d null;\n         try {\n         rspUser \u003d userClient.execute(reqUser, accessToken);\n         } catch (ApiException e) {\n         throw new RuntimeException(e);\n         }\n         List\u003cUserImport\u003e userInfoByDepId \u003d rspUser.getResult().getList().stream()\n         .filter(Objects::nonNull)\n         .map(userInfo -\u003e {\n         UserImport userImport \u003d UserImport.builder().build();\n         BeanUtils.copyProperties(userInfo, userImport);\n         userImport.setDeptIdList(new ArrayList\u003c\u003e());\n         userInfo.getDeptIdList().forEach(deptId -\u003e {\n         userImport.getDeptIdList().add(deptId);\n         });\n         return userImport;\n         }).toList();\n\n         if (!userInfoByDepId.isEmpty()) {\n         foundUser \u003d userInfoByDepId.get(0);\n         break;\n         }\n\n         // 遍历子部门\n         OapiV2DepartmentListsubidRequest reqSubDepList \u003d new OapiV2DepartmentListsubidRequest();\n         reqSubDepList.setDeptId(depId);\n         OapiV2DepartmentListsubidResponse rspSubDepLst \u003d null;\n         try {\n         rspSubDepLst \u003d subDepClient.execute(reqSubDepList, accessToken);\n         } catch (Exception e) {\n         throw new RuntimeException(e);\n         }\n         depIdList.addAll(rspSubDepLst.getResult().getDeptIdList());\n         }\n\n         if (foundUser !\u003d null) {\n         Assert.notNull(foundUser.getMobile(), i18nMessage.resolveMessage(\"kb.system.department.sync.get.user.tel\"));\n         } else {\n         throw new RuntimeException(i18nMessage.resolveMessage(\"kb.system.department.sync.null.user\"));\n         }**/\n\n    }\n\n    /**\n     * 配置第三方平台\n     *\n     * @param kbConfigThirdPartReq\n     * @return\n     */\n    @Override\n    public Result\u003cBoolean\u003e configThirdPart(KbConfigThirdPartReq kbConfigThirdPartReq) {\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        String userCode \u003d sysUserInfo.getCode();\n        String tenantId \u003d sysUserInfo.getTenantId();\n\n        String key \u003d Cns.LOCK_KNOWLEDGE_KEY + tenantId;\n        RLock rLock \u003d redissonClient.getLock(key);\n        try {\n            // 1. 判断渠道\n            Platforms platforms \u003d Platforms.of(kbConfigThirdPartReq.getThirdPartPlatformName());\n            switch (Objects.requireNonNull(platforms)) {\n                case DING_TALK -\u003e {\n                    // 2. 验证钉钉应用权限\n                    validateDingTalkPermissions(\n                            kbConfigThirdPartReq.getThirdPartPlatformId(),\n                            kbConfigThirdPartReq.getThirdPartPlatformSecret());\n\n                    // 3. 判断更新/新增\n                    KbThirdPartImportConfig existConfig \u003d kbThirdPartImportConfigMapper.selectOne(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaQuery().eq(KbThirdPartImportConfig::getTenantId, tenantId));\n                    KbThirdPartDingTalk existDingTalk \u003d kbThirdPartDingTalkMapper.selectOne(Wrappers.\u003cKbThirdPartDingTalk\u003elambdaQuery().eq(KbThirdPartDingTalk::getTenantId, tenantId));\n                    // 4.1 新增\n                    if (ObjectUtil.isNull(existDingTalk) \u0026\u0026 ObjectUtil.isNull(existConfig)) {\n                        existDingTalk \u003d KbThirdPartDingTalk.builder()\n                                .createTime(LocalDateTime.now())\n                                .creator(userCode)\n                                .modifierTime(LocalDateTime.now())\n                                .modifier(userCode)\n                                .tenantId(tenantId)\n                                .dingtalkId(kbConfigThirdPartReq.getThirdPartPlatformId())\n                                .dingtalkSecret(kbConfigThirdPartReq.getThirdPartPlatformSecret())\n                                .build();\n                        existConfig \u003d KbThirdPartImportConfig.builder()\n                                .createTime(LocalDateTime.now())\n                                .creator(userCode)\n                                .modifierTime(LocalDateTime.now())\n                                .modifier(userCode)\n                                .tenantId(tenantId)\n                                .thirdPartName(Platforms.DING_TALK.name())\n                                .build();\n\n                        kbThirdPartDingTalkMapper.insert(existDingTalk);\n                        kbThirdPartImportConfigMapper.insert(existConfig);\n                    }\n                    // 4.2 更新\n                    else if (ObjectUtil.isNotNull(existConfig) \u0026\u0026 ObjectUtil.isNotNull(existDingTalk)) {\n                        existDingTalk.setModifier(userCode);\n                        existDingTalk.setModifierTime(LocalDateTime.now());\n                        existDingTalk.setDingtalkId(kbConfigThirdPartReq.getThirdPartPlatformId());\n                        existDingTalk.setDingtalkSecret(kbConfigThirdPartReq.getThirdPartPlatformSecret());\n                        kbThirdPartDingTalkMapper.updateById(existDingTalk);\n                        // 4.3 用户试图绑定多个平台\n                    } else if (ObjectUtil.isNotNull(existConfig) \u0026\u0026 ObjectUtil.isNull(existDingTalk)) {\n                        throw new RuntimeException(i18nMessage.resolveMessage(\"kb.system.department.sync.repeat.platform\"));\n                        // 4.4 用户数据损坏，重建config\n                    } else if (ObjectUtil.isNull(existConfig) \u0026\u0026 ObjectUtil.isNotNull(existDingTalk)) {\n                        existConfig \u003d KbThirdPartImportConfig.builder()\n                                .createTime(LocalDateTime.now())\n                                .creator(userCode)\n                                .modifierTime(LocalDateTime.now())\n                                .modifier(userCode)\n                                .tenantId(tenantId)\n                                .thirdPartName(Platforms.DING_TALK.name())\n                                .build();\n\n                        existDingTalk.setModifier(userCode);\n                        existDingTalk.setModifierTime(LocalDateTime.now());\n                        existDingTalk.setDingtalkId(kbConfigThirdPartReq.getThirdPartPlatformId());\n                        existDingTalk.setDingtalkSecret(kbConfigThirdPartReq.getThirdPartPlatformSecret());\n\n                        kbThirdPartDingTalkMapper.updateById(existDingTalk);\n                        kbThirdPartImportConfigMapper.insert(existConfig);\n                    }\n                }\n                default -\u003e throw new RuntimeException(i18nMessage.resolveMessage(\"kb.system.department.sync.unsupported.platform\"));\n            }\n        } catch (Exception e) {\n            throw new RuntimeException(e.getMessage());\n        } finally {\n            // 释放分布式锁\n            if (rLock !\u003d null \u0026\u0026 rLock.isLocked()) {\n                rLock.unlock();\n                log.info(\"free thirdPartImportConfig lock successful...\");\n            }\n        }\n        return Result.success(Boolean.TRUE);\n    }\n\n    @Override\n    public Result\u003cKbThirdPartGetConfigResp\u003e getThirdPartConfig() {\n        SysUserInfo sysUserInfo \u003d UserContextHolder.getCurrentUser();\n        String tenantId \u003d sysUserInfo.getTenantId();\n        KbThirdPartImportConfig kbThirdPartImportConfig \u003d kbThirdPartImportConfigMapper.selectOne(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaQuery().eq(KbThirdPartImportConfig::getTenantId, tenantId));\n        Assert.notNull(kbThirdPartImportConfig, \"kb.system.department.sync.null.config\");\n        String thirdPartName \u003d kbThirdPartImportConfig.getThirdPartName();\n        switch (Platforms.valueOf(thirdPartName)) {\n            case DING_TALK -\u003e {\n                KbThirdPartDingTalk existDingTalk \u003d kbThirdPartDingTalkMapper.selectOne(Wrappers.\u003cKbThirdPartDingTalk\u003elambdaQuery().eq(KbThirdPartDingTalk::getTenantId, tenantId), false);\n                Assert.notNull(existDingTalk, \"kb.system.department.sync.null.config\");\n                KbThirdPartGetConfigResp dingTalkResp \u003d new KbThirdPartGetConfigResp();\n                dingTalkResp.setPlatformName(Platforms.DING_TALK.name());\n                dingTalkResp.setDingtalkId(existDingTalk.getDingtalkId());\n                dingTalkResp.setDingtalkSecret(existDingTalk.getDingtalkSecret());\n                return Result.data(dingTalkResp);\n            }\n            default -\u003e throw new RuntimeException(i18nMessage.resolveMessage(\"kb.system.department.sync.unsupported.platform\"));\n        }\n\n    }\n\n    /**\n     * 第三方平台导入组织架构\n     *\n     * @return 是否成功\n     */\n    @Override\n    public Result\u003cKbDepartmentKbThirdPartImportResp\u003e thirdPartImport() {\n        log.info(\"第三方平台导入组织架构\");\n        SysUserInfo currentUser \u003d UserContextHolder.getCurrentUser();\n        String tenantId \u003d currentUser.getTenantId();\n        String currentUserCode \u003d currentUser.getCode();\n\n        // 1. 清理超时的进行中任务（30分钟超时）\n        cleanUpStuckTasks(tenantId, currentUserCode);\n\n        // 2. 查询当前租户是否有任务正在进行中\n        KbAsyncTasksStatus asyncTasksStatus \u003d kbAsyncTasksStatusMapper.selectOne(Wrappers.\u003cKbAsyncTasksStatus\u003elambdaQuery()\n                // 单任务类型\n                .eq(KbAsyncTasksStatus::getType, KbEventMessageTypes.EVENT_ThirdPartImport.name())\n                // 租户ID\n                .eq(KbAsyncTasksStatus::getTenantId, tenantId)\n                .in(KbAsyncTasksStatus::getStatus, Arrays.asList(\n                        KbAsyncTasksStatusTypes.PENDING.getStatus(),\n                        KbAsyncTasksStatusTypes.IN_PROGRESS.getStatus())));\n        Assert.isNull(asyncTasksStatus, \"kb.system.task.sync.in_progress\");\n\n        // 3. 查询对应租户,判断是否满足\n        KbThirdPartImportConfig kbThirdPartImportConfig \u003d kbThirdPartImportConfigMapper.selectOne(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaQuery().eq(KbThirdPartImportConfig::getTenantId, tenantId));\n        Assert.notNull(kbThirdPartImportConfig, \"kb.system.department.sync.null.config\");\n        String platformName \u003d kbThirdPartImportConfig.getThirdPartName();\n\n        switch (Objects.requireNonNull(Platforms.of(platformName))) {\n            case DING_TALK -\u003e {\n                KbThirdPartDingTalk kbThirdPartDingTalk \u003d kbThirdPartDingTalkMapper.selectOne(Wrappers.\u003cKbThirdPartDingTalk\u003elambdaQuery().eq(KbThirdPartDingTalk::getTenantId, tenantId));\n                String id \u003d kbThirdPartDingTalk.getDingtalkId();\n                String secret \u003d kbThirdPartDingTalk.getDingtalkSecret();\n                // 4. 保存任务状态\n                String taskId \u003d IdUtil.getSnowflakeNextIdStr();\n                kbAsyncTasksStatusMapper.insert(KbAsyncTasksStatus.builder()\n                        .creator(currentUserCode)\n                        .createTime(LocalDateTime.now())\n                        .modifierTime(LocalDateTime.now())\n                        .modifier(currentUserCode)\n                        .type(KbEventMessageTypes.EVENT_ThirdPartImport.name())\n                        .status(KbAsyncTasksStatusTypes.PENDING.getStatus())\n                        .code(taskId)\n                        .tenantId(tenantId)\n                        .description(Platforms.DING_TALK.name())\n                        .build());\n\n                // 5. 发送异步消息\n                DepartmentThirdPartImportMessage commonEvent \u003d DepartmentThirdPartImportMessage.of(tenantId, currentUserCode, platformName, id, secret, taskId);\n                KbEventMessageCallbackDTO callbackDTO \u003d KbEventMessageCallbackDTO.of(KbEventMessageTypes.EVENT_ThirdPartImport, commonEvent);\n                rabbitMessageService.sendKbThirdPartImportMessage(callbackDTO);\n                // 6. 返回任务Id\n                return Result.success(new KbDepartmentKbThirdPartImportResp(taskId));\n            }\n            default -\u003e throw new RuntimeException(i18nMessage.resolveMessage(\"kb.system.department.sync.unsupported.platform\"));\n        }\n    }\n\n    @Override\n    public Result\u003cKbDepartmentQueryProcessResp\u003e processQuery(String taskId) {\n        String key \u003d Cns.IMPORT_PROGRESS_KEY_PREFIX + taskId;\n        String progress \u003d redisTemplate.opsForValue().get(key);\n        if (StringUtils.isBlank(progress)) {\n            return Result.success(new KbDepartmentQueryProcessResp(\"0\", KbAsyncTasksStatusTypes.PENDING.getDesc()));\n        }\n        String[] split \u003d progress.split(\":\");\n        return Result.success(new KbDepartmentQueryProcessResp(split[0], split[1]));\n    }\n\n    @Override\n    public Result\u003cBoolean\u003e thirdPartImportVerify(KbConfigThirdPartReq kbConfigThirdPartReq) {\n        Platforms platforms \u003d Platforms.of(kbConfigThirdPartReq.getThirdPartPlatformName());\n        switch (Objects.requireNonNull(platforms)) {\n            case DING_TALK -\u003e {\n                // 验证钉钉应用权限\n                validateDingTalkPermissions(\n                        kbConfigThirdPartReq.getThirdPartPlatformId(),\n                        kbConfigThirdPartReq.getThirdPartPlatformSecret());\n            }\n            default -\u003e throw new RuntimeException(i18nMessage.resolveMessage(\"kb.system.department.sync.unsupported.platform\"));\n        }\n\n        return Result.success(Boolean.TRUE);\n    }\n\n    @Override\n    public Result\u003cKbThirdPartConfigIsResp\u003e thirdPartConfigIs() {\n        String tenantId \u003d UserContextHolder.getTenantId();\n        KbThirdPartImportConfig kbThirdPartImportConfig \u003d kbThirdPartImportConfigMapper.selectOne(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaQuery().eq(KbThirdPartImportConfig::getTenantId, tenantId));\n        KbThirdPartConfigIsResp kbThirdPartConfigIsResp \u003d new KbThirdPartConfigIsResp();\n        if (ObjectUtil.isNull(kbThirdPartImportConfig)) {\n            kbThirdPartConfigIsResp.setConfigIs(false);\n        } else {\n            kbThirdPartConfigIsResp.setConfigIs(true);\n            kbThirdPartConfigIsResp.setPlatformName(kbThirdPartImportConfig.getThirdPartName());\n        }\n        return Result.success(kbThirdPartConfigIsResp);\n    }\n\n    @Transactional\n    @Override\n    public Result\u003cBoolean\u003e deleteConfig() {\n        String tenantId \u003d UserContextHolder.getTenantId();\n        KbThirdPartImportConfig kbThirdPartImportConfig \u003d kbThirdPartImportConfigMapper.selectOne(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaQuery().eq(KbThirdPartImportConfig::getTenantId, tenantId));\n        if (ObjectUtil.isNotNull(kbThirdPartImportConfig)) {\n            kbThirdPartImportConfigMapper.deleteById(kbThirdPartImportConfig);\n            String thirdPartName \u003d kbThirdPartImportConfig.getThirdPartName();\n            if (Objects.equals(thirdPartName, Platforms.DING_TALK.name())) {\n                kbThirdPartDingTalkMapper.delete(Wrappers.\u003cKbThirdPartDingTalk\u003elambdaQuery().eq(KbThirdPartDingTalk::getTenantId, tenantId));\n            }\n        }\n        return Result.success(Boolean.TRUE);\n    }\n\n    @Override\n    public Pagination\u003cKbThirdPartImportTaskHistoryResp\u003e taskHistory(Integer pageNo, Integer pageSize) {\n        String tenantId \u003d UserContextHolder.getTenantId();\n        try (Page\u003cKbAsyncTasksStatus\u003e page \u003d PageHelper.startPage(pageNo, pageSize)) {\n            List\u003cKbThirdPartImportTaskHistoryResp\u003e resList \u003d new ArrayList\u003c\u003e();\n            List\u003cKbAsyncTasksStatus\u003e taskList \u003d kbAsyncTasksStatusMapper.selectList(Wrappers.\u003cKbAsyncTasksStatus\u003elambdaQuery()\n                    .eq(KbAsyncTasksStatus::getTenantId, tenantId)\n                    .eq(KbAsyncTasksStatus::getType, KbEventMessageTypes.EVENT_ThirdPartImport.name())\n                    .orderByDesc(KbAsyncTasksStatus::getModifierTime));\n            if (CollUtil.isNotEmpty(taskList)) {\n                taskList.forEach(task -\u003e {\n                    KbThirdPartImportTaskHistoryResp res \u003d new KbThirdPartImportTaskHistoryResp();\n                    KbAsyncTasksStatusTypes taskStatus \u003d KbAsyncTasksStatusTypes.of(task.getStatus());\n                    // 如果数据库出现了未知的任务类型，标记为失败\n                    if (ObjectUtil.isNotNull(taskStatus)) {\n                        res.setStatus(taskStatus.getDesc());\n                    } else {\n                        log.warn(\"未知的任务类型：{}\", task.getStatus());\n                        res.setStatus(KbAsyncTasksStatusTypes.FAILED.getDesc());\n                    }\n                    String description \u003d task.getDescription();\n                    switch (Objects.requireNonNull(Platforms.of(description))) {\n                        case DING_TALK -\u003e res.setPlatformName(\"钉钉\");\n                        case LARK -\u003e res.setPlatformName(\"飞书\");\n                        default -\u003e throw new RuntimeException(i18nMessage.resolveMessage(\"kb.system.department.sync.unsupported.platform\"));\n                    }\n                    res.setStartTime(task.getCreateTime());\n                    res.setEndTime(task.getModifierTime());\n                    resList.add(res);\n                });\n            }\n            return Pagination.pagination(resList, page.getTotal(), pageNo, pageSize);\n        }\n    }\n\n    @Override\n    public Result\u003cKbThirdPartImportTaskHistoryResp\u003e lastTask() {\n        String tenantId \u003d UserContextHolder.getTenantId();\n        // 1. 找当前配置的平台\n        KbThirdPartImportConfig kbThirdPartImportConfig \u003d kbThirdPartImportConfigMapper.selectOne(Wrappers.\u003cKbThirdPartImportConfig\u003elambdaQuery().eq(KbThirdPartImportConfig::getTenantId, tenantId));\n        Assert.notNull(kbThirdPartImportConfig, \"kb.system.department.sync.null.config\");\n\n        // 2. 查当前平台的最后一次任务\n        KbAsyncTasksStatus lastTask \u003d kbAsyncTasksStatusMapper.selectOne(Wrappers.\u003cKbAsyncTasksStatus\u003elambdaQuery()\n                .eq(KbAsyncTasksStatus::getTenantId, tenantId)\n                .eq(KbAsyncTasksStatus::getType, KbEventMessageTypes.EVENT_ThirdPartImport.name())\n                .eq(KbAsyncTasksStatus::getDescription, kbThirdPartImportConfig.getThirdPartName())\n                .in(KbAsyncTasksStatus::getStatus, KbAsyncTasksStatusTypes.FAILED.getStatus(), KbAsyncTasksStatusTypes.COMPLETED.getStatus())\n                .orderByDesc(KbAsyncTasksStatus::getModifierTime)\n                .last(\"LIMIT 1\"));\n\n        KbThirdPartImportTaskHistoryResp res \u003d new KbThirdPartImportTaskHistoryResp();\n        if (ObjectUtil.isNotNull(lastTask)) {\n            res.setStatus(lastTask.getStatus());\n            res.setEndTime(lastTask.getModifierTime());\n            res.setPlatformName(lastTask.getDescription());\n        }\n\n        return Result.data(res);\n    }\n\n    /**\n     * 清理超时的进行中任务\n     *\n     * @param tenantId 租户ID\n     * @param currentUserCode 当前用户代码\n     */\n    private void cleanUpStuckTasks(String tenantId, String currentUserCode) {\n        try {\n            // 查找超过30分钟仍处于PENDING或IN_PROGRESS状态的任务\n            LocalDateTime timeoutThreshold \u003d LocalDateTime.now().minusMinutes(30);\n\n            List\u003cKbAsyncTasksStatus\u003e stuckTasks \u003d kbAsyncTasksStatusMapper.selectList(Wrappers.\u003cKbAsyncTasksStatus\u003elambdaQuery()\n                    .eq(KbAsyncTasksStatus::getType, KbEventMessageTypes.EVENT_ThirdPartImport.name())\n                    .eq(KbAsyncTasksStatus::getTenantId, tenantId)\n                    .in(KbAsyncTasksStatus::getStatus, Arrays.asList(\n                            KbAsyncTasksStatusTypes.PENDING.getStatus(),\n                            KbAsyncTasksStatusTypes.IN_PROGRESS.getStatus()))\n                    .lt(KbAsyncTasksStatus::getCreateTime, timeoutThreshold));\n\n            if (CollUtil.isNotEmpty(stuckTasks)) {\n                log.info(\"发现{}个超时的进行中任务，开始清理\", stuckTasks.size());\n\n                for (KbAsyncTasksStatus stuckTask : stuckTasks) {\n                    // 更新任务状态为失败\n                    kbAsyncTasksStatusMapper.update(Wrappers.\u003cKbAsyncTasksStatus\u003elambdaUpdate()\n                            .eq(KbAsyncTasksStatus::getId, stuckTask.getId())\n                            .set(KbAsyncTasksStatus::getStatus, KbAsyncTasksStatusTypes.FAILED.getStatus())\n                            .set(KbAsyncTasksStatus::getModifier, currentUserCode)\n                            .set(KbAsyncTasksStatus::getModifierTime, LocalDateTime.now()));\n\n                    // 清理Redis中的进度信息\n                    String progressKey \u003d Cns.IMPORT_PROGRESS_KEY_PREFIX + stuckTask.getCode();\n                    redisTemplate.delete(progressKey);\n\n                    log.info(\"已清理超时任务：{}，状态更新为失败\", stuckTask.getCode());\n                }\n            }\n        } catch (Exception e) {\n            log.error(\"清理超时任务时发生异常\", e);\n            // 清理失败不应该影响正常的导入流程，只记录日志\n        }",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 510
    },
    {
      "filePath": "E:/Project/GitHub/PandaCoder/src/main/java/com/shuyixiao/livingdoc/vector/impl/ElasticsearchVectorStore.java",
      "timestamp": 1761295459343,
      "startOffset": 55,
      "endOffset": 2358,
      "codeContent": ".elastic.clients.elasticsearch.ElasticsearchClient;\nimport co.elastic.clients.elasticsearch._types.query_dsl.Query;\nimport co.elastic.clients.elasticsearch.core.*;\nimport co.elastic.clients.elasticsearch.core.bulk.BulkOperation;\nimport co.elastic.clients.elasticsearch.core.search.Hit;\nimport co.elastic.clients.elasticsearch.indices.CreateIndexRequest;\nimport co.elastic.clients.elasticsearch.indices.DeleteIndexRequest;\nimport co.elastic.clients.elasticsearch.indices.ExistsRequest;\nimport co.elastic.clients.json.JsonData;\nimport co.elastic.clients.json.jackson.JacksonJsonpMapper;\nimport co.elastic.clients.transport.rest_client.RestClientTransport;\nimport com.shuyixiao.livingdoc.config.LivingDocProperties;\nimport com.shuyixiao.livingdoc.vector.SearchResult;\nimport com.shuyixiao.livingdoc.vector.VectorDocument;\nimport com.shuyixiao.livingdoc.vector.VectorStore;\nimport org.apache.http.HttpHost;\nimport org.apache.http.auth.AuthScope;\nimport org.apache.http.auth.UsernamePasswordCredentials;\nimport org.apache.http.impl.client.BasicCredentialsProvider;\nimport org.elasticsearch.client.RestClient;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\nimport java.io.IOException;\nimport java.time.LocalDateTime;\nimport java.time.format.DateTimeFormatter;\nimport java.util.*;\nimport java.util.stream.Collectors;\n\n/**\n * Elasticsearch 8.15 向量存储实现\n * \n * \u003cp\u003e使用 Elasticsearch 8.15 的 dense_vector 类型存储向量，支持 kNN 搜索。\n * \n * \u003cp\u003e特性：\n * \u003cul\u003e\n *   \u003cli\u003e基于 Elasticsearch 8.15 新版 Java Client\u003c/li\u003e\n *   \u003cli\u003e原生 kNN (k-Nearest Neighbors) 搜索\u003c/li\u003e\n *   \u003cli\u003e高性能向量检索（百万级文档）\u003c/li\u003e\n *   \u003cli\u003e支持元数据过滤\u003c/li\u003e\n *   \u003cli\u003e支持批量操作\u003c/li\u003e\n *   \u003cli\u003e自动索引管理\u003c/li\u003e\n * \u003c/ul\u003e\n * \n * @author PandaCoder Team\n * @since 2.3.0\n */\npublic class ElasticsearchVectorStore implements VectorStore {\n    \n    private static final Logger log \u003d LoggerFactory.getLogger(ElasticsearchVectorStore.class);\n    \n    private final ElasticsearchClient client;\n    private final RestClient restClient;\n    private final String indexName;\n    private final int dimensions;\n    private final String similarityAlgorithm;\n    \n    public ElasticsearchVectorStore(\n            ElasticsearchClient client,\n            RestClient restClient,\n            LivingDocProperties.ElasticsearchConfig config) {\n        this.client \u003d client;\n        this.restClient \u003d restC",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 63
    },
    {
      "filePath": "E:/Project/GitHub/PandaCoder/src/main/java/com/shuyixiao/livingdoc/settings/LivingDocConfigurable.java",
      "timestamp": 1761297131701,
      "startOffset": 10094,
      "endOffset": 10312,
      "codeContent": "Panel wrapper \u003d new JPanel(new BorderLayout());\n        JScrollPane scrollPane \u003d new JBScrollPane(panel);\n        scrollPane.setBorder(null);\n        wrapper.add(scrollPane, BorderLayout.CENTER);\n        return wrapper",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 5
    },
    {
      "filePath": "E:/Project/GitHub/PandaCoder/src/main/java/com/shuyixiao/livingdoc/analyzer/model/ProjectDocumentation.java",
      "timestamp": 1761299590424,
      "startOffset": 321,
      "endOffset": 2166,
      "codeContent": "路径\n     */\n    private String projectPath;\n    \n    /**\n     * 项目描述\n     */\n    private String projectDescription;\n    \n    /**\n     * 项目版本\n     */\n    private String version;\n    \n    /**\n     * API端点列表\n     */\n    private List\u003cApiEndpoint\u003e apis \u003d new ArrayList\u003c\u003e();\n    \n    /**\n     * 实体模型列表\n     */\n    private List\u003cEntityModel\u003e entities \u003d new ArrayList\u003c\u003e();\n    \n    /**\n     * 生成时间\n     */\n    private LocalDateTime generatedAt;\n    \n    public ProjectDocumentation() {\n        this.generatedAt \u003d LocalDateTime.now();\n    }\n    \n    // Getters and Setters\n    \n    public String getProjectName() {\n        return projectName;\n    }\n    \n    public void setProjectName(String projectName) {\n        this.projectName \u003d projectName;\n    }\n    \n    public String getProjectPath() {\n        return projectPath;\n    }\n    \n    public void setProjectPath(String projectPath) {\n        this.projectPath \u003d projectPath;\n    }\n    \n    public String getProjectDescription() {\n        return projectDescription;\n    }\n    \n    public void setProjectDescription(String projectDescription) {\n        this.projectDescription \u003d projectDescription;\n    }\n    \n    public String getVersion() {\n        return version;\n    }\n    \n    public void setVersion(String version) {\n        this.version \u003d version;\n    }\n    \n    public List\u003cApiEndpoint\u003e getApis() {\n        return apis;\n    }\n    \n    public void setApis(List\u003cApiEndpoint\u003e apis) {\n        this.apis \u003d apis;\n    }\n    \n    public void addApi(ApiEndpoint api) {\n        this.apis.add(api);\n    }\n    \n    public void addApis(List\u003cApiEndpoint\u003e apis) {\n        this.apis.addAll(apis);\n    }\n    \n    // Alias methods for compatibility\n    public List\u003cApiEndpoint\u003e getEndpoints() {\n        return apis;\n    }\n    \n    public void setEndpoints(List\u003cApiEndpoint\u003e endpoints) {\n        this.apis \u003d endpoints",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 90
    },
    {
      "filePath": "E:/Project/GitHub/PandaCoder/src/main/java/com/shuyixiao/livingdoc/analyzer/model/Parameter.java",
      "timestamp": 1761299615746,
      "startOffset": 1742,
      "endOffset": 1915,
      "codeContent": "    \n    // Alias methods for compatibility\n    public String getIn() {\n        return source;\n    }\n    \n    public void setIn(String in) {\n        this.source \u003d in;\n    }\n",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 10
    },
    {
      "filePath": "E:/Project/GitHub/PandaCoder/src/main/java/com/shuyixiao/livingdoc/analyzer/model/ApiEndpoint.java",
      "timestamp": 1761299615749,
      "startOffset": 4101,
      "endOffset": 4602,
      "codeContent": "/ Alias methods for compatibility\n    public String getUrl() {\n        return path;\n    }\n    \n    public void setUrl(String url) {\n        this.path \u003d url;\n    }\n    \n    public String getMethod() {\n        return httpMethod;\n    }\n    \n    public void setMethod(String method) {\n        this.httpMethod \u003d method;\n    }\n    \n    public String getClassName() {\n        return controller;\n    }\n    \n    public void setClassName(String className) {\n        this.controller \u003d className;\n    }\n    \n    /",
      "aiProbability": 95,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 26
    },
    {
      "filePath": "E:/Project/GitHub/PandaCoder/src/main/java/com/shuyixiao/livingdoc/analyzer/JavaDocAnalyzer.java",
      "timestamp": 1761299630956,
      "startOffset": 139,
      "endOffset": 229,
      "codeContent": "javadoc.PsiDocComment;\nimport com.intellij.psi.javadoc.PsiDocTag;\nimport com.intellij.psi.",
      "aiProbability": 90,
      "aiTool": "AI Assistant",
      "detectionMethod": "REALTIME_SPEED_ANALYSIS",
      "lineCount": 3
    }
  ],
  "toolStats": {
    "AI Assistant": {
      "usageCount": 62,
      "totalLines": 11676
    }
  }
}