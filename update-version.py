#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
PandaCoder ç‰ˆæœ¬æ›´æ–°è„šæœ¬
ä½¿ç”¨æ–¹æ³•: python update-version.py
"""

import re
import sys
import io
from pathlib import Path

# è®¾ç½® Windows æ§åˆ¶å°è¾“å‡ºç¼–ç 
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')

def read_properties(file_path):
    """è¯»å– properties æ–‡ä»¶ï¼Œæ”¯æŒå¤šè¡Œå€¼"""
    props = {}
    current_key = None
    current_value = []
    
    with open(file_path, 'r', encoding='utf-8') as f:
        lines = f.readlines()
        
    for i, line in enumerate(lines):
        stripped = line.strip()
        
        # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
        if not stripped or stripped.startswith('#'):
            # å¦‚æœå½“å‰æœ‰æ­£åœ¨è¯»å–çš„keyï¼Œä¸”é‡åˆ°ç©ºè¡Œæˆ–æ³¨é‡Šï¼Œè¯´æ˜å¤šè¡Œå€¼ç»“æŸ
            if current_key and stripped.startswith('#'):
                props[current_key] = '\n'.join(current_value)
                current_key = None
                current_value = []
            continue
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„ key=value è¡Œ
        if '=' in stripped and not stripped.startswith('|'):
            # ä¿å­˜ä¹‹å‰çš„ key-value
            if current_key:
                props[current_key] = '\n'.join(current_value)
            
            # å¼€å§‹æ–°çš„ key-value
            key, value = stripped.split('=', 1)
            current_key = key.strip()
            current_value = [value.strip()]
        elif current_key:
            # è¿™æ˜¯å¤šè¡Œå€¼çš„å»¶ç»­è¡Œ
            current_value.append(stripped)
    
    # ä¿å­˜æœ€åä¸€ä¸ª key-value
    if current_key:
        props[current_key] = '\n'.join(current_value)
    
    return props

def update_version_properties(plugin_version, version_type, release_date, current_features):
    """æ›´æ–° version.properties æ–‡ä»¶"""
    version_file = Path('src/main/resources/version.properties')
    content = f"""# Auto-generated version information
# DO NOT EDIT THIS FILE MANUALLY
# This file is generated by update-version.py script
# To update version, edit gradle.properties file and run: python update-version.py

version={plugin_version}
versionType={version_type}
releaseDate={release_date}
currentFeatures={current_features}
"""
    version_file.write_text(content, encoding='utf-8')
    print(f"âœ“ å·²æ›´æ–°: {version_file}")

def update_readme(plugin_version):
    """æ›´æ–° README.md ä¸­çš„ç‰ˆæœ¬å·å¾½ç« """
    readme_file = Path('README.md')
    if not readme_file.exists():
        print(f"âœ— æœªæ‰¾åˆ°: {readme_file}")
        return
    
    content = readme_file.read_text(encoding='utf-8')
    new_content = re.sub(
        r'https://img\.shields\.io/badge/Version-[\d.]+',
        f'https://img.shields.io/badge/Version-{plugin_version}',
        content
    )
    readme_file.write_text(new_content, encoding='utf-8')
    print(f"âœ“ å·²æ›´æ–°: {readme_file}")

def main():
    print("=" * 60)
    print("PandaCoder ç‰ˆæœ¬æ›´æ–°å·¥å…·")
    print("=" * 60)
    print()
    
    # è¯»å– gradle.properties
    props_file = Path('gradle.properties')
    if not props_file.exists():
        print("é”™è¯¯: æœªæ‰¾åˆ° gradle.properties æ–‡ä»¶")
        sys.exit(1)
    
    props = read_properties(props_file)
    plugin_version = props.get('pluginVersion', '')
    version_type = props.get('versionType', '')
    release_date = props.get('releaseDate', '')
    current_features = props.get('currentFeatures', '')
    
    print("å½“å‰ç‰ˆæœ¬é…ç½®:")
    print(f"  ç‰ˆæœ¬å·: {plugin_version}")
    print(f"  ç‰ˆæœ¬ç±»å‹: {version_type}")
    print(f"  å‘å¸ƒæ—¥æœŸ: {release_date}")
    print(f"  ä¸»è¦åŠŸèƒ½: {current_features}")
    print()
    
    # æ›´æ–°æ–‡ä»¶
    print("æ­£åœ¨æ›´æ–°æ–‡ä»¶...")
    update_version_properties(plugin_version, version_type, release_date, current_features)
    update_readme(plugin_version)
    
    print()
    print("=" * 60)
    print("âœ“ ç‰ˆæœ¬æ›´æ–°å®Œæˆï¼")
    print("=" * 60)
    print()
    print("å·²æ›´æ–°çš„æ–‡ä»¶:")
    print("  1. src/main/resources/version.properties")
    print("  2. README.md")
    print()
    print("ä¸‹ä¸€æ­¥æ“ä½œ:")
    print("  1. è¿è¡Œ gradlew clean build é‡æ–°æ„å»ºé¡¹ç›®")
    print(f"  2. æäº¤æ›´æ”¹: git add . && git commit -m 'chore: update version to {plugin_version}'")
    print(f"  3. åˆ›å»ºæ ‡ç­¾: git tag v{plugin_version}")
    print("  4. æ¨é€è¿œç¨‹: git push && git push --tags")
    print()
    print("ğŸ“ åŒæ­¥åˆ°åšå®¢:")
    print("  è¿è¡Œ: python sync-to-blog.py")
    print("=" * 60)

if __name__ == '__main__':
    main()

