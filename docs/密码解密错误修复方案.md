# 🔧 密码解密错误修复方案

## 📋 问题描述

**错误信息：**
```
javax.crypto.IllegalBlockSizeException: Input length must be multiple of 16 when decrypting with padded cipher
```

**错误原因：**
存储的密码数据不是有效的 AES 加密数据，可能的原因包括：
1. 密码是明文存储的（旧版本或手动修改配置文件）
2. Base64 编码的数据损坏或不完整
3. 加密密钥不一致（项目路径变化导致）
4. 配置文件被手动修改

---

## ✅ 解决方案（已修复）

### 方案概述

我已经升级了 `PasswordEncryptor` 类（版本 2.0.0 → 2.1.0），新版本具有以下特性：

#### 🎯 核心改进

1. **智能密码格式检测**
   - 自动识别加密密码（`ENC:` 前缀）
   - 兼容旧格式的 Base64 加密数据
   - 支持明文密码（自动转换）

2. **容错机制**
   - 解密失败时不再抛出异常崩溃
   - 自动降级为明文处理
   - 详细的日志记录便于排查

3. **向后兼容**
   - 完全兼容旧版本配置
   - 自动迁移明文密码
   - 无需手动修改配置文件

---

## 🚀 使用方法

### 方法1：重新保存配置（推荐）

这是最简单、最安全的方法：

1. **打开插件配置界面**
   - 在 IDEA 中打开 Git 统计工具窗口
   - 切换到"邮件配置"标签页

2. **重新输入密码**
   - 在"发件人密码"字段重新输入你的 SMTP 密码
   - 点击"保存配置"按钮

3. **测试连接**
   - 点击"测试连接"按钮验证配置
   - 如果成功，密码已自动加密保存

### 方法2：清除配置文件

如果方法1不起作用，可以清除配置文件：

1. **关闭 IDEA**

2. **删除配置文件**
   ```
   项目目录/.idea/gitStatEmailConfig.xml
   ```

3. **重新打开 IDEA**
   - 重新配置邮件设置
   - 密码会自动加密保存

### 方法3：手动修复配置文件

如果你了解配置文件结构，可以手动修复：

1. **找到配置文件**
   ```
   项目目录/.idea/gitStatEmailConfig.xml
   ```

2. **编辑文件**
   - 找到 `<senderPassword>` 标签
   - 将其值改为空字符串：`<senderPassword></senderPassword>`
   - 或者直接删除该行

3. **重启 IDEA 并重新配置**

---

## 🔍 技术细节

### 新版本密码格式

**加密格式：**
```
ENC:Base64编码的AES加密数据
```

**示例：**
```
ENC:xK8vN2pQ7mR5tY9wE3aF6bC1dH4jL8sP
```

### 密码处理流程

```
输入密码
    ↓
检查是否以 "ENC:" 开头？
    ↓ 是
    解密 Base64 数据
    ↓
    返回明文密码
    
    ↓ 否
    尝试作为旧格式 Base64 解密
    ↓
    成功？
    ↓ 是
    返回明文密码
    
    ↓ 否
    作为明文密码返回（兼容模式）
    ↓
    记录警告日志
```

### 加密算法

- **算法：** AES (Advanced Encryption Standard)
- **模式：** ECB (Electronic Codebook)
- **填充：** PKCS5Padding
- **密钥长度：** 128 位（16 字节）
- **密钥生成：** 基于项目路径 + "GitStatEmail" 字符串

---

## ⚠️ 注意事项

### 1. 项目路径变化

如果项目路径发生变化（移动项目文件夹），加密密钥会改变，导致无法解密旧密码。

**解决方法：**
- 重新保存配置（推荐）
- 或者将项目移回原路径

### 2. 配置文件共享

不建议将 `.idea/gitStatEmailConfig.xml` 文件提交到版本控制系统，因为：
- 包含敏感的邮箱密码信息
- 加密密钥基于项目路径，不同开发者路径不同

**建议：**
在 `.gitignore` 中添加：
```
.idea/gitStatEmailConfig.xml
```

### 3. 密码安全性

虽然密码已加密，但 AES-ECB 模式不是最安全的加密方式。建议：
- 使用 SMTP 应用专用密码（而非邮箱登录密码）
- 定期更换密码
- 不要在不安全的环境中使用

---

## 📊 版本对比

| 特性 | 旧版本 (2.0.0) | 新版本 (2.1.0) |
|------|---------------|---------------|
| 加密格式 | Base64 | ENC:Base64 |
| 明文兼容 | ❌ 抛出异常 | ✅ 自动处理 |
| 错误处理 | ❌ 程序崩溃 | ✅ 优雅降级 |
| 日志记录 | ❌ 无 | ✅ 详细日志 |
| 格式检测 | ❌ 无 | ✅ 智能检测 |

---

## 🎉 总结

**问题已修复！** 新版本的 `PasswordEncryptor` 类能够：

✅ 自动处理各种密码格式  
✅ 兼容旧版本配置  
✅ 解密失败时不会崩溃  
✅ 提供详细的错误日志  

**下一步操作：**
1. 重新编译插件
2. 重新保存邮件配置
3. 测试邮件发送功能

如有问题，请查看 IDEA 日志文件获取详细错误信息。

