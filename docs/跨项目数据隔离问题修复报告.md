# è·¨é¡¹ç›®æ•°æ®éš”ç¦»é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ› é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆçš„é—®é¢˜
ç”¨æˆ·åœ¨ä½¿ç”¨ PandaCoder æ’ä»¶æ—¶å‘ç°ï¼š
- åœ¨é¡¹ç›® A ä¸­å¯åŠ¨ SQL Monitor å’Œ ES DSL Monitor ç›‘æ§æœåŠ¡
- ç›‘æ§çš„æ—¥å¿—æ­£å¸¸æ˜¾ç¤ºåœ¨é¡¹ç›® A çš„å·¥å…·çª—å£ä¸­
- æ‰“å¼€ä¸€ä¸ªæ–°çš„ IDEA çª—å£ï¼Œæ‰“å¼€é¡¹ç›® B
- **é—®é¢˜**ï¼šé¡¹ç›® A çš„ç›‘æ§æ—¥å¿—å‡ºç°åœ¨äº†é¡¹ç›® B çš„å·¥å…·çª—å£ä¸­ï¼

è¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„**è·¨é¡¹ç›®æ•°æ®ä¸²æ‰°**é—®é¢˜ã€‚

---

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### 1. æœåŠ¡æ³¨å†Œçº§åˆ«æ£€æŸ¥ âœ…
é¦–å…ˆæ£€æŸ¥äº†æœåŠ¡çš„æ³¨å†Œçº§åˆ«ï¼Œå‘ç°æ‰€æœ‰ç›‘æ§æœåŠ¡éƒ½**æ­£ç¡®æ³¨å†Œä¸º `projectService`**ï¼š

```xml
<!-- plugin.xml -->
<projectService serviceImplementation="com.shuyixiao.sql.service.SqlRecordService"/>
<projectService serviceImplementation="com.shuyixiao.sql.service.SqlMonitoringService"/>
<projectService serviceImplementation="com.shuyixiao.esdsl.service.EsDslRecordService"/>
<projectService serviceImplementation="com.shuyixiao.esdsl.service.EsDslMonitoringService"/>
<projectService serviceImplementation="com.shuyixiao.bugrecorder.service.ConsoleMonitoringService"/>
```

âœ… æœåŠ¡çº§åˆ«æ²¡æœ‰é—®é¢˜ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½æœ‰ç‹¬ç«‹çš„æœåŠ¡å®ä¾‹ã€‚

### 2. æ•°æ®å­˜å‚¨æœºåˆ¶æ£€æŸ¥ âœ…
æ£€æŸ¥äº†æ•°æ®å­˜å‚¨ä½ç½®ï¼Œå‘ç°æ¯ä¸ªé¡¹ç›®çš„æ•°æ®éƒ½å­˜å‚¨åœ¨å„è‡ªçš„ `.idea` ç›®å½•ä¸‹ï¼š

```java
// SqlRecordService.java
String projectPath = project.getBasePath();
File ideaDir = new File(projectPath, ".idea");
this.storageFile = new File(ideaDir, STORAGE_FILE);
```

âœ… æ•°æ®å­˜å‚¨éš”ç¦»æ­£ç¡®ï¼Œæ¯ä¸ªé¡¹ç›®æœ‰ç‹¬ç«‹çš„æ•°æ®æ–‡ä»¶ã€‚

### 3. ç›‘å¬å™¨æ³¨å†Œæœºåˆ¶æ£€æŸ¥ âŒ **å‘ç°é—®é¢˜ï¼**

é—®é¢˜å‡ºåœ¨ `setupExecutionListener()` æ–¹æ³•ä¸­ï¼š

```java
// é—®é¢˜ä»£ç 
private void setupExecutionListener() {
    ApplicationManager.getApplication().getMessageBus()
            .connect(project)
            .subscribe(ExecutionManager.EXECUTION_TOPIC, new ExecutionListener() {
                @Override
                public void processStarted(@NotNull String executorId, 
                                         @NotNull ExecutionEnvironment env,
                                         @NotNull ProcessHandler handler) {
                    // âŒ æ²¡æœ‰æ£€æŸ¥ env.getProject() æ˜¯å¦æ˜¯å½“å‰é¡¹ç›®ï¼
                    ApplicationManager.getApplication().invokeLater(() -> {
                        attachListener(handler);
                    });
                }
            });
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. `ExecutionManager.EXECUTION_TOPIC` æ˜¯ä¸€ä¸ª**åº”ç”¨çº§åˆ«çš„æ¶ˆæ¯æ€»çº¿ä¸»é¢˜**
2. è™½ç„¶ä½¿ç”¨äº† `.connect(project)` æ¥é™å®šè¿æ¥çš„ç”Ÿå‘½å‘¨æœŸ
3. ä½†æ˜¯ `EXECUTION_TOPIC` ä¼šæ¥æ”¶**æ‰€æœ‰é¡¹ç›®**çš„æ‰§è¡Œäº‹ä»¶
4. **å…³é”®ç¼ºé™·**ï¼š`processStarted()` æ–¹æ³•ä¸­æ²¡æœ‰æ£€æŸ¥ `ExecutionEnvironment` æ˜¯å¦å±äºå½“å‰é¡¹ç›®
5. å¯¼è‡´é¡¹ç›® A çš„ç›‘æ§æœåŠ¡ä¼šç›‘å¬åˆ°é¡¹ç›® B çš„è¿›ç¨‹å¯åŠ¨äº‹ä»¶
6. ä»è€Œå°†é¡¹ç›® B çš„æ—¥å¿—è®°å½•åˆ°é¡¹ç›® A çš„æ•°æ®ä¸­

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤åŸåˆ™
åœ¨æ‰€æœ‰ `ExecutionListener` çš„å›è°ƒæ–¹æ³•ä¸­ï¼Œæ·»åŠ **é¡¹ç›®å½’å±æ£€æŸ¥**ï¼š

```java
if (env.getProject() != project) {
    return; // å¿½ç•¥å…¶ä»–é¡¹ç›®çš„äº‹ä»¶
}
```

### ä¿®å¤çš„æ–‡ä»¶åˆ—è¡¨

#### 1. SQL Monitor ç›‘æ§æœåŠ¡
**æ–‡ä»¶**: `src/main/java/com/shuyixiao/sql/service/SqlMonitoringService.java`

**ä¿®å¤å†…å®¹**:
```java
@Override
public void processStarted(@NotNull String executorId, @NotNull ExecutionEnvironment env,
                           @NotNull ProcessHandler handler) {
    // âœ… å…³é”®ä¿®å¤ï¼šåªå¤„ç†å½“å‰é¡¹ç›®çš„è¿›ç¨‹ï¼Œé¿å…è·¨é¡¹ç›®æ•°æ®ä¸²æ‰°
    if (env.getProject() != project) {
        LOG.debug("[SQL Monitor] å¿½ç•¥å…¶ä»–é¡¹ç›®çš„è¿›ç¨‹: " + env.getProject().getName());
        return;
    }
    
    ApplicationManager.getApplication().invokeLater(() -> {
        LOG.info("[SQL Monitor] ä¸ºå½“å‰é¡¹ç›®é™„åŠ ç›‘å¬å™¨: " + project.getName());
        attachListener(handler);
    });
}

@Override
public void processTerminated(@NotNull String executorId, @NotNull ExecutionEnvironment env,
                              @NotNull ProcessHandler handler, int exitCode) {
    // âœ… å…³é”®ä¿®å¤ï¼šåªå¤„ç†å½“å‰é¡¹ç›®çš„è¿›ç¨‹
    if (env.getProject() != project) {
        return;
    }
    
    removeListener(handler);
}
```

#### 2. ES DSL Monitor ç›‘æ§æœåŠ¡
**æ–‡ä»¶**: `src/main/java/com/shuyixiao/esdsl/service/EsDslMonitoringService.java`

**ä¿®å¤å†…å®¹**: ä¸ SQL Monitor ç›¸åŒçš„ä¿®å¤é€»è¾‘

#### 3. Bug Recorder ç›‘æ§æœåŠ¡
**æ–‡ä»¶**: `src/main/java/com/shuyixiao/bugrecorder/service/ConsoleMonitoringService.java`

**ä¿®å¤å†…å®¹**: ä¸ SQL Monitor ç›¸åŒçš„ä¿®å¤é€»è¾‘

#### 4. Enhanced Bug Recorder æ‰§è¡Œç›‘å¬å™¨
**æ–‡ä»¶**: `src/main/java/com/shuyixiao/bugrecorder/enhanced/EnhancedExecutionListener.java`

**ä¿®å¤å†…å®¹**:
```java
private void handleProcessStarted(@NotNull String executorId, @NotNull ExecutionEnvironment env,
                                 @NotNull ProcessHandler handler) {
    if (isDisposed.get() || !monitoringService.isMonitoringEnabled()) {
        return;
    }

    // âœ… å…³é”®ä¿®å¤ï¼šåªå¤„ç†å½“å‰é¡¹ç›®çš„è¿›ç¨‹ï¼Œé¿å…è·¨é¡¹ç›®æ•°æ®ä¸²æ‰°
    if (env.getProject() != project) {
        LOG.debug("[Enhanced Bug Recorder] å¿½ç•¥å…¶ä»–é¡¹ç›®çš„è¿›ç¨‹: " + env.getProject().getName());
        return;
    }

    // ... åç»­å¤„ç†é€»è¾‘
}

private void handleProcessTerminating(@NotNull String executorId, @NotNull ExecutionEnvironment env,
                                    @NotNull ProcessHandler handler) {
    if (isDisposed.get()) {
        return;
    }

    // âœ… å…³é”®ä¿®å¤ï¼šåªå¤„ç†å½“å‰é¡¹ç›®çš„è¿›ç¨‹
    if (env.getProject() != project) {
        return;
    }

    // ... æ¸…ç†é€»è¾‘
}

private void handleProcessTerminated(@NotNull String executorId, @NotNull ExecutionEnvironment env,
                                   @NotNull ProcessHandler handler, int exitCode) {
    if (isDisposed.get()) {
        return;
    }

    // âœ… å…³é”®ä¿®å¤ï¼šåªå¤„ç†å½“å‰é¡¹ç›®çš„è¿›ç¨‹
    if (env.getProject() != project) {
        return;
    }

    // ... æ¸…ç†é€»è¾‘
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
é¡¹ç›® A (PandaCoder)
  â”œâ”€ å¯åŠ¨ Spring Boot åº”ç”¨
  â”œâ”€ SQL Monitor ç›‘å¬å™¨é™„åŠ åˆ°è¿›ç¨‹
  â””â”€ æ•è· SQL æ—¥å¿— âœ…

é¡¹ç›® B (OtherProject)
  â”œâ”€ æ‰“å¼€æ–°çš„ IDEA çª—å£
  â”œâ”€ å¯åŠ¨ Spring Boot åº”ç”¨
  â”œâ”€ âŒ é¡¹ç›® A çš„ SQL Monitor ä¹Ÿç›‘å¬åˆ°äº†é¡¹ç›® B çš„è¿›ç¨‹ï¼
  â””â”€ âŒ é¡¹ç›® B çš„ SQL æ—¥å¿—å‡ºç°åœ¨é¡¹ç›® A çš„å·¥å…·çª—å£ä¸­
```

### ä¿®å¤å
```
é¡¹ç›® A (PandaCoder)
  â”œâ”€ å¯åŠ¨ Spring Boot åº”ç”¨
  â”œâ”€ SQL Monitor ç›‘å¬å™¨é™„åŠ åˆ°è¿›ç¨‹
  â””â”€ æ•è· SQL æ—¥å¿— âœ…

é¡¹ç›® B (OtherProject)
  â”œâ”€ æ‰“å¼€æ–°çš„ IDEA çª—å£
  â”œâ”€ å¯åŠ¨ Spring Boot åº”ç”¨
  â”œâ”€ âœ… é¡¹ç›® A çš„ SQL Monitor æ£€æµ‹åˆ°è¿™æ˜¯å…¶ä»–é¡¹ç›®çš„è¿›ç¨‹ï¼Œå¿½ç•¥
  â”œâ”€ âœ… é¡¹ç›® B çš„ SQL Monitor ç›‘å¬å™¨é™„åŠ åˆ°è‡ªå·±çš„è¿›ç¨‹
  â””â”€ âœ… é¡¹ç›® B çš„ SQL æ—¥å¿—åªå‡ºç°åœ¨é¡¹ç›® B çš„å·¥å…·çª—å£ä¸­
```

---

## ğŸ¯ éªŒè¯æ–¹æ³•

### æµ‹è¯•æ­¥éª¤
1. åœ¨ IDEA ä¸­æ‰“å¼€é¡¹ç›® Aï¼Œå¯åŠ¨ SQL Monitor å’Œ ES DSL Monitor
2. è¿è¡Œé¡¹ç›® A çš„ Spring Boot åº”ç”¨ï¼Œç¡®è®¤æ—¥å¿—æ­£å¸¸æ˜¾ç¤º
3. æ‰“å¼€æ–°çš„ IDEA çª—å£ï¼Œæ‰“å¼€é¡¹ç›® B
4. è¿è¡Œé¡¹ç›® B çš„ Spring Boot åº”ç”¨
5. **éªŒè¯**ï¼š
   - é¡¹ç›® A çš„å·¥å…·çª—å£ä¸­ä¸åº”è¯¥å‡ºç°é¡¹ç›® B çš„æ—¥å¿—
   - é¡¹ç›® B çš„å·¥å…·çª—å£ä¸­ä¸åº”è¯¥å‡ºç°é¡¹ç›® A çš„æ—¥å¿—
   - æ¯ä¸ªé¡¹ç›®çš„æ—¥å¿—åº”è¯¥å®Œå…¨éš”ç¦»

### æ—¥å¿—éªŒè¯
ä¿®å¤åï¼Œåœ¨æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š

```
[SQL Monitor] ä¸ºå½“å‰é¡¹ç›®é™„åŠ ç›‘å¬å™¨: PandaCoder
[SQL Monitor] å¿½ç•¥å…¶ä»–é¡¹ç›®çš„è¿›ç¨‹: OtherProject
```

---

## ğŸ“ æŠ€æœ¯æ€»ç»“

### å…³é”®çŸ¥è¯†ç‚¹
1. **IntelliJ Platform çš„æ¶ˆæ¯æ€»çº¿æœºåˆ¶**
   - `ExecutionManager.EXECUTION_TOPIC` æ˜¯åº”ç”¨çº§åˆ«çš„ä¸»é¢˜
   - ä¼šå¹¿æ’­æ‰€æœ‰é¡¹ç›®çš„æ‰§è¡Œäº‹ä»¶
   - å¿…é¡»åœ¨ç›‘å¬å™¨ä¸­æ‰‹åŠ¨è¿‡æ»¤é¡¹ç›®

2. **é¡¹ç›®çº§åˆ«æœåŠ¡çš„æ­£ç¡®ä½¿ç”¨**
   - è™½ç„¶æœåŠ¡æ˜¯é¡¹ç›®çº§åˆ«çš„ï¼Œä½†ç›‘å¬çš„äº‹ä»¶æ˜¯åº”ç”¨çº§åˆ«çš„
   - éœ€è¦åœ¨äº‹ä»¶å¤„ç†ä¸­æ£€æŸ¥ `ExecutionEnvironment.getProject()`

3. **æ•°æ®éš”ç¦»çš„å¤šå±‚ä¿éšœ**
   - æœåŠ¡çº§åˆ«ï¼šä½¿ç”¨ `projectService` è€Œä¸æ˜¯ `applicationService`
   - æ•°æ®å­˜å‚¨ï¼šå­˜å‚¨åœ¨é¡¹ç›®çš„ `.idea` ç›®å½•ä¸‹
   - äº‹ä»¶å¤„ç†ï¼šåœ¨ç›‘å¬å™¨ä¸­è¿‡æ»¤é¡¹ç›®å½’å±

### æœ€ä½³å®è·µ
åœ¨è®¢é˜…åº”ç”¨çº§åˆ«çš„æ¶ˆæ¯æ€»çº¿ä¸»é¢˜æ—¶ï¼Œ**å§‹ç»ˆæ£€æŸ¥äº‹ä»¶çš„é¡¹ç›®å½’å±**ï¼š

```java
ApplicationManager.getApplication().getMessageBus()
    .connect(project)
    .subscribe(SOME_APPLICATION_LEVEL_TOPIC, new SomeListener() {
        @Override
        public void onEvent(Event event) {
            // âœ… æœ€ä½³å®è·µï¼šæ£€æŸ¥é¡¹ç›®å½’å±
            if (event.getProject() != project) {
                return;
            }
            
            // å¤„ç†äº‹ä»¶
        }
    });
```

---

## âœ… ä¿®å¤å®Œæˆ

**ä¿®å¤æ—¥æœŸ**: 2025-10-31

**å½±å“èŒƒå›´**:
- SQL Monitor ç›‘æ§æœåŠ¡ âœ…
- ES DSL Monitor ç›‘æ§æœåŠ¡ âœ…
- Bug Recorder ç›‘æ§æœåŠ¡ âœ…
- Enhanced Bug Recorder ç›‘æ§æœåŠ¡ âœ…

**æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯

**é£é™©è¯„ä¼°**: ä½é£é™©ï¼Œä»…æ·»åŠ äº†é¡¹ç›®å½’å±æ£€æŸ¥ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

