# ES 控制台日志 - 快速实施指南

## 🎯 核心问题

**ais-server 项目无法像 MyBatis Logs 一样在控制台输出 ES 查询语句**

### 原因
- Elasticsearch 客户端默认不输出 DSL 查询
- 缺少日志配置
- 没有自定义拦截器

---

## ⚡ 最快解决方案（5分钟）

### 步骤1：修改 logback-local.xml

在 `src/main/resources/logback-local.xml` 中添加：

```xml
<!-- ===== 在 </configuration> 之前添加 ===== -->

<!-- Elasticsearch 客户端日志 -->
<logger name="org.elasticsearch.client" level="DEBUG">
    <appender-ref ref="STDOUT" />
    <appender-ref ref="syslog" />
</logger>

<!-- Spring Data Elasticsearch -->
<logger name="org.springframework.data.elasticsearch" level="DEBUG">
    <appender-ref ref="STDOUT" />
    <appender-ref ref="syslog" />
</logger>

<!-- ES 请求追踪（最详细） -->
<logger name="tracer" level="TRACE">
    <appender-ref ref="STDOUT" />
    <appender-ref ref="syslog" />
</logger>
```

### 步骤2：重启应用

重启后，控制台会输出：

```
TRACE tracer - curl -X POST "localhost:9200/index/_search" -d '{
  "query": {
    "bool": {
      "must": [{"match": {"content": "查询内容"}}]
    }
  },
  "knn": {
    "field": "vector",
    "k": 10
  }
}'
```

### 步骤3：配合 PandaCoder 插件使用

1. 打开 IDEA 底部的 **"ES DSL Monitor"** 工具窗口
2. 勾选 **"启用ES监听"**
3. 运行应用，查询会自动捕获并展示

**完成！** ✅

---

## 🎨 美化方案（1-2小时）

### 创建自定义日志拦截器

创建文件：`src/main/java/com/torchv/system/extensions/elasticsearch/ElasticsearchQueryLogger.java`

```java
package com.torchv.system.extensions.elasticsearch;

import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.data.elasticsearch.client.elc.NativeQuery;
import org.springframework.data.elasticsearch.core.SearchHits;
import org.springframework.stereotype.Component;
import com.fasterxml.jackson.databind.ObjectMapper;

/**
 * ES 查询日志拦截器 - 类似 MyBatis Log
 */
@Slf4j
@Aspect
@Component
@ConditionalOnProperty(name = "elasticsearch.logging.enabled", havingValue = "true")
public class ElasticsearchQueryLogger {

    private final ObjectMapper mapper = new ObjectMapper();
    
    @Around("execution(* org.springframework.data.elasticsearch.core.ElasticsearchOperations.search(..))")
    public Object logQuery(ProceedingJoinPoint joinPoint) throws Throwable {
        long start = System.currentTimeMillis();
        
        // 记录查询
        Object[] args = joinPoint.getArgs();
        if (args.length > 0 && args[0] instanceof NativeQuery) {
            NativeQuery query = (NativeQuery) args[0];
            String indexName = args.length > 2 ? args[2].toString() : "unknown";
            
            log.info("╔═══════════════════════════════════════════════════════════════");
            log.info("║ 📊 ES Query");
            log.info("╠═══════════════════════════════════════════════════════════════");
            log.info("║ Index: {}", indexName);
            
            // 打印 Query DSL
            if (query.getQuery() != null) {
                String queryJson = mapper.writerWithDefaultPrettyPrinter()
                    .writeValueAsString(query.getQuery());
                for (String line : queryJson.split("\n")) {
                    log.info("║   {}", line);
                }
            }
            
            // 打印 KNN Query
            if (query.getKnnQuery() != null && !query.getKnnQuery().isEmpty()) {
                log.info("║ KNN: field={}, k={}", 
                    "vector", query.getPageable().getPageSize());
            }
        }
        
        // 执行查询
        Object result = joinPoint.proceed();
        
        // 记录结果
        long time = System.currentTimeMillis() - start;
        if (result instanceof SearchHits) {
            SearchHits<?> hits = (SearchHits<?>) result;
            log.info("╠═══════════════════════════════════════════════════════════════");
            log.info("║ ✅ Result: {} hits | {} ms", hits.getTotalHits(), time);
            log.info("╚═══════════════════════════════════════════════════════════════");
        }
        
        return result;
    }
}
```

### 在 application-dev.yml 中启用

```yaml
# 启用 ES 查询日志
elasticsearch:
  logging:
    enabled: true
```

### 添加依赖（如果缺少）

在 `pom.xml` 中确认有：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

### 效果

```
╔═══════════════════════════════════════════════════════════════
║ 📊 ES Query
╠═══════════════════════════════════════════════════════════════
║ Index: torchv_chunk_dims_1024
║   {
║     "bool" : {
║       "must" : [ {
║         "match" : {
║           "content" : {
║             "query" : "用户问题",
║             "boost" : 0.3
║           }
║         }
║       } ]
║     }
║   }
║ KNN: field=vector, k=10
╠═══════════════════════════════════════════════════════════════
║ ✅ Result: 156 hits | 23 ms
╚═══════════════════════════════════════════════════════════════
```

---

## 📊 方案对比

| 方案 | 时间 | 效果 | 推荐度 |
|------|------|------|--------|
| 方案1：配置原生日志 | 5分钟 | ⭐⭐⭐ | 快速验证 ✅ |
| 方案2：自定义拦截器 | 1-2小时 | ⭐⭐⭐⭐⭐ | 生产使用 ✅✅✅ |

---

## 🔧 PandaCoder 项目改进

### 当前问题
- 用户不知道如何配置日志
- 配置文档不够详细
- 缺少配置检测功能

### 改进方案

#### 1. 更新使用文档

在 `docs/EsDslMonitor使用指南.md` 中添加醒目提示：

```markdown
## ⚠️ 重要：必须配置日志才能捕获 ES 查询

### Logback 配置（最常用）

在 `src/main/resources/logback-spring.xml` 中添加：

\```xml
<logger name="org.elasticsearch.client" level="DEBUG"/>
<logger name="tracer" level="TRACE"/>
\```

### 验证配置

运行应用后，在控制台搜索 `curl -X POST` 或 `elasticsearch`，
如果没有找到，说明日志配置未生效。
```

#### 2. 提供配置模板

在项目根目录创建 `config-templates/` 文件夹，提供：
- `logback-es-config.xml` - Logback 配置模板
- `application-es-config.yml` - Application 配置模板
- `log4j2-es-config.xml` - Log4j2 配置模板

#### 3. 在工具窗口添加帮助

在 `EsDslToolWindow.java` 中添加帮助按钮：

```java
JButton helpButton = new JButton("❓ 配置帮助");
helpButton.addActionListener(e -> {
    String message = """
        ES DSL Monitor 需要应用程序输出 ES 查询日志才能捕获。
        
        请在项目中配置：
        
        1. Logback (推荐)
           在 logback.xml 中添加：
           <logger name="tracer" level="TRACE"/>
        
        2. Application.yml
           logging:
             level:
               tracer: TRACE
        
        配置后重启应用即可。
        
        详细说明请查看：docs/EsDslMonitor使用指南.md
        """;
    
    JOptionPane.showMessageDialog(
        panel,
        message,
        "配置帮助",
        JOptionPane.INFORMATION_MESSAGE
    );
});
```

---

## ✅ 实施检查清单

### ais-server 项目

- [ ] 修改 `logback-local.xml`，添加 ES 日志配置
- [ ] 重启应用，验证控制台输出
- [ ] 创建 `ElasticsearchQueryLogger.java`（可选）
- [ ] 在 `application-dev.yml` 中配置开关（可选）
- [ ] 测试验证美化输出效果（可选）

### PandaCoder 项目

- [ ] 更新 `docs/EsDslMonitor使用指南.md`
- [ ] 创建 `config-templates/` 配置模板文件夹
- [ ] 在工具窗口添加"配置帮助"按钮（可选）
- [ ] 增强 `EsDslParser.java` 解析能力（可选）

---

## 🎓 关键知识点

### 1. Elasticsearch 客户端日志层级

```
org.elasticsearch.client          # 基础客户端日志
  ├── RestClient                   # REST 请求日志
  └── sniffer                      # 节点探测日志

tracer                             # 最详细的追踪日志（包含完整 DSL）

org.springframework.data.elasticsearch  # Spring Data 日志
```

### 2. Logback 配置要点

```xml
<!-- additivity="false" 防止日志重复输出 -->
<logger name="tracer" level="TRACE" additivity="false">
    <appender-ref ref="STDOUT" />
</logger>
```

### 3. 性能考虑

生产环境建议：
```yaml
logging:
  level:
    tracer: ${ES_LOG_LEVEL:INFO}  # 生产环境 INFO，开发环境 TRACE
```

---

## 📞 需要帮助？

如果遇到问题：

1. **查看详细文档**：`ES控制台日志实现建议.md`
2. **检查日志配置**：确认 logger 配置正确
3. **验证日志级别**：运行时打印当前日志级别

---

**创建时间**：2024-10-18  
**快速上手，立即见效！** 🚀

