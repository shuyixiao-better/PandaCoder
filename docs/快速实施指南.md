# ES æ§åˆ¶å°æ—¥å¿— - å¿«é€Ÿå®æ–½æŒ‡å—

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**ais-server é¡¹ç›®æ— æ³•åƒ MyBatis Logs ä¸€æ ·åœ¨æ§åˆ¶å°è¾“å‡º ES æŸ¥è¯¢è¯­å¥**

### åŸå› 
- Elasticsearch å®¢æˆ·ç«¯é»˜è®¤ä¸è¾“å‡º DSL æŸ¥è¯¢
- ç¼ºå°‘æ—¥å¿—é…ç½®
- æ²¡æœ‰è‡ªå®šä¹‰æ‹¦æˆªå™¨

---

## âš¡ æœ€å¿«è§£å†³æ–¹æ¡ˆï¼ˆ5åˆ†é’Ÿï¼‰

### æ­¥éª¤1ï¼šä¿®æ”¹ logback-local.xml

åœ¨ `src/main/resources/logback-local.xml` ä¸­æ·»åŠ ï¼š

```xml
<!-- ===== åœ¨ </configuration> ä¹‹å‰æ·»åŠ  ===== -->

<!-- Elasticsearch å®¢æˆ·ç«¯æ—¥å¿— -->
<logger name="org.elasticsearch.client" level="DEBUG">
    <appender-ref ref="STDOUT" />
    <appender-ref ref="syslog" />
</logger>

<!-- Spring Data Elasticsearch -->
<logger name="org.springframework.data.elasticsearch" level="DEBUG">
    <appender-ref ref="STDOUT" />
    <appender-ref ref="syslog" />
</logger>

<!-- ES è¯·æ±‚è¿½è¸ªï¼ˆæœ€è¯¦ç»†ï¼‰ -->
<logger name="tracer" level="TRACE">
    <appender-ref ref="STDOUT" />
    <appender-ref ref="syslog" />
</logger>
```

### æ­¥éª¤2ï¼šé‡å¯åº”ç”¨

é‡å¯åï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºï¼š

```
TRACE tracer - curl -X POST "localhost:9200/index/_search" -d '{
  "query": {
    "bool": {
      "must": [{"match": {"content": "æŸ¥è¯¢å†…å®¹"}}]
    }
  },
  "knn": {
    "field": "vector",
    "k": 10
  }
}'
```

### æ­¥éª¤3ï¼šé…åˆ PandaCoder æ’ä»¶ä½¿ç”¨

1. æ‰“å¼€ IDEA åº•éƒ¨çš„ **"ES DSL Monitor"** å·¥å…·çª—å£
2. å‹¾é€‰ **"å¯ç”¨ESç›‘å¬"**
3. è¿è¡Œåº”ç”¨ï¼ŒæŸ¥è¯¢ä¼šè‡ªåŠ¨æ•è·å¹¶å±•ç¤º

**å®Œæˆï¼** âœ…

---

## ğŸ¨ ç¾åŒ–æ–¹æ¡ˆï¼ˆ1-2å°æ—¶ï¼‰

### åˆ›å»ºè‡ªå®šä¹‰æ—¥å¿—æ‹¦æˆªå™¨

åˆ›å»ºæ–‡ä»¶ï¼š`src/main/java/com/torchv/system/extensions/elasticsearch/ElasticsearchQueryLogger.java`

```java
package com.torchv.system.extensions.elasticsearch;

import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.data.elasticsearch.client.elc.NativeQuery;
import org.springframework.data.elasticsearch.core.SearchHits;
import org.springframework.stereotype.Component;
import com.fasterxml.jackson.databind.ObjectMapper;

/**
 * ES æŸ¥è¯¢æ—¥å¿—æ‹¦æˆªå™¨ - ç±»ä¼¼ MyBatis Log
 */
@Slf4j
@Aspect
@Component
@ConditionalOnProperty(name = "elasticsearch.logging.enabled", havingValue = "true")
public class ElasticsearchQueryLogger {

    private final ObjectMapper mapper = new ObjectMapper();
    
    @Around("execution(* org.springframework.data.elasticsearch.core.ElasticsearchOperations.search(..))")
    public Object logQuery(ProceedingJoinPoint joinPoint) throws Throwable {
        long start = System.currentTimeMillis();
        
        // è®°å½•æŸ¥è¯¢
        Object[] args = joinPoint.getArgs();
        if (args.length > 0 && args[0] instanceof NativeQuery) {
            NativeQuery query = (NativeQuery) args[0];
            String indexName = args.length > 2 ? args[2].toString() : "unknown";
            
            log.info("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            log.info("â•‘ ğŸ“Š ES Query");
            log.info("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            log.info("â•‘ Index: {}", indexName);
            
            // æ‰“å° Query DSL
            if (query.getQuery() != null) {
                String queryJson = mapper.writerWithDefaultPrettyPrinter()
                    .writeValueAsString(query.getQuery());
                for (String line : queryJson.split("\n")) {
                    log.info("â•‘   {}", line);
                }
            }
            
            // æ‰“å° KNN Query
            if (query.getKnnQuery() != null && !query.getKnnQuery().isEmpty()) {
                log.info("â•‘ KNN: field={}, k={}", 
                    "vector", query.getPageable().getPageSize());
            }
        }
        
        // æ‰§è¡ŒæŸ¥è¯¢
        Object result = joinPoint.proceed();
        
        // è®°å½•ç»“æœ
        long time = System.currentTimeMillis() - start;
        if (result instanceof SearchHits) {
            SearchHits<?> hits = (SearchHits<?>) result;
            log.info("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            log.info("â•‘ âœ… Result: {} hits | {} ms", hits.getTotalHits(), time);
            log.info("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        }
        
        return result;
    }
}
```

### åœ¨ application-dev.yml ä¸­å¯ç”¨

```yaml
# å¯ç”¨ ES æŸ¥è¯¢æ—¥å¿—
elasticsearch:
  logging:
    enabled: true
```

### æ·»åŠ ä¾èµ–ï¼ˆå¦‚æœç¼ºå°‘ï¼‰

åœ¨ `pom.xml` ä¸­ç¡®è®¤æœ‰ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

### æ•ˆæœ

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ“Š ES Query
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ Index: torchv_chunk_dims_1024
â•‘   {
â•‘     "bool" : {
â•‘       "must" : [ {
â•‘         "match" : {
â•‘           "content" : {
â•‘             "query" : "ç”¨æˆ·é—®é¢˜",
â•‘             "boost" : 0.3
â•‘           }
â•‘         }
â•‘       } ]
â•‘     }
â•‘   }
â•‘ KNN: field=vector, k=10
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ âœ… Result: 156 hits | 23 ms
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ—¶é—´ | æ•ˆæœ | æ¨èåº¦ |
|------|------|------|--------|
| æ–¹æ¡ˆ1ï¼šé…ç½®åŸç”Ÿæ—¥å¿— | 5åˆ†é’Ÿ | â­â­â­ | å¿«é€ŸéªŒè¯ âœ… |
| æ–¹æ¡ˆ2ï¼šè‡ªå®šä¹‰æ‹¦æˆªå™¨ | 1-2å°æ—¶ | â­â­â­â­â­ | ç”Ÿäº§ä½¿ç”¨ âœ…âœ…âœ… |

---

## ğŸ”§ PandaCoder é¡¹ç›®æ”¹è¿›

### å½“å‰é—®é¢˜
- ç”¨æˆ·ä¸çŸ¥é“å¦‚ä½•é…ç½®æ—¥å¿—
- é…ç½®æ–‡æ¡£ä¸å¤Ÿè¯¦ç»†
- ç¼ºå°‘é…ç½®æ£€æµ‹åŠŸèƒ½

### æ”¹è¿›æ–¹æ¡ˆ

#### 1. æ›´æ–°ä½¿ç”¨æ–‡æ¡£

åœ¨ `docs/EsDslMonitorä½¿ç”¨æŒ‡å—.md` ä¸­æ·»åŠ é†’ç›®æç¤ºï¼š

```markdown
## âš ï¸ é‡è¦ï¼šå¿…é¡»é…ç½®æ—¥å¿—æ‰èƒ½æ•è· ES æŸ¥è¯¢

### Logback é…ç½®ï¼ˆæœ€å¸¸ç”¨ï¼‰

åœ¨ `src/main/resources/logback-spring.xml` ä¸­æ·»åŠ ï¼š

\```xml
<logger name="org.elasticsearch.client" level="DEBUG"/>
<logger name="tracer" level="TRACE"/>
\```

### éªŒè¯é…ç½®

è¿è¡Œåº”ç”¨åï¼Œåœ¨æ§åˆ¶å°æœç´¢ `curl -X POST` æˆ– `elasticsearch`ï¼Œ
å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè¯´æ˜æ—¥å¿—é…ç½®æœªç”Ÿæ•ˆã€‚
```

#### 2. æä¾›é…ç½®æ¨¡æ¿

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `config-templates/` æ–‡ä»¶å¤¹ï¼Œæä¾›ï¼š
- `logback-es-config.xml` - Logback é…ç½®æ¨¡æ¿
- `application-es-config.yml` - Application é…ç½®æ¨¡æ¿
- `log4j2-es-config.xml` - Log4j2 é…ç½®æ¨¡æ¿

#### 3. åœ¨å·¥å…·çª—å£æ·»åŠ å¸®åŠ©

åœ¨ `EsDslToolWindow.java` ä¸­æ·»åŠ å¸®åŠ©æŒ‰é’®ï¼š

```java
JButton helpButton = new JButton("â“ é…ç½®å¸®åŠ©");
helpButton.addActionListener(e -> {
    String message = """
        ES DSL Monitor éœ€è¦åº”ç”¨ç¨‹åºè¾“å‡º ES æŸ¥è¯¢æ—¥å¿—æ‰èƒ½æ•è·ã€‚
        
        è¯·åœ¨é¡¹ç›®ä¸­é…ç½®ï¼š
        
        1. Logback (æ¨è)
           åœ¨ logback.xml ä¸­æ·»åŠ ï¼š
           <logger name="tracer" level="TRACE"/>
        
        2. Application.yml
           logging:
             level:
               tracer: TRACE
        
        é…ç½®åé‡å¯åº”ç”¨å³å¯ã€‚
        
        è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ï¼šdocs/EsDslMonitorä½¿ç”¨æŒ‡å—.md
        """;
    
    JOptionPane.showMessageDialog(
        panel,
        message,
        "é…ç½®å¸®åŠ©",
        JOptionPane.INFORMATION_MESSAGE
    );
});
```

---

## âœ… å®æ–½æ£€æŸ¥æ¸…å•

### ais-server é¡¹ç›®

- [ ] ä¿®æ”¹ `logback-local.xml`ï¼Œæ·»åŠ  ES æ—¥å¿—é…ç½®
- [ ] é‡å¯åº”ç”¨ï¼ŒéªŒè¯æ§åˆ¶å°è¾“å‡º
- [ ] åˆ›å»º `ElasticsearchQueryLogger.java`ï¼ˆå¯é€‰ï¼‰
- [ ] åœ¨ `application-dev.yml` ä¸­é…ç½®å¼€å…³ï¼ˆå¯é€‰ï¼‰
- [ ] æµ‹è¯•éªŒè¯ç¾åŒ–è¾“å‡ºæ•ˆæœï¼ˆå¯é€‰ï¼‰

### PandaCoder é¡¹ç›®

- [ ] æ›´æ–° `docs/EsDslMonitorä½¿ç”¨æŒ‡å—.md`
- [ ] åˆ›å»º `config-templates/` é…ç½®æ¨¡æ¿æ–‡ä»¶å¤¹
- [ ] åœ¨å·¥å…·çª—å£æ·»åŠ "é…ç½®å¸®åŠ©"æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
- [ ] å¢å¼º `EsDslParser.java` è§£æèƒ½åŠ›ï¼ˆå¯é€‰ï¼‰

---

## ğŸ“ å…³é”®çŸ¥è¯†ç‚¹

### 1. Elasticsearch å®¢æˆ·ç«¯æ—¥å¿—å±‚çº§

```
org.elasticsearch.client          # åŸºç¡€å®¢æˆ·ç«¯æ—¥å¿—
  â”œâ”€â”€ RestClient                   # REST è¯·æ±‚æ—¥å¿—
  â””â”€â”€ sniffer                      # èŠ‚ç‚¹æ¢æµ‹æ—¥å¿—

tracer                             # æœ€è¯¦ç»†çš„è¿½è¸ªæ—¥å¿—ï¼ˆåŒ…å«å®Œæ•´ DSLï¼‰

org.springframework.data.elasticsearch  # Spring Data æ—¥å¿—
```

### 2. Logback é…ç½®è¦ç‚¹

```xml
<!-- additivity="false" é˜²æ­¢æ—¥å¿—é‡å¤è¾“å‡º -->
<logger name="tracer" level="TRACE" additivity="false">
    <appender-ref ref="STDOUT" />
</logger>
```

### 3. æ€§èƒ½è€ƒè™‘

ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š
```yaml
logging:
  level:
    tracer: ${ES_LOG_LEVEL:INFO}  # ç”Ÿäº§ç¯å¢ƒ INFOï¼Œå¼€å‘ç¯å¢ƒ TRACE
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£**ï¼š`ESæ§åˆ¶å°æ—¥å¿—å®ç°å»ºè®®.md`
2. **æ£€æŸ¥æ—¥å¿—é…ç½®**ï¼šç¡®è®¤ logger é…ç½®æ­£ç¡®
3. **éªŒè¯æ—¥å¿—çº§åˆ«**ï¼šè¿è¡Œæ—¶æ‰“å°å½“å‰æ—¥å¿—çº§åˆ«

---

**åˆ›å»ºæ—¶é—´**ï¼š2024-10-18  
**å¿«é€Ÿä¸Šæ‰‹ï¼Œç«‹å³è§æ•ˆï¼** ğŸš€

