# PandaCoder 版本号统一管理方案

## 📋 概述

本文档说明 PandaCoder 项目的版本号统一管理方案。通过此方案，**只需修改一个文件即可更新整个项目的版本号**。

## 🎯 设计目标

1. **单一数据源**：版本号只在 `gradle.properties` 中定义
2. **自动同步**：通过 Gradle 任务自动同步到所有相关文件
3. **易于维护**：版本迭代时只需修改一处配置
4. **构建时生成**：版本信息在构建时自动注入到代码中

## 📁 版本信息配置文件

### gradle.properties（唯一的版本号来源）

```properties
# ==================== 插件版本配置 ====================
# 这是全局唯一的版本号配置，修改此处即可更新整个项目的版本号
# 版本号格式：主版本号.次版本号.修订号
pluginVersion=1.1.9

# 版本类型：正式版本、内测版本、测试版本等
versionType=内测版本

# 发布日期：格式 YYYY-MM-DD
releaseDate=2024-12-21

# 当前版本主要功能描述
currentFeatures=模力方舟腾讯混元模型翻译为默认值
```

## 🔄 版本号同步机制

### 1. Gradle 构建配置（build.gradle）

```groovy
// 从 gradle.properties 读取版本号
version = pluginVersion
```

### 2. 自动生成版本信息文件

构建时自动生成 `build/generated-resources/version.properties`：

```groovy
tasks.register('generateVersionProperties') {
    description = '生成版本信息属性文件，用于在运行时读取版本号'
    group = 'build'
    
    def outputDir = file("$buildDir/generated-resources")
    outputs.dir outputDir
    
    doLast {
        outputDir.mkdirs()
        def versionFile = new File(outputDir, 'version.properties')
        versionFile.text = """# Auto-generated version information
version=${pluginVersion}
versionType=${versionType}
releaseDate=${releaseDate}
currentFeatures=${currentFeatures}
"""
    }
}
```

### 3. Java 代码读取版本信息（VersionInfo.java）

```java
public final class VersionInfo {
    private static final Properties VERSION_PROPS = new Properties();
    
    static {
        try (InputStream input = VersionInfo.class.getClassLoader()
                .getResourceAsStream("version.properties")) {
            if (input != null) {
                VERSION_PROPS.load(input);
            }
        } catch (IOException e) {
            System.err.println("Error loading version.properties: " + e.getMessage());
        }
    }
    
    public static final String CURRENT_VERSION = VERSION_PROPS.getProperty("version", "1.1.9");
    public static final String VERSION_TYPE = VERSION_PROPS.getProperty("versionType", "内测版本");
    public static final String RELEASE_DATE = VERSION_PROPS.getProperty("releaseDate", "2024-12-21");
    public static final String CURRENT_FEATURES = VERSION_PROPS.getProperty("currentFeatures", "");
}
```

### 4. 自动更新 README.md

```groovy
tasks.register('updateReadmeVersion') {
    description = '自动更新 README.md 中的版本号徽章'
    group = 'version'
    
    doLast {
        def readmeFile = file('README.md')
        if (readmeFile.exists()) {
            def content = readmeFile.text
            content = content.replaceAll(
                /https:\/\/img\.shields\.io\/badge\/Version-[\d.]+/,
                "https://img.shields.io/badge/Version-${pluginVersion}"
            )
            readmeFile.text = content
        }
    }
}
```

## 🚀 使用方法

### 版本更新流程

当需要发布新版本时，按以下步骤操作：

#### 步骤 1：修改 gradle.properties

```properties
pluginVersion=1.2.0          # 修改版本号
versionType=正式版本          # 修改版本类型
releaseDate=2024-12-25       # 修改发布日期
currentFeatures=新增XXX功能   # 修改功能描述
```

#### 步骤 2：运行版本更新脚本

```bash
# 使用 Python 脚本（推荐）
python update-version.py

# 或使用 PowerShell 脚本（Windows）
.\update-version.ps1

# 或使用 Gradle 脚本
gradlew -b update-version.gradle
```

#### 步骤 3：验证更新结果

运行后会自动更新以下文件：
- ✅ `src/main/resources/version.properties` - 版本信息文件
- ✅ `README.md` - 版本号徽章自动更新
- ✅ `VersionInfo.java` - 运行时自动从 version.properties 读取

#### 步骤 4：重新构建项目

```bash
# Windows
gradlew clean build

# Linux/Mac
./gradlew clean build
```

### 可用的 Gradle 任务

| 任务名称 | 说明 | 使用场景 |
|---------|------|---------|
| `generateVersionProperties` | 生成版本信息属性文件 | 构建时自动执行 |
| `updateReadmeVersion` | 更新 README.md 中的版本号 | 版本更新时手动执行 |
| `updateVersion` | 一键更新所有版本相关文件 | **推荐使用** |

### 示例输出

运行 `./gradlew updateVersion` 后的输出：

```
========================================
版本更新完成！
当前版本：1.2.0
版本类型：正式版本
发布日期：2024-12-25
主要功能：新增XXX功能
========================================
已更新的文件：
1. build/generated-resources/version.properties
2. README.md

注意事项：
- 版本号已从 gradle.properties 同步到所有相关文件
- VersionInfo.java 将在下次编译时自动从 version.properties 读取版本信息
- 如需发布新版本，请先修改 gradle.properties 中的版本信息，然后运行：./gradlew updateVersion
========================================
```

## 📊 版本号管理流程图

```
┌─────────────────────────┐
│  gradle.properties      │  ← 唯一的版本号来源（手动修改）
│  - pluginVersion        │
│  - versionType          │
│  - releaseDate          │
│  - currentFeatures      │
└───────────┬─────────────┘
            │
            ├──────────────────────────────────┐
            │                                  │
            ▼                                  ▼
┌─────────────────────────┐      ┌─────────────────────────┐
│  build.gradle           │      │  Gradle Task:           │
│  version = pluginVersion│      │  generateVersionProps   │
└─────────────────────────┘      └───────────┬─────────────┘
                                             │
                                             ▼
                                 ┌─────────────────────────┐
                                 │  version.properties     │
                                 │  (自动生成)              │
                                 └───────────┬─────────────┘
                                             │
                                             ▼
                                 ┌─────────────────────────┐
                                 │  VersionInfo.java       │
                                 │  (运行时读取)            │
                                 └─────────────────────────┘
            │
            ▼
┌─────────────────────────┐
│  Gradle Task:           │
│  updateReadmeVersion    │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  README.md              │
│  (自动更新版本徽章)      │
└─────────────────────────┘
```

## ✅ 优势

1. **单一数据源**：所有版本信息都来自 `gradle.properties`
2. **自动化**：通过 Gradle 任务自动同步，减少人为错误
3. **类型安全**：Java 代码中的版本信息通过 Properties 文件加载，支持默认值
4. **易于维护**：版本更新只需修改一个文件，运行一个命令
5. **构建集成**：版本信息在构建时自动生成，确保一致性
6. **向后兼容**：如果 version.properties 不存在，使用默认值保证功能可用

## 🔧 故障排除

### 问题 1：VersionInfo.java 读取不到版本信息

**原因**：version.properties 文件未生成

**解决方案**：
```bash
./gradlew clean build
```

### 问题 2：README.md 版本号未更新

**原因**：未运行 updateReadmeVersion 任务

**解决方案**：
```bash
./gradlew updateVersion
```

### 问题 3：构建后版本号仍然是旧版本

**原因**：
1. gradle.properties 未正确修改
2. 缓存问题

**解决方案**：
```bash
./gradlew clean
./gradlew updateVersion
./gradlew build
```

## 📝 最佳实践

1. **版本更新前**：
   - 确保所有代码已提交
   - 更新版本历史文档
   - 准备好 Release Notes

2. **版本更新时**：
   - 修改 `gradle.properties` 中的所有版本相关字段
   - 运行 `./gradlew updateVersion`
   - 验证所有文件都已正确更新

3. **版本更新后**：
   - 运行完整测试
   - 提交所有更改的文件
   - 创建 Git Tag：`git tag v1.2.0`
   - 推送到远程：`git push origin v1.2.0`

## 🎉 总结

通过这套版本号统一管理方案，PandaCoder 项目实现了：
- ✅ 版本号的单一数据源管理
- ✅ 自动化的版本同步机制
- ✅ 简化的版本更新流程
- ✅ 减少人为错误的可能性

**记住**：每次版本更新，只需两步：
1. 修改 `gradle.properties`
2. 运行 `./gradlew updateVersion`

就这么简单！🎊

